// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "metrics", "tracing"]
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
  output = "../node_modules/.prisma/client"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================

enum UserRole {
  CONSUMER
  BRAND_USER
  BRAND_ADMIN
  PLATFORM_ADMIN
  FABRICATOR
}

enum OrderStatus {
  CREATED
  PENDING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum DesignStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
}

enum BrandStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
  VERIFIED
}

enum WebhookEventType {
  ORDER_CREATED
  ORDER_UPDATED
  ORDER_PAID
  DESIGN_CREATED
  DESIGN_COMPLETED
  PRODUCT_UPDATED
}

enum ZoneType {
  TEXT
  IMAGE
  PATTERN
  COLOR
}

enum CustomizationEffect {
  NORMAL
  EMBOSSED
  ENGRAVED
  THREE_D
}

enum CustomizationStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

// ========================================
// MODELS
// ========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String? // Null for OAuth users
  firstName     String?
  lastName      String?
  name          String? // Full name field
  avatar        String?
  role          UserRole  @default(CONSUMER)
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: SetNull)

  designs        Design[]
  orders         Order[]
  refreshTokens  RefreshToken[]
  customizations Customization[]
  notifications  Notification[]

  // OAuth
  oauthAccounts OAuthAccount[]

  // Quotas
  userQuota UserQuota?
  
  // Marketplace
  artisan Artisan?

  // GDPR
  userConsents UserConsent[]

  @@index([email])
  @@index([brandId])
  @@index([role])
}

model OAuthAccount {
  id           String    @id @default(cuid())
  provider     String // google, github, etc.
  providerId   String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Brand {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  logo        String?
  website     String?
  status      BrandStatus @default(PENDING_VERIFICATION)

  // KYC Fields
  companyName String?
  vatNumber   String?
  address     String?
  city        String?
  country     String?
  postalCode  String?
  phone       String?

  // Billing
  stripeCustomerId     String?
  stripeSubscriptionId String? // Stripe subscription ID
  plan                 String    @default("starter")
  planExpiresAt        DateTime?
  limits               Json? // Brand limits configuration

  // Budgets (for AI costs)
  aiCostLimitCents Int?      @default(500000) // 5000€ default limit
  aiCostUsedCents  Int       @default(0)
  aiCostResetAt    DateTime? // Monthly reset

  // Settings
  settings      Json? // Brand-specific settings
  webhookUrl    String?
  webhookSecret String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users                 User[]
  products              Product[]
  designs               Design[]
  orders                Order[]
  webhooks              Webhook[]
  apiKeys               ApiKey[]
  aiCosts               AICost[]
  ecommerceIntegrations EcommerceIntegration[]
  usageMetrics          UsageMetric[]
  customizations        Customization[]

  @@index([slug])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model Product {
  id          String  @id @default(cuid())
  name        String
  description String?
  sku         String?
  price       Decimal @db.Decimal(10, 2)
  currency    String  @default("EUR")

  // Images
  images       String[] // Array of image URLs
  baseAssetUrl String? // Base asset URL for rendering

  // 3D Model
  model3dUrl  String?
  modelConfig Json? // 3D model configuration

  // Customization & Product Engine
  customizationOptions Json? // Available customization options
  rulesJson            Json? // Product Rules Engine configuration

  // Manufacturing & Cost
  baseCostCents     Int? // Base manufacturing cost in cents
  laborCostCents    Int? // Labor cost in cents
  overheadCostCents Int? // Overhead cost in cents
  materialOptions   Json? // Available materials with pricing
  finishOptions     Json? // Available finishes with pricing
  productionTime    Int? // Estimated production time in hours

  // Status
  isActive Boolean @default(true)
  isPublic Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  designs         Design[]
  orders          Order[]
  productMappings ProductMapping[]
  zones           Zone[]
  customizations  Customization[]

  @@index([brandId])
  @@index([isActive])
  @@index([isPublic])
}

model Design {
  id          String  @id @default(cuid())
  name        String?
  description String?

  // Generation
  prompt      String
  promptHash  String? // For caching
  options     Json // Generation options
  optionsJson Json? // Legacy field for compatibility
  status      DesignStatus @default(PENDING)

  // Results
  previewUrl String? // Low-res preview
  highResUrl String? // High-res result
  imageUrl   String? // Main image URL
  renderUrl  String? // Render URL
  metadata   Json? // AI generation metadata

  // Cost tracking
  costCents Int     @default(0)
  provider  String? // AI provider used

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  orders         Order[]
  assets         Asset[]
  customizations Customization[]

  @@index([userId])
  @@index([brandId])
  @@index([productId])
  @@index([status])
  @@index([promptHash])
  @@index([createdAt])
}

model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique
  status      OrderStatus @default(CREATED)

  // Customer info
  customerEmail   String
  customerName    String?
  customerPhone   String?
  userEmail       String? // For GDPR anonymization
  shippingAddress Json?

  // Pricing
  subtotalCents Int
  taxCents      Int    @default(0)
  shippingCents Int    @default(0)
  totalCents    Int
  currency      String @default("EUR")

  // Payment
  paymentStatus   PaymentStatus @default(PENDING)
  stripeSessionId String?
  stripePaymentId String?

  // Shipping
  trackingNumber      String?
  trackingUrl         String?
  productionBundleUrl String? // URL to production bundle

  // Notes
  notes    String?
  metadata Json? // Additional order metadata

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  paidAt    DateTime?
  shippedAt DateTime?

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  designId String
  design   Design @relation(fields: [designId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  customizations Customization[]
  workOrder      WorkOrder?
  quotes         Quote[]

  @@index([userId])
  @@index([brandId])
  @@index([designId])
  @@index([productId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
}

model ApiKey {
  id          String    @id @default(cuid())
  name        String
  key         String    @unique
  secret      String? // Hashed secret for API key authentication
  scopes      String[] // Array of permissions (legacy)
  permissions String[] // Array of permissions (new)
  rateLimit   Json? // Rate limiting configuration
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([key])
  @@index([isActive])
}

model AICost {
  id        String   @id @default(cuid())
  provider  String // openai, replicate, etc.
  model     String // gpt-4, stable-diffusion, etc.
  costCents Int
  tokens    Int? // For text models
  duration  Int? // Processing time in seconds
  createdAt DateTime @default(now())

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([provider])
  @@index([createdAt])
}

model UserQuota {
  id             String   @id @default(cuid())
  monthlyLimit   Int      @default(100) // Monthly design generations
  monthlyUsed    Int      @default(0)
  costLimitCents Int      @default(5000) // 50€ monthly limit
  costUsedCents  Int      @default(0)
  resetAt        DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([resetAt])
}

model Webhook {
  id             String    @id @default(cuid())
  event          String // Event type (design.created, order.updated, etc.)
  url            String // Webhook URL
  payload        Json // Webhook payload data
  statusCode     Int? // HTTP response status code
  success        Boolean   @default(false) // Whether webhook was successful
  error          String? // Error message if failed
  idempotencyKey String?   @unique // For idempotency
  timestamp      DateTime? // For replay protection
  createdAt      DateTime  @default(now())

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([event])
  @@index([success])
  @@index([createdAt])
  @@index([idempotencyKey])
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

// ========================================
// AI PROMPT TEMPLATES
// ========================================

model PromptTemplate {
  id          String   @id @default(cuid())
  name        String
  version     Int      @default(1)
  occasion    String?  // 'birth', 'engagement', 'mourning', 'friendship', etc.
  style       String?  // 'minimal', 'baroque', 'art-deco', etc.
  prompt      String   // Template avec variables {{variable}}
  variables   Json?    // Variables disponibles et leurs descriptions
  constraints Json?    // Contraintes production (serti, gravure, etc.)
  brandKit    Json?    // Brand kit integration (couleurs, ton, interdits)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, version])
  @@index([occasion])
  @@index([style])
  @@index([isActive])
}

// ========================================
// DESIGN DNA (Embeddings + Parameters)
// ========================================

model DesignDNA {
  id            String   @id @default(cuid())
  designId     String   @unique
  story         String?  // Story/intention utilisateur
  tags          String[] // Tags normalisés
  embedding     Json?    // Vector embedding (pgvector)
  parameters    Json?    // Paramètres retenus (ce qui a été cliqué)
  conversionData Json?   // Données de conversion (clicks, time, etc.)
  productionData Json?   // Données production (QC, défauts, etc.)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([designId])
}

// ========================================
// WORKERS & PRODUCTION MODELS
// ========================================

model RenderResult {
  id           String   @id @default(cuid())
  renderId     String   @unique
  type         String // '2d', '3d', 'preview'
  status       String // 'success', 'failed'
  url          String?
  thumbnailUrl String?
  metadata     Json?
  createdAt    DateTime @default(now())

  @@index([renderId])
  @@index([type])
  @@index([status])
}

model RenderProgress {
  id         String   @id @default(cuid())
  renderId   String   @unique
  stage      String
  percentage Int
  message    String
  timestamp  DateTime @default(now())

  @@index([renderId])
}

model RenderError {
  id         String   @id @default(cuid())
  renderId   String
  error      String
  occurredAt DateTime @default(now())

  @@index([renderId])
}

model ExportResult {
  id        String   @id @default(cuid())
  renderId  String   @unique
  format    String // 'gltf', 'usdz', 'png', etc.
  url       String
  size      Int
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([renderId])
  @@index([format])
}

model ProductionStatus {
  id           String   @id @default(cuid())
  orderId      String   @unique
  currentStage String
  message      String
  percentage   Int
  lastUpdated  DateTime @default(now())

  @@index([orderId])
}

model QualityReport {
  id              String   @id @default(cuid())
  orderId         String   @unique
  overallScore    Float
  issues          String[]
  recommendations String[]
  passed          Boolean
  createdAt       DateTime @default(now())

  @@index([orderId])
}

model BatchRenderProgress {
  id          String   @id @default(cuid())
  batchId     String   @unique
  completed   Int
  total       Int
  percentage  Int
  results     Json?
  lastUpdated DateTime @default(now())

  @@index([batchId])
}

// ========================================
// E-COMMERCE INTEGRATIONS
// ========================================

model EcommerceIntegration {
  id           String    @id @default(cuid())
  brandId      String
  platform     String // 'shopify', 'woocommerce', 'magento'
  shopDomain   String
  accessToken  String?
  refreshToken String?
  config       Json
  status       String    @default("active")
  lastSyncAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  brand           Brand            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  productMappings ProductMapping[]
  syncLogs        SyncLog[]

  @@index([brandId])
  @@index([platform])
  @@index([shopDomain])
  @@index([status])
}

model ProductMapping {
  id                String   @id @default(cuid())
  integrationId     String
  luneoProductId    String
  externalProductId String
  externalSku       String
  syncStatus        String   @default("synced")
  lastSyncedAt      DateTime @default(now())
  metadata          Json?

  // Relations
  integration EcommerceIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  product     Product              @relation(fields: [luneoProductId], references: [id], onDelete: Cascade)

  @@unique([integrationId, externalProductId])
  @@index([integrationId])
  @@index([luneoProductId])
  @@index([externalProductId])
  @@index([externalSku])
}

model SyncLog {
  id             String   @id @default(cuid())
  integrationId  String
  type           String // 'product', 'order', 'inventory'
  direction      String // 'import', 'export'
  status         String // 'success', 'failed', 'partial'
  itemsProcessed Int      @default(0)
  itemsFailed    Int      @default(0)
  errors         Json?
  duration       Int // in milliseconds
  createdAt      DateTime @default(now())

  // Relations
  integration EcommerceIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model WebhookLog {
  id          String    @id @default(cuid())
  webhookId   String
  topic       String
  shopDomain  String
  payload     Json
  status      String    @default("received")
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([webhookId])
  @@index([topic])
  @@index([shopDomain])
  @@index([status])
  @@index([createdAt])
}

// ========================================
// ADDITIONAL MODELS
// ========================================

model Asset {
  id        String   @id @default(cuid())
  designId  String
  url       String
  type      String // 'image', 'model', 'texture', 'video'
  format    String
  size      Int
  width     Int?
  height    Int?
  metadata  Json?
  createdAt DateTime @default(now())

  // Relations
  design Design @relation(fields: [designId], references: [id], onDelete: Cascade)

  @@index([designId])
  @@index([type])
}

model AuditLog {
  id           String   @id @default(cuid())
  eventType    String
  userId       String
  resourceType String
  resourceId   String
  action       String
  success      Boolean  @default(true)
  metadata     Json?
  timestamp    DateTime @default(now())
  ipAddress    String?
  userAgent    String?

  @@index([userId])
  @@index([eventType])
  @@index([resourceType])
  @@index([resourceId])
  @@index([timestamp])
  @@index([success])
}

model UserConsent {
  id          String   @id @default(cuid())
  userId      String
  consentType String // 'privacy', 'marketing', 'analytics'
  granted     Boolean  @default(false)
  recordedAt  DateTime @default(now())
  ipAddress   String?
  userAgent   String?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([consentType])
  @@index([recordedAt])
}

model UsageMetric {
  id        String   @id @default(cuid())
  brandId   String
  metric    String // 'designs_created', 'renders_2d', 'api_calls', etc.
  value     Int
  unit      String // 'count', 'bytes', 'seconds'
  timestamp DateTime @default(now())
  metadata  Json?

  // Relations
  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([metric])
  @@index([timestamp])
}

// ========================================
// PRODUCT CUSTOMIZATION MODELS
// ========================================

model Zone {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        ZoneType @default(TEXT)

  // 3D Position & UV Mapping
  positionX Float
  positionY Float
  positionZ Float
  rotationX Float @default(0)
  rotationY Float @default(0)
  rotationZ Float @default(0)
  scaleX    Float @default(1)
  scaleY    Float @default(1)
  scaleZ    Float @default(1)

  // UV Mapping coordinates
  uvMinU Float // Minimum U coordinate (0-1)
  uvMaxU Float // Maximum U coordinate (0-1)
  uvMinV Float // Minimum V coordinate (0-1)
  uvMaxV Float // Maximum V coordinate (0-1)

  // Customization Options
  maxChars        Int? // Maximum characters for text zones
  allowedFonts    String[] // Allowed fonts for text zones
  defaultFont     String? // Default font
  defaultColor    String? // Default color (hex)
  defaultSize     Int? // Default text size
  allowedColors   String[] // Allowed colors
  allowedPatterns String[] // Allowed patterns

  // Constraints
  isRequired Boolean @default(false)
  isActive   Boolean @default(true)
  order      Int     @default(0) // Display order

  // Metadata
  metadata Json? // Additional configuration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  customizations Customization[]

  @@index([productId])
  @@index([type])
  @@index([isActive])
  @@index([order])
}

// ========================================
// NOTIFICATIONS
// ========================================

model Notification {
  id          String    @id @default(cuid())
  userId      String
  type        String // 'info', 'success', 'warning', 'error', 'order', 'customization', 'system'
  title       String
  message     String
  data        Json? // Additional data
  read        Boolean   @default(false)
  readAt      DateTime?
  actionUrl   String? // URL for action button
  actionLabel String? // Label for action button
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([type])
  @@index([createdAt])
}

model Customization {
  id          String  @id @default(cuid())
  name        String?
  description String?

  // User Input
  prompt     String // User's text input
  promptHash String? // Hash for caching

  // Configuration
  zoneId String
  zone   Zone   @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Options used
  font        String?
  color       String?
  size        Int?
  effect      CustomizationEffect @default(ENGRAVED)
  orientation String? // horizontal, vertical, curved
  options     Json? // Additional options

  // Status & Generation
  status CustomizationStatus @default(PENDING)
  jobId  String? // AI engine job ID

  // Generated Assets
  textureUrl String? // Generated texture URL
  modelUrl   String? // Modified 3D model URL (.glb)
  previewUrl String? // Preview image URL
  highResUrl String? // High resolution render URL
  arModelUrl String? // AR-optimized model URL (.usdz)

  // Metadata
  metadata     Json? // Generation metadata (processing time, etc.)
  errorMessage String? // Error message if failed
  retryCount   Int     @default(0)

  // Cost tracking
  costCents        Int  @default(0)
  processingTimeMs Int? // Processing time in milliseconds

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: SetNull)

  designId String? // Link to Design if part of a design
  design   Design? @relation(fields: [designId], references: [id], onDelete: SetNull)

  orderId String? // Link to Order if purchased
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([productId])
  @@index([zoneId])
  @@index([brandId])
  @@index([status])
  @@index([promptHash])
  @@index([jobId])
  @@index([createdAt])
  @@index([designId])
  @@index([orderId])
}

// ========================================
// OUTBOX PATTERN (Event Sourcing)
// ========================================

model OutboxEvent {
  id          String    @id @default(cuid())
  eventType   String // Event type (design.completed, order.paid, etc.)
  payload     Json // Event payload
  status      String    @default("pending") // pending, published, failed
  attempts    Int       @default(0)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status, createdAt])
  @@index([eventType])
}

// ========================================
// MARKETPLACE (Lot 4)
// ========================================

model Artisan {
  id                  String   @id @default(cuid())
  userId              String   @unique
  businessName        String
  legalName           String?
  taxId               String?
  address             Json?
  phone               String?
  email               String?
  website             String?
  
  // KYC/KYB
  kycStatus           String   @default("pending") // pending, verified, rejected, suspended
  kycVerifiedAt       DateTime?
  kycDocuments        Json?
  
  // Stripe Connect
  stripeAccountId     String?
  stripeAccountStatus String?
  onboardingCompleted Boolean  @default(false)
  
  // Capacités
  maxVolume           Int      @default(10)
  currentLoad         Int      @default(0)
  averageLeadTime     Int      @default(7) // jours
  minOrderValue       Int      @default(0) // cents
  
  // Matériaux supportés
  supportedMaterials  String[]
  supportedTechniques String[]
  supportedZones      String[]
  
  // Qualité & Performance
  qualityScore        Float    @default(5.0)
  totalOrders         Int      @default(0)
  completedOrders     Int      @default(0)
  onTimeDeliveryRate  Float    @default(1.0)
  defectRate          Float    @default(0.0)
  returnRate          Float    @default(0.0)
  
  // SLA
  slaLevel            String   @default("standard") // basic, standard, premium, enterprise
  slaPenalties        Json     @default("{}")
  slaBonuses          Json     @default("{}")
  
  // Status
  status              String   @default("active") // active, inactive, suspended, quarantined
  quarantineReason    String?
  quarantineUntil     DateTime?
  
  // Settings
  settings            Json     @default("{}")
  payoutSchedule      String   @default("weekly") // daily, weekly, biweekly, monthly
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  capabilities ArtisanCapability[]
  workOrders   WorkOrder[]
  quotes       Quote[]
  slaRecords   SLARecord[]
  payouts      Payout[]
  
  @@index([kycStatus])
  @@index([status])
  @@index([qualityScore])
  @@index([stripeAccountId])
}

model ArtisanCapability {
  id             String   @id @default(cuid())
  artisanId      String
  material       String
  technique      String
  maxSize        Float?
  minSize        Float?
  leadTime       Int? // jours
  costMultiplier Float    @default(1.0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  artisan Artisan @relation(fields: [artisanId], references: [id], onDelete: Cascade)
  
  @@index([artisanId])
  @@index([material])
  @@index([technique])
}

model WorkOrder {
  id                String   @id @default(cuid())
  orderId           String   @unique
  artisanId         String
  quoteId           String?  @unique
  
  // Routing
  routingScore      Float?
  routingReason     String?
  selectedAt        DateTime?
  
  // Production
  status            String   @default("assigned") // assigned, accepted, in_progress, qc_pending, qc_passed, qc_failed, shipped, completed, cancelled
  acceptedAt        DateTime?
  startedAt         DateTime?
  estimatedCompletion DateTime?
  completedAt       DateTime?
  
  // SLA
  slaDeadline       DateTime?
  slaMet            Boolean?
  slaPenaltyCents   Int      @default(0)
  slaBonusCents     Int      @default(0)
  
  // Financial
  payoutAmountCents Int?
  commissionCents   Int?
  payoutStatus      String   @default("pending") // pending, processing, paid, failed, cancelled
  payoutId          String?
  
  // QC
  qcScore           Float?
  qcPassed          Boolean?
  qcIssues          String[]
  qcReportId        String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  order    Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  artisan  Artisan   @relation(fields: [artisanId], references: [id], onDelete: Restrict)
  quote    Quote?    @relation("WorkOrderQuote", fields: [quoteId], references: [id], onDelete: SetNull)
  slaRecord SLARecord?
  
  @@index([artisanId])
  @@index([status])
  @@index([slaDeadline])
  @@index([payoutStatus])
}

model Quote {
  id            String   @id @default(cuid())
  orderId       String
  artisanId     String
  
  // Pricing
  priceCents   Int
  leadTime     Int // jours
  breakdown    Json
  
  // Scoring
  qualityScore Float?
  costScore    Float?
  leadTimeScore Float?
  distanceScore Float?
  overallScore  Float?
  
  // Status
  status        String   @default("pending") // pending, selected, rejected, expired
  selectedAt    DateTime?
  expiresAt     DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  artisan Artisan  @relation(fields: [artisanId], references: [id], onDelete: Restrict)
  workOrder WorkOrder? @relation("WorkOrderQuote")
  
  @@index([orderId])
  @@index([artisanId])
  @@index([status])
  @@index([overallScore])
}

model SLARecord {
  id          String   @id @default(cuid())
  workOrderId String   @unique
  artisanId   String
  deadline    DateTime
  completedAt DateTime?
  onTime      Boolean?
  delayHours  Int?
  penaltyCents Int     @default(0)
  bonusCents  Int      @default(0)
  reason      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  artisan   Artisan   @relation(fields: [artisanId], references: [id], onDelete: Restrict)
  
  @@index([artisanId])
  @@index([onTime])
}

model Payout {
  id              String   @id @default(cuid())
  artisanId       String
  stripeTransferId String?
  
  // Amount
  amountCents     Int
  currency         String   @default("EUR")
  feesCents        Int       @default(0)
  netAmountCents  Int
  
  // Period
  periodStart      DateTime
  periodEnd        DateTime
  workOrderIds     String[]
  
  // Status
  status           String   @default("pending") // pending, processing, paid, failed, cancelled
  paidAt           DateTime?
  failureReason    String?
  
  // Reserve (fraude/retours)
  reserveCents     Int       @default(0)
  reserveReleaseAt DateTime?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  artisan Artisan @relation(fields: [artisanId], references: [id], onDelete: Restrict)
  
  @@index([artisanId])
  @@index([status])
  @@index([periodStart])
  @@index([stripeTransferId])
}

// ========================================
// TRUST & SAFETY + ANALYTICS (Lot 6)
// ========================================

model ModerationRecord {
  id          String   @id @default(cuid())
  type        String // text, image, ai_generation
  content     String // Text or image URL
  context     Json? // userId, brandId, designId
  
  // Result
  approved    Boolean
  confidence  Float
  categories  String[]
  reason      String?
  action      String // allow, review, block
  
  createdAt   DateTime @default(now())
  
  @@index([type])
  @@index([approved])
  @@index([createdAt])
}

model IPClaim {
  id              String   @id @default(cuid())
  claimantName    String
  claimantEmail   String
  claimantType    String // copyright, trademark, patent, other
  designId        String
  description     String
  evidence        String[] // URLs
  
  // Review
  status          String   @default("pending") // pending, under_review, approved, rejected, resolved
  reviewedBy      String?
  reviewedAt      DateTime?
  resolution      String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([designId])
  @@index([status])
  @@index([createdAt])
}

model Experiment {
  id            String   @id @default(cuid())
  name          String
  description   String
  type          String // pricing, copy, prompt, variants, layout
  variants      Json // Array of { id, name, config, weight }
  status        String   @default("draft") // draft, running, paused, completed
  startDate     DateTime?
  endDate       DateTime?
  targetAudience Json? // brands, countries, userRoles
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  assignments   ExperimentAssignment[]
  conversions   Conversion[]
  
  @@index([status])
  @@index([type])
  @@index([startDate])
}

model ExperimentAssignment {
  id            String   @id @default(cuid())
  userId        String
  experimentId  String
  variantId     String
  assignedAt    DateTime @default(now())
  
  // Relations
  experiment    Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  
  @@unique([userId, experimentId])
  @@index([experimentId])
  @@index([variantId])
}

model Conversion {
  id            String   @id @default(cuid())
  userId        String?
  sessionId     String
  experimentId  String?
  variantId     String?
  eventType     String // signup, design_created, order_created, purchase
  value         Int? // Revenue in cents
  attribution   Json // AttributionData
  timestamp     DateTime @default(now())
  
  // Relations
  experiment    Experiment? @relation(fields: [experimentId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([sessionId])
  @@index([experimentId])
  @@index([eventType])
  @@index([timestamp])
}

model Attribution {
  id            String   @id @default(cuid())
  userId        String?
  sessionId     String
  source        String // direct, organic, paid, referral, email, social
  medium        String?
  campaign      String?
  term          String?
  content       String?
  referrer      String?
  landingPage   String
  device        Json
  location      Json?
  timestamp     DateTime @default(now())
  
  @@index([userId])
  @@index([sessionId])
  @@index([source])
  @@index([campaign])
  @@index([timestamp])
}

model FraudCheck {
  id                String   @id @default(cuid())
  userId            String?
  email             String?
  ipAddress         String?
  deviceFingerprint String?
  orderValue        Int?
  actionType        String // signup, login, order, payment
  
  // Result
  riskScore         Int // 0-100
  riskLevel         String // low, medium, high, critical
  reasons           String[]
  action            String // allow, review, block
  checks            Json // velocity, device, email, ip, value
  
  createdAt         DateTime @default(now())
  
  @@index([userId])
  @@index([email])
  @@index([ipAddress])
  @@index([riskLevel])
  @@index([createdAt])
}

// ========================================
// INDEXES FOR PERFORMANCE
// ========================================

// Note: Composite indexes are defined inline with models
