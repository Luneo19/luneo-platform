// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================

enum UserRole {
  CONSUMER
  BRAND_USER
  BRAND_ADMIN
  PLATFORM_ADMIN
  FABRICATOR
}

enum OrderStatus {
  CREATED
  PENDING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum DesignStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
}

enum BrandStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
  VERIFIED
}

enum WebhookEventType {
  ORDER_CREATED
  ORDER_UPDATED
  ORDER_PAID
  DESIGN_CREATED
  DESIGN_COMPLETED
  PRODUCT_UPDATED
}

enum ZoneType {
  TEXT
  IMAGE
  PATTERN
  COLOR
}

enum CustomizationEffect {
  NORMAL
  EMBOSSED
  ENGRAVED
  THREE_D
}

enum CustomizationStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

// ========================================
// ENUMS POUR SAAS PERSONNALISATION
// ========================================

enum SubscriptionPlan {
  FREE
  STARTER
  PROFESSIONAL
  BUSINESS
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum GenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}

enum CustomizationType {
  TEXT
  IMAGE
  COLOR
  PATTERN
  FONT
  SIZE
  POSITION
}

// ========================================
// ENUMS POUR ASSET HUB
// ========================================

enum AssetFileType {
  IMAGE
  VIDEO
  DOCUMENT
  MODEL_3D
  AUDIO
  OTHER
}

// ========================================
// ENUMS POUR PROJECTS
// ========================================

enum ProjectType {
  DESIGN
  CAMPAIGN
  COLLECTION
  TEMPLATE
  VIRTUAL_TRY_ON
  CUSTOMIZER
  CONFIGURATOR
  OTHER
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  DELETED
}

// ========================================
// ENUMS POUR INTÉGRITÉ DES DONNÉES (ENUM-01)
// ========================================

enum SyncLogStatus {
  SUCCESS
  FAILED
  PARTIAL
}

enum SyncLogType {
  PRODUCT
  ORDER
  INVENTORY
}

enum SyncDirection {
  IMPORT
  EXPORT
}

enum KycStatus {
  PENDING
  VERIFIED
  REJECTED
  SUSPENDED
}

enum WorkOrderStatus {
  ASSIGNED
  ACCEPTED
  IN_PROGRESS
  QC_PENDING
  QC_PASSED
  QC_FAILED
  SHIPPED
  COMPLETED
  CANCELLED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
}

enum WorkspaceEnvironment {
  DEVELOPMENT
  STAGING
  PRODUCTION
}

// ========================================
// ENUMS POUR CONFIGURATOR 3D
// ========================================

enum Configurator3DOptionType {
  COLOR
  TEXTURE
  MATERIAL
  SIZE
  TEXT
  IMAGE
  MODEL
}

enum Configurator3DSessionStatus {
  ACTIVE
  SAVED
  COMPLETED
  ABANDONED
  EXPIRED
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum WebhookEvent {
  DESIGN_CREATED
  DESIGN_UPDATED
  DESIGN_COMPLETED
  DESIGN_FAILED
  ORDER_CREATED
  ORDER_UPDATED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  TEST
  GENERATION_STARTED
  GENERATION_COMPLETED
  GENERATION_FAILED
  AR_VIEW
}

// ========================================
// INDUSTRY ADAPTIVE DASHBOARD ENUMS
// ========================================

enum ModulePriority {
  PRIMARY
  SECONDARY
  AVAILABLE
  HIDDEN
}

enum CompanySize {
  SOLO
  SMALL_2_10
  MEDIUM_11_50
  LARGE_51_200
  ENTERPRISE_200_PLUS
}

enum PrimaryUseCase {
  CUSTOMIZER
  DESIGN_AI
  VISUALIZATION_3D
  AR_TRYON
  PRINT_PRODUCTION
  ALL
}

enum OnboardingActionType {
  TUTORIAL
  SETUP_GUIDE
  TEMPLATE_IMPORT
  INTEGRATION_CONNECT
  SKIP
}

enum MarketplaceItemType {
  TEMPLATE
  DESIGN
  MODEL_3D
  TEXTURE
  ANIMATION
  PROMPT_PACK
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  REFUNDED
}

enum MarketplacePayoutStatus {
  PENDING
  COMPLETED
  FAILED
}

// ========================================
// MODELS
// ========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String? // Null for OAuth users
  firstName     String?
  lastName      String?
  avatar        String?
  role          UserRole  @default(CONSUMER)
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?

  // 2FA
  is2FAEnabled  Boolean  @default(false) @map("is_2fa_enabled")
  twoFASecret   String?  @map("two_fa_secret")
  temp2FASecret String?  @map("temp_2fa_secret")
  backupCodes   String[] @default([]) @map("backup_codes")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp

  // Notification preferences (email, marketing, order updates, security alerts)
  notificationPreferences Json?

  // Relations
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: SetNull)

  designs        Design[]
  orders         Order[]
  refreshTokens  RefreshToken[]
  customizations Customization[]
  notifications  Notification[]

  // OAuth
  oauthAccounts OAuthAccount[]

  // Audit & Safety
  auditLogs         AuditLog[]
  moderationRecords ModerationRecord[]

  // Quotas
  userQuota UserQuota?

  // Experiments
  experimentAssignments ExperimentAssignment[]

  // Marketplace
  artisan Artisan?

  // GDPR
  userConsents UserConsent[]

  // Crédits IA
  aiCredits          Int       @default(0) @map("ai_credits")
  aiCreditsPurchased Int       @default(0) @map("ai_credits_purchased")
  aiCreditsUsed      Int       @default(0) @map("ai_credits_used")
  lastCreditPurchase DateTime? @map("last_credit_purchase")

  creditTransactions CreditTransaction[]

  // Support & Monitoring
  tickets          Ticket[]         @relation("TicketUser")
  ticketMessages   TicketMessage[]  @relation("TicketMessages")
  assignedTickets  Ticket[]         @relation("AssignedTickets")
  ticketActivities TicketActivity[] @relation("TicketActivities")

  // AI Studio
  aiGenerations AIGeneration[]
  aiCollections AICollection[]

  // Collaboration
  sharedResourcesCreated SharedResource[] @relation("SharedResourcesCreated")
  comments               Comment[]

  // Collections & Team
  designCollections    DesignCollection[]
  collectionItemsAdded DesignCollectionItem[] @relation("CollectionItemsAdded")
  libraryFavorites     LibraryFavorite[]
  teamMembers          TeamMember[]
  teamInvitesSent      TeamInvite[]           @relation("TeamInvitesSent")
  teamMembersInvited   TeamMember[]           @relation("TeamInviter")
  cliparts             Clipart[]

  // Super Admin - Customer relation
  customer Customer?

  // ORION - Customer health (Super Admin)
  healthScore CustomerHealthScore?

  // Discount & Referral
  discountUsages      DiscountUsage[]
  referralsAsReferrer Referral[]      @relation("Referrer")
  referralsAsReferred Referral?       @relation("Referred")
  commissions         Commission[]
  withdrawals         Withdrawal[]
  userProfile         UserProfile?
  downloads          Download[]

  // Observability
  traces Trace[] @relation("UserTraces")

  // AR Collaboration
  arProjects           ARProject[]           @relation("UserARProjects")
  arProjectMemberships ARProjectMember[]     @relation("UserARProjectMemberships")
  arProjectComments    ARProjectComment[]    @relation("UserARProjectComments")

  // Shopping Cart
  carts Cart[] @relation("UserCart")

  // Knowledge Base
  knowledgeBaseArticles KnowledgeBaseArticle[] @relation("KBAuthor")

  // NPS
  npsResponses NPSResponse[] @relation("UserNPSResponses")

  @@index([email])
  @@index([brandId])
  @@index([role])
  @@index([aiCredits])
  @@index([deletedAt]) // Soft delete index for efficient queries on active users
  // Composite indexes for multi-tenant queries
  @@index([brandId, role])
  @@index([brandId, isActive])
  @@index([brandId, createdAt])
  @@index([lastLoginAt]) // Cache warming & active-session queries
}

model Download {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resourceId   String   @map("resource_id")
  resourceType String   @map("resource_type") // design, template, clipart, product
  fileUrl      String?  @map("file_url")
  fileSize     Int?     @map("file_size")
  format       String?
  downloadedAt DateTime @default(now()) @map("downloaded_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([userId, downloadedAt])
  @@index([resourceType])
  @@index([resourceId, resourceType])
  @@map("downloads")
}

model OAuthAccount {
  id           String    @id @default(cuid())
  provider     String // google, github, etc.
  providerId   String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // SEC-08: Token rotation et détection de réutilisation
  family    String    @default(cuid()) // Identifiant de chaîne de tokens
  usedAt    DateTime? // Null si pas encore utilisé, date si déjà consommé
  revokedAt DateTime? // Révoqué suite à détection de réutilisation

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([family])
}

model Brand {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  logo        String?
  industry    String?   // e.g. "jewelry", "watches", "glasses", "other"
  website     String?
  status      BrandStatus @default(PENDING_VERIFICATION)

  // KYC Fields
  companyName String?
  vatNumber   String?
  address     String?
  city        String?
  country     String?
  postalCode  String?
  phone       String?

  // Billing
  stripeCustomerId     String?
  stripeSubscriptionId String? // Stripe subscription ID
  plan                 String    @default("starter")
  planExpiresAt        DateTime?
  limits               Json? // Brand limits configuration

  // Budgets (for AI costs)
  aiCostLimitCents Int?      @default(500000) // 5000€ default limit
  aiCostUsedCents  Int       @default(0)
  aiCostResetAt    DateTime? // Monthly reset

  // Settings
  settings      Json? // Brand-specific settings (legacy - utiliser ClientSettings)
  webhookUrl    String?
  webhookSecret String?

  // NOUVEAU: Champs pour SaaS personnalisation
  subscriptionPlan      SubscriptionPlan   @default(FREE)
  subscriptionStatus    SubscriptionStatus @default(TRIALING)
  trialEndsAt           DateTime?
  monthlyGenerations    Int                @default(0)
  maxMonthlyGenerations Int                @default(100)
  maxProducts           Int                @default(5)
  arEnabled             Boolean            @default(false)
  whiteLabel            Boolean            @default(false)

  // Grace period & read-only (failed payment)
  gracePeriodEndsAt     DateTime?   // When grace period expires (null = no grace period)
  readOnlyMode          Boolean     @default(false) // If true, only billing/read endpoints allowed
  lastGraceReminderDay  Int?        // Last grace reminder sent: 0, 1, or 2 (for day 0, 1, 2)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  users                 User[]
  products              Product[]
  designs               Design[]
  orders                Order[]
  webhooks              Webhook[]
  webhookSubscriptions  WebhookSubscription[]
  apiKeys               ApiKey[]
  aiCosts               AICost[]
  ecommerceIntegrations EcommerceIntegration[]
  usageMetrics          UsageMetric[]
  customizations        Customization[]

  // Analytics Avancées
  analyticsEvents      AnalyticsEvent[]
  analyticsFunnels     AnalyticsFunnel[]
  analyticsCohorts     AnalyticsCohort[]
  analyticsSegments    AnalyticsSegment[]
  analyticsPredictions AnalyticsPrediction[]

  // AI Studio
  aiGenerations AIGeneration[]
  aiCollections AICollection[]

  // Collaboration
  sharedResources SharedResource[]

  // NOUVEAU: Relations SaaS personnalisation
  clientSettings ClientSettings?
  generations    Generation[]
  templates      Template[]
  invoices       Invoice[]

  // Collections & Team
  designCollections DesignCollection[]
  teamMembers       TeamMember[]
  teamInvites       TeamInvite[]
  cliparts          Clipart[]

  // Agents IA
  agentConversations AgentConversation[]

  // SSO Enterprise
  ssoConfigurations SSOConfiguration[]

  // Discounts
  discounts Discount[]

  // Print-on-Demand
  printOrders PrintOrder[]

  // Audit & Safety
  auditLogs         AuditLog[]
  moderationRecords ModerationRecord[]

  // Workspaces & Projects
  workspaces Workspace[]
  projects   Project[]

  // AR Collaboration
  arProjects ARProject[] @relation("BrandARProjects")

  // Observability
  traces Trace[] @relation("BrandTraces")

  // Feature Flags
  featureFlags FeatureFlag[] @relation("BrandFeatureFlags")

  // Marketplace (Phase 8 - templates & assets between brands)
  marketplaceItems    MarketplaceItem[]    @relation("MarketplaceSeller")
  marketplaceReviews  MarketplaceReview[]  @relation("MarketplaceReviewer")
  marketplacePurchases MarketplacePurchase[] @relation("MarketplaceBuyer")

  // Usage Records
  usageRecords UsageRecord[]

  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([slug])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([subscriptionPlan])
  @@index([subscriptionStatus])
  @@index([deletedAt])
  // DB-01: Index manquants sur champs date critiques
  @@index([trialEndsAt])
  @@index([planExpiresAt])
  @@index([subscriptionStatus, trialEndsAt])
  @@index([organizationId])
}

// ========================================
// MARKETPLACE (Phase 8 - templates & assets between brands)
// ========================================

model MarketplaceItem {
  id              String   @id @default(cuid())
  sellerId        String   // Brand ID of the seller
  seller          Brand    @relation("MarketplaceSeller", fields: [sellerId], references: [id], onDelete: Restrict)
  title           String
  description     String?  @db.Text
  type            MarketplaceItemType
  category        String?  // jewelry, watches, glasses, etc.
  tags            String[]
  price           Decimal  @db.Decimal(10, 2)  // 0 = free
  currency        String   @default("CHF")
  previewImages   String[]
  fileUrl         String?  // URL to the downloadable asset
  fileType        String?  // glb, png, json, etc.
  downloads       Int      @default(0)
  rating          Decimal? @db.Decimal(3, 2)
  reviewCount     Int      @default(0)
  isActive        Boolean  @default(true)
  isFeatured      Boolean  @default(false)
  metadata        Json?    // Additional info (dimensions, file size, etc.)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  reviews         MarketplaceReview[]
  purchases       MarketplacePurchase[]

  @@index([sellerId])
  @@index([type])
  @@index([category])
  @@index([isActive, isFeatured])
}

model MarketplaceReview {
  id        String   @id @default(cuid())
  itemId    String
  item      MarketplaceItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  buyerId   String   // Brand ID of the reviewer
  buyer     Brand    @relation("MarketplaceReviewer", fields: [buyerId], references: [id])
  rating    Int      // 1-5
  comment   String?  @db.Text
  createdAt DateTime @default(now())

  @@unique([itemId, buyerId])
  @@index([itemId])
  @@index([buyerId])
}

model MarketplacePurchase {
  id                 String                  @id @default(cuid())
  itemId             String
  item               MarketplaceItem         @relation(fields: [itemId], references: [id])
  buyerId            String                  // Brand ID of the buyer
  buyer              Brand                   @relation("MarketplaceBuyer", fields: [buyerId], references: [id])
  price              Decimal                 @db.Decimal(10, 2)
  currency           String                  @default("CHF")
  status             PurchaseStatus           @default(COMPLETED)
  commissionPercent  Int?                    // Platform commission % (from seller's plan)
  commissionCents    Int?                    // Platform commission amount in cents
  payoutScheduledAt  DateTime?                // When seller payout is due (createdAt + 7 days)
  payoutStatus       MarketplacePayoutStatus @default(PENDING)
  paidOutAt          DateTime?               // When Stripe transfer was completed
  createdAt          DateTime                @default(now())

  @@index([buyerId])
  @@index([itemId])
  @@index([payoutScheduledAt, payoutStatus])
}

// ========================================
// ORGANIZATION & INDUSTRY
// ========================================

model Organization {
  id                    String        @id @default(cuid())
  name                  String
  slug                  String        @unique
  industryId            String?
  industry              Industry?     @relation(fields: [industryId], references: [id])
  onboardingCompletedAt DateTime?
  onboardingCurrentStep Int           @default(0)
  companySize           CompanySize?
  primaryUseCase        PrimaryUseCase?
  businessGoals         Json?
  dashboardLayout       Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  brands                Brand[]
  onboardingProgress    OnboardingProgress[]
  dashboardPreferences  UserDashboardPreference[]

  @@index([slug])
  @@index([industryId])
}

model Industry {
  id          String   @id @default(cuid())
  slug        String   @unique
  labelFr     String
  labelEn     String
  icon        String
  accentColor String
  description String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizations   Organization[]
  moduleConfigs   IndustryModuleConfig[]
  widgetConfigs   IndustryWidgetConfig[]
  kpiConfigs      IndustryKpiConfig[]
  templates       IndustryTemplate[]
  terminology     IndustryTerminology[]
  onboardingSteps IndustryOnboarding[]

  @@index([slug])
  @@index([isActive, sortOrder])
}

model IndustryModuleConfig {
  id               String         @id @default(cuid())
  industryId       String
  industry         Industry       @relation(fields: [industryId], references: [id], onDelete: Cascade)
  moduleSlug       String
  priority         ModulePriority @default(AVAILABLE)
  sortOrder        Int            @default(0)
  isDefaultEnabled Boolean        @default(true)
  defaultSettings  Json?

  @@unique([industryId, moduleSlug])
  @@index([industryId])
}

model IndustryWidgetConfig {
  id               String  @id @default(cuid())
  industryId       String
  industry         Industry @relation(fields: [industryId], references: [id], onDelete: Cascade)
  widgetSlug       String
  position         Int     @default(0)
  gridColumn       Int     @default(1)
  gridRow          Int     @default(1)
  gridWidth        Int     @default(1)
  gridHeight       Int     @default(1)
  isDefaultVisible Boolean @default(true)

  @@unique([industryId, widgetSlug])
  @@index([industryId])
}

model IndustryKpiConfig {
  id                String  @id @default(cuid())
  industryId        String
  industry          Industry @relation(fields: [industryId], references: [id], onDelete: Cascade)
  kpiSlug           String
  labelFr           String
  labelEn           String
  icon              String
  sortOrder         Int     @default(0)
  isDefaultVisible  Boolean @default(true)
  calculationMethod String?

  @@unique([industryId, kpiSlug])
  @@index([industryId])
}

model IndustryTemplate {
  id            String  @id @default(cuid())
  industryId    String
  industry      Industry @relation(fields: [industryId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  thumbnailUrl  String?
  templateData  Json?
  productType   String?
  is3D          Boolean @default(false)
  modelUrl      String?
  sortOrder     Int     @default(0)

  @@index([industryId])
}

model IndustryTerminology {
  id            String  @id @default(cuid())
  industryId    String
  industry      Industry @relation(fields: [industryId], references: [id], onDelete: Cascade)
  genericTerm   String
  customTermFr  String
  customTermEn  String
  context       String  @default("all")

  @@unique([industryId, genericTerm, context])
  @@index([industryId])
}

model IndustryOnboarding {
  id            String              @id @default(cuid())
  industryId    String
  industry      Industry            @relation(fields: [industryId], references: [id], onDelete: Cascade)
  stepOrder     Int
  titleFr       String
  titleEn       String
  descriptionFr String?
  descriptionEn String?
  videoUrl      String?
  actionType    OnboardingActionType @default(TUTORIAL)
  actionPayload Json?

  @@unique([industryId, stepOrder])
  @@index([industryId])
}

model OnboardingProgress {
  id                 String    @id @default(cuid())
  organizationId     String
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId             String
  step1Profile       Json?
  step1CompletedAt   DateTime?
  step2Industry      String?
  step2CompletedAt   DateTime?
  step3UseCases      Json?
  step3CompletedAt   DateTime?
  step4Goals         Json?
  step4CompletedAt   DateTime?
  step5Integrations  Json?
  step5CompletedAt   DateTime?
  completedAt        DateTime?
  skippedAt          DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model UserDashboardPreference {
  id                String       @id @default(cuid())
  userId            String
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  widgetOverrides   Json?
  sidebarOrder      Json?
  pinnedModules     Json?
  lastVisitedModule String?
  dashboardTheme    String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

// ========================================
// AR COLLABORATION
// ========================================

model ARProject {
  id          String   @id @default(cuid())
  name        String
  description String?
  thumbnail   String?
  brandId     String
  ownerId     String
  status      String   @default("active")
  settings    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  brand    Brand    @relation("BrandARProjects", fields: [brandId], references: [id], onDelete: Cascade)
  owner    User     @relation("UserARProjects", fields: [ownerId], references: [id], onDelete: Cascade)
  members  ARProjectMember[]
  comments ARProjectComment[]

  @@index([brandId])
  @@index([ownerId])
}

model ARProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      String   @default("viewer")
  joinedAt  DateTime @default(now())

  project ARProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user   User      @relation("UserARProjectMemberships", fields: [userId], references: [id])

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model ARProjectComment {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project ARProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user   User      @relation("UserARProjectComments", fields: [userId], references: [id])

  @@index([projectId])
  @@index([userId])
}

// ========================================
// CLIENT SETTINGS (SaaS Personnalisation)
// ========================================

model ClientSettings {
  id      String @id @default(cuid())
  brandId String @unique
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  // UI Customization
  primaryColor   String @default("#000000")
  secondaryColor String @default("#ffffff")
  fontFamily     String @default("Inter")
  borderRadius   Int    @default(8)

  // AI Settings
  defaultAiProvider String  @default("openai")
  customApiKey      String?
  defaultQuality    String  @default("standard")
  defaultStyle      String  @default("realistic")

  // AR Settings
  arTrackingType String @default("face")
  arQuality      String @default("medium")

  // Notifications
  emailNotifications Boolean @default(true)
  webhookEnabled     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
}

model Product {
  id          String  @id @default(cuid())
  name        String
  slug        String // NOUVEAU: Slug pour URL
  description String?
  sku         String?
  price       Decimal @db.Decimal(10, 2)
  currency    String  @default("EUR")

  // Images
  images       String[] // Array of image URLs
  baseAssetUrl String? // Base asset URL for rendering
  baseImage    String? // NOUVEAU: Base image pour génération
  baseImageUrl String? // NOUVEAU: Base image URL
  thumbnailUrl String? // NOUVEAU: Thumbnail URL

  // 3D Model
  model3dUrl  String?
  modelConfig Json? // 3D model configuration

  // Customization & Product Engine
  customizationOptions Json? // Available customization options
  rulesJson            Json? // Product Rules Engine configuration

  // Manufacturing & Cost
  baseCostCents     Int? // Base manufacturing cost in cents
  laborCostCents    Int? // Labor cost in cents
  overheadCostCents Int? // Overhead cost in cents
  materialOptions   Json? // Available materials with pricing
  finishOptions     Json? // Available finishes with pricing
  productionTime    Int? // Estimated production time in hours

  // NOUVEAU: Champs pour génération IA
  promptTemplate    String? // Template de prompt pour génération
  negativePrompt    String? // Negative prompt
  aiProvider        String  @default("openai") // Provider IA par défaut
  generationQuality String  @default("standard") // standard, hd
  outputFormat      String  @default("png") // png, jpg, webp
  outputWidth       Int     @default(1024)
  outputHeight      Int     @default(1024)

  // NOUVEAU: Champs AR
  arEnabled      Boolean @default(true)
  arTrackingType String  @default("surface") // face, body, hand, surface
  arScale        Float   @default(1.0)
  arOffset       Json? // Offset 3D { x, y, z }

  // Status
  isActive Boolean       @default(true)
  isPublic Boolean       @default(true)
  status   ProductStatus @default(DRAFT) // NOUVEAU: Status explicite
  category String? // NOUVEAU: Catégorie produit
  tags     String[] // NOUVEAU: Tags

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime? // NOUVEAU: Date de publication
  deletedAt   DateTime? // Soft delete timestamp

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  designs         Design[]
  orders          Order[]          @relation("OrderProduct") // Relation nommée
  orderItems      OrderItem[]      @relation("OrderItemProduct") // NOUVEAU
  productMappings ProductMapping[]
  zones           Zone[]
  customizations  Customization[]

  // NOUVEAU: Lien vers DesignSpec
  specs DesignSpec[] @relation("ProductSpecs") // NOUVEAU

  // NOUVEAU: Customizable Areas (Zakeke-like)
  customizableAreas CustomizableArea[]

  // NOUVEAU: Relations SaaS personnalisation
  customizationZones CustomizationZone[] // Zones de personnalisation pour widget
  generations        Generation[] // Générations depuis widget
  templates          Template[] // Templates de prompts

  // Try-On relations
  tryOnMappings    TryOnProductMapping[]
  tryOnScreenshots TryOnScreenshot[]

  // 3D configurator
  product3DConfig Product3DConfiguration?

  // Variants & Inventory
  variants ProductVariant[]

  @@unique([brandId, slug]) // NOUVEAU: Unique par brand
  @@index([brandId])
  @@index([isActive])
  @@index([isPublic])
  @@index([brandId, isActive]) // NOUVEAU: Composite
  @@index([status])
  @@index([deletedAt]) // Soft delete index for efficient queries on active products
  // Composite indexes for filtered queries
  @@index([brandId, status])
  @@index([brandId, createdAt])
  @@index([brandId, category])
}

model ProductVariant {
  id                String   @id @default(cuid())
  productId         String
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku               String?
  name              String   // e.g. "Or Rose 18K - Taille 52"
  attributes        Json     // { color: "Or Rose", size: "52", material: "18K" }
  price             Decimal? @db.Decimal(10, 2) // null = use product price
  compareAtPrice    Decimal? @db.Decimal(10, 2)
  stock             Int      @default(0)
  lowStockThreshold Int      @default(5)
  images            String[]
  weight            Decimal? @db.Decimal(10, 2)
  barcode           String?
  isActive          Boolean  @default(true)
  position          Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([productId])
  @@index([sku])
}

model Product3DConfiguration {
  id             String   @id @default(cuid())
  productId      String   @unique
  modelUrl       String?
  textureUrl     String?
  materialType   String   @default("standard")
  environmentMap String?
  lightingPreset String   @default("studio")
  cameraPosition Json?
  cameraTarget   Json?
  customZones    Json?
  renderSettings Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

// ========================================
// CUSTOMIZATION ZONE (SaaS Personnalisation)
// ========================================

model CustomizationZone {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  name String
  type CustomizationType

  positionX Float
  positionY Float
  width     Float
  height    Float
  rotation  Float @default(0)

  maxLength     Int?
  allowedChars  String?
  allowedFonts  String[]
  allowedColors String[]
  minSize       Int?
  maxSize       Int?

  defaultValue String?
  defaultFont  String?
  defaultColor String?
  defaultSize  Int?

  renderStyle String @default("engraved")

  order    Int     @default(0)
  required Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([productId, order])
}

// ========================================
// TEMPLATE (SaaS Personnalisation)
// ========================================

model Template {
  id        String   @id @default(cuid())
  brandId   String
  brand     Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  name        String
  description String?

  promptTemplate String
  negativePrompt String?
  variables      Json

  aiProvider String @default("openai")
  model      String @default("dall-e-3")
  quality    String @default("standard")
  style      String @default("natural")

  exampleOutputs String[]

  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([productId])
  @@index([brandId, isActive])
  @@index([brandId, createdAt])
}

model Design {
  id          String  @id @default(cuid())
  name        String?
  description String?

  // Generation
  prompt      String
  promptHash  String? // For caching
  options     Json // Generation options
  optionsJson Json? // Legacy field for compatibility
  status      DesignStatus @default(PENDING)

  // Results
  previewUrl String? // Low-res preview
  highResUrl String? // High-res result
  imageUrl   String? // Main image URL
  renderUrl  String? // Render URL
  metadata   Json? // AI generation metadata

  // NOUVEAU: Widget Editor Data (Zakeke-like)
  canvasWidth           Int? // Canvas width in pixels
  canvasHeight          Int? // Canvas height in pixels
  canvasBackgroundColor String? @default("#ffffff") // Background color
  designData            Json? // Full design data from widget (DesignData type)

  // Cost tracking
  costCents Int     @default(0)
  provider  String? // AI provider used

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  deletedAt   DateTime? // Soft delete timestamp

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // NOUVEAU: Lien vers DesignSpec
  specId String?
  spec   DesignSpec? @relation(fields: [specId], references: [id], onDelete: SetNull)

  orders         Order[]         @relation("OrderDesign") // Relation nommée pour éviter conflit
  orderItems     OrderItem[]     @relation("OrderItemDesign") // NOUVEAU
  assets         Asset[]
  customizations Customization[]
  versions       DesignVersion[] // Historique des versions
  RenderResult   RenderResult[]

  // NOUVEAU: Layers relation
  layers DesignLayer[]

  // Collections
  collectionItems DesignCollectionItem[]

  // IP Claims / Blocking
  isBlocked        Boolean   @default(false)
  blockedReason    String?
  blockedAt        DateTime?
  blockedByClaimId String?
  blockedByClaim  IPClaim?  @relation("BlockedDesigns", fields: [blockedByClaimId], references: [id], onDelete: SetNull)

  // Trust & Safety
  moderationRecords ModerationRecord[]
  ipClaims          IPClaim[]

  // DNA
  designDNA DesignDNA?

  @@index([userId])
  @@index([brandId])
  @@index([productId])
  @@index([status])
  @@index([promptHash])
  @@index([createdAt])
  @@index([specId]) // NOUVEAU
  @@index([brandId, status]) // NOUVEAU: Composite
  @@index([brandId, status, createdAt]) // Composite for filtered + sorted queries
  @@index([isBlocked])
  // DB-01: Index manquant
  @@index([completedAt])
  // DB-01: Composite index for status-based queries with date sorting
  @@index([status, createdAt])
  @@index([deletedAt]) // Soft delete index for efficient queries on active designs
}

// ========================================
// DESIGN VERSION (Versioning)
// ========================================

model DesignVersion {
  id       String @id @default(cuid())
  designId String
  design   Design @relation(fields: [designId], references: [id], onDelete: Cascade)

  // Version metadata
  versionNumber Int // Version number (1, 2, 3, ...)
  name          String? // Optional name for this version
  description   String? // Optional description

  // Snapshot of design state at version creation
  prompt     String
  options    Json // Generation options snapshot
  previewUrl String? // Preview URL snapshot
  highResUrl String? // High-res URL snapshot
  imageUrl   String? // Main image URL snapshot
  renderUrl  String? // Render URL snapshot
  metadata   Json? // AI generation metadata snapshot
  designData Json? // Widget editor data snapshot

  // Version type
  isAutoSave Boolean @default(false) // Auto-saved version or manual
  snapshot   Json? // Full snapshot of design state

  // Tracking
  createdBy String? // User ID who created this version
  createdAt DateTime @default(now())

  // DB-02: Contrainte unique pour éviter les doublons de version
  @@unique([designId, versionNumber])
  @@index([designId])
  @@index([designId, versionNumber])
  @@index([designId, isAutoSave])
  @@index([createdBy])
}

model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique
  status      OrderStatus @default(CREATED)

  // Customer info
  customerEmail   String
  customerName    String?
  customerPhone   String?
  userEmail       String? // For GDPR anonymization
  shippingAddress Json?

  // Pricing
  subtotalCents Int
  taxCents      Int    @default(0)
  shippingCents Int    @default(0)
  totalCents    Int
  currency      String @default("EUR")

  // Payment
  paymentStatus   PaymentStatus @default(PENDING)
  stripeSessionId String?
  stripePaymentId String?

  // Shipping
  trackingNumber      String?
  trackingCarrier     String?
  trackingUrl         String?
  productionBundleUrl String? // URL to production bundle
  shippedAt          DateTime?
  deliveredAt         DateTime?
  estimatedDelivery   DateTime?

  // Notes
  notes    String?
  metadata Json? // Additional order metadata

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  paidAt    DateTime?
  deletedAt DateTime? // Soft delete timestamp (GDPR compliance)

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  // NOUVEAU: Multi-items support
  items OrderItem[] // NOUVEAU

  // DEPRECATED: Garder pour backward compatibility (rendre nullable)
  designId  String? // DEPRECATED: Utiliser OrderItem.designId
  design    Design?  @relation("OrderDesign", fields: [designId], references: [id], onDelete: Cascade)
  productId String? // DEPRECATED: Utiliser OrderItem.productId
  product   Product? @relation("OrderProduct", fields: [productId], references: [id], onDelete: Cascade)

  customizations Customization[]
  workOrder      WorkOrder?
  quotes         Quote[]

  // Discount & Referral
  discountUsages DiscountUsage[]
  commissions    Commission[]

  // Commission tracking
  commissionPercent Float? @default(0)
  commissionCents   Int?   @default(0)
  discountId        String?
  discount          Discount? @relation(fields: [discountId], references: [id], onDelete: SetNull)

  // Print-on-Demand
  printOrders PrintOrder[]

  // Production & Quality
  productionStatus ProductionStatus?
  qualityReport    QualityReport?

  @@index([userId])
  @@index([brandId])
  @@index([designId]) // Garder pour backward compat
  @@index([productId]) // Garder pour backward compat
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
  @@index([brandId, status]) // NOUVEAU: Composite pour performance
  @@index([brandId, createdAt]) // NOUVEAU: Composite pour pagination
  @@index([brandId, status, createdAt]) // Composite for filtered + sorted queries
  // DB-01: Index manquants sur champs date et paiement
  @@index([paymentStatus])
  @@index([paidAt])
  @@index([shippedAt])
  @@index([paymentStatus, createdAt])
  @@index([discountId])
  @@index([deletedAt]) // Soft delete index for efficient queries on active orders
  // DB-01: Composite index for status-based queries with date sorting
  @@index([status, createdAt])
  // Composite for brand payment queries
  @@index([brandId, paymentStatus])
  // PRODUCTION: Composite for user order history (sorted by date)
  @@index([userId, createdAt])
}

// ========================================
// PRINT ORDER (Print-on-Demand)
// ========================================
model PrintOrder {
  id              String   @id @default(cuid())
  orderId         String   // Reference to the main Order
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  brandId         String
  brand           Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  provider        String   // 'printful', 'printify', 'gelato'
  providerOrderId String?  // Provider's order ID
  status          String   @default("pending") // pending, processing, shipped, delivered, cancelled
  trackingNumber  String?
  trackingUrl     String?
  items           Json     // Order items details
  shippingAddress Json     // Shipping address
  providerCost    Int      @default(0) // Cost from provider in cents
  luneoMargin     Int      @default(0) // Luneo's margin in cents
  brandMargin     Int      @default(0) // Brand's margin in cents
  totalPrice      Int      @default(0) // Total price charged to customer
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orderId])
  @@index([brandId])
  @@index([providerOrderId])
  @@index([status])
}

// ========================================
// ORDER ITEM (Multi-items support)
// ========================================

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  productId  String
  designId   String? // Nullable si pas de design
  snapshotId String? // Lien vers Snapshot (immuable)
  quantity   Int     @default(1)
  priceCents Int // Prix unitaire au moment de la commande (snapshot)
  totalCents Int // priceCents * quantity
  metadata   Json? // Customization options, line item properties Shopify, etc.

  // Relations
  order    Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product  Product   @relation("OrderItemProduct", fields: [productId], references: [id], onDelete: Restrict)
  design   Design?   @relation("OrderItemDesign", fields: [designId], references: [id], onDelete: SetNull)
  snapshot Snapshot? @relation("SnapshotOrderItems", fields: [snapshotId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // DB-02: Contrainte unique pour éviter les doublons d'item dans une commande
  // Note: designId est nullable, donc la contrainte permet plusieurs items sans design
  @@unique([orderId, productId, designId])
  @@index([orderId])
  @@index([productId])
  @@index([designId])
  @@index([snapshotId])
  @@index([orderId, productId])
}

model WebhookSubscription {
  id        String   @id @default(cuid())
  brandId   String
  brand     Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  event     String   // 'new_design', 'new_order', 'new_subscription', 'design_updated'
  targetUrl String   // Zapier's webhook URL
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId, event])
  @@index([isActive])
}

model ApiKey {
  id          String    @id @default(cuid())
  name        String
  key         String    @unique
  secret      String? // Hashed secret for API key authentication
  scopes      String[] // Array of permissions (legacy)
  permissions String[] // Array of permissions (new)
  rateLimit   Json? // Rate limiting configuration
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([key])
  @@index([isActive])
  @@index([brandId, isActive])
}

model AICost {
  id        String   @id @default(cuid())
  provider  String // openai, replicate, etc.
  model     String // gpt-4, stable-diffusion, etc.
  costCents Int
  tokens    Int? // For text models
  duration  Int? // Processing time in seconds
  createdAt DateTime @default(now())

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([provider])
  @@index([createdAt])
  @@index([brandId, createdAt])
  @@index([brandId, provider])
}

model UserQuota {
  id             String   @id @default(cuid())
  monthlyLimit   Int      @default(100) // Monthly design generations
  monthlyUsed    Int      @default(0)
  costLimitCents Int      @default(5000) // 50€ monthly limit
  costUsedCents  Int      @default(0)
  resetAt        DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([resetAt])
}

model Webhook {
  id      String @id @default(cuid())
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  name   String
  url    String // Webhook URL
  secret String // Secret pour signature

  events   WebhookEvent[] // NOUVEAU: Events supportés
  isActive Boolean        @default(true)

  lastCalledAt   DateTime?
  lastStatusCode Int?
  failureCount   Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  webhookLogs WebhookLog[]
  // Note: Cannot index on array field 'events' in Prisma

  @@index([brandId])
  @@index([isActive])
  @@index([brandId, isActive])
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

// ========================================
// AI PROMPT TEMPLATES
// ========================================

model PromptTemplate {
  id          String   @id @default(cuid())
  name        String
  version     Int      @default(1)
  occasion    String? // 'birth', 'engagement', 'mourning', 'friendship', etc.
  style       String? // 'minimal', 'baroque', 'art-deco', etc.
  prompt      String // Template avec variables {{variable}}
  variables   Json? // Variables disponibles et leurs descriptions
  constraints Json? // Contraintes production (serti, gravure, etc.)
  brandKit    Json? // Brand kit integration (couleurs, ton, interdits)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, version])
  @@index([occasion])
  @@index([style])
  @@index([isActive])
}

// ========================================
// DESIGN DNA (Embeddings + Parameters)
// ========================================

model DesignDNA {
  id             String   @id @default(cuid())
  designId       String   @unique
  design         Design   @relation(fields: [designId], references: [id], onDelete: Cascade)
  story          String? // Story/intention utilisateur
  tags           String[] // Tags normalisés
  embedding      Json? // Vector embedding (pgvector)
  parameters     Json? // Paramètres retenus (ce qui a été cliqué)
  conversionData Json? // Données de conversion (clicks, time, etc.)
  productionData Json? // Données production (QC, défauts, etc.)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([designId])
}

// ========================================
// DESIGN SPEC (Versionné, Déterministe)
// ========================================

model DesignSpec {
  id          String @id @default(cuid())
  specVersion String @default("1.0.0") // Semantic versioning
  specHash    String @unique // SHA256 du spec canonique
  spec        Json // JSON Schema validé, format canonique
  productId   String

  // Zone inputs (normalisés)
  zoneInputs Json // { zoneId: { text, font, color, size, effect, orientation, ... } }

  // Metadata
  metadata Json? // Provenance (widget, shopify, api), userAgent, sessionId, etc.

  // Relations
  product Product @relation("ProductSpecs", fields: [productId], references: [id], onDelete: Cascade)

  snapshots Snapshot[]
  designs   Design[] // Designs générés depuis ce spec

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([specHash])
  @@index([productId])
  @@index([specVersion])
  @@index([createdAt])
  @@index([productId, specHash])
}

// ========================================
// SNAPSHOT (Immuable, Point-in-Time)
// ========================================

model Snapshot {
  id       String @id @default(cuid())
  specId   String // Lien vers DesignSpec
  specHash String // Dupliqué pour queries rapides (index)
  specData Json // Dupliqué pour immutabilité (snapshot du spec au moment T)

  // Previews & Exports
  previewUrl   String? // 2D preview (PNG/WebP)
  preview3dUrl String? // 3D preview (GLTF viewer)
  thumbnailUrl String? // Thumbnail 200x200

  // Production Assets
  productionBundleUrl String? // ZIP avec SVG/DXF/PDF
  arModelUrl          String? // USDZ pour AR
  gltfModelUrl        String? // GLTF pour 3D viewer

  // Asset Versions (pour traçabilité)
  assetVersions Json? // [{ url, format, size, hash, createdAt, version }]

  // Validation & Lock
  isValidated Boolean   @default(false)
  validatedBy String? // User ID
  validatedAt DateTime?
  isLocked    Boolean   @default(false) // Lock pour empêcher modifications
  lockedAt    DateTime?

  // Audit
  createdBy  String? // User ID ou 'widget' ou 'api'
  provenance Json? // { source: 'widget'|'shopify'|'api', sessionId, ipAddress, userAgent, widgetVersion }

  // Relations
  spec           DesignSpec      @relation(fields: [specId], references: [id], onDelete: Restrict)
  orderItems     OrderItem[]     @relation("SnapshotOrderItems") // Orders qui utilisent ce snapshot
  workOrders     WorkOrder[] // WorkOrders liés
  customizations Customization[] // Customizations liées
  renderResults  RenderResult[] // Renders liés

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // Ne devrait jamais changer (immuable)

  @@unique([specHash, validatedAt]) // Un snapshot par specHash validé (si validé)
  @@index([specId])
  @@index([specHash])
  @@index([isValidated])
  @@index([isLocked])
  @@index([createdAt])
  @@index([validatedAt])
  @@index([specHash, isValidated])
}

// ========================================
// WORKERS & PRODUCTION MODELS
// ========================================

model RenderResult {
  id           String  @id @default(cuid())
  renderId     String  @unique
  type         String // '2d', '3d', 'preview', 'ar', 'manufacturing'
  status       String // 'pending', 'processing', 'success', 'failed'
  url          String?
  thumbnailUrl String?
  metadata     Json?

  // NOUVEAU: Relations Prisma (au lieu de renderId string loose)
  snapshotId      String?
  snapshot        Snapshot?      @relation(fields: [snapshotId], references: [id], onDelete: SetNull)
  designId        String?
  design          Design?        @relation(fields: [designId], references: [id], onDelete: SetNull)
  customizationId String?
  customization   Customization? @relation(fields: [customizationId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([renderId])
  @@index([type])
  @@index([status])
  @@index([snapshotId]) // NOUVEAU
  @@index([designId]) // NOUVEAU
  @@index([customizationId]) // NOUVEAU
  @@index([type, status]) // NOUVEAU: Composite
}

model RenderProgress {
  id         String   @id @default(cuid())
  renderId   String   @unique
  stage      String
  percentage Int
  message    String
  timestamp  DateTime @default(now())

  @@index([renderId])
}

model RenderError {
  id         String   @id @default(cuid())
  renderId   String
  error      String
  occurredAt DateTime @default(now())

  @@index([renderId])
}

model ExportResult {
  id        String   @id @default(cuid())
  renderId  String   @unique
  format    String // 'gltf', 'usdz', 'png', etc.
  url       String
  size      Int
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([renderId])
  @@index([format])
}

model ProductionStatus {
  id           String   @id @default(cuid())
  orderId      String   @unique
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  currentStage String
  message      String
  percentage   Int
  lastUpdated  DateTime @default(now())

  @@index([orderId])
}

model QualityReport {
  id              String   @id @default(cuid())
  orderId         String   @unique
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  overallScore    Float
  issues          String[]
  recommendations String[]
  passed          Boolean
  createdAt       DateTime @default(now())

  @@index([orderId])
}

model BatchRenderProgress {
  id          String   @id @default(cuid())
  batchId     String   @unique
  completed   Int
  total       Int
  percentage  Int
  results     Json?
  lastUpdated DateTime @default(now())

  @@index([batchId])
}

// ========================================
// E-COMMERCE INTEGRATIONS
// ========================================

model EcommerceIntegration {
  id           String    @id @default(cuid())
  brandId      String
  platform     String // 'shopify', 'woocommerce', 'magento'
  shopDomain   String
  accessToken  String?
  refreshToken String?
  config       Json
  status       String    @default("active")
  lastSyncAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  brand           Brand            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  productMappings ProductMapping[]
  syncLogs        SyncLog[]

  @@index([brandId])
  @@index([platform])
  @@index([shopDomain])
  @@index([status])
  @@index([brandId, status])
  @@index([brandId, platform])
}

model ProductMapping {
  id                String   @id @default(cuid())
  integrationId     String
  luneoProductId    String
  externalProductId String
  externalSku       String
  syncStatus        String   @default("synced")
  lastSyncedAt      DateTime @default(now())
  metadata          Json?

  // Relations
  integration EcommerceIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  product     Product              @relation(fields: [luneoProductId], references: [id], onDelete: Cascade)

  @@unique([integrationId, externalProductId])
  @@index([integrationId])
  @@index([luneoProductId])
  @@index([externalProductId])
  @@index([externalSku])
}

model SyncLog {
  id             String        @id @default(cuid())
  integrationId  String
  type           SyncLogType // ENUM-01: Utilise enum au lieu de string
  direction      SyncDirection // ENUM-01: Utilise enum au lieu de string
  status         SyncLogStatus // ENUM-01: Utilise enum au lieu de string
  itemsProcessed Int           @default(0)
  itemsFailed    Int           @default(0)
  errors         Json?
  duration       Int // in milliseconds
  createdAt      DateTime      @default(now())

  // Relations
  integration EcommerceIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model WebhookLog {
  id        String   @id @default(cuid())
  webhookId String
  webhook   Webhook? @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  eventId       String?
  eventRelation Event?  @relation(fields: [eventId], references: [id], onDelete: SetNull)

  event      String
  payload    Json
  statusCode Int?
  response   String?
  error      String?
  duration   Int? // Durée en ms

  createdAt DateTime @default(now())

  @@index([webhookId])
  @@index([eventId])
  @@index([event])
  @@index([createdAt])
}

// ========================================
// GENERATION (SaaS Personnalisation - Widget)
// ========================================

model Generation {
  id        String  @id @default(cuid())
  brandId   String
  brand     Brand   @relation(fields: [brandId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  publicId  String  @unique @default(cuid())
  sessionId String?

  customizations Json
  userPrompt     String?
  finalPrompt    String
  negativePrompt String?

  aiProvider String
  model      String
  quality    String

  status       GenerationStatus @default(PENDING)
  outputUrl    String?
  thumbnailUrl String?
  arModelUrl   String?

  aiResponse     Json?
  processingTime Int?
  tokensUsed     Int?
  cost           Decimal? @db.Decimal(10, 6)

  errorMessage String?
  errorCode    String?
  retryCount   Int     @default(0)

  ipAddress String?
  userAgent String?
  referrer  String?

  viewedInAr    Boolean @default(false)
  arViewCount   Int     @default(0)
  downloadCount Int     @default(0)
  sharedCount   Int     @default(0)

  createdAt   DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime?

  @@index([brandId])
  @@index([productId])
  @@index([publicId])
  @@index([status])
  @@index([createdAt])
  // DB-01: Index manquants sur champs date
  @@index([completedAt])
  @@index([expiresAt])
  @@index([status, completedAt])
  @@index([sessionId])
  @@index([brandId, status])
}

// ========================================
// INVOICE (Billing)
// ========================================

model Invoice {
  id              String @id @default(cuid())
  brandId         String
  brand           Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)
  stripeInvoiceId String @unique

  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("eur")
  status   String

  periodStart DateTime
  periodEnd   DateTime

  pdfUrl String?

  createdAt DateTime  @default(now())
  paidAt    DateTime?

  @@index([brandId])
  @@index([stripeInvoiceId])
  @@index([status])
  @@index([createdAt])
  @@index([brandId, status])
  @@index([brandId, createdAt])
}

// ========================================
// USAGE RECORD (Billing)
// ========================================

model UsageRecord {
  id      String @id @default(cuid())
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  type  String // 'generation', 'ar_view', 'api_call', etc.
  count Int    @default(1)

  metadata Json?

  recordedAt DateTime @default(now())

  @@index([brandId])
  @@index([recordedAt])
  @@index([type])
  @@index([brandId, type, recordedAt])
}

// ========================================
// ADDITIONAL MODELS
// ========================================

model Asset {
  id        String   @id @default(cuid())
  designId  String
  url       String
  type      String // 'image', 'model', 'texture', 'video'
  format    String
  size      Int
  width     Int?
  height    Int?
  metadata  Json?
  createdAt DateTime @default(now())

  // Relations
  design Design @relation(fields: [designId], references: [id], onDelete: Cascade)

  @@index([designId])
  @@index([type])
}

model AuditLog {
  id           String   @id @default(cuid())
  eventType    String
  userId       String?
  brandId      String?
  resourceType String
  resourceId   String
  action       String
  success      Boolean  @default(true)
  metadata     Json?
  timestamp    DateTime @default(now())
  ipAddress    String?
  userAgent    String?

  // Relations
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)
  brand Brand? @relation(fields: [brandId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([brandId])
  @@index([eventType])
  @@index([resourceType])
  @@index([resourceId])
  @@index([timestamp])
  @@index([success])
  @@index([brandId, eventType, timestamp])
}

model UserConsent {
  id          String   @id @default(cuid())
  userId      String
  consentType String // 'privacy', 'marketing', 'analytics'
  granted     Boolean  @default(false)
  recordedAt  DateTime @default(now())
  ipAddress   String?
  userAgent   String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([consentType])
  @@index([recordedAt])
}

// ========================================
// DISCOUNT & PROMO CODES
// ========================================

enum DiscountType {
  PERCENTAGE
  FIXED
}

model Discount {
  id               String       @id @default(cuid())
  code             String       @unique
  type             DiscountType
  value            Int // Pourcentage (0-100) ou montant fixe en centimes
  minPurchaseCents Int?         @map("min_purchase_cents")
  maxDiscountCents Int?         @map("max_discount_cents")
  validFrom        DateTime     @map("valid_from")
  validUntil       DateTime     @map("valid_until")
  usageLimit       Int?         @map("usage_limit")
  usageCount       Int          @default(0) @map("usage_count")
  isActive         Boolean      @default(true) @map("is_active")
  brandId          String?
  brand            Brand?       @relation(fields: [brandId], references: [id], onDelete: SetNull)
  description      String?
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  discountUsages DiscountUsage[]
  orders Order[]

  @@index([code])
  @@index([brandId])
  @@index([isActive])
  @@index([validFrom, validUntil])
  @@map("discounts")
}

model DiscountUsage {
  id         String   @id @default(cuid())
  discountId String   @map("discount_id")
  discount   Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  userId     String?  @map("user_id")
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  orderId    String?  @map("order_id")
  order      Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  usedAt     DateTime @default(now()) @map("used_at")

  @@index([discountId])
  @@index([userId])
  @@index([orderId])
  @@map("discount_usages")
}

// ========================================
// REFERRAL PROGRAM
// ========================================

enum ReferralStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model Referral {
  id             String         @id @default(cuid())
  referrerId     String         @map("referrer_id")
  referrer       User           @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referredUserId String?        @unique @map("referred_user_id")
  referredUser   User?          @relation("Referred", fields: [referredUserId], references: [id], onDelete: SetNull)
  referralCode   String         @map("referral_code")
  status         ReferralStatus @default(PENDING)
  createdAt      DateTime       @default(now()) @map("created_at")
  completedAt    DateTime?      @map("completed_at")

  commissions Commission[]

  @@index([referrerId])
  @@index([referredUserId])
  @@index([referralCode])
  @@index([status])
  @@map("referrals")
}

model Commission {
  id          String           @id @default(cuid())
  referralId  String           @map("referral_id")
  referral    Referral         @relation(fields: [referralId], references: [id], onDelete: Cascade)
  userId      String           @map("user_id")
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderId     String?          @map("order_id")
  order       Order?           @relation(fields: [orderId], references: [id], onDelete: SetNull)
  amountCents Int              @map("amount_cents")
  percentage  Float            @default(0.1) // 10% par défaut
  status      CommissionStatus @default(PENDING)
  approvedAt  DateTime?        @map("approved_at")
  paidAt      DateTime?        @map("paid_at")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  @@index([referralId])
  @@index([userId])
  @@index([orderId])
  @@index([status])
  @@map("commissions")
}

model Withdrawal {
  id            String           @id @default(cuid())
  userId        String           @map("user_id")
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  amountCents   Int              @map("amount_cents")
  iban          String
  status        WithdrawalStatus @default(PENDING)
  processedAt   DateTime?        @map("processed_at")
  failureReason String?          @map("failure_reason")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("withdrawals")
}

model ReferralApplication {
  id         String    @id @default(cuid())
  email      String    @unique
  status     String    @default("pending") // 'pending', 'approved', 'rejected'
  appliedAt  DateTime  @default(now()) @map("applied_at")
  reviewedAt DateTime? @map("reviewed_at")

  @@index([email])
  @@index([status])
  @@map("referral_applications")
}

// ========================================
// USER PROFILE (for IBAN and additional info)
// ========================================

model UserProfile {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  iban      String?
  bic       String?
  bankName  String?  @map("bank_name")
  address   Json? // Full address as JSON
  phone     String?
  website   String?
  timezone  String?  @default("Europe/Paris")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_profiles")
}

model UsageMetric {
  id        String   @id @default(cuid())
  brandId   String
  metric    String // 'designs_created', 'renders_2d', 'api_calls', etc.
  value     Int
  unit      String // 'count', 'bytes', 'seconds'
  timestamp DateTime @default(now())
  metadata  Json?

  // Relations
  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([metric])
  @@index([timestamp])
  @@index([brandId, metric, timestamp])
}

// ========================================
// WIDGET EDITOR MODELS (Zakeke-like)
// ========================================

model CustomizableArea {
  id          String  @id @default(cuid())
  productId   String
  name        String
  description String?

  // Position & Dimensions (in mm or pixels)
  x      Float @default(0)
  y      Float @default(0)
  width  Float
  height Float

  // Constraints
  minWidth    Float?
  maxWidth    Float?
  minHeight   Float?
  maxHeight   Float?
  aspectRatio Float? // Lock aspect ratio

  // Allowed layer types
  allowedLayerTypes String[] @default(["text", "image", "shape"]) // ["text", "image", "shape", "clipart"]

  // Text constraints (if text allowed)
  maxTextLength    Int?
  allowedFonts     String[]
  defaultFont      String?
  defaultFontSize  Int?
  allowedFontSizes Int[] // [12, 14, 16, 18, 24, 32, 48, 72]

  // Image constraints (if image allowed)
  maxImageSize   Int? // Max file size in bytes
  allowedFormats String[] @default(["png", "jpg", "jpeg", "svg", "webp"])
  minImageWidth  Int?
  minImageHeight Int?
  maxImageWidth  Int?
  maxImageHeight Int?

  // Shape constraints (if shape allowed)
  allowedShapes String[] @default(["rectangle", "circle", "triangle", "polygon", "star"])

  // Color constraints
  allowedColors String[] // Hex colors
  defaultColor  String?  @default("#000000")

  // Display settings
  isRequired   Boolean @default(false)
  isActive     Boolean @default(true)
  displayOrder Int     @default(0)

  // Metadata
  metadata Json? // Additional configuration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([isActive])
  @@index([displayOrder])
  @@index([productId, isActive])
}

model DesignLayer {
  id       String @id @default(cuid())
  designId String
  type     String // "text", "image", "shape", "clipart"

  // Position & Transform
  x        Float @default(0)
  y        Float @default(0)
  rotation Float @default(0) // degrees
  scaleX   Float @default(1)
  scaleY   Float @default(1)
  opacity  Float @default(1) // 0-1

  // Visibility & Lock
  visible Boolean @default(true)
  locked  Boolean @default(false)

  // Layer-specific data (JSON for flexibility)
  data Json // TextLayerData, ImageLayerData, ShapeLayerData, etc.

  // Z-index (order in layer stack)
  zIndex Int @default(0)

  // Metadata
  metadata Json? // Additional layer metadata

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  design Design @relation(fields: [designId], references: [id], onDelete: Cascade)

  @@index([designId])
  @@index([type])
  @@index([visible])
  @@index([zIndex])
  @@index([designId, zIndex])
}

// ========================================
// PRODUCT CUSTOMIZATION MODELS
// ========================================

model Zone {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        ZoneType @default(TEXT)

  // 3D Position & UV Mapping
  positionX Float
  positionY Float
  positionZ Float
  rotationX Float @default(0)
  rotationY Float @default(0)
  rotationZ Float @default(0)
  scaleX    Float @default(1)
  scaleY    Float @default(1)
  scaleZ    Float @default(1)

  // UV Mapping coordinates
  uvMinU Float // Minimum U coordinate (0-1)
  uvMaxU Float // Maximum U coordinate (0-1)
  uvMinV Float // Minimum V coordinate (0-1)
  uvMaxV Float // Maximum V coordinate (0-1)

  // Customization Options
  maxChars        Int? // Maximum characters for text zones
  allowedFonts    String[] // Allowed fonts for text zones
  defaultFont     String? // Default font
  defaultColor    String? // Default color (hex)
  defaultSize     Int? // Default text size
  allowedColors   String[] // Allowed colors
  allowedPatterns String[] // Allowed patterns

  // Constraints
  isRequired Boolean @default(false)
  isActive   Boolean @default(true)
  order      Int     @default(0) // Display order

  // Metadata
  metadata Json? // Additional configuration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  customizations Customization[]

  // DB-02: Contrainte unique pour éviter les zones avec le même nom sur un produit
  @@unique([productId, name])
  @@index([productId])
  @@index([type])
  @@index([isActive])
  @@index([order])
}

// ========================================
// NOTIFICATIONS
// ========================================

model Notification {
  id          String    @id @default(cuid())
  userId      String
  type        String // 'info', 'success', 'warning', 'error', 'order', 'customization', 'system'
  title       String
  message     String
  data        Json? // Additional data
  read        Boolean   @default(false)
  readAt      DateTime?
  actionUrl   String? // URL for action button
  actionLabel String? // Label for action button
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([type])
  @@index([createdAt])
  // DB-01: Composite index for user notification queries
  @@index([userId, read])
}

model Customization {
  id          String  @id @default(cuid())
  name        String?
  description String?

  // User Input
  prompt     String // User's text input
  promptHash String? // Hash for caching

  // Configuration
  zoneId String
  zone   Zone   @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Options used
  font        String?
  color       String?
  size        Int?
  effect      CustomizationEffect @default(ENGRAVED)
  orientation String? // horizontal, vertical, curved
  options     Json? // Additional options

  // Status & Generation
  status CustomizationStatus @default(PENDING)
  jobId  String? // AI engine job ID

  // Generated Assets
  textureUrl String? // Generated texture URL
  modelUrl   String? // Modified 3D model URL (.glb)
  previewUrl String? // Preview image URL
  highResUrl String? // High resolution render URL
  arModelUrl String? // AR-optimized model URL (.usdz)

  // Metadata
  metadata     Json? // Generation metadata (processing time, etc.)
  errorMessage String? // Error message if failed
  retryCount   Int     @default(0)

  // Cost tracking
  costCents        Int  @default(0)
  processingTimeMs Int? // Processing time in milliseconds

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: SetNull)

  designId String? // Link to Design if part of a design
  design   Design? @relation(fields: [designId], references: [id], onDelete: SetNull)

  orderId String? // Link to Order if purchased
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // NOUVEAU: Lien vers Snapshot
  snapshotId   String?
  snapshot     Snapshot?      @relation(fields: [snapshotId], references: [id], onDelete: SetNull)
  RenderResult RenderResult[]

  @@index([userId])
  @@index([productId])
  @@index([zoneId])
  @@index([brandId])
  @@index([status])
  @@index([promptHash])
  @@index([jobId])
  @@index([createdAt])
  @@index([designId])
  @@index([orderId])
  @@index([snapshotId]) // NOUVEAU
  // DB-01: Composite index for status-based queries with date sorting
  @@index([status, createdAt])
}

// ========================================
// OUTBOX PATTERN (Event Sourcing)
// ========================================

model OutboxEvent {
  id          String    @id @default(cuid())
  eventType   String // Event type (design.completed, order.paid, etc.)
  payload     Json // Event payload
  status      String    @default("pending") // pending, published, failed
  attempts    Int       @default(0)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status, createdAt])
  @@index([eventType])
}

// ========================================
// MARKETPLACE (Lot 4)
// ========================================

model Artisan {
  id           String  @id @default(cuid())
  userId       String  @unique
  businessName String
  legalName    String?
  taxId        String?
  address      Json?
  phone        String?
  email        String?
  website      String?

  // KYC/KYB - ENUM-01: Utilise enum au lieu de string
  kycStatus     KycStatus @default(PENDING)
  kycVerifiedAt DateTime?
  kycDocuments  Json?

  // Stripe Connect
  stripeAccountId     String?
  stripeAccountStatus String?
  onboardingCompleted Boolean @default(false)

  // Capacités
  maxVolume       Int @default(10)
  currentLoad     Int @default(0)
  averageLeadTime Int @default(7) // jours
  minOrderValue   Int @default(0) // cents

  // Matériaux supportés
  supportedMaterials  String[]
  supportedTechniques String[]
  supportedZones      String[]

  // Qualité & Performance
  qualityScore       Float @default(5.0)
  totalOrders        Int   @default(0)
  completedOrders    Int   @default(0)
  onTimeDeliveryRate Float @default(1.0)
  defectRate         Float @default(0.0)
  returnRate         Float @default(0.0)

  // SLA
  slaLevel     String @default("standard") // basic, standard, premium, enterprise
  slaPenalties Json   @default("{}")
  slaBonuses   Json   @default("{}")

  // Status
  status           String    @default("active") // active, inactive, suspended, quarantined
  quarantineReason String?
  quarantineUntil  DateTime?

  // Settings
  settings       Json   @default("{}")
  payoutSchedule String @default("weekly") // daily, weekly, biweekly, monthly

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  capabilities ArtisanCapability[]
  workOrders   WorkOrder[]
  quotes       Quote[]
  slaRecords   SLARecord[]
  payouts      Payout[]

  @@index([kycStatus])
  @@index([status])
  @@index([qualityScore])
  @@index([stripeAccountId])
}

model ArtisanCapability {
  id             String   @id @default(cuid())
  artisanId      String
  material       String
  technique      String
  maxSize        Float?
  minSize        Float?
  leadTime       Int? // jours
  costMultiplier Float    @default(1.0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  artisan Artisan @relation(fields: [artisanId], references: [id], onDelete: Cascade)

  @@index([artisanId])
  @@index([material])
  @@index([technique])
}

model WorkOrder {
  id        String  @id @default(cuid())
  orderId   String  @unique
  artisanId String
  quoteId   String? @unique

  // Routing
  routingScore  Float?
  routingReason String?
  selectedAt    DateTime?

  // Production - ENUM-01: Utilise enum au lieu de string
  status              WorkOrderStatus @default(ASSIGNED)
  acceptedAt          DateTime?
  startedAt           DateTime?
  estimatedCompletion DateTime?
  completedAt         DateTime?

  // SLA
  slaDeadline     DateTime?
  slaMet          Boolean?
  slaPenaltyCents Int       @default(0)
  slaBonusCents   Int       @default(0)

  // Financial
  payoutAmountCents Int?
  commissionCents   Int?
  payoutStatus      String  @default("pending") // pending, processing, paid, failed, cancelled
  payoutId          String?

  // QC
  qcScore    Float?
  qcPassed   Boolean?
  qcIssues   String[]
  qcReportId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order     Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  artisan   Artisan    @relation(fields: [artisanId], references: [id], onDelete: Restrict)
  quote     Quote?     @relation("WorkOrderQuote", fields: [quoteId], references: [id], onDelete: SetNull)
  slaRecord SLARecord?

  // NOUVEAU: Lien vers Snapshot (pour production bundle)
  snapshotId String?
  snapshot   Snapshot? @relation(fields: [snapshotId], references: [id], onDelete: SetNull)

  @@index([artisanId])
  @@index([status])
  @@index([slaDeadline])
  @@index([payoutStatus])
  @@index([snapshotId]) // NOUVEAU
  // DB-01: Index manquants sur champs date
  @@index([acceptedAt])
  @@index([completedAt])
  @@index([status, acceptedAt])
}

model Quote {
  id        String @id @default(cuid())
  orderId   String
  artisanId String

  // Pricing
  priceCents Int
  leadTime   Int // jours
  breakdown  Json

  // Scoring
  qualityScore  Float?
  costScore     Float?
  leadTimeScore Float?
  distanceScore Float?
  overallScore  Float?

  // Status
  status     String    @default("pending") // pending, selected, rejected, expired
  selectedAt DateTime?
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order     Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  artisan   Artisan    @relation(fields: [artisanId], references: [id], onDelete: Restrict)
  workOrder WorkOrder? @relation("WorkOrderQuote")

  @@index([orderId])
  @@index([artisanId])
  @@index([status])
  @@index([overallScore])
}

model SLARecord {
  id           String    @id @default(cuid())
  workOrderId  String    @unique
  artisanId    String
  deadline     DateTime
  completedAt  DateTime?
  onTime       Boolean?
  delayHours   Int?
  penaltyCents Int       @default(0)
  bonusCents   Int       @default(0)
  reason       String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  artisan   Artisan   @relation(fields: [artisanId], references: [id], onDelete: Restrict)

  @@index([artisanId])
  @@index([onTime])
}

model Payout {
  id               String  @id @default(cuid())
  artisanId        String
  stripeTransferId String?

  // Amount
  amountCents    Int
  currency       String @default("EUR")
  feesCents      Int    @default(0)
  netAmountCents Int

  // Period
  periodStart  DateTime
  periodEnd    DateTime
  workOrderIds String[]

  // Status - ENUM-01: Utilise enum au lieu de string
  status        PayoutStatus @default(PENDING)
  paidAt        DateTime?
  failureReason String?

  // Reserve (fraude/retours)
  reserveCents     Int       @default(0)
  reserveReleaseAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  artisan Artisan @relation(fields: [artisanId], references: [id], onDelete: Restrict)

  @@index([artisanId])
  @@index([status])
  @@index([periodStart])
  @@index([stripeTransferId])
}

// ========================================
// TRUST & SAFETY + ANALYTICS (Lot 6)
// ========================================

model ModerationRecord {
  id       String  @id @default(cuid())
  type     String // text, image, ai_generation
  content  String // Text or image URL
  userId   String?
  brandId  String?
  designId String?
  context  Json? // Additional context metadata

  // Result
  approved   Boolean
  confidence Float
  categories String[]
  reason     String?
  action     String // allow, review, block

  createdAt DateTime @default(now())

  // Relations
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  brand  Brand?  @relation(fields: [brandId], references: [id], onDelete: SetNull)
  design Design? @relation(fields: [designId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([approved])
  @@index([createdAt])
  @@index([userId])
  @@index([brandId])
  @@index([designId])
}

model IPClaim {
  id            String   @id @default(cuid())
  claimantName  String
  claimantEmail String
  claimantType  String // copyright, trademark, patent, other
  designId      String
  description   String
  evidence      String[] // URLs

  // Review
  status     String    @default("pending") // pending, under_review, approved, rejected, resolved
  reviewedBy String?
  reviewedAt DateTime?
  resolution String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  design Design @relation(fields: [designId], references: [id], onDelete: Cascade)
  blockedDesigns Design[] @relation("BlockedDesigns")

  @@index([designId])
  @@index([status])
  @@index([createdAt])
}

model Experiment {
  id             String    @id @default(cuid())
  name           String
  description    String
  type           String // pricing, copy, prompt, variants, layout
  variants       Json // Array of { id, name, config, weight }
  status         String    @default("draft") // draft, running, paused, completed
  startDate      DateTime?
  endDate        DateTime?
  targetAudience Json? // brands, countries, userRoles

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignments ExperimentAssignment[]
  conversions Conversion[]

  @@index([status])
  @@index([type])
  @@index([startDate])
}

model ExperimentAssignment {
  id           String   @id @default(cuid())
  userId       String
  experimentId String
  variantId    String
  assignedAt   DateTime @default(now())

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  experiment Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@unique([userId, experimentId])
  @@index([experimentId])
  @@index([variantId])
}

model Conversion {
  id           String   @id @default(cuid())
  userId       String?
  sessionId    String
  experimentId String?
  variantId    String?
  eventType    String // signup, design_created, order_created, purchase
  value        Int? // Revenue in cents
  attribution  Json // AttributionData
  timestamp    DateTime @default(now())

  // Relations
  experiment Experiment? @relation(fields: [experimentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([sessionId])
  @@index([experimentId])
  @@index([eventType])
  @@index([timestamp])
}

model Attribution {
  id          String   @id @default(cuid())
  userId      String?
  sessionId   String
  source      String // direct, organic, paid, referral, email, social
  medium      String?
  campaign    String?
  term        String?
  content     String?
  referrer    String?
  landingPage String
  device      Json
  location    Json?
  timestamp   DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([source])
  @@index([campaign])
  @@index([timestamp])
}

model FraudCheck {
  id                String  @id @default(cuid())
  userId            String?
  email             String?
  ipAddress         String?
  deviceFingerprint String?
  orderValue        Int?
  actionType        String // signup, login, order, payment

  // Result
  riskScore Int // 0-100
  riskLevel String // low, medium, high, critical
  reasons   String[]
  action    String // allow, review, block
  checks    Json // velocity, device, email, ip, value

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([email])
  @@index([ipAddress])
  @@index([riskLevel])
  @@index([createdAt])
}

// ========================================
// CREDITS SYSTEM
// ========================================

model CreditPack {
  id            String   @id @default(cuid())
  name          String
  credits       Int
  priceCents    Int      @map("price_cents")
  stripePriceId String?  @map("stripe_price_id")
  isActive      Boolean  @default(true) @map("is_active")
  isFeatured    Boolean  @default(false) @map("is_featured")
  savings       Int? // Percentage savings vs base pack
  badge         String? // "Best Value", "Most Popular", etc.
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  transactions CreditTransaction[]

  @@index([isActive])
  @@index([isFeatured])
  @@index([stripePriceId])
  @@map("CreditPack")
}

model CreditTransaction {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  packId          String?   @map("pack_id")
  amount          Int // Positive = purchase, Negative = usage
  balanceBefore   Int       @map("balance_before")
  balanceAfter    Int       @map("balance_after")
  type            String // 'purchase', 'usage', 'refund', 'bonus', 'expiration', 'monthly_refill'
  source          String? // '/api/ai/generate', 'admin', 'stripe_webhook'
  metadata        Json? // Additional data (endpoint, cost, model, duration, etc.)
  stripeSessionId String?   @map("stripe_session_id")
  stripePaymentId String?   @map("stripe_payment_id")
  expiresAt       DateTime? @map("expires_at") // Add-on credits expire after 12 months; plan refills have null
  expiredAt       DateTime? @map("expired_at") // When this transaction was marked expired (balance adjusted)
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  pack CreditPack? @relation(fields: [packId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([stripeSessionId])
  @@index([packId])
  @@index([expiresAt])
  @@index([expiredAt])
  // PRODUCTION: Composite for user credit history (sorted by date)
  @@index([userId, createdAt])
  @@map("CreditTransaction")
}

// ========================================
// MONITORING SYSTEM - Enterprise Grade
// ========================================

enum AlertSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  SUPPRESSED
}

enum ServiceHealthStatus {
  HEALTHY
  DEGRADED
  UNHEALTHY
  UNKNOWN
}

enum MetricType {
  COUNTER
  GAUGE
  HISTOGRAM
  SUMMARY
}

model MonitoringMetric {
  id        String   @id @default(cuid())
  service   String // database, cache, storage, email, payments, api
  metric    String // cpu_usage, memory_usage, request_count, error_rate
  value     Float
  unit      String? // ms, %, bytes, count
  labels    Json? // Additional metadata (endpoint, method, status, etc.)
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([service])
  @@index([metric])
  @@index([timestamp])
  @@index([service, metric, timestamp])
  @@map("MonitoringMetric")
}

model ServiceHealth {
  id           String              @id @default(cuid())
  service      String              @unique // database, cache, storage, email, payments
  status       ServiceHealthStatus @default(UNKNOWN)
  latency      Int? // milliseconds
  lastCheck    DateTime            @default(now())
  lastSuccess  DateTime?
  failureCount Int                 @default(0)
  message      String?
  metadata     Json? // Additional service info
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([service])
  @@index([status])
  @@index([lastCheck])
  @@map("ServiceHealth")
}

model Alert {
  id             String        @id @default(cuid())
  severity       AlertSeverity @default(WARNING)
  status         AlertStatus   @default(ACTIVE)
  title          String
  message        String
  service        String? // Which service triggered this
  metric         String? // Which metric triggered this
  threshold      Float? // Threshold that was exceeded
  currentValue   Float? // Current value when alert triggered
  acknowledgedBy String? // User ID who acknowledged
  acknowledgedAt DateTime?
  resolvedBy     String? // User ID who resolved
  resolvedAt     DateTime?
  resolvedReason String?
  metadata       Json? // Additional alert data
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([severity])
  @@index([status])
  @@index([service])
  @@index([createdAt])
  @@index([status, severity])
  @@map("Alert")
}

model AlertRule {
  id            String        @id @default(cuid())
  name          String
  description   String?
  service       String
  metric        String
  condition     String // gt, lt, eq, gte, lte
  threshold     Float
  severity      AlertSeverity @default(WARNING)
  enabled       Boolean       @default(true)
  cooldown      Int           @default(300) // seconds
  lastTriggered DateTime?
  triggerCount  Int           @default(0)
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([service, metric])
  @@index([enabled])
  @@map("AlertRule")
}

model WebVital {
  id         String   @id @default(cuid())
  userId     String?
  sessionId  String?
  page       String
  metric     String // LCP, FID, CLS, TTFB, FCP
  value      Float
  rating     String? // good, needs-improvement, poor
  device     Json? // Device info
  connection Json? // Connection info
  timestamp  DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([metric])
  @@index([timestamp])
  @@index([page, metric, timestamp])
  @@map("WebVital")
}

// ========================================
// SUPPORT SYSTEM - Enterprise Grade
// ========================================

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
  CANCELLED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  BILLING
  TECHNICAL
  ACCOUNT
  FEATURE_REQUEST
  BUG
  INTEGRATION
  OTHER
}

enum MessageType {
  USER
  AGENT
  SYSTEM
  INTERNAL
}

model Ticket {
  id           String         @id @default(cuid())
  ticketNumber String         @unique // TKT-XXXXX
  subject      String
  description  String
  status       TicketStatus   @default(OPEN)
  priority     TicketPriority @default(MEDIUM)
  category     TicketCategory @default(TECHNICAL)

  // Relations
  userId       String
  user         User      @relation("TicketUser", fields: [userId], references: [id], onDelete: Cascade)
  assignedTo   String? // User ID of assigned agent
  assignedUser User?     @relation("AssignedTickets", fields: [assignedTo], references: [id], onDelete: SetNull)
  assignedAt   DateTime?

  // Metadata
  tags            String[]
  metadata        Json? // Additional ticket data
  firstResponseAt DateTime? // Time to first response
  resolvedAt      DateTime?
  closedAt        DateTime?

  // CSAT (Customer Satisfaction)
  csatRating      Int?      // 1-5 rating
  csatComment     String?   // Optional feedback comment
  csatSubmittedAt DateTime? // When CSAT was submitted

  // Relations
  messages    TicketMessage[]
  attachments TicketAttachment[]
  activities  TicketActivity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([assignedTo])
  @@index([ticketNumber])
  @@index([createdAt])
  @@index([status, priority])
  // DB-01: Index manquants sur champs date
  @@index([resolvedAt])
  @@index([closedAt])
  @@index([firstResponseAt])
  // DB-01: Composite index for user ticket queries
  @@index([userId, status])
  @@map("Ticket")
}

model TicketMessage {
  id         String      @id @default(cuid())
  ticketId   String
  ticket     Ticket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  type       MessageType @default(USER)
  content    String
  userId     String? // User who sent the message
  user       User?       @relation("TicketMessages", fields: [userId], references: [id], onDelete: SetNull)
  isInternal Boolean     @default(false) // Internal note (not visible to user)
  isRead     Boolean     @default(false)
  readAt     DateTime?

  // Relations
  attachments TicketAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
  @@index([type])
  @@map("TicketMessage")
}

model TicketAttachment {
  id         String   @id @default(cuid())
  ticketId   String?
  messageId  String?
  fileName   String
  fileUrl    String
  fileSize   Int // bytes
  mimeType   String
  uploadedBy String // User ID
  createdAt  DateTime @default(now())

  ticket  Ticket?        @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  message TicketMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([messageId])
  @@index([uploadedBy])
  @@map("TicketAttachment")
}

model TicketActivity {
  id        String   @id @default(cuid())
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  action    String // created, status_changed, assigned, priority_changed, etc.
  userId    String? // User who performed the action
  user      User?    @relation("TicketActivities", fields: [userId], references: [id], onDelete: SetNull)
  oldValue  String?
  newValue  String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
  @@map("TicketActivity")
}

model KnowledgeBaseArticle {
  id            String    @id @default(cuid())
  title         String
  slug          String    @unique
  content       String // Markdown content
  excerpt       String?
  category      String
  tags          String[]
  isPublished   Boolean   @default(false)
  isFeatured    Boolean   @default(false)
  views         Int       @default(0)
  helpful       Int       @default(0)
  notHelpful    Int       @default(0)
  authorId      String
  author        User      @relation("KBAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  lastUpdatedBy String?
  publishedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([category])
  @@index([isPublished])
  @@index([isFeatured])
  @@index([slug])
  @@index([createdAt])
  @@index([authorId])
  @@map("KnowledgeBaseArticle")
}

// ========================================
// ANALYTICS AVANCÉES
// ========================================

model AnalyticsEvent {
  id         String   @id @default(cuid())
  eventType  String // 'page_view', 'conversion', 'funnel_step', 'user_action', etc.
  userId     String?
  sessionId  String?
  properties Json // Données événement (flexible pour différents types d'événements)
  timestamp  DateTime @default(now())

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([eventType, timestamp])
  @@index([userId, timestamp])
  @@index([brandId, timestamp])
  @@index([sessionId, timestamp])
  @@index([brandId, eventType, timestamp])
  @@index([timestamp])
  @@map("AnalyticsEvent")
}

model AnalyticsFunnel {
  id          String  @id @default(cuid())
  name        String
  description String?
  steps       Json // Configuration des étapes [{ name, eventType, order }]
  isActive    Boolean @default(true)

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([isActive])
  @@index([brandId, isActive])
  @@map("AnalyticsFunnel")
}

model AnalyticsCohort {
  id         String   @id @default(cuid())
  cohortDate DateTime // Date d'acquisition de la cohorte
  period     Int // Période de rétention (7, 30, 90, 180, 365 jours)
  retention  Float // Taux de rétention (0-100)
  revenue    Float // Revenus générés par la cohorte
  userCount  Int // Nombre d'utilisateurs dans la cohorte

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([brandId, cohortDate, period])
  @@index([brandId, cohortDate])
  @@index([brandId, period])
  @@index([cohortDate])
  @@index([period])
  @@map("AnalyticsCohort")
}

model AnalyticsSegment {
  id          String  @id @default(cuid())
  name        String
  description String?
  criteria    Json // Critères de segmentation (flexible)
  userCount   Int     @default(0)
  isActive    Boolean @default(true)

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([isActive])
  @@index([brandId, isActive])
  @@map("AnalyticsSegment")
}

model AnalyticsPrediction {
  id         String @id @default(cuid())
  type       String // 'revenue', 'conversion', 'churn', 'ltv', etc.
  value      Float // Valeur prédite
  confidence Float // Niveau de confiance (0-1)
  period     String // '7d', '30d', '90d', '1y'
  metadata   Json? // Métadonnées supplémentaires (facteurs, modèles ML, etc.)

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([brandId, type, createdAt])
  @@index([brandId, type])
  @@index([type, period])
  @@index([createdAt])
  @@map("AnalyticsPrediction")
}

// ========================================
// AI STUDIO - GÉNÉRATIONS
// ========================================

enum AIGenerationType {
  IMAGE_2D
  MODEL_3D
  ANIMATION
  TEMPLATE
}

enum AIGenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model AIGeneration {
  id             String             @id @default(cuid())
  type           AIGenerationType
  prompt         String
  negativePrompt String?
  model          String // 'stable-diffusion-xl', 'dall-e-3', 'midjourney-v6', etc.
  provider       String // 'openai', 'replicate', 'stability', 'custom'
  parameters     Json // Paramètres de génération (steps, guidance, seed, etc.)
  status         AIGenerationStatus @default(PENDING)
  resultUrl      String? // URL du résultat final
  thumbnailUrl   String? // URL de la miniature
  credits        Int                @default(0) // Crédits utilisés
  costCents      Int                @default(0) // Coût en centimes
  duration       Int? // Temps de génération en secondes
  quality        Float? // Score de qualité 0-100 (si disponible)
  error          String? // Message d'erreur si échec

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  // Versioning
  parentGenerationId String? // Pour les variantes
  parentGeneration   AIGeneration?  @relation("AIGenerationVersions", fields: [parentGenerationId], references: [id], onDelete: SetNull)
  versions           AIGeneration[] @relation("AIGenerationVersions")
  aiVersions         AIVersion[] // Versions détaillées

  // Collections
  collections AICollectionGeneration[]

  createdAt   DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete timestamp (user data cleanup)

  @@index([userId, createdAt])
  @@index([brandId, createdAt])
  @@index([brandId, type, status])
  @@index([type, status])
  @@index([status])
  @@index([model])
  @@index([parentGenerationId])
  @@index([userId, status])
  @@index([createdAt])
  @@index([deletedAt]) // Soft delete index for efficient queries on active generations
  @@map("AIGeneration")
}

model AIVersion {
  id           String       @id @default(cuid())
  generationId String
  generation   AIGeneration @relation(fields: [generationId], references: [id], onDelete: Cascade)
  version      Int // Numéro de version (1, 2, 3, etc.)
  prompt       String // Prompt utilisé pour cette version
  parameters   Json // Paramètres utilisés
  resultUrl    String // URL du résultat
  quality      Float? // Score de qualité
  credits      Int // Crédits utilisés
  createdAt    DateTime     @default(now())

  @@unique([generationId, version])
  @@index([generationId])
  @@map("AIVersion")
}

model AICollection {
  id          String  @id @default(cuid())
  name        String
  description String?
  isShared    Boolean @default(false)

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  generations AICollectionGeneration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([brandId])
  @@index([isShared])
  @@map("AICollection")
}

model AICollectionGeneration {
  id           String       @id @default(cuid())
  collectionId String
  collection   AICollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  generationId String
  generation   AIGeneration @relation(fields: [generationId], references: [id], onDelete: Cascade)
  addedAt      DateTime     @default(now())

  @@unique([collectionId, generationId])
  @@index([collectionId])
  @@index([generationId])
  @@map("AICollectionGeneration")
}

// ========================================
// COLLABORATION
// ========================================

enum ResourceType {
  ANALYTICS_REPORT
  AI_GENERATION
  DESIGN
  PRODUCT
  ORDER
  CUSTOMIZATION
}

model SharedResource {
  id           String       @id @default(cuid())
  resourceType ResourceType
  resourceId   String // ID de la ressource partagée
  sharedWith   String[] // IDs des utilisateurs avec qui c'est partagé
  permissions  Json // Permissions par utilisateur { userId: ['view', 'edit', 'delete'] }
  isPublic     Boolean      @default(false) // Partage public (lien)
  publicToken  String?      @unique // Token pour accès public

  // Relations
  createdBy     String
  createdByUser User   @relation("SharedResourcesCreated", fields: [createdBy], references: [id], onDelete: Cascade)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  comments Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceType, resourceId])
  @@index([createdBy])
  @@index([brandId])
  @@index([brandId, resourceType])
  @@index([isPublic, publicToken])
  @@index([publicToken])
  @@map("SharedResource")
}

model Comment {
  id           String       @id @default(cuid())
  resourceType ResourceType
  resourceId   String
  content      String
  parentId     String? // Pour les réponses aux commentaires
  parent       Comment?     @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies      Comment[]    @relation("CommentReplies")

  // Relations
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  sharedResourceId String?
  sharedResource   SharedResource? @relation(fields: [sharedResourceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceType, resourceId])
  @@index([authorId])
  @@index([parentId])
  @@index([sharedResourceId])
  @@index([resourceType, resourceId, createdAt])
  @@map("Comment")
}

// ========================================
// RELATIONS ADDITIONNELLES
// ========================================

// Add relations to User model
// Add to User model:
//   tickets            Ticket[]
//   ticketMessages     TicketMessage[]
//   assignedTickets     Ticket[] @relation("AssignedTickets")
//   aiGenerations      AIGeneration[]
//   aiCollections       AICollection[]
//   sharedResourcesCreated SharedResource[] @relation("SharedResourcesCreated")
//   comments           Comment[]

// ========================================
// COLLECTIONS & FAVORITES
// ========================================

model DesignCollection {
  id          String   @id @default(cuid())
  userId      String
  brandId     String
  name        String
  description String?
  isPublic    Boolean  @default(false)
  coverImage  String?
  itemCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand Brand                  @relation(fields: [brandId], references: [id], onDelete: Cascade)
  items DesignCollectionItem[]

  @@index([userId])
  @@index([brandId])
  @@index([isPublic])
  @@index([brandId, isPublic])
  @@index([brandId, createdAt])
  @@map("DesignCollection")
}

model DesignCollectionItem {
  id           String   @id @default(cuid())
  collectionId String
  designId     String
  notes        String?
  addedBy      String
  order        Int      @default(0)
  createdAt    DateTime @default(now())

  // Relations
  collection  DesignCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  design      Design           @relation(fields: [designId], references: [id], onDelete: Cascade)
  addedByUser User             @relation("CollectionItemsAdded", fields: [addedBy], references: [id], onDelete: Cascade)

  @@unique([collectionId, designId])
  @@index([collectionId])
  @@index([designId])
  @@map("DesignCollectionItem")
}

model LibraryFavorite {
  id           String   @id @default(cuid())
  userId       String
  resourceId   String
  resourceType String // 'template', 'clipart', 'design', etc.
  createdAt    DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceId, resourceType])
  @@index([userId])
  @@index([resourceType])
  @@map("LibraryFavorite")
}

model Clipart {
  id            String   @id @default(cuid())
  userId        String?
  brandId       String?
  name          String
  description   String?
  category      String
  tags          String[]
  url           String
  thumbnailUrl  String?
  width         Int?
  height        Int?
  fileSize      Int?
  isPublic      Boolean  @default(false)
  downloadCount Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)
  brand Brand? @relation(fields: [brandId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([brandId])
  @@index([category])
  @@index([isPublic])
  @@index([brandId, category])
  @@index([createdAt])
  @@map("Clipart")
}

// ========================================
// TEAM MANAGEMENT
// ========================================

model TeamMember {
  id             String    @id @default(cuid())
  organizationId String // Brand ID or User ID (for organization)
  userId         String? // User ID if user exists
  email          String
  role           String    @default("member") // 'admin', 'manager', 'designer', 'member', 'viewer'
  permissions    String[] // Array of permission strings
  status         String    @default("pending") // 'active', 'inactive', 'pending', 'invited'
  invitedBy      String?
  joinedAt       DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  user    User?  @relation(fields: [userId], references: [id], onDelete: SetNull)
  inviter User?  @relation("TeamInviter", fields: [invitedBy], references: [id], onDelete: SetNull)
  brand   Brand? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([organizationId, status])
  @@index([organizationId, role])
  @@map("TeamMember")
}

model TeamInvite {
  id             String    @id @default(cuid())
  organizationId String
  email          String
  role           String    @default("member")
  token          String    @unique
  invitedBy      String
  status         String    @default("pending") // 'pending', 'accepted', 'cancelled', 'expired'
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  inviter User   @relation("TeamInvitesSent", fields: [invitedBy], references: [id], onDelete: Cascade)
  brand   Brand? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email, status])
  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
  @@map("TeamInvite")
}

// Add relations to Brand model
// Add to Brand model:
//   analyticsEvents    AnalyticsEvent[]
//   analyticsFunnels   AnalyticsFunnel[]
//   analyticsCohorts   AnalyticsCohort[]
//   analyticsSegments  AnalyticsSegment[]
//   analyticsPredictions AnalyticsPrediction[]
//   aiGenerations      AIGeneration[]
//   aiCollections      AICollection[]
//   sharedResources    SharedResource[]

// ========================================
// AGENTS IA
// ========================================

model AgentConversation {
  id      String  @id @default(cuid())
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  agentType String // luna, aria, nova
  sessionId String?
  userId    String?

  // Contexte
  context Json @default("{}")

  // Messages
  messages AgentMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([agentType])
  @@index([sessionId])
  @@map("AgentConversation")
}

model AgentMessage {
  id             String            @id @default(cuid())
  conversationId String
  conversation   AgentConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role    String // user, assistant, system
  content String

  // Metadata
  intent   String?
  actions  Json?
  metadata Json    @default("{}")

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([createdAt])
  @@map("AgentMessage")
}

// ========================================
// SUPER ADMIN DASHBOARD MODELS
// ========================================

// ========================================
// GESTION CLIENTS ÉTENDUE
// ========================================

model Customer {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Métriques
  totalRevenue    Float  @default(0)
  ltv             Float  @default(0)
  engagementScore Int    @default(100)
  churnRisk       String @default("low") // low, medium, high

  // Tracking
  firstSeenAt    DateTime @default(now())
  lastSeenAt     DateTime @default(now())
  totalSessions  Int      @default(0)
  totalTimeSpent Int      @default(0) // en secondes

  // Relations
  segments   CustomerSegment[]
  activities CustomerActivity[]
  emailsSent EmailLog[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  AutomationRun AutomationRun[]
  Event         Event[]

  @@index([userId])
  @@index([churnRisk])
  @@index([lastSeenAt])
  @@index([createdAt])
}

model CustomerActivity {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  type     String // login, action, page_view, etc.
  action   String
  metadata Json?

  createdAt DateTime @default(now())

  @@index([customerId, createdAt])
  @@index([type])
  @@index([createdAt])
}

model CustomerSegment {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Critères dynamiques
  criteria Json // { engagementScore: { gte: 80 }, plan: "pro" }

  // Relations
  customers Customer[]
  campaigns EmailCampaign[] @relation("CampaignSegment")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

// ========================================
// EMAIL MARKETING
// ========================================

model EmailTemplate {
  id          String                @id @default(cuid())
  name        String
  slug        String                @unique
  subject     String
  htmlContent String                @db.Text
  textContent String?               @db.Text
  variables   String[]              // ["firstName", "planName", etc.]
  category    EmailTemplateCategory @default(OTHER)

  // Relations
  campaigns       EmailCampaign[]
  automationSteps AutomationStep[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([category])
}

model EmailCampaign {
  id         String         @id @default(cuid())
  name       String
  subject    String
  templateId String?
  template   EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  status CampaignStatus @default(DRAFT) // ENUM-01: Utilise enum au lieu de string

  // Ciblage
  segmentId String?
  segment   CustomerSegment? @relation("CampaignSegment", fields: [segmentId], references: [id], onDelete: SetNull)

  // Stats
  sentCount  Int @default(0)
  openCount  Int @default(0)
  clickCount Int @default(0)

  scheduledAt DateTime?
  sentAt      DateTime?

  // Relations
  logs EmailLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([scheduledAt])
}

model EmailAutomation {
  id            String           @id @default(cuid())
  name          String
  description   String?
  trigger       String           // user.created, trial.started, etc.
  triggerConfig Json?

  status AutomationStatus @default(draft)

  // Relations
  steps AutomationStep[]
  runs  AutomationRun[]
  logs  EmailLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([trigger])
  @@index([status])
}

model AutomationStep {
  id           String          @id @default(cuid())
  automationId String
  automation   EmailAutomation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  order Int

  type String // email, wait, condition

  // Pour type "email"
  templateId String?
  template   EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  subject    String?

  // Pour type "wait"
  waitDuration Int? // en minutes

  // Pour type "condition"
  condition Json?

  createdAt DateTime @default(now())

  @@index([automationId, order])
}

model AutomationRun {
  id           String             @id @default(cuid())
  automationId String
  automation   EmailAutomation    @relation(fields: [automationId], references: [id], onDelete: Cascade)

  customerId String
  customer   Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)

  status      AutomationRunStatus @default(active)
  currentStep Int                 @default(0)

  startedAt   DateTime            @default(now())
  completedAt DateTime?
  nextStepAt  DateTime?

  @@index([automationId])
  @@index([customerId])
  @@index([status])
  @@index([nextStepAt])
}

model EmailLog {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  messageId String @unique // ID du provider (Resend, etc.)
  type      String // campaign, automation, transactional

  campaignId   String?
  campaign     EmailCampaign?   @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  automationId String?
  automation   EmailAutomation? @relation(fields: [automationId], references: [id], onDelete: SetNull)

  subject  String
  template String?

  status String @default("sent") // sent, delivered, opened, clicked, bounced

  openedAt  DateTime?
  clickedAt DateTime?
  bouncedAt DateTime?

  createdAt DateTime @default(now())

  @@index([customerId, createdAt])
  @@index([type])
  @@index([status])
  @@index([messageId])
  @@index([campaignId])
  @@index([automationId])
}

// ========================================
// INTÉGRATIONS ADS
// ========================================

model AdPlatformConnection {
  id          String  @id @default(cuid())
  platform    String // meta, google, tiktok
  accountId   String // ID du compte pub
  accountName String?

  accessToken  String    @db.Text
  refreshToken String?   @db.Text
  expiresAt    DateTime?

  status String @default("active") // active, expired, error

  lastSyncAt DateTime?
  metadata   Json? // Infos additionnelles du compte

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([platform, accountId])
  @@index([platform])
  @@index([status])
}

model AdCampaignSync {
  id         String @id @default(cuid())
  platform   String
  externalId String // ID de la campagne sur la plateforme
  name       String
  status     String

  // Métriques synchronisées
  spend       Float @default(0)
  impressions Int   @default(0)
  clicks      Int   @default(0)
  conversions Int   @default(0)
  revenue     Float @default(0)

  // Période des données
  dateFrom DateTime
  dateTo   DateTime

  syncedAt DateTime @default(now())

  @@unique([platform, externalId, dateFrom, dateTo])
  @@index([platform, dateFrom])
  @@index([dateFrom, dateTo])
}

// ========================================
// WEBHOOKS & EVENTS (Extension)
// ========================================

model Event {
  id         String    @id @default(cuid())
  type       String // user.created, subscription.cancelled, etc.
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  data Json // Payload de l'événement

  processed   Boolean   @default(false)
  processedAt DateTime?

  // Relations
  webhookLogs WebhookLog[] @relation

  createdAt DateTime @default(now())

  @@index([type, createdAt])
  @@index([customerId, createdAt])
  @@index([processed, createdAt])
}

// Note: Webhook et WebhookLog existent déjà dans le schema
// On ajoute juste la relation avec Event
// Il faut ajouter dans WebhookLog:
//   eventId String?
//   event   Event? @relation(fields: [eventId], references: [id])

// ========================================
// ANALYTICS & METRICS SNAPSHOTS
// ========================================

model DailyMetrics {
  id   String   @id @default(cuid())
  date DateTime @db.Date

  // Revenue
  mrr     Float @default(0)
  arr     Float @default(0)
  revenue Float @default(0)

  // Customers
  totalCustomers   Int @default(0)
  activeCustomers  Int @default(0)
  newCustomers     Int @default(0)
  churnedCustomers Int @default(0)

  // Trials
  activeTrials    Int @default(0)
  trialsStarted   Int @default(0)
  trialsConverted Int @default(0)

  // Churn
  churnRate Float @default(0)

  // Ads
  adSpend       Float @default(0)
  adConversions Int   @default(0)
  adRevenue     Float @default(0)

  createdAt DateTime @default(now())

  @@unique([date])
  @@index([date])
}

model MonthlyMetrics {
  id    String @id @default(cuid())
  year  Int
  month Int

  // Revenue
  mrr          Float @default(0)
  arr          Float @default(0)
  totalRevenue Float @default(0)

  // Growth
  mrrGrowth Float @default(0)

  // Customers
  startingCustomers Int @default(0)
  endingCustomers   Int @default(0)
  newCustomers      Int @default(0)
  churnedCustomers  Int @default(0)

  // Rates
  churnRate      Float @default(0)
  conversionRate Float @default(0)

  // LTV & CAC
  avgLtv      Float @default(0)
  avgCac      Float @default(0)
  ltvCacRatio Float @default(0)

  createdAt DateTime @default(now())

  @@unique([year, month])
  @@index([year, month])
}

model CohortData {
  id          String   @id @default(cuid())
  cohortMonth DateTime @db.Date // Mois de la cohorte (inscription)

  // Données par mois après inscription
  monthNumber    Int // 0 = mois d'inscription, 1 = mois suivant, etc.
  startingCount  Int // Nombre de clients au départ de la cohorte
  remainingCount Int // Nombre de clients restants ce mois
  retentionRate  Float // % de rétention
  revenue        Float @default(0)

  createdAt DateTime @default(now())

  @@unique([cohortMonth, monthNumber])
  @@index([cohortMonth])
}

// ========================================
// NOTIFICATIONS ADMIN
// ========================================

model AdminNotification {
  id      String @id @default(cuid())
  type    String // alert, info, success, warning
  title   String
  message String

  // Lien vers une action
  actionUrl   String?
  actionLabel String?

  read   Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([read, createdAt])
}

// ========================================
// AUDIT LOG (Actions Admin)
// ========================================

model AdminAuditLog {
  id         String  @id @default(cuid())
  adminId    String // ID de l'admin qui a fait l'action
  action     String // create, update, delete, export, etc.
  resource   String // customer, campaign, webhook, etc.
  resourceId String?

  changes Json? // Détail des changements (before/after)

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([adminId, createdAt])
  @@index([resource, resourceId])
}

// ========================================
// SSO CONFIGURATION (Enterprise SSO)
// ========================================

model SSOConfiguration {
  id       String  @id @default(cuid())
  brandId  String
  brand    Brand   @relation(fields: [brandId], references: [id], onDelete: Cascade)
  provider String // 'saml' | 'oidc'
  name     String
  enabled  Boolean @default(true)

  // SAML Configuration
  samlEntryPoint    String?
  samlIssuer        String?
  samlCert          String? // Base64 encoded certificate
  samlCallbackUrl   String?
  samlDecryptionPvk String? // Encrypted private key

  // OIDC Configuration
  oidcIssuer       String?
  oidcClientId     String?
  oidcClientSecret String? // Encrypted
  oidcCallbackUrl  String?
  oidcScope        String? @default("openid profile email")

  // Metadata
  metadataUrl String?
  metadataXml String? // SAML metadata XML

  // Settings
  autoProvisioning Boolean @default(true)
  defaultRole      String?
  attributeMapping Json? // { email: "email", firstName: "given_name", ... }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([brandId, provider])
  @@index([brandId])
  @@index([provider])
  @@index([enabled])
}

// ========================================
// MARKETPLACE & COMMUNITY (PHASE 7)
// ========================================

model MarketplaceTemplate {
  id          String   @id @default(cuid())
  creatorId   String
  name        String
  slug        String   @unique
  description String?
  category    String?
  tags        String[]

  // Template content
  promptTemplate String
  negativePrompt String?
  variables      Json?
  exampleOutputs String[]

  // AI settings
  aiProvider String @default("openai")
  model      String @default("dall-e-3")
  quality    String @default("standard")
  style      String @default("natural")

  // Pricing
  priceCents          Int     @default(0)
  isFree              Boolean @default(false)
  revenueSharePercent Int     @default(70)

  // Stats
  downloads         Int   @default(0)
  likes             Int   @default(0)
  reviews           Int   @default(0)
  averageRating     Float @default(0)
  totalRevenueCents Int   @default(0)

  // Status
  status      String    @default("draft")
  publishedAt DateTime?
  featured    Boolean   @default(false)

  // Metadata
  thumbnailUrl  String?
  previewImages String[]
  metadata      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId])
  @@index([status])
  @@index([category])
  @@index([featured])
  @@index([publishedAt])
}

model CreatorProfile {
  id          String  @id @default(cuid())
  userId      String  @unique
  username    String  @unique
  displayName String
  bio         String?
  avatar      String?
  coverImage  String?
  website     String?

  // Social links
  socialLinks Json?

  // Stats
  templatesCount     Int   @default(0)
  totalSales         Int   @default(0)
  totalEarningsCents Int   @default(0)
  followersCount     Int   @default(0)
  followingCount     Int   @default(0)
  averageRating      Float @default(0)

  // Stripe Connect
  stripeConnectId String?
  payoutEnabled   Boolean @default(false)

  // Verification
  verified   Boolean   @default(false)
  verifiedAt DateTime?

  // Status
  status String @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([username])
  @@index([verified])
  @@index([status])
}

model TemplatePurchase {
  id         String @id @default(cuid())
  templateId String
  buyerId    String
  creatorId  String

  // Pricing
  priceCents          Int
  platformFeeCents    Int
  creatorRevenueCents Int

  // Payment
  stripePaymentIntentId String?
  paymentStatus         String  @default("pending")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
  @@index([buyerId])
  @@index([creatorId])
  @@index([paymentStatus])
}

model CreatorPayout {
  id        String @id @default(cuid())
  creatorId String

  // Amounts
  totalRevenueCents Int
  platformFeeCents  Int
  netAmountCents    Int

  // Stripe
  stripeTransferId String?
  stripePayoutId   String?

  // Status
  status        String  @default("pending")
  failureReason String?

  // Period
  periodStart DateTime
  periodEnd   DateTime

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime?

  @@index([creatorId])
  @@index([status])
  @@index([periodStart])
  @@index([periodEnd])
}

model TemplateLike {
  id         String @id @default(cuid())
  templateId String
  userId     String

  createdAt DateTime @default(now())

  @@unique([templateId, userId])
  @@index([templateId])
  @@index([userId])
}

model CreatorFollow {
  id          String @id @default(cuid())
  followerId  String
  followingId String

  createdAt DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model TemplateReview {
  id         String  @id @default(cuid())
  templateId String
  userId     String
  purchaseId String?

  rating  Int
  comment String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, userId])
  @@index([templateId])
  @@index([userId])
  @@index([rating])
}

model TemplateFavorite {
  id         String @id @default(cuid())
  templateId String
  userId     String

  createdAt DateTime @default(now())

  @@unique([templateId, userId])
  @@index([templateId])
  @@index([userId])
}

model TemplateCollection {
  id           String  @id @default(cuid())
  creatorId    String
  name         String
  slug         String  @unique
  description  String?
  thumbnailUrl String?
  isPublic     Boolean @default(true)

  templatesCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId])
}

model TemplateCollectionItem {
  id           String @id @default(cuid())
  collectionId String
  templateId   String
  order        Int    @default(0)

  createdAt DateTime @default(now())

  @@unique([collectionId, templateId])
  @@index([collectionId])
  @@index([templateId])
}

// ========================================
// ENTERPRISE (PHASE 8)
// ========================================

model CustomTheme {
  id              String  @id @default(cuid())
  brandId         String
  name            String
  primaryColor    String
  secondaryColor  String
  accentColor     String
  backgroundColor String
  textColor       String
  fontFamily      String  @default("Inter")
  borderRadius    String  @default("8px")
  logoUrl         String?
  faviconUrl      String?
  customCss       String? @db.Text
  isActive        Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([isActive])
  @@index([brandId, isActive])
}

model CustomDomain {
  id             String    @id @default(cuid())
  brandId        String
  domain         String    @unique
  isActive       Boolean   @default(false)
  sslCertificate String?   @db.Text
  sslExpiresAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([isActive])
  @@index([brandId, isActive])
}

model SLATicket {
  id                    String    @id @default(cuid())
  ticketId              String
  brandId               String
  planId                String
  priority              String // 'low', 'medium', 'high', 'critical'
  createdAt             DateTime  @default(now())
  firstResponseAt       DateTime?
  resolvedAt            DateTime?
  slaResponseDeadline   DateTime
  slaResolutionDeadline DateTime
  slaStatus             String    @default("on_time") // 'on_time', 'at_risk', 'breached'
  escalationLevel       Int       @default(0)

  updatedAt DateTime @updatedAt

  @@unique([ticketId])
  @@index([brandId])
  @@index([planId])
  @@index([slaStatus])
  @@index([slaResponseDeadline])
  @@index([slaResolutionDeadline])
  @@index([brandId, slaStatus])
}

// ========================================
// AI MONITORING (Added for backend compatibility)
// ========================================

model AIQuota {
  id      String  @id @default(cuid())
  userId  String? @unique // Optional pour les quotas brand-level
  brandId String? @unique
  planId  String?

  // Limits
  dailyLimit      Int    @default(100)
  monthlyLimit    Int    @default(3000)
  tokenLimit      Int    @default(1000000)
  requestLimit    Int    @default(10000)
  totalLimit      Int    @default(100000)
  limitType       String @default("requests")
  limitValue      Int    @default(1000)
  monthlyTokens   Int    @default(1000000)
  monthlyRequests Int    @default(10000)

  // Usage
  dailyUsed    Int @default(0)
  monthlyUsed  Int @default(0)
  usedTokens   Int @default(0)
  usedRequests Int @default(0)
  totalUsed    Int @default(0)

  // Reset timestamps
  dailyResetAt   DateTime @default(now())
  monthlyResetAt DateTime @default(now())
  resetAt        DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([brandId])
  @@index([planId])
}

model AIUsageLog {
  id      String  @id @default(cuid())
  userId  String
  brandId String?
  agentId String?

  // Provider info
  provider  String?
  model     String
  operation String? // Type d'opération (chat, completion, embedding, etc.)

  // Request details - support both naming conventions
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  inputTokens      Int? // Alias pour promptTokens
  outputTokens     Int? // Alias pour completionTokens
  costCents        Int  @default(0)
  latencyMs        Int  @default(0)

  // Metadata
  requestType  String?
  success      Boolean @default(true)
  errorMessage String?
  metadata     Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([brandId])
  @@index([agentId])
  @@index([createdAt])
  @@index([model])
  @@index([provider])
  @@index([operation])
}

model AIAnalytics {
  id      String  @id @default(cuid())
  brandId String?
  agentId String?

  // Aggregated data
  date              DateTime @db.Date
  totalRequests     Int      @default(0)
  totalTokens       Int      @default(0)
  totalCostCents    Int      @default(0)
  averageLatencyMs  Int      @default(0)
  errorRate         Float    @default(0)
  conversationCount Int      @default(0)
  messageCount      Int      @default(0) // Nombre de messages

  // By model breakdown (JSON)
  modelBreakdown    Json?
  providerBreakdown Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([brandId, agentId, date])
  @@index([date])
  @@index([brandId])
  @@index([agentId])
}

model AIRateLimit {
  id      String  @id @default(cuid())
  userId  String?
  brandId String?

  // Rate limit data
  windowStart  DateTime
  requestCount Int      @default(0)
  tokenCount   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, windowStart])
  @@unique([brandId, userId, windowStart])
  @@index([userId])
  @@index([brandId])
  @@index([windowStart])
}

// ========================================
// AR INTEGRATIONS
// ========================================

model ARIntegration {
  id      String @id @default(cuid())
  brandId String

  // Platform config
  platform   String // 'web', 'ios', 'android'
  name       String
  apiKey     String?
  apiSecret  String?
  webhookUrl String?

  // Sync status
  lastSyncAt DateTime?
  syncStatus String    @default("idle")

  // Settings
  isActive Boolean @default(true)
  settings Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([platform])
  @@index([isActive])
  @@index([brandId, isActive])
}

model SyncHistory {
  id            String @id @default(cuid())
  integrationId String

  // Sync details
  entityType String?
  entityId   String?
  syncType   String?
  status     String  @default("pending")

  // Results
  itemsSynced      Int     @default(0)
  recordsProcessed Int     @default(0)
  errors           Json?
  errorMessage     String?
  metadata         Json?

  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  createdAt DateTime @default(now())

  @@index([integrationId])
  @@index([entityType])
  @@index([entityId])
  @@index([syncType])
  @@index([status])
  @@index([startedAt])
}

// ========================================
// WEBHOOK DELIVERY
// ========================================

model WebhookDelivery {
  id        String @id @default(cuid())
  webhookId String

  // Delivery details
  eventType String
  payload   Json

  // Response
  statusCode   Int?
  responseCode Int?
  responseBody String? @db.Text

  // Status
  status        String    @default("pending")
  attempts      Int       @default(0)
  lastAttemptAt DateTime?
  nextRetryAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([webhookId])
  @@index([status])
  @@index([eventType])
  @@index([createdAt])
}

// ========================================
// DISASTER RECOVERY
// ========================================

model BackupRecord {
  id String @id @default(cuid())

  // Backup details
  type   String // 'full', 'incremental', 'differential'
  status String @default("pending")

  // Storage
  storagePath String?
  location    String?
  sizeBytes   BigInt  @default(0)
  size        Int     @default(0)

  // Checksums
  checksum String?

  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime?

  // Metadata & Errors
  metadata     Json?
  errorMessage String?
  error        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model RestoreDrillRecord {
  id       String  @id @default(cuid())
  backupId String?

  // Drill details
  type   String // 'full', 'partial', 'verification'
  status String @default("pending")

  // Results
  tablesRestored  Int   @default(0)
  recordsVerified Int   @default(0)
  discrepancies   Json?
  duration        Int?

  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  // Metadata & Errors
  performedBy  String?
  notes        String? @db.Text
  errorMessage String?
  error        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([backupId])
  @@index([status])
  @@index([createdAt])
}

// ========================================
// ASSET HUB
// ========================================

model AssetFolder {
  id             String  @id @default(cuid())
  brandId        String
  organizationId String?
  parentId       String?

  name        String
  description String?
  path        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  parent   AssetFolder?  @relation("FolderTree", fields: [parentId], references: [id], onDelete: SetNull)
  children AssetFolder[] @relation("FolderTree")
  files    AssetFile[]

  @@index([brandId])
  @@index([organizationId])
  @@index([parentId])
}

model AssetFile {
  id             String  @id @default(cuid())
  brandId        String
  organizationId String?
  folderId       String?

  // File info
  name         String
  originalName String?
  mimeType     String
  size         Int
  sizeBytes    Int? // Alias for services using this field
  type         AssetFileType @default(OTHER)

  // Storage
  url          String
  cdnUrl       String?
  thumbnailUrl String?
  thumbnails   Json? // For multiple thumbnail sizes
  storageKey   String?
  publicId     String?

  // Metadata
  width    Int?
  height   Int?
  duration Int?
  metadata Json?
  tags     String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  folder AssetFolder? @relation(fields: [folderId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([folderId])
  @@index([type])
  @@index([brandId, type])
  @@index([brandId, folderId])
}

// ========================================
// PROJECTS & WORKSPACES
// ========================================

model Workspace {
  id      String @id @default(cuid())
  brandId String

  name        String
  slug        String
  description String?
  environment WorkspaceEnvironment @default(DEVELOPMENT)

  isDefault Boolean @default(false)
  settings  Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp (consistency with Project)

  // Relations
  brand           Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)
  projects        Project[]
  projectsManyRef Project[] @relation("ProjectWorkspaces")

  @@unique([brandId, slug])
  @@index([brandId])
  @@index([deletedAt]) // Soft delete index for efficient queries on active workspaces
}

model Project {
  id             String  @id @default(cuid())
  brandId        String
  organizationId String?
  workspaceId    String?

  name        String
  slug        String
  description String?
  type        ProjectType   @default(DESIGN)
  status      ProjectStatus @default(DRAFT)

  // Security
  apiKey String? @unique

  // Metadata
  thumbnail String?
  settings  Json?
  metadata  Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  brand                        Brand                         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  workspace                    Workspace?                    @relation(fields: [workspaceId], references: [id])
  configurator3DConfigurations Configurator3DConfiguration[]
  tryOnConfigurations          TryOnConfiguration[]
  visualCustomizers            VisualCustomizer[]
  workspaces                   Workspace[]                   @relation("ProjectWorkspaces")

  @@unique([brandId, slug])
  @@unique([organizationId, slug])
  @@index([brandId])
  @@index([organizationId])
  @@index([workspaceId])
  @@index([type])
  @@index([status])
  @@index([brandId, status])
  @@index([brandId, type])
}

// ========================================
// CONFIGURATOR 3D
// ========================================

model Configurator3DConfiguration {
  id        String  @id @default(cuid())
  brandId   String
  productId String?
  projectId String?

  name        String
  description String?

  // 3D Model
  modelUrl     String?
  thumbnailUrl String?

  // Settings & Scene
  settings    Json?
  sceneConfig Json? // 3D scene configuration (lighting, camera, etc.)
  uiConfig    Json? // UI configuration

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project    Project?                     @relation(fields: [projectId], references: [id])
  options    Configurator3DOption[]
  sessions   Configurator3DSession[]
  components Configurator3DComponent[]

  @@index([brandId])
  @@index([productId])
  @@index([projectId])
  @@index([isActive])
  @@index([brandId, isActive])
}

model Configurator3DComponent {
  id              String @id @default(cuid())
  configurationId String

  name       String
  type       String
  meshName   String? // 3D mesh reference
  settings   Json?
  isVisible  Boolean @default(true)
  isOptional Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  configuration Configurator3DConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)

  @@index([configurationId])
}

model Configurator3DOption {
  id              String @id @default(cuid())
  configurationId String

  name        String
  label       String? // Display label
  type        Configurator3DOptionType
  description String?

  // Values
  value        String?
  values       Json?
  defaultValue String?

  // Display
  sortOrder   Int     @default(0)
  order       Int     @default(0) // Alias for services
  isRequired  Boolean @default(false)

  // Constraints
  constraints Json?

  // Pricing
  priceDelta Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  configuration Configurator3DConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)

  @@index([configurationId])
  @@index([type])
  @@index([order])
}

model Configurator3DSession {
  id              String  @id @default(cuid())
  sessionId       String? @unique // External session ID
  configurationId String
  userId          String?
  visitorId       String? // Anonymous visitor tracking

  status Configurator3DSessionStatus @default(ACTIVE)

  // Session data
  selectedOptions Json?
  previewUrl      String?
  previewImageUrl String? // Alias for compatibility
  state           Json? // Full session state

  // Metadata
  deviceInfo String?
  ipAddress  String?

  // Timestamps
  startedAt   DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  savedAt     DateTime?
  completedAt DateTime?
  expiresAt   DateTime?

  // Relations
  configuration Configurator3DConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)

  @@index([configurationId])
  @@index([userId])
  @@index([status])
  @@index([sessionId])
  @@index([visitorId])
}

// ========================================
// IDEMPOTENCY & WEBHOOK TRACKING
// ========================================

model IdempotencyKey {
  id        String   @id @default(cuid())
  key       String   @unique
  result    String?  @db.Text
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([expiresAt])
}

// Renamed from WebhookEvent to avoid conflict with WebhookEvent enum
model ProcessedWebhookEvent {
  id        String  @id @default(cuid())
  eventId   String  @unique // Stripe event ID
  eventType String
  processed Boolean @default(false)
  result    Json?
  error     String? @db.Text
  attempts  Int     @default(0)

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([eventType])
  @@index([processed])
  @@index([createdAt])
  @@map("webhook_events") // Keep original table name for compatibility
}

// ========================================
// TRY-ON MODULE (Virtual Try-On)
// ========================================

enum TryOnProductType {
  GLASSES
  JEWELRY
  WATCH
  HAT
  MAKEUP
  CLOTHING
  ACCESSORY
}

enum TryOnSessionStatus {
  ACTIVE
  COMPLETED
  EXPIRED
}

model TryOnConfiguration {
  id          String           @id @default(cuid())
  projectId   String
  name        String
  productType TryOnProductType
  settings    Json             @default("{}")
  uiConfig    Json?
  isActive    Boolean          @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project  Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sessions TryOnSession[]
  mappings TryOnProductMapping[]

  @@index([projectId])
  @@index([productType])
  @@index([isActive])
}

model TryOnProductMapping {
  id              String @id @default(cuid())
  configurationId String
  productId       String
  modelId         String? // 3D model reference

  // 3D positioning data
  anchorPoints Json?
  scaleFactor  Float @default(1.0)
  adjustments  Json? // Position/rotation adjustments

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  configuration TryOnConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  product       Product            @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([configurationId, productId])
  @@index([configurationId])
  @@index([productId])
}

model TryOnSession {
  id              String             @id @default(cuid())
  sessionId       String?            @unique // External session ID
  configurationId String
  userId          String?
  visitorId       String? // Anonymous visitor tracking
  status          TryOnSessionStatus @default(ACTIVE)

  // Session data
  deviceInfo String?
  ipAddress  String?
  userAgent  String?

  // Analytics
  productsViewed    Json?
  productsTried     String[] @default([])
  interactionData   Json?
  screenshotsTaken  Int      @default(0)
  shared            Boolean  @default(false)
  converted         Boolean  @default(false)

  // Timestamps
  startedAt DateTime  @default(now())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  endedAt   DateTime?
  expiresAt DateTime?

  // Relations
  configuration TryOnConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  screenshots   TryOnScreenshot[]

  @@index([configurationId])
  @@index([userId])
  @@index([status])
  @@index([sessionId])
  @@index([startedAt])
}

model TryOnScreenshot {
  id        String @id @default(cuid())
  sessionId String
  productId String

  // Image data
  imageUrl     String
  thumbnailUrl String?
  sharedUrl    String? // Public share URL

  // Metadata
  metadata Json?
  isShared Boolean @default(false)

  createdAt DateTime @default(now())

  // Relations
  session TryOnSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  product Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([productId])
}

// ========================================
// VISUAL CUSTOMIZER MODULE
// ========================================

enum VisualCustomizerLayerType {
  IMAGE
  TEXT
  SHAPE
  PATTERN
  CLIPART
}

model VisualCustomizer {
  id          String  @id @default(cuid())
  projectId   String
  name        String
  description String?

  // Canvas configuration
  canvasConfig Json

  // UI configuration
  uiConfig Json?

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  layers  VisualCustomizerLayer[]
  presets VisualCustomizerPreset[]

  @@index([projectId])
  @@index([isActive])
}

model VisualCustomizerLayer {
  id           String                    @id @default(cuid())
  customizerId String
  name         String
  type         VisualCustomizerLayerType
  order        Int                       @default(0)

  // Layer properties
  properties Json @default("{}")
  config     Json? // Layer configuration

  // Constraints
  constraints Json?

  // Visibility
  isLocked  Boolean @default(false)
  isVisible Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customizer VisualCustomizer @relation(fields: [customizerId], references: [id], onDelete: Cascade)

  @@index([customizerId])
  @@index([type])
  @@index([order])
}

model VisualCustomizerPreset {
  id           String @id @default(cuid())
  customizerId String
  name         String
  description  String?

  // Preset data
  layerConfig Json

  // Display
  thumbnailUrl    String?
  previewImageUrl String? // Alias for compatibility
  sortOrder       Int     @default(0)
  isDefault       Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customizer VisualCustomizer @relation(fields: [customizerId], references: [id], onDelete: Cascade)

  @@index([customizerId])
}

// ========================================
// OBSERVABILITY - Distributed Tracing
// ========================================

model Trace {
  id            String   @id @default(cuid())
  traceId       String   @unique
  spanId        String
  parentSpanId  String?
  operationName String
  serviceName   String
  duration      Int // milliseconds
  status        String   @default("ok") // ok, error, timeout
  metadata      Json?
  brandId       String?
  userId        String?

  createdAt DateTime @default(now())

  // Relations
  brand Brand? @relation("BrandTraces", fields: [brandId], references: [id], onDelete: SetNull)
  user  User?  @relation("UserTraces", fields: [userId], references: [id], onDelete: SetNull)

  @@index([traceId])
  @@index([serviceName])
  @@index([operationName])
  @@index([status])
  @@index([createdAt])
  @@index([brandId])
  @@index([userId])
  @@index([serviceName, createdAt])
}

// ========================================
// FEATURE FLAGS
// ========================================

model FeatureFlag {
  id          String  @id @default(cuid())
  key         String  @unique
  description String?
  isEnabled   Boolean @default(false)
  brandId     String? // null = global flag, set = brand-specific
  brand       Brand?  @relation("BrandFeatureFlags", fields: [brandId], references: [id], onDelete: SetNull)
  percentage  Int?    // Gradual rollout percentage (0-100)
  conditions  Json?   // Advanced targeting conditions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([brandId])
  @@index([isEnabled])
  @@index([brandId, isEnabled])
}

// ============================================================================
// ORION - Super Admin AI Command Center
// ============================================================================

// ========================================
// ORION ENUMS
// ========================================

enum OrionAgentType {
  ACQUISITION
  ONBOARDING
  COMMUNICATION
  RETENTION
  REVENUE
  ANALYTICS
  GENERAL
}

enum OrionAgentStatus {
  ACTIVE
  PAUSED
  MAINTENANCE
}

enum ChurnRisk {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum GrowthPotential {
  LOW
  MEDIUM
  HIGH
}

enum AutomationStatus {
  draft
  active
  paused
}

enum AutomationRunStatus {
  active
  completed
  cancelled
}

enum EmailTemplateCategory {
  ONBOARDING
  RETENTION
  ENGAGEMENT
  TRANSACTIONAL
  UPSELL
  WIN_BACK
  OTHER
}

model OrionAgent {
  id          String           @id @default(uuid())
  name        String           @unique // APOLLO, ATHENA, HERMES, ARTEMIS, HADES, ZEUS
  displayName String
  type        OrionAgentType   @default(GENERAL)
  description String?
  status      OrionAgentStatus @default(PAUSED)
  config      Json             @default("{}")
  lastRunAt   DateTime?
  tasksLast24h Int             @default(0)
  successRate  Float           @default(0)
  errorCount   Int             @default(0)
  avgExecTime  Float           @default(0) // ms
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("orion_agents")
}

model CustomerHealthScore {
  id               String          @id @default(uuid())
  userId           String          @unique
  healthScore      Int             @default(50) // 0-100
  churnRisk        ChurnRisk       @default(LOW)
  activationScore  Int             @default(0)
  engagementScore  Int             @default(0)
  adoptionScore    Int             @default(0)
  growthPotential  GrowthPotential @default(MEDIUM)
  lastActivityAt   DateTime?
  signals          Json            @default("[]")
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("customer_health_scores")
}

// ========================================
// MARKETING SPEND (CAC Tracking)
// ========================================

model MarketingSpend {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  channel   String   // organic, google_ads, facebook, linkedin, referral, etc.
  amount    Int      // Amount in cents
  currency  String   @default("eur")
  notes     String?
  createdBy String?  // Admin user ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([channel])
  @@map("marketing_spends")
}

// ========================================
// NPS (Net Promoter Score)
// ========================================

model NPSResponse {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserNPSResponses", fields: [userId], references: [id], onDelete: Cascade)
  score     Int      // 0-10
  comment   String?
  source    String   @default("in_app") // in_app, email, manual
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("nps_responses")
}

// ========================================
// CART (Shopping Cart)
// ========================================

model Cart {
  id        String     @id @default(cuid())
  sessionId String?    @unique // For anonymous users
  userId    String?
  user      User?      @relation("UserCart", fields: [userId], references: [id], onDelete: Cascade)
  brandId   String
  items     CartItem[]
  metadata  Json?
  expiresAt DateTime?  // Auto-expire abandoned carts
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([userId, brandId])
  @@index([sessionId])
  @@index([brandId])
  @@index([expiresAt])
}

model CartItem {
  id              String  @id @default(cuid())
  cartId          String
  cart            Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId       String
  designId        String?
  customizationId String?
  quantity        Int     @default(1)
  priceCents      Int // snapshot price at time of add
  metadata        Json? // custom options, preview URL, etc.
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([cartId, productId, designId, customizationId])
  @@index([cartId])
  @@index([productId])
}
