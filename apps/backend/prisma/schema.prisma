// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================

enum UserRole {
  CONSUMER
  BRAND_USER
  BRAND_ADMIN
  PLATFORM_ADMIN
  FABRICATOR
}

enum OrderStatus {
  CREATED
  PENDING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum DesignStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
}

enum BrandStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
  VERIFIED
}

enum WebhookEventType {
  ORDER_CREATED
  ORDER_UPDATED
  ORDER_PAID
  DESIGN_CREATED
  DESIGN_COMPLETED
  PRODUCT_UPDATED
}

// ========================================
// MODELS
// ========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String? // Null for OAuth users
  firstName     String?
  lastName      String?
  name          String? // Full name field
  avatar        String?
  role          UserRole  @default(CONSUMER)
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Billing
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?
  stripePlan             String?
  stripeStatus           String?
  stripeCurrentPeriodEnd DateTime?

  // Relations
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: SetNull)

  designs       Design[]
  orders        Order[]
  refreshTokens RefreshToken[]

  // OAuth
  oauthAccounts OAuthAccount[]

  // Quotas
  userQuota UserQuota?

  // GDPR
  userConsents UserConsent[]

  @@index([email])
  @@index([brandId])
  @@index([role])
  @@index([stripeSubscriptionId])
  @@index([stripePlan])
}

model OAuthAccount {
  id           String    @id @default(cuid())
  provider     String // google, github, etc.
  providerId   String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Brand {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  logo        String?
  website     String?
  status      BrandStatus @default(PENDING_VERIFICATION)

  // KYC Fields
  companyName String?
  vatNumber   String?
  address     String?
  city        String?
  country     String?
  postalCode  String?
  phone       String?

  // Billing
  stripeCustomerId     String?
  stripeSubscriptionId String? // Stripe subscription ID
  plan                 String    @default("starter")
  planExpiresAt        DateTime?
  limits               Json? // Brand limits configuration

  // Settings
  settings      Json? // Brand-specific settings
  webhookUrl    String?
  webhookSecret String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users                 User[]
  products              Product[]
  designs               Design[]
  orders                Order[]
  webhooks              Webhook[]
  apiKeys               ApiKey[]
  aiCosts               AICost[]
  ecommerceIntegrations EcommerceIntegration[]
  shopifyInstalls       ShopifyInstall[]
  usageMetrics          UsageMetric[]
  usageTopUps           UsageTopUp[]
  renderAuditLogs       RenderAuditLog[]

  @@index([slug])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model Product {
  id          String  @id @default(cuid())
  name        String
  description String?
  sku         String?
  price       Decimal @db.Decimal(10, 2)
  currency    String  @default("EUR")

  // Images
  images       String[] // Array of image URLs
  baseAssetUrl String? // Base asset URL for rendering

  // 3D Model
  model3dUrl  String?
  modelConfig Json? // 3D model configuration

  // Customization & Product Engine
  customizationOptions Json? // Available customization options
  rulesJson            Json? // Product Rules Engine configuration

  // Manufacturing & Cost
  baseCostCents     Int? // Base manufacturing cost in cents
  laborCostCents    Int? // Labor cost in cents
  overheadCostCents Int? // Overhead cost in cents
  materialOptions   Json? // Available materials with pricing
  finishOptions     Json? // Available finishes with pricing
  productionTime    Int? // Estimated production time in hours

  // Status
  isActive Boolean @default(true)
  isPublic Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  designs         Design[]
  orders          Order[]
  productMappings ProductMapping[]

  @@index([brandId])
  @@index([isActive])
  @@index([isPublic])
}

model Design {
  id          String  @id @default(cuid())
  name        String?
  description String?

  // Generation
  prompt      String
  promptHash  String? // For caching
  options     Json // Generation options
  optionsJson Json? // Legacy field for compatibility
  status      DesignStatus @default(PENDING)

  // Results
  previewUrl String? // Low-res preview
  highResUrl String? // High-res result
  imageUrl   String? // Main image URL
  renderUrl  String? // Render URL
  compositeTextureUrl String? // Composite texture URL for renders
  metadata   Json? // AI generation metadata

  // Cost tracking
  costCents Int     @default(0)
  costTokens Int    @default(0) // Tokens used for AI generation
  provider  String? // AI provider used

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  orders Order[]
  assets Asset[]

  @@index([userId])
  @@index([brandId])
  @@index([productId])
  @@index([status])
  @@index([promptHash])
  @@index([createdAt])
}

model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique
  status      OrderStatus @default(CREATED)

  // Customer info
  customerEmail   String
  customerName    String?
  customerPhone   String?
  userEmail       String? // For GDPR anonymization
  shippingAddress Json?

  // Pricing
  subtotalCents Int
  taxCents      Int    @default(0)
  shippingCents Int    @default(0)
  totalCents    Int
  currency      String @default("EUR")

  // Payment
  paymentStatus   PaymentStatus @default(PENDING)
  stripeSessionId String?
  stripePaymentId String?
  refundId        String?
  refundAmountCents Int?
  refundedAt     DateTime?

  // Shipping
  trackingNumber      String?
  trackingUrl         String?
  productionBundleUrl String? // URL to production bundle

  // Notes
  notes    String?
  metadata Json? // Additional order metadata

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  paidAt    DateTime?
  shippedAt DateTime?

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  designId String
  design   Design @relation(fields: [designId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([brandId])
  @@index([designId])
  @@index([productId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
}

model ApiKey {
  id          String    @id @default(cuid())
  name        String
  key         String    @unique
  secret      String? // Hashed secret for API key authentication
  scopes      String[] // Array of permissions (legacy)
  permissions String[] // Array of permissions (new)
  rateLimit   Json? // Rate limiting configuration
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([key])
  @@index([isActive])
}

model AICost {
  id        String   @id @default(cuid())
  provider  String // openai, replicate, etc.
  model     String // gpt-4, stable-diffusion, etc.
  costCents Int
  tokens    Int? // For text models
  duration  Int? // Processing time in seconds
  createdAt DateTime @default(now())

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([provider])
  @@index([createdAt])
}

model UserQuota {
  id             String   @id @default(cuid())
  monthlyLimit   Int      @default(100) // Monthly design generations
  monthlyUsed    Int      @default(0)
  costLimitCents Int      @default(5000) // 50â‚¬ monthly limit
  costUsedCents  Int      @default(0)
  resetAt        DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([resetAt])
}

model UsageTopUp {
  id               String   @id @default(cuid())
  brandId          String
  metric           String
  units            Int
  unitPriceCents   Int
  totalPriceCents  Int
  status           String   @default("pending") // pending, completed, failed
  stripeCheckoutId String?  @unique
  stripePaymentId  String?
  periodKey        String // e.g. 2025-11
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([metric])
  @@index([periodKey])
  @@index([status])
}

model Webhook {
  id         String   @id @default(cuid())
  event      String // Event type (design.created, order.updated, etc.)
  url        String // Webhook URL
  payload    Json // Webhook payload data
  statusCode Int? // HTTP response status code
  success    Boolean  @default(false) // Whether webhook was successful
  error      String? // Error message if failed
  createdAt  DateTime @default(now())

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([event])
  @@index([success])
  @@index([createdAt])
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

// ========================================
// WORKERS & PRODUCTION MODELS
// ========================================

model RenderResult {
  id           String   @id @default(cuid())
  renderId     String   @unique
  type         String // '2d', '3d', 'preview'
  status       String // 'success', 'failed'
  url          String?
  thumbnailUrl String?
  metadata     Json?
  createdAt    DateTime @default(now())

  @@index([renderId])
  @@index([type])
  @@index([status])
}

model RenderProgress {
  id         String   @id @default(cuid())
  renderId   String   @unique
  stage      String
  percentage Int
  message    String
  timestamp  DateTime @default(now())

  @@index([renderId])
}

model RenderError {
  id         String   @id @default(cuid())
  renderId   String
  error      String
  occurredAt DateTime @default(now())

  @@index([renderId])
}

model ExportResult {
  id        String   @id @default(cuid())
  renderId  String   @unique
  format    String // 'gltf', 'usdz', 'png', etc.
  url       String
  size      Int
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([renderId])
  @@index([format])
}

model ProductionStatus {
  id           String   @id @default(cuid())
  orderId      String   @unique
  currentStage String
  message      String
  percentage   Int
  lastUpdated  DateTime @default(now())

  @@index([orderId])
}

model QualityReport {
  id              String   @id @default(cuid())
  orderId         String   @unique
  overallScore    Float
  issues          String[]
  recommendations String[]
  passed          Boolean
  createdAt       DateTime @default(now())

  @@index([orderId])
}

model BatchRenderProgress {
  id          String   @id @default(cuid())
  batchId     String   @unique
  completed   Int
  total       Int
  percentage  Int
  results     Json?
  lastUpdated DateTime @default(now())

  @@index([batchId])
}

// ========================================
// E-COMMERCE INTEGRATIONS
// ========================================

model EcommerceIntegration {
  id           String    @id @default(cuid())
  brandId      String
  platform     String // 'shopify', 'woocommerce', 'magento'
  shopDomain   String
  accessToken  String?
  refreshToken String?
  config       Json
  status       String    @default("active")
  lastSyncAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  brand           Brand            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  productMappings ProductMapping[]
  syncLogs        SyncLog[]

  @@index([brandId])
  @@index([platform])
  @@index([shopDomain])
  @@index([status])
}

model ProductMapping {
  id                String   @id @default(cuid())
  integrationId     String
  luneoProductId    String
  externalProductId String
  externalSku       String
  syncStatus        String   @default("synced")
  lastSyncedAt      DateTime @default(now())
  metadata          Json?

  // Relations
  integration EcommerceIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  product     Product              @relation(fields: [luneoProductId], references: [id], onDelete: Cascade)

  @@unique([integrationId, externalProductId])
  @@index([integrationId])
  @@index([luneoProductId])
  @@index([externalProductId])
  @@index([externalSku])
}

model SyncLog {
  id             String   @id @default(cuid())
  integrationId  String
  type           String // 'product', 'order', 'inventory'
  direction      String // 'import', 'export'
  status         String // 'success', 'failed', 'partial'
  itemsProcessed Int      @default(0)
  itemsFailed    Int      @default(0)
  errors         Json?
  duration       Int // in milliseconds
  createdAt      DateTime @default(now())

  // Relations
  integration EcommerceIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model WebhookLog {
  id          String    @id @default(cuid())
  webhookId   String
  topic       String
  shopDomain  String
  payload     Json
  status      String    @default("received")
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([webhookId])
  @@index([topic])
  @@index([shopDomain])
  @@index([status])
  @@index([createdAt])
}

model ShopifyInstall {
  id            String    @id @default(cuid())
  shopDomain    String    @unique
  accessToken    String    // Encrypted access token
  webhookSecret String?    // Encrypted webhook secret
  installedAt    DateTime  @default(now())
  scopes         String[]  // Array of granted scopes
  status         String    @default("active") // active, revoked, suspended
  brandId        String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([shopDomain])
  @@index([status])
}

// ========================================
// ADDITIONAL MODELS
// ========================================

model Asset {
  id        String   @id @default(cuid())
  designId  String
  url       String
  type      String // 'image', 'model', 'texture', 'video'
  format    String
  size      Int
  width     Int?
  height    Int?
  metadata  Json?
  createdAt DateTime @default(now())

  // Relations
  design Design @relation(fields: [designId], references: [id], onDelete: Cascade)

  @@index([designId])
  @@index([type])
}

model AuditLog {
  id           String   @id @default(cuid())
  eventType    String
  userId       String
  userEmail    String?
  brandId      String?
  resourceType String
  resourceId   String
  action       String
  success      Boolean  @default(true)
  metadata     Json?
  timestamp    DateTime @default(now())
  ipAddress    String?
  userAgent    String?
  errorMessage String?

  @@index([userId])
  @@index([brandId])
  @@index([eventType])
  @@index([resourceType])
  @@index([resourceId])
  @@index([timestamp])
  @@index([success])
}

model UserConsent {
  id          String   @id @default(cuid())
  userId      String
  consentType String // 'privacy', 'marketing', 'analytics'
  granted     Boolean  @default(false)
  recordedAt  DateTime @default(now())
  ipAddress   String?
  userAgent   String?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([consentType])
  @@index([recordedAt])
}

model UsageMetric {
  id        String   @id @default(cuid())
  brandId   String
  metric    String // 'designs_created', 'renders_2d', 'api_calls', etc.
  value     Int
  unit      String // 'count', 'bytes', 'seconds'
  timestamp DateTime @default(now())
  metadata  Json?

  // Relations
  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([metric])
  @@index([timestamp])
}

model StripeWebhookEvent {
  id              String   @id @default(cuid())
  stripeEventId   String   @unique // Stripe event ID for idempotency
  eventType       String
  processed       Boolean  @default(false)
  processedAt     DateTime?
  payload         Json
  error           String?
  retryCount      Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([stripeEventId])
  @@index([eventType])
  @@index([processed])
  @@index([createdAt])
}

model RenderAuditLog {
  id              String   @id @default(cuid())
  brandId         String
  renderId        String
  renderType      String // '2d', '3d', 'preview'
  status          String // 'success', 'failed', 'cancelled'
  costCents       Int      @default(0) // Cost in cents
  creditsUsed     Int      @default(0) // Credits consumed
  durationMs      Int? // Render duration in milliseconds
  metadata        Json? // Additional render metadata
  createdAt       DateTime @default(now())

  // Relations
  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([renderId])
  @@index([renderType])
  @@index([status])
  @@index([createdAt])
}

// ========================================
// INDEXES FOR PERFORMANCE
// ========================================

// Note: Composite indexes are defined inline with models
