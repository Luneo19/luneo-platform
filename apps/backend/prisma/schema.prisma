// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================

enum UserRole {
  CONSUMER
  BRAND_USER
  BRAND_ADMIN
  PLATFORM_ADMIN
  FABRICATOR
}

enum OrderStatus {
  CREATED
  PENDING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum DesignStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
}

enum BrandStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
  VERIFIED
}

enum WebhookEventType {
  ORDER_CREATED
  ORDER_UPDATED
  ORDER_PAID
  DESIGN_CREATED
  DESIGN_COMPLETED
  PRODUCT_UPDATED
}

enum ZoneType {
  TEXT
  IMAGE
  PATTERN
  COLOR
}

enum CustomizationEffect {
  NORMAL
  EMBOSSED
  ENGRAVED
  THREE_D
}

enum CustomizationStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

// ========================================
// ENUMS POUR SAAS PERSONNALISATION
// ========================================

enum SubscriptionPlan {
  FREE
  STARTER
  PROFESSIONAL
  BUSINESS
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum GenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}

enum CustomizationType {
  TEXT
  IMAGE
  COLOR
  PATTERN
  FONT
  SIZE
  POSITION
}

// ========================================
// ENUMS POUR ASSET HUB
// ========================================

enum AssetFileType {
  IMAGE
  VIDEO
  DOCUMENT
  MODEL_3D
  AUDIO
  OTHER
}

// ========================================
// ENUMS POUR PROJECTS
// ========================================

enum ProjectType {
  DESIGN
  CAMPAIGN
  COLLECTION
  TEMPLATE
  VIRTUAL_TRY_ON
  CUSTOMIZER
  CONFIGURATOR
  OTHER
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  DELETED
}

// ========================================
// ENUMS POUR INTÉGRITÉ DES DONNÉES (ENUM-01)
// ========================================

enum SyncLogStatus {
  SUCCESS
  FAILED
  PARTIAL
}

enum SyncLogType {
  PRODUCT
  ORDER
  INVENTORY
}

enum SyncDirection {
  IMPORT
  EXPORT
}

enum KycStatus {
  PENDING
  VERIFIED
  REJECTED
  SUSPENDED
}

enum WorkOrderStatus {
  ASSIGNED
  ACCEPTED
  IN_PROGRESS
  QC_PENDING
  QC_PASSED
  QC_FAILED
  SHIPPED
  COMPLETED
  CANCELLED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
}

enum WorkspaceEnvironment {
  DEVELOPMENT
  STAGING
  PRODUCTION
}

// ========================================
// ENUMS POUR CONFIGURATOR 3D
// ========================================

enum ConfiguratorType {
  JEWELRY
  WATCH
  EYEWEAR
  FURNITURE
  APPAREL
  ACCESSORIES
  CUSTOM
}

enum ConfiguratorStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ComponentType {
  MESH
  MATERIAL
  TEXTURE
  COLOR
  DECAL
  ACCESSORY
  SIZE
  ENGRAVING
}

enum SelectionMode {
  SINGLE
  MULTIPLE
  REQUIRED
  OPTIONAL
}

enum DependencyMode {
  ALL
  ANY
}

enum Configurator3DOptionType {
  COLOR
  TEXTURE
  MATERIAL
  SIZE
  TEXT
  IMAGE
  MODEL
  NUMBER
  BOOLEAN
}

enum PricingType {
  FIXED
  PERCENTAGE
  REPLACEMENT
  FORMULA
}

enum RuleType {
  DEPENDENCY
  EXCLUSION
  COMBINATION
  VISIBILITY
  PRICING
  VALIDATION
}

enum Configurator3DSessionStatus {
  ACTIVE
  SAVED
  COMPLETED
  ABANDONED
  CONVERTED
  EXPIRED
}

enum ConversionType {
  ADD_TO_CART
  PURCHASE
  QUOTE_REQUEST
  SAVE_DESIGN
  SHARE
}

enum InteractionType {
  SESSION_START
  SESSION_END
  COMPONENT_SELECT
  OPTION_SELECT
  OPTION_CHANGE
  CAMERA_MOVE
  CAMERA_ZOOM
  CAMERA_ROTATE
  SCREENSHOT_CAPTURE
  AR_LAUNCH
  AR_PLACEMENT
  PRICE_VIEW
  ADD_TO_CART
  SAVE_DESIGN
  SHARE
  EXPORT
  UNDO
  REDO
  RESET
  HELP_OPEN
  ERROR
}

enum ExportType {
  PDF
  AR_IOS
  AR_ANDROID
  MODEL_3D
  IMAGE
  VIDEO
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum WebhookEvent {
  DESIGN_CREATED
  DESIGN_UPDATED
  DESIGN_COMPLETED
  DESIGN_FAILED
  ORDER_CREATED
  ORDER_UPDATED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  TEST
  GENERATION_STARTED
  GENERATION_COMPLETED
  GENERATION_FAILED
  AR_VIEW
}

// ========================================
// INDUSTRY ADAPTIVE DASHBOARD ENUMS
// ========================================

enum ModulePriority {
  PRIMARY
  SECONDARY
  AVAILABLE
  HIDDEN
}

enum CompanySize {
  SOLO
  SMALL_2_10
  MEDIUM_11_50
  LARGE_51_200
  ENTERPRISE_200_PLUS
}

enum PrimaryUseCase {
  CUSTOMIZER
  DESIGN_AI
  VISUALIZATION_3D
  AR_TRYON
  PRINT_PRODUCTION
  ALL
}

enum OnboardingActionType {
  TUTORIAL
  SETUP_GUIDE
  TEMPLATE_IMPORT
  INTEGRATION_CONNECT
  SKIP
}

enum MarketplaceItemType {
  TEMPLATE
  DESIGN
  MODEL_3D
  TEXTURE
  ANIMATION
  PROMPT_PACK
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  REFUNDED
}

enum MarketplacePayoutStatus {
  PENDING
  COMPLETED
  FAILED
}

// ========================================
// MODELS
// ========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String? // Null for OAuth users
  firstName     String?
  lastName      String?
  avatar        String?
  role          UserRole  @default(CONSUMER)
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?

  // 2FA
  is2FAEnabled  Boolean  @default(false) @map("is_2fa_enabled")
  twoFASecret   String?  @map("two_fa_secret")
  temp2FASecret String?  @map("temp_2fa_secret")
  backupCodes   String[] @default([]) @map("backup_codes")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp

  // Notification preferences (email, marketing, order updates, security alerts)
  notificationPreferences Json?

  // Relations
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: SetNull)

  designs        Design[]
  orders         Order[]
  refreshTokens  RefreshToken[]
  customizations Customization[]
  notifications  Notification[]

  // OAuth
  oauthAccounts OAuthAccount[]

  // Audit & Safety
  auditLogs         AuditLog[]
  moderationRecords ModerationRecord[]

  // Quotas
  userQuota UserQuota?

  // Experiments
  experimentAssignments ExperimentAssignment[]

  // Marketplace
  artisan Artisan?

  // GDPR
  userConsents UserConsent[]

  // Crédits IA
  aiCredits          Int       @default(0) @map("ai_credits")
  aiCreditsPurchased Int       @default(0) @map("ai_credits_purchased")
  aiCreditsUsed      Int       @default(0) @map("ai_credits_used")
  lastCreditPurchase DateTime? @map("last_credit_purchase")

  creditTransactions CreditTransaction[]

  // Support & Monitoring
  tickets          Ticket[]         @relation("TicketUser")
  ticketMessages   TicketMessage[]  @relation("TicketMessages")
  assignedTickets  Ticket[]         @relation("AssignedTickets")
  ticketActivities TicketActivity[] @relation("TicketActivities")

  // AI Studio
  aiGenerations AIGeneration[]
  aiCollections AICollection[]

  // Collaboration
  sharedResourcesCreated SharedResource[] @relation("SharedResourcesCreated")
  comments               Comment[]

  // Collections & Team
  designCollections    DesignCollection[]
  collectionItemsAdded DesignCollectionItem[] @relation("CollectionItemsAdded")
  libraryFavorites     LibraryFavorite[]
  teamMembers          TeamMember[]
  teamInvitesSent      TeamInvite[]           @relation("TeamInvitesSent")
  teamMembersInvited   TeamMember[]           @relation("TeamInviter")
  cliparts             Clipart[]

  // Super Admin - Customer relation
  customer Customer?

  // ORION - Customer health (Super Admin)
  healthScore CustomerHealthScore?

  // Orion Module 24
  aiTicketResponsesReviewed AITicketResponse[]  @relation("AIResponseReviewer")
  escalationHistoryEntries  EscalationHistory[] @relation("EscalationUser")
  aiTrainingExamples        AITrainingExample[] @relation("AITrainingCreator")

  // Discount & Referral
  discountUsages      DiscountUsage[]
  referralsAsReferrer Referral[]      @relation("Referrer")
  referralsAsReferred Referral?       @relation("Referred")
  commissions         Commission[]
  withdrawals         Withdrawal[]
  userProfile         UserProfile?
  downloads           Download[]

  // Observability
  traces Trace[] @relation("UserTraces")

  // AR Collaboration
  arProjects           ARProject[]        @relation("UserARProjects")
  arProjectMemberships ARProjectMember[]  @relation("UserARProjectMemberships")
  arProjectComments    ARProjectComment[] @relation("UserARProjectComments")

  // Shopping Cart
  carts Cart[] @relation("UserCart")

  // Knowledge Base
  knowledgeBaseArticles KnowledgeBaseArticle[] @relation("KBAuthor")

  // NPS
  npsResponses NPSResponse[] @relation("UserNPSResponses")

  // Visual Customizer V2 relations
  createdCustomizers  VisualCustomizer[]           @relation("UserCreatedCustomizers")
  createdPresets      VisualCustomizerPreset[]     @relation("UserCreatedPresets")
  uploadedAssets      CustomizerAsset[]            @relation("UserUploadedAssets")
  customizerSessions  CustomizerSession[]          @relation("UserCustomizerSessions")
  savedDesigns        CustomizerSavedDesign[]      @relation("UserSavedDesigns")
  customizerExports   CustomizerExport[]           @relation("UserCustomizerExports")
  moderationReviews   CustomizerModerationRecord[] @relation("UserModerationReviews")
  customizerAuditLogs CustomizerAuditLog[]         @relation("UserCustomizerAuditLogs")

  @@index([email])
  @@index([brandId])
  @@index([role])
  @@index([aiCredits])
  @@index([deletedAt]) // Soft delete index for efficient queries on active users
  // Composite indexes for multi-tenant queries
  @@index([brandId, role])
  @@index([brandId, isActive])
  @@index([brandId, createdAt])
  @@index([lastLoginAt]) // Cache warming & active-session queries
}

model Download {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resourceId   String   @map("resource_id")
  resourceType String   @map("resource_type") // design, template, clipart, product
  fileUrl      String?  @map("file_url")
  fileSize     Int?     @map("file_size")
  format       String?
  downloadedAt DateTime @default(now()) @map("downloaded_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([userId, downloadedAt])
  @@index([resourceType])
  @@index([resourceId, resourceType])
  @@map("downloads")
}

model OAuthAccount {
  id           String    @id @default(cuid())
  provider     String // google, github, etc.
  providerId   String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // SEC-08: Token rotation et détection de réutilisation
  family    String    @default(cuid()) // Identifiant de chaîne de tokens
  usedAt    DateTime? // Null si pas encore utilisé, date si déjà consommé
  revokedAt DateTime? // Révoqué suite à détection de réutilisation

  // SECURITY FIX: Session metadata for suspicious activity detection
  ipAddress  String? // IP address at token creation
  userAgent  String? // User agent at token creation
  deviceInfo String? // Parsed device info (browser, OS)

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([family])
}

model Brand {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  logo        String?
  industry    String? // e.g. "jewelry", "watches", "glasses", "other"
  website     String?
  status      BrandStatus @default(PENDING_VERIFICATION)

  // KYC Fields
  companyName String?
  vatNumber   String?
  address     String?
  city        String?
  country     String?
  postalCode  String?
  phone       String?

  // Billing
  stripeCustomerId     String?
  stripeSubscriptionId String? // Stripe subscription ID
  plan                 String    @default("free")
  planExpiresAt        DateTime?
  limits               Json? // Brand limits configuration

  // Budgets (for AI costs)
  aiCostLimitCents Int?      @default(500000) // 5000€ default limit
  aiCostUsedCents  Int       @default(0)
  aiCostResetAt    DateTime? // Monthly reset

  // Settings
  settings      Json? // Brand-specific settings (legacy - utiliser ClientSettings)
  webhookUrl    String?
  webhookSecret String?

  // NOUVEAU: Champs pour SaaS personnalisation
  subscriptionPlan      SubscriptionPlan   @default(FREE)
  subscriptionStatus    SubscriptionStatus @default(TRIALING)
  trialEndsAt           DateTime?
  monthlyGenerations    Int                @default(0)
  maxMonthlyGenerations Int                @default(5)
  maxProducts           Int                @default(2)
  arEnabled             Boolean            @default(false)
  whiteLabel            Boolean            @default(false)

  // Grace period & read-only (failed payment)
  gracePeriodEndsAt    DateTime? // When grace period expires (null = no grace period)
  readOnlyMode         Boolean   @default(false) // If true, only billing/read endpoints allowed
  lastGraceReminderDay Int? // Last grace reminder sent: 0, 1, or 2 (for day 0, 1, 2)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  users                 User[]
  products              Product[]
  designs               Design[]
  orders                Order[]
  webhooks              Webhook[]
  webhookSubscriptions  WebhookSubscription[]
  apiKeys               ApiKey[]
  aiCosts               AICost[]
  ecommerceIntegrations EcommerceIntegration[]
  usageMetrics          UsageMetric[]
  customizations        Customization[]

  // Analytics Avancées
  analyticsEvents      AnalyticsEvent[]
  analyticsFunnels     AnalyticsFunnel[]
  analyticsCohorts     AnalyticsCohort[]
  analyticsSegments    AnalyticsSegment[]
  analyticsPredictions AnalyticsPrediction[]

  // AI Studio
  aiGenerations AIGeneration[]
  aiCollections AICollection[]

  // Collaboration
  sharedResources SharedResource[]

  // NOUVEAU: Relations SaaS personnalisation
  clientSettings ClientSettings?
  generations    Generation[]
  templates      Template[]
  invoices       Invoice[]

  // Collections & Team
  designCollections DesignCollection[]
  teamMembers       TeamMember[]
  teamInvites       TeamInvite[]
  cliparts          Clipart[]

  // Agents IA
  agentConversations   AgentConversation[]
  novaTickets          NovaTicket[]
  lunaGenerations      LunaGeneration[]
  ariaAnalyses         AriaAnalysis[]
  ragDocuments         RAGDocument[]
  agentPromptTemplates AgentPromptTemplate[]
  agentMetrics         AgentMetric[]
  agentAlerts          AgentAlert[]

  // SSO Enterprise
  ssoConfigurations SSOConfiguration[]

  // Discounts
  discounts Discount[]

  // Print-on-Demand
  printOrders PrintOrder[]

  // Audit & Safety
  auditLogs         AuditLog[]
  moderationRecords ModerationRecord[]

  // Workspaces & Projects
  workspaces                   Workspace[]
  projects                     Project[]
  configurator3DConfigurations Configurator3DConfiguration[]

  // AR Collaboration
  arProjects ARProject[] @relation("BrandARProjects")

  // Observability
  traces Trace[] @relation("BrandTraces")

  // Feature Flags
  featureFlags FeatureFlag[] @relation("BrandFeatureFlags")

  // Marketplace (Phase 8 - templates & assets between brands)
  marketplaceItems     MarketplaceItem[]     @relation("MarketplaceSeller")
  marketplaceReviews   MarketplaceReview[]   @relation("MarketplaceReviewer")
  marketplacePurchases MarketplacePurchase[] @relation("MarketplaceBuyer")

  // Usage Records
  usageRecords UsageRecord[]

  // Try-On Conversions, Shares & Widget Config
  tryOnConversions  TryOnConversion[]
  tryOnShares       TryOnShare[]
  tryOnWidgetConfig TryOnWidgetConfig?

  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // P2-6: Multi-tenancy relations for CRM/Email/Experiment models
  experiments      Experiment[]      @relation("BrandExperiments")
  customerSegments CustomerSegment[] @relation("BrandCustomerSegments")
  emailCampaigns   EmailCampaign[]   @relation("BrandEmailCampaigns")
  emailAutomations EmailAutomation[] @relation("BrandEmailAutomations")

  // Visual Customizer V2 relations
  visualCustomizers     VisualCustomizer[]           @relation("BrandVisualCustomizers")
  customizerAssets      CustomizerAsset[]            @relation("BrandCustomizerAssets")
  clipartCategories     ClipartCategory[]            @relation("BrandClipartCategories")
  customizerModerations CustomizerModerationRecord[] @relation("BrandCustomizerModerations")

  // PCE
  pipelines        Pipeline[]
  renderJobs       RenderJob[]
  renderBatches    RenderBatch[]
  renderUsage      RenderUsage[]
  productionOrders ProductionOrder[]
  podProviders     PODProvider[]
  returns          Return[]
  shippingRates    ShippingRate[]

  // Orion Module 24
  tickets            Ticket[]            @relation("BrandTickets")
  supportSLAPolicies SupportSLAPolicy[]
  escalationRules    EscalationRule[]
  supportMacros      SupportMacro[]
  orionAutomationsV2 OrionAutomationV2[]
  securityThreats    SecurityThreat[]
  blockedIPs         BlockedIP[]

  @@index([slug])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([subscriptionPlan])
  @@index([subscriptionStatus])
  @@index([deletedAt])
  // DB-01: Index manquants sur champs date critiques
  @@index([trialEndsAt])
  @@index([planExpiresAt])
  @@index([subscriptionStatus, trialEndsAt])
  @@index([organizationId])
}

// ========================================
// MARKETPLACE (Phase 8 - templates & assets between brands)
// ========================================

model MarketplaceItem {
  id            String              @id @default(cuid())
  sellerId      String // Brand ID of the seller
  seller        Brand               @relation("MarketplaceSeller", fields: [sellerId], references: [id], onDelete: Restrict)
  title         String
  description   String?             @db.Text
  type          MarketplaceItemType
  category      String? // jewelry, watches, glasses, etc.
  tags          String[]
  price         Decimal             @db.Decimal(10, 2) // 0 = free
  currency      String              @default("CHF")
  previewImages String[]
  fileUrl       String? // URL to the downloadable asset
  fileType      String? // glb, png, json, etc.
  downloads     Int                 @default(0)
  rating        Decimal?            @db.Decimal(3, 2)
  reviewCount   Int                 @default(0)
  isActive      Boolean             @default(true)
  isFeatured    Boolean             @default(false)
  metadata      Json? // Additional info (dimensions, file size, etc.)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  reviews   MarketplaceReview[]
  purchases MarketplacePurchase[]

  @@index([sellerId])
  @@index([type])
  @@index([category])
  @@index([isActive, isFeatured])
}

model MarketplaceReview {
  id        String          @id @default(cuid())
  itemId    String
  item      MarketplaceItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  buyerId   String // Brand ID of the reviewer
  buyer     Brand           @relation("MarketplaceReviewer", fields: [buyerId], references: [id])
  rating    Int // 1-5
  comment   String?         @db.Text
  createdAt DateTime        @default(now())

  @@unique([itemId, buyerId])
  @@index([itemId])
  @@index([buyerId])
}

model MarketplacePurchase {
  id                String                  @id @default(cuid())
  itemId            String
  item              MarketplaceItem         @relation(fields: [itemId], references: [id])
  buyerId           String // Brand ID of the buyer
  buyer             Brand                   @relation("MarketplaceBuyer", fields: [buyerId], references: [id])
  price             Decimal                 @db.Decimal(10, 2)
  currency          String                  @default("CHF")
  status            PurchaseStatus          @default(COMPLETED)
  commissionPercent Int? // Platform commission % (from seller's plan)
  commissionCents   Int? // Platform commission amount in cents
  payoutScheduledAt DateTime? // When seller payout is due (createdAt + 7 days)
  payoutStatus      MarketplacePayoutStatus @default(PENDING)
  paidOutAt         DateTime? // When Stripe transfer was completed
  createdAt         DateTime                @default(now())

  @@index([buyerId])
  @@index([itemId])
  @@index([payoutScheduledAt, payoutStatus])
}

// ========================================
// ORGANIZATION & INDUSTRY
// ========================================

model Organization {
  id                    String          @id @default(cuid())
  name                  String
  slug                  String          @unique
  industryId            String?
  industry              Industry?       @relation(fields: [industryId], references: [id])
  onboardingCompletedAt DateTime?
  onboardingCurrentStep Int             @default(0)
  companySize           CompanySize?
  primaryUseCase        PrimaryUseCase?
  businessGoals         Json?
  dashboardLayout       Json?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  brands               Brand[]
  onboardingProgress   OnboardingProgress[]
  dashboardPreferences UserDashboardPreference[]

  @@index([slug])
  @@index([industryId])
}

model Industry {
  id          String   @id @default(cuid())
  slug        String   @unique
  labelFr     String
  labelEn     String
  icon        String
  accentColor String
  description String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizations   Organization[]
  moduleConfigs   IndustryModuleConfig[]
  widgetConfigs   IndustryWidgetConfig[]
  kpiConfigs      IndustryKpiConfig[]
  templates       IndustryTemplate[]
  terminology     IndustryTerminology[]
  onboardingSteps IndustryOnboarding[]

  @@index([slug])
  @@index([isActive, sortOrder])
}

model IndustryModuleConfig {
  id               String         @id @default(cuid())
  industryId       String
  industry         Industry       @relation(fields: [industryId], references: [id], onDelete: Cascade)
  moduleSlug       String
  priority         ModulePriority @default(AVAILABLE)
  sortOrder        Int            @default(0)
  isDefaultEnabled Boolean        @default(true)
  defaultSettings  Json?

  @@unique([industryId, moduleSlug])
  @@index([industryId])
}

model IndustryWidgetConfig {
  id               String   @id @default(cuid())
  industryId       String
  industry         Industry @relation(fields: [industryId], references: [id], onDelete: Cascade)
  widgetSlug       String
  position         Int      @default(0)
  gridColumn       Int      @default(1)
  gridRow          Int      @default(1)
  gridWidth        Int      @default(1)
  gridHeight       Int      @default(1)
  isDefaultVisible Boolean  @default(true)

  @@unique([industryId, widgetSlug])
  @@index([industryId])
}

model IndustryKpiConfig {
  id                String   @id @default(cuid())
  industryId        String
  industry          Industry @relation(fields: [industryId], references: [id], onDelete: Cascade)
  kpiSlug           String
  labelFr           String
  labelEn           String
  icon              String
  sortOrder         Int      @default(0)
  isDefaultVisible  Boolean  @default(true)
  calculationMethod String?

  @@unique([industryId, kpiSlug])
  @@index([industryId])
}

model IndustryTemplate {
  id           String   @id @default(cuid())
  industryId   String
  industry     Industry @relation(fields: [industryId], references: [id], onDelete: Cascade)
  name         String
  description  String?
  thumbnailUrl String?
  templateData Json?
  productType  String?
  is3D         Boolean  @default(false)
  modelUrl     String?
  sortOrder    Int      @default(0)

  @@index([industryId])
}

model IndustryTerminology {
  id           String   @id @default(cuid())
  industryId   String
  industry     Industry @relation(fields: [industryId], references: [id], onDelete: Cascade)
  genericTerm  String
  customTermFr String
  customTermEn String
  context      String   @default("all")

  @@unique([industryId, genericTerm, context])
  @@index([industryId])
}

model IndustryOnboarding {
  id            String               @id @default(cuid())
  industryId    String
  industry      Industry             @relation(fields: [industryId], references: [id], onDelete: Cascade)
  stepOrder     Int
  titleFr       String
  titleEn       String
  descriptionFr String?
  descriptionEn String?
  videoUrl      String?
  actionType    OnboardingActionType @default(TUTORIAL)
  actionPayload Json?

  @@unique([industryId, stepOrder])
  @@index([industryId])
}

model OnboardingProgress {
  id                String       @id @default(cuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId            String
  step1Profile      Json?
  step1CompletedAt  DateTime?
  step2Industry     String?
  step2CompletedAt  DateTime?
  step3UseCases     Json?
  step3CompletedAt  DateTime?
  step4Goals        Json?
  step4CompletedAt  DateTime?
  step5Integrations Json?
  step5CompletedAt  DateTime?
  completedAt       DateTime?
  skippedAt         DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model UserDashboardPreference {
  id                String       @id @default(cuid())
  userId            String
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  widgetOverrides   Json?
  sidebarOrder      Json?
  pinnedModules     Json?
  lastVisitedModule String?
  dashboardTheme    String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

// ========================================
// AR COLLABORATION
// ========================================

model ARProject {
  id          String   @id @default(cuid())
  name        String
  description String?
  thumbnail   String?
  brandId     String
  ownerId     String
  status      String   @default("active")
  settings    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  brand    Brand              @relation("BrandARProjects", fields: [brandId], references: [id], onDelete: Cascade)
  owner    User               @relation("UserARProjects", fields: [ownerId], references: [id], onDelete: Cascade)
  members  ARProjectMember[]
  comments ARProjectComment[]

  // AR Studio Enterprise relations
  models             AR3DModel[]
  imageTargets       ARImageTarget[]
  qrCodes            ARQRCode[]
  sessions           ARSession[]           @relation("ProjectARSessions")
  conversionFunnels  ARConversionFunnel[]
  heatmapData        ARHeatmapData[]
  collaborationRooms ARCollaborationRoom[]

  @@index([brandId])
  @@index([ownerId])
}

model ARProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      String   @default("viewer")
  joinedAt  DateTime @default(now())

  project ARProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User      @relation("UserARProjectMemberships", fields: [userId], references: [id])

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model ARProjectComment {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project ARProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User      @relation("UserARProjectComments", fields: [userId], references: [id])

  @@index([projectId])
  @@index([userId])
}

// ========================================
// AR STUDIO ENTERPRISE - ENUMS
// ========================================

enum ModelValidationStatus {
  PENDING
  VALIDATING
  VALID
  INVALID
  FIXED_AUTOMATICALLY
}

enum ARConversionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum TrackingQuality {
  EXCELLENT
  GOOD
  FAIR
  POOR
  UNUSABLE
}

enum TriggerAction {
  SHOW_3D_MODEL
  PLAY_VIDEO
  OPEN_URL
  SHOW_INFO_CARD
  START_ANIMATION
  LAUNCH_CONFIGURATOR
}

enum QRCodeType {
  AR_VIEWER
  PRODUCT_PAGE
  CONFIGURATOR
  MARKETING_CAMPAIGN
  PRINT_CATALOG
}

enum ARInteractionType {
  SESSION_START
  SESSION_END
  MODEL_PLACED
  MODEL_MOVED
  MODEL_ROTATED
  MODEL_SCALED
  MODEL_REMOVED
  SCREENSHOT_TAKEN
  SCREENSHOT_SHARED
  SURFACE_DETECTED
  SURFACE_SELECTED
  TARGET_RECOGNIZED
  TARGET_LOST
  ERROR_OCCURRED
  CONVERSION
}

enum PlacementMode {
  GROUND_PLANE
  TABLE_TOP
  WALL
  WRIST
  FACE
  FREE
}

enum ARTrackingType {
  WORLD
  IMAGE
  BODY
  FACE
}

enum ARRoomStatus {
  WAITING
  ACTIVE
  ENDED
}

// ========================================
// AR STUDIO ENTERPRISE - 3D MODELS
// ========================================

model AR3DModel {
  id        String    @id @default(cuid())
  projectId String
  project   ARProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name      String

  // Source file
  originalFileName String
  originalFormat   String
  originalFileURL  String
  originalFileSize Int

  // Converted files
  gltfURL      String?
  gltfDracoURL String?
  usdzURL      String?
  thumbnailURL String?

  // LODs (Level of Detail)
  lodLevels Json? // { lod0: url, lod1: url, lod2: url }

  // Metadata
  polyCount     Int   @default(0)
  textureCount  Int   @default(0)
  materialCount Int   @default(0)
  dimensions    Json? // { width, height, depth } in cm
  boundingBox   Json? // { min: {x,y,z}, max: {x,y,z} }

  // Validation
  validationStatus ModelValidationStatus @default(PENDING)
  validationErrors String[]
  autoFixApplied   String[]

  // Performance estimates
  estimatedLoadTime Json? // { mobile: ms, desktop: ms }
  recommendedLOD    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  conversions    ARModelConversion[]
  imageTargets   ARImageTarget[]     @relation("ModelImageTargets")
  sessions       ARSession[]         @relation("ModelARSessions")
  heatmapData    ARHeatmapData[]     @relation("ModelHeatmaps")
  productConfigs ProductARConfig[]   @relation("PrimaryARModel")

  @@index([projectId])
  @@index([validationStatus])
}

model ARModelConversion {
  id      String    @id @default(cuid())
  modelId String
  model   AR3DModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

  sourceFormat String
  targetFormat String
  status       ARConversionStatus @default(PENDING)

  // Metrics
  processingTime   Int? // ms
  compressionRatio Float? // 0.x = x% of original size
  qualityScore     Float? // 0-1

  // Error details
  errorMessage String? @db.Text
  errorStack   String? @db.Text

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([modelId])
  @@index([status])
}

// ========================================
// AR STUDIO ENTERPRISE - IMAGE TARGETS
// ========================================

model ARImageTarget {
  id        String    @id @default(cuid())
  projectId String
  project   ARProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name         String
  imageURL     String
  thumbnailURL String?

  // Tracking data
  featureDescriptor Bytes?
  featurePoints     Int?

  // Quality assessment
  trackingQuality TrackingQuality @default(FAIR)
  qualityScore    Float           @default(0)
  qualityIssues   String[]
  recommendations String[]

  // Physical dimensions (for AR scale)
  physicalWidth  Float // cm
  physicalHeight Float // cm

  // Linked 3D model
  linkedModelId String?
  linkedModel   AR3DModel? @relation("ModelImageTargets", fields: [linkedModelId], references: [id], onDelete: SetNull)

  // Trigger configuration
  triggerAction TriggerAction @default(SHOW_3D_MODEL)
  triggerConfig Json? // { animation: "rotate", autoplay: true, etc. }

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([linkedModelId])
  @@index([isActive])
}

// ========================================
// AR STUDIO ENTERPRISE - QR CODES
// ========================================

model ARQRCode {
  id        String    @id @default(cuid())
  projectId String
  project   ARProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Content
  type      QRCodeType
  targetURL String
  shortCode String     @unique

  // Customization
  logoURL         String?
  foregroundColor String  @default("#000000")
  backgroundColor String  @default("#FFFFFF")
  style           String  @default("squares") // squares, dots, rounded
  size            Int     @default(300) // pixels
  errorCorrection String  @default("M") // L, M, Q, H

  // Generated files
  pngURL String?
  svgURL String?
  pdfURL String?

  // Analytics counters
  scanCount      Int       @default(0)
  uniqueScanners Int       @default(0)
  lastScannedAt  DateTime?

  // Metadata
  name        String
  description String?
  tags        String[]

  isActive  Boolean   @default(true)
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  scans ARQRScan[]

  @@index([shortCode])
  @@index([projectId])
  @@index([isActive])
}

model ARQRScan {
  id       String   @id @default(cuid())
  qrCodeId String
  qrCode   ARQRCode @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)

  // Context
  platform String
  browser  String
  device   String
  country  String?
  city     String?

  // Session tracking
  sessionId String?
  userId    String?

  // AR journey
  landedOnAR Boolean @default(false)
  arDuration Int? // seconds
  conversion String? // add_to_cart, purchase, share

  scannedAt DateTime @default(now())

  @@index([qrCodeId, scannedAt])
  @@index([platform])
}

// ========================================
// AR STUDIO ENTERPRISE - SESSIONS & ANALYTICS
// ========================================

model ARSession {
  id        String     @id @default(cuid())
  projectId String
  project   ARProject  @relation("ProjectARSessions", fields: [projectId], references: [id], onDelete: Cascade)
  modelId   String?
  model     AR3DModel? @relation("ModelARSessions", fields: [modelId], references: [id], onDelete: SetNull)
  userId    String?

  // Device context
  platform String // ios, android, desktop
  device   String
  browser  String
  arMethod String // webxr, quick-look, scene-viewer

  // Features used during session
  featuresUsed String[] // plane-detection, light-estimation, etc.

  // Duration
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  duration  Int? // seconds

  // Interaction counters
  placementCount   Int @default(0)
  rotationCount    Int @default(0)
  scaleChangeCount Int @default(0)
  screenshotsTaken Int @default(0)
  shareCount       Int @default(0)

  // Experience quality
  trackingQuality Float? // 0-1 average over session
  fpsAverage      Int?
  fpsMin          Int?
  errors          String[]

  // Conversion
  conversionAction String? // add_to_cart, purchase, wishlist
  conversionValue  Float? // value in EUR

  // Geolocation (for analytics)
  country String?
  region  String?

  // Relations
  interactions       ARInteraction[]
  performanceMetrics ARPerformanceMetric[]

  @@index([projectId, startedAt])
  @@index([modelId])
  @@index([platform])
  @@index([userId])
}

model ARInteraction {
  id        String    @id @default(cuid())
  sessionId String
  session   ARSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  type      ARInteractionType
  timestamp DateTime          @default(now())

  // 3D position in AR space
  position Json? // { x, y, z }
  rotation Json? // { x, y, z, w }
  scale    Float?

  // Context
  modelId  String?
  targetId String? // Image target ID

  // Additional data
  metadata Json?

  @@index([sessionId, timestamp])
  @@index([type])
}

model ARPerformanceMetric {
  id        String    @id @default(cuid())
  sessionId String
  session   ARSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  timestamp     DateTime @default(now())
  fps           Int
  memoryUsage   Int // MB
  batteryDrain  Float? // % per minute
  thermalState  String? // normal, fair, serious, critical
  trackingState String // tracking, limited, notAvailable

  @@index([sessionId, timestamp])
}

model ARConversionFunnel {
  id        String    @id @default(cuid())
  projectId String
  project   ARProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  date      DateTime

  // Funnel stages
  qrScans         Int @default(0)
  arLaunches      Int @default(0)
  modelPlacements Int @default(0)
  engagedSessions Int @default(0) // >30s
  screenshots     Int @default(0)
  shares          Int @default(0)
  addToCarts      Int @default(0)
  purchases       Int @default(0)

  // Revenue
  totalRevenue  Float @default(0)
  avgOrderValue Float @default(0)

  @@unique([projectId, date])
  @@index([projectId])
}

model ARHeatmapData {
  id        String    @id @default(cuid())
  projectId String
  project   ARProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  modelId   String
  model     AR3DModel @relation("ModelHeatmaps", fields: [modelId], references: [id], onDelete: Cascade)

  // Aggregated data (daily update)
  viewAngleDistribution Json // Distribution of viewing angles
  scaleDistribution     Json // Distribution of scales used
  placementHeatmap      Json // Frequent placement zones
  interactionHotspots   Json // Frequent interaction points

  date DateTime

  @@unique([projectId, modelId, date])
  @@index([projectId])
  @@index([modelId])
}

// ========================================
// AR STUDIO ENTERPRISE - E-COMMERCE AR CONFIG
// ========================================

model ProductARConfig {
  id        String  @id @default(cuid())
  productId String  @unique
  product   Product @relation("ProductARConfiguration", fields: [productId], references: [id], onDelete: Cascade)

  // Primary 3D model
  primaryModelId String
  primaryModel   AR3DModel @relation("PrimaryARModel", fields: [primaryModelId], references: [id])

  // Variant models mapping
  variantModels Json? // { "color:gold": modelId, "color:silver": modelId }

  // Placement configuration
  defaultScale    Float         @default(1.0)
  defaultRotation Json          @default("{\"x\":0,\"y\":0,\"z\":0}")
  placementMode   PlacementMode @default(GROUND_PLANE)

  // UI overlay in AR
  showPriceInAR     Boolean @default(true)
  showBuyButton     Boolean @default(true)
  showVariantPicker Boolean @default(true)
  overlayPosition   String  @default("bottom") // top, bottom, floating

  // Tracking type
  trackingType  ARTrackingType @default(WORLD)
  imageTargetId String?

  // Analytics counters
  impressions Int @default(0)
  arLaunches  Int @default(0)
  conversions Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([primaryModelId])
}

// ========================================
// AR STUDIO ENTERPRISE - COLLABORATION ROOMS
// ========================================

model ARCollaborationRoom {
  id        String    @id @default(cuid())
  projectId String
  project   ARProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name       String
  hostUserId String

  // State
  status          ARRoomStatus @default(WAITING)
  maxParticipants Int          @default(10)

  // Configuration
  allowVoiceChat    Boolean @default(true)
  allowAnnotations  Boolean @default(true)
  allowModelEditing Boolean @default(false)

  // Cloud Anchors (shared spatial anchors)
  cloudAnchors Json? // Array of cloud anchor data

  createdAt DateTime  @default(now())
  endedAt   DateTime?

  // Relations
  participants ARRoomParticipant[]

  @@index([projectId, status])
  @@index([hostUserId])
}

model ARRoomParticipant {
  id     String              @id @default(cuid())
  roomId String
  room   ARCollaborationRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  userId String

  role     String    @default("viewer") // host, editor, viewer
  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  // Presence
  platform   String
  lastPingAt DateTime @default(now())

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
}

// ========================================
// CLIENT SETTINGS (SaaS Personnalisation)
// ========================================

model ClientSettings {
  id      String @id @default(cuid())
  brandId String @unique
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  // UI Customization
  primaryColor   String @default("#000000")
  secondaryColor String @default("#ffffff")
  fontFamily     String @default("Inter")
  borderRadius   Int    @default(8)

  // AI Settings
  defaultAiProvider String  @default("openai")
  customApiKey      String?
  defaultQuality    String  @default("standard")
  defaultStyle      String  @default("realistic")

  // AR Settings
  arTrackingType String @default("face")
  arQuality      String @default("medium")

  // Notifications
  emailNotifications Boolean @default(true)
  webhookEnabled     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
}

model Product {
  id          String  @id @default(cuid())
  name        String
  slug        String // NOUVEAU: Slug pour URL
  description String?
  sku         String?
  price       Decimal @db.Decimal(10, 2)
  currency    String  @default("EUR")

  // Images
  images       String[] // Array of image URLs
  baseAssetUrl String? // Base asset URL for rendering
  baseImage    String? // NOUVEAU: Base image pour génération
  baseImageUrl String? // NOUVEAU: Base image URL
  thumbnailUrl String? // NOUVEAU: Thumbnail URL

  // 3D Model
  model3dUrl  String?
  modelConfig Json? // 3D model configuration

  // Customization & Product Engine
  customizationOptions Json? // Available customization options
  rulesJson            Json? // Product Rules Engine configuration

  // Manufacturing & Cost
  baseCostCents     Int? // Base manufacturing cost in cents
  laborCostCents    Int? // Labor cost in cents
  overheadCostCents Int? // Overhead cost in cents
  materialOptions   Json? // Available materials with pricing
  finishOptions     Json? // Available finishes with pricing
  productionTime    Int? // Estimated production time in hours

  // NOUVEAU: Champs pour génération IA
  promptTemplate    String? // Template de prompt pour génération
  negativePrompt    String? // Negative prompt
  aiProvider        String  @default("openai") // Provider IA par défaut
  generationQuality String  @default("standard") // standard, hd
  outputFormat      String  @default("png") // png, jpg, webp
  outputWidth       Int     @default(1024)
  outputHeight      Int     @default(1024)

  // NOUVEAU: Champs AR
  arEnabled      Boolean @default(true)
  arTrackingType String  @default("surface") // face, body, hand, surface
  arScale        Float   @default(1.0)
  arOffset       Json? // Offset 3D { x, y, z }

  // Status
  isActive Boolean       @default(true)
  isPublic Boolean       @default(true)
  status   ProductStatus @default(DRAFT) // NOUVEAU: Status explicite
  category String? // NOUVEAU: Catégorie produit
  tags     String[] // NOUVEAU: Tags

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime? // NOUVEAU: Date de publication
  deletedAt   DateTime? // Soft delete timestamp

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  designs         Design[]
  orders          Order[]          @relation("OrderProduct") // Relation nommée
  orderItems      OrderItem[]      @relation("OrderItemProduct") // NOUVEAU
  productMappings ProductMapping[]
  zones           Zone[]
  customizations  Customization[]

  // NOUVEAU: Lien vers DesignSpec
  specs DesignSpec[] @relation("ProductSpecs") // NOUVEAU

  // NOUVEAU: Customizable Areas (Zakeke-like)
  customizableAreas CustomizableArea[]

  // NOUVEAU: Relations SaaS personnalisation
  customizationZones CustomizationZone[] // Zones de personnalisation pour widget
  generations        Generation[] // Générations depuis widget
  templates          Template[] // Templates de prompts

  // Try-On relations
  tryOnMappings    TryOnProductMapping[]
  tryOnScreenshots TryOnScreenshot[]
  tryOnConversions TryOnConversion[]
  tryOnShares      TryOnShare[]

  // 3D configurator
  product3DConfig Product3DConfiguration?

  // AR Studio Enterprise
  productARConfig ProductARConfig? @relation("ProductARConfiguration")

  // Variants & Inventory
  variants ProductVariant[]

  // Visual Customizer V2
  visualCustomizers VisualCustomizer[] @relation("ProductVisualCustomizers")

  @@unique([brandId, slug]) // NOUVEAU: Unique par brand
  @@index([brandId])
  @@index([isActive])
  @@index([isPublic])
  @@index([brandId, isActive]) // NOUVEAU: Composite
  @@index([status])
  @@index([deletedAt]) // Soft delete index for efficient queries on active products
  // Composite indexes for filtered queries
  @@index([brandId, status])
  @@index([brandId, createdAt])
  @@index([brandId, category])
}

model ProductVariant {
  id                String   @id @default(cuid())
  productId         String
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku               String?
  name              String // e.g. "Or Rose 18K - Taille 52"
  attributes        Json // { color: "Or Rose", size: "52", material: "18K" }
  price             Decimal? @db.Decimal(10, 2) // null = use product price
  compareAtPrice    Decimal? @db.Decimal(10, 2)
  stock             Int      @default(0)
  lowStockThreshold Int      @default(5)
  images            String[]
  weight            Decimal? @db.Decimal(10, 2)
  barcode           String?
  isActive          Boolean  @default(true)
  position          Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([productId])
  @@index([sku])
}

model Product3DConfiguration {
  id             String   @id @default(cuid())
  productId      String   @unique
  modelUrl       String?
  textureUrl     String?
  materialType   String   @default("standard")
  environmentMap String?
  lightingPreset String   @default("studio")
  cameraPosition Json?
  cameraTarget   Json?
  customZones    Json?
  renderSettings Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

// ========================================
// CUSTOMIZATION ZONE (SaaS Personnalisation)
// ========================================

model CustomizationZone {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  name String
  type CustomizationType

  positionX Float
  positionY Float
  width     Float
  height    Float
  rotation  Float @default(0)

  maxLength     Int?
  allowedChars  String?
  allowedFonts  String[]
  allowedColors String[]
  minSize       Int?
  maxSize       Int?

  defaultValue String?
  defaultFont  String?
  defaultColor String?
  defaultSize  Int?

  renderStyle String @default("engraved")

  order    Int     @default(0)
  required Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([productId, order])
}

// ========================================
// TEMPLATE (SaaS Personnalisation)
// ========================================

model Template {
  id        String   @id @default(cuid())
  brandId   String
  brand     Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  name        String
  description String?

  promptTemplate String
  negativePrompt String?
  variables      Json

  aiProvider String @default("openai")
  model      String @default("dall-e-3")
  quality    String @default("standard")
  style      String @default("natural")

  exampleOutputs String[]

  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([productId])
  @@index([brandId, isActive])
  @@index([brandId, createdAt])
}

model Design {
  id          String  @id @default(cuid())
  name        String?
  description String?

  // Generation
  prompt      String
  promptHash  String? // For caching
  options     Json // Generation options
  optionsJson Json? // Legacy field for compatibility
  status      DesignStatus @default(PENDING)

  // Results
  previewUrl String? // Low-res preview
  highResUrl String? // High-res result
  imageUrl   String? // Main image URL
  renderUrl  String? // Render URL
  metadata   Json? // AI generation metadata

  // NOUVEAU: Widget Editor Data (Zakeke-like)
  canvasWidth           Int? // Canvas width in pixels
  canvasHeight          Int? // Canvas height in pixels
  canvasBackgroundColor String? @default("#ffffff") // Background color
  designData            Json? // Full design data from widget (DesignData type)

  // Cost tracking
  costCents Int     @default(0)
  provider  String? // AI provider used

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  deletedAt   DateTime? // Soft delete timestamp

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // NOUVEAU: Lien vers DesignSpec
  specId String?
  spec   DesignSpec? @relation(fields: [specId], references: [id], onDelete: SetNull)

  orders         Order[]         @relation("OrderDesign") // Relation nommée pour éviter conflit
  orderItems     OrderItem[]     @relation("OrderItemDesign") // NOUVEAU
  assets         Asset[]
  customizations Customization[]
  versions       DesignVersion[] // Historique des versions
  RenderResult   RenderResult[]

  // NOUVEAU: Layers relation
  layers DesignLayer[]

  // Collections
  collectionItems DesignCollectionItem[]

  // IP Claims / Blocking
  isBlocked        Boolean   @default(false)
  blockedReason    String?
  blockedAt        DateTime?
  blockedByClaimId String?
  blockedByClaim   IPClaim?  @relation("BlockedDesigns", fields: [blockedByClaimId], references: [id], onDelete: SetNull)

  // Trust & Safety
  moderationRecords ModerationRecord[]
  ipClaims          IPClaim[]

  // DNA
  designDNA DesignDNA?

  @@index([userId])
  @@index([brandId])
  @@index([productId])
  @@index([status])
  @@index([promptHash])
  @@index([createdAt])
  @@index([specId]) // NOUVEAU
  @@index([brandId, status]) // NOUVEAU: Composite
  @@index([brandId, status, createdAt]) // Composite for filtered + sorted queries
  @@index([isBlocked])
  // DB-01: Index manquant
  @@index([completedAt])
  // DB-01: Composite index for status-based queries with date sorting
  @@index([status, createdAt])
  @@index([deletedAt]) // Soft delete index for efficient queries on active designs
}

// ========================================
// DESIGN VERSION (Versioning)
// ========================================

model DesignVersion {
  id       String @id @default(cuid())
  designId String
  design   Design @relation(fields: [designId], references: [id], onDelete: Cascade)

  // Version metadata
  versionNumber Int // Version number (1, 2, 3, ...)
  name          String? // Optional name for this version
  description   String? // Optional description

  // Snapshot of design state at version creation
  prompt     String
  options    Json // Generation options snapshot
  previewUrl String? // Preview URL snapshot
  highResUrl String? // High-res URL snapshot
  imageUrl   String? // Main image URL snapshot
  renderUrl  String? // Render URL snapshot
  metadata   Json? // AI generation metadata snapshot
  designData Json? // Widget editor data snapshot

  // Version type
  isAutoSave Boolean @default(false) // Auto-saved version or manual
  snapshot   Json? // Full snapshot of design state

  // Tracking
  createdBy String? // User ID who created this version
  createdAt DateTime @default(now())

  // DB-02: Contrainte unique pour éviter les doublons de version
  @@unique([designId, versionNumber])
  @@index([designId])
  @@index([designId, versionNumber])
  @@index([designId, isAutoSave])
  @@index([createdBy])
}

model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique
  status      OrderStatus @default(CREATED)

  // Customer info
  customerEmail   String
  customerName    String?
  customerPhone   String?
  userEmail       String? // For GDPR anonymization
  shippingAddress Json?

  // Pricing
  subtotalCents Int
  taxCents      Int    @default(0)
  shippingCents Int    @default(0)
  totalCents    Int
  currency      String @default("EUR")

  // Payment
  paymentStatus   PaymentStatus @default(PENDING)
  stripeSessionId String?
  stripePaymentId String?

  // Shipping
  trackingNumber      String?
  trackingCarrier     String?
  trackingUrl         String?
  productionBundleUrl String? // URL to production bundle
  shippedAt           DateTime?
  deliveredAt         DateTime?
  estimatedDelivery   DateTime?

  // Notes
  notes    String?
  metadata Json? // Additional order metadata

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  paidAt    DateTime?
  deletedAt DateTime? // Soft delete timestamp (GDPR compliance)

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  // NOUVEAU: Multi-items support
  items OrderItem[] // NOUVEAU

  // DEPRECATED: Garder pour backward compatibility (rendre nullable)
  designId  String? // DEPRECATED: Utiliser OrderItem.designId
  design    Design?  @relation("OrderDesign", fields: [designId], references: [id], onDelete: Cascade)
  productId String? // DEPRECATED: Utiliser OrderItem.productId
  product   Product? @relation("OrderProduct", fields: [productId], references: [id], onDelete: Cascade)

  customizations Customization[]
  workOrder      WorkOrder?
  quotes         Quote[]

  // Discount & Referral
  discountUsages DiscountUsage[]
  commissions    Commission[]

  // Commission tracking
  commissionPercent Float?    @default(0)
  commissionCents   Int?      @default(0)
  discountId        String?
  discount          Discount? @relation(fields: [discountId], references: [id], onDelete: SetNull)

  // Print-on-Demand
  printOrders PrintOrder[]

  // Production & Quality
  productionStatus ProductionStatus?
  qualityReport    QualityReport?

  // PCE
  pipeline         Pipeline?
  productionOrders ProductionOrder[]

  @@index([userId])
  @@index([brandId])
  @@index([designId]) // Garder pour backward compat
  @@index([productId]) // Garder pour backward compat
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
  @@index([brandId, status]) // NOUVEAU: Composite pour performance
  @@index([brandId, createdAt]) // NOUVEAU: Composite pour pagination
  @@index([brandId, status, createdAt]) // Composite for filtered + sorted queries
  // DB-01: Index manquants sur champs date et paiement
  @@index([paymentStatus])
  @@index([paidAt])
  @@index([shippedAt])
  @@index([paymentStatus, createdAt])
  @@index([discountId])
  @@index([deletedAt]) // Soft delete index for efficient queries on active orders
  // DB-01: Composite index for status-based queries with date sorting
  @@index([status, createdAt])
  // Composite for brand payment queries
  @@index([brandId, paymentStatus])
  // PRODUCTION: Composite for user order history (sorted by date)
  @@index([userId, createdAt])
}

// ========================================
// PRINT ORDER (Print-on-Demand)
// ========================================
model PrintOrder {
  id              String   @id @default(cuid())
  orderId         String // Reference to the main Order
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  brandId         String
  brand           Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  provider        String // 'printful', 'printify', 'gelato'
  providerOrderId String? // Provider's order ID
  status          String   @default("pending") // pending, processing, shipped, delivered, cancelled
  trackingNumber  String?
  trackingUrl     String?
  items           Json // Order items details
  shippingAddress Json // Shipping address
  providerCost    Int      @default(0) // Cost from provider in cents
  luneoMargin     Int      @default(0) // Luneo's margin in cents
  brandMargin     Int      @default(0) // Brand's margin in cents
  totalPrice      Int      @default(0) // Total price charged to customer
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orderId])
  @@index([brandId])
  @@index([providerOrderId])
  @@index([status])
}

// ========================================
// ORDER ITEM (Multi-items support)
// ========================================

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  productId  String
  designId   String? // Nullable si pas de design
  snapshotId String? // Lien vers Snapshot (immuable)
  quantity   Int     @default(1)
  priceCents Int // Prix unitaire au moment de la commande (snapshot)
  totalCents Int // priceCents * quantity
  metadata   Json? // Customization options, line item properties Shopify, etc.

  // Relations
  order    Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product  Product   @relation("OrderItemProduct", fields: [productId], references: [id], onDelete: Restrict)
  design   Design?   @relation("OrderItemDesign", fields: [designId], references: [id], onDelete: SetNull)
  snapshot Snapshot? @relation("SnapshotOrderItems", fields: [snapshotId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // DB-02: Contrainte unique pour éviter les doublons d'item dans une commande
  // Note: designId est nullable, donc la contrainte permet plusieurs items sans design
  @@unique([orderId, productId, designId])
  @@index([orderId])
  @@index([productId])
  @@index([designId])
  @@index([snapshotId])
  @@index([orderId, productId])
}

model WebhookSubscription {
  id        String   @id @default(cuid())
  brandId   String
  brand     Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  event     String // 'new_design', 'new_order', 'new_subscription', 'design_updated'
  targetUrl String // Zapier's webhook URL
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId, event])
  @@index([isActive])
}

model ApiKey {
  id          String    @id @default(cuid())
  name        String
  key         String    @unique
  secret      String? // Hashed secret for API key authentication
  scopes      String[] // Array of permissions (legacy)
  permissions String[] // Array of permissions (new)
  rateLimit   Json? // Rate limiting configuration
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([key])
  @@index([isActive])
  @@index([brandId, isActive])
}

model AICost {
  id        String   @id @default(cuid())
  provider  String // openai, replicate, etc.
  model     String // gpt-4, stable-diffusion, etc.
  costCents Int
  tokens    Int? // For text models
  duration  Int? // Processing time in seconds
  createdAt DateTime @default(now())

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([provider])
  @@index([createdAt])
  @@index([brandId, createdAt])
  @@index([brandId, provider])
}

model UserQuota {
  id             String   @id @default(cuid())
  monthlyLimit   Int      @default(100) // Monthly design generations
  monthlyUsed    Int      @default(0)
  costLimitCents Int      @default(5000) // 50€ monthly limit
  costUsedCents  Int      @default(0)
  resetAt        DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([resetAt])
}

model Webhook {
  id      String @id @default(cuid())
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  name   String
  url    String // Webhook URL
  secret String // Secret pour signature

  events   WebhookEvent[] // NOUVEAU: Events supportés
  isActive Boolean        @default(true)

  lastCalledAt   DateTime?
  lastStatusCode Int?
  failureCount   Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  webhookLogs WebhookLog[]
  // Note: Cannot index on array field 'events' in Prisma

  @@index([brandId])
  @@index([isActive])
  @@index([brandId, isActive])
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

// ========================================
// AI PROMPT TEMPLATES
// ========================================

model PromptTemplate {
  id          String   @id @default(cuid())
  name        String
  version     Int      @default(1)
  occasion    String? // 'birth', 'engagement', 'mourning', 'friendship', etc.
  style       String? // 'minimal', 'baroque', 'art-deco', etc.
  prompt      String // Template avec variables {{variable}}
  variables   Json? // Variables disponibles et leurs descriptions
  constraints Json? // Contraintes production (serti, gravure, etc.)
  brandKit    Json? // Brand kit integration (couleurs, ton, interdits)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, version])
  @@index([occasion])
  @@index([style])
  @@index([isActive])
}

// ========================================
// DESIGN DNA (Embeddings + Parameters)
// ========================================

model DesignDNA {
  id             String   @id @default(cuid())
  designId       String   @unique
  design         Design   @relation(fields: [designId], references: [id], onDelete: Cascade)
  story          String? // Story/intention utilisateur
  tags           String[] // Tags normalisés
  embedding      Json? // Vector embedding (pgvector)
  parameters     Json? // Paramètres retenus (ce qui a été cliqué)
  conversionData Json? // Données de conversion (clicks, time, etc.)
  productionData Json? // Données production (QC, défauts, etc.)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([designId])
}

// ========================================
// DESIGN SPEC (Versionné, Déterministe)
// ========================================

model DesignSpec {
  id          String @id @default(cuid())
  specVersion String @default("1.0.0") // Semantic versioning
  specHash    String @unique // SHA256 du spec canonique
  spec        Json // JSON Schema validé, format canonique
  productId   String

  // Zone inputs (normalisés)
  zoneInputs Json // { zoneId: { text, font, color, size, effect, orientation, ... } }

  // Metadata
  metadata Json? // Provenance (widget, shopify, api), userAgent, sessionId, etc.

  // Relations
  product Product @relation("ProductSpecs", fields: [productId], references: [id], onDelete: Cascade)

  snapshots Snapshot[]
  designs   Design[] // Designs générés depuis ce spec

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([specHash])
  @@index([productId])
  @@index([specVersion])
  @@index([createdAt])
  @@index([productId, specHash])
}

// ========================================
// SNAPSHOT (Immuable, Point-in-Time)
// ========================================

model Snapshot {
  id       String @id @default(cuid())
  specId   String // Lien vers DesignSpec
  specHash String // Dupliqué pour queries rapides (index)
  specData Json // Dupliqué pour immutabilité (snapshot du spec au moment T)

  // Previews & Exports
  previewUrl   String? // 2D preview (PNG/WebP)
  preview3dUrl String? // 3D preview (GLTF viewer)
  thumbnailUrl String? // Thumbnail 200x200

  // Production Assets
  productionBundleUrl String? // ZIP avec SVG/DXF/PDF
  arModelUrl          String? // USDZ pour AR
  gltfModelUrl        String? // GLTF pour 3D viewer

  // Asset Versions (pour traçabilité)
  assetVersions Json? // [{ url, format, size, hash, createdAt, version }]

  // Validation & Lock
  isValidated Boolean   @default(false)
  validatedBy String? // User ID
  validatedAt DateTime?
  isLocked    Boolean   @default(false) // Lock pour empêcher modifications
  lockedAt    DateTime?

  // Audit
  createdBy  String? // User ID ou 'widget' ou 'api'
  provenance Json? // { source: 'widget'|'shopify'|'api', sessionId, ipAddress, userAgent, widgetVersion }

  // Relations
  spec           DesignSpec      @relation(fields: [specId], references: [id], onDelete: Restrict)
  orderItems     OrderItem[]     @relation("SnapshotOrderItems") // Orders qui utilisent ce snapshot
  workOrders     WorkOrder[] // WorkOrders liés
  customizations Customization[] // Customizations liées
  renderResults  RenderResult[] // Renders liés

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // Ne devrait jamais changer (immuable)

  @@unique([specHash, validatedAt]) // Un snapshot par specHash validé (si validé)
  @@index([specId])
  @@index([specHash])
  @@index([isValidated])
  @@index([isLocked])
  @@index([createdAt])
  @@index([validatedAt])
  @@index([specHash, isValidated])
}

// ========================================
// WORKERS & PRODUCTION MODELS
// ========================================

model RenderResult {
  id           String  @id @default(cuid())
  renderId     String  @unique
  type         String // '2d', '3d', 'preview', 'ar', 'manufacturing'
  status       String // 'pending', 'processing', 'success', 'failed'
  url          String?
  thumbnailUrl String?
  metadata     Json?

  // NOUVEAU: Relations Prisma (au lieu de renderId string loose)
  snapshotId      String?
  snapshot        Snapshot?      @relation(fields: [snapshotId], references: [id], onDelete: SetNull)
  designId        String?
  design          Design?        @relation(fields: [designId], references: [id], onDelete: SetNull)
  customizationId String?
  customization   Customization? @relation(fields: [customizationId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([renderId])
  @@index([type])
  @@index([status])
  @@index([snapshotId]) // NOUVEAU
  @@index([designId]) // NOUVEAU
  @@index([customizationId]) // NOUVEAU
  @@index([type, status]) // NOUVEAU: Composite
}

model RenderProgress {
  id         String   @id @default(cuid())
  renderId   String   @unique
  stage      String
  percentage Int
  message    String
  timestamp  DateTime @default(now())

  @@index([renderId])
}

model RenderError {
  id         String   @id @default(cuid())
  renderId   String
  error      String
  occurredAt DateTime @default(now())

  @@index([renderId])
}

model ExportResult {
  id        String   @id @default(cuid())
  renderId  String   @unique
  format    String // 'gltf', 'usdz', 'png', etc.
  url       String
  size      Int
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([renderId])
  @@index([format])
}

model ProductionStatus {
  id           String   @id @default(cuid())
  orderId      String   @unique
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  currentStage String
  message      String
  percentage   Int
  lastUpdated  DateTime @default(now())

  @@index([orderId])
}

model QualityReport {
  id              String   @id @default(cuid())
  orderId         String   @unique
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  overallScore    Float
  issues          String[]
  recommendations String[]
  passed          Boolean
  createdAt       DateTime @default(now())

  @@index([orderId])
}

model BatchRenderProgress {
  id          String   @id @default(cuid())
  batchId     String   @unique
  completed   Int
  total       Int
  percentage  Int
  results     Json?
  lastUpdated DateTime @default(now())

  @@index([batchId])
}

// ========================================
// E-COMMERCE INTEGRATIONS
// ========================================

model EcommerceIntegration {
  id           String    @id @default(cuid())
  brandId      String
  platform     String // 'shopify', 'woocommerce', 'magento'
  shopDomain   String
  accessToken  String?
  refreshToken String?
  config       Json
  status       String    @default("active")
  lastSyncAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  brand           Brand            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  productMappings ProductMapping[]
  syncLogs        SyncLog[]

  @@index([brandId])
  @@index([platform])
  @@index([shopDomain])
  @@index([status])
  @@index([brandId, status])
  @@index([brandId, platform])
}

model ProductMapping {
  id                String   @id @default(cuid())
  integrationId     String
  luneoProductId    String
  externalProductId String
  externalSku       String
  syncStatus        String   @default("synced")
  lastSyncedAt      DateTime @default(now())
  metadata          Json?

  // Relations
  integration EcommerceIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  product     Product              @relation(fields: [luneoProductId], references: [id], onDelete: Cascade)

  @@unique([integrationId, externalProductId])
  @@index([integrationId])
  @@index([luneoProductId])
  @@index([externalProductId])
  @@index([externalSku])
}

model SyncLog {
  id             String        @id @default(cuid())
  integrationId  String
  type           SyncLogType // ENUM-01: Utilise enum au lieu de string
  direction      SyncDirection // ENUM-01: Utilise enum au lieu de string
  status         SyncLogStatus // ENUM-01: Utilise enum au lieu de string
  itemsProcessed Int           @default(0)
  itemsFailed    Int           @default(0)
  errors         Json?
  duration       Int // in milliseconds
  createdAt      DateTime      @default(now())

  // Relations
  integration EcommerceIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model WebhookLog {
  id        String   @id @default(cuid())
  webhookId String
  webhook   Webhook? @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  eventId       String?
  eventRelation Event?  @relation(fields: [eventId], references: [id], onDelete: SetNull)

  event      String
  payload    Json
  statusCode Int?
  response   String?
  error      String?
  duration   Int? // Durée en ms

  createdAt DateTime @default(now())

  @@index([webhookId])
  @@index([eventId])
  @@index([event])
  @@index([createdAt])
}

// ========================================
// GENERATION (SaaS Personnalisation - Widget)
// ========================================

model Generation {
  id        String  @id @default(cuid())
  brandId   String
  brand     Brand   @relation(fields: [brandId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  publicId  String  @unique @default(cuid())
  sessionId String?

  customizations Json
  userPrompt     String?
  finalPrompt    String
  negativePrompt String?

  aiProvider String
  model      String
  quality    String

  status       GenerationStatus @default(PENDING)
  outputUrl    String?
  thumbnailUrl String?
  arModelUrl   String?

  aiResponse     Json?
  processingTime Int?
  tokensUsed     Int?
  cost           Decimal? @db.Decimal(10, 6)

  errorMessage String?
  errorCode    String?
  retryCount   Int     @default(0)

  ipAddress String?
  userAgent String?
  referrer  String?

  viewedInAr    Boolean @default(false)
  arViewCount   Int     @default(0)
  downloadCount Int     @default(0)
  sharedCount   Int     @default(0)

  createdAt   DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime?

  @@index([brandId])
  @@index([productId])
  @@index([publicId])
  @@index([status])
  @@index([createdAt])
  // DB-01: Index manquants sur champs date
  @@index([completedAt])
  @@index([expiresAt])
  @@index([status, completedAt])
  @@index([sessionId])
  @@index([brandId, status])
}

// ========================================
// INVOICE (Billing)
// ========================================

model Invoice {
  id              String @id @default(cuid())
  brandId         String
  brand           Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)
  stripeInvoiceId String @unique

  invoiceNumber String? @unique
  amount        Decimal @db.Decimal(10, 2)
  currency      String  @default("eur")
  status        String

  // Tax / VAT fields
  clientCountry   String?
  clientType      String? // B2B or B2C
  clientVatNumber String?
  amountHt        Decimal? @db.Decimal(10, 2)
  vatRate         Decimal? @db.Decimal(5, 2)
  vatAmount       Decimal? @db.Decimal(10, 2)
  amountTtc       Decimal? @db.Decimal(10, 2)
  reverseCharge   Boolean  @default(false)

  periodStart DateTime
  periodEnd   DateTime
  issueDate   DateTime?
  dueDate     DateTime?

  pdfUrl String?

  createdAt DateTime  @default(now())
  paidAt    DateTime?

  creditNotes CreditNote[]

  @@index([brandId])
  @@index([stripeInvoiceId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([createdAt])
  @@index([brandId, status])
  @@index([brandId, createdAt])
}

model CreditNote {
  id           String   @id @default(cuid())
  invoiceId    String
  invoice      Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  creditNumber String   @unique
  amount       Decimal  @db.Decimal(10, 2)
  reason       String
  status       String   @default("issued")
  pdfUrl       String?
  createdAt    DateTime @default(now())

  @@index([invoiceId])
}

// ========================================
// USAGE RECORD (Billing)
// ========================================

model UsageRecord {
  id      String @id @default(cuid())
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  type  String // 'generation', 'ar_view', 'api_call', etc.
  count Int    @default(1)

  metadata Json?

  recordedAt DateTime @default(now())

  @@index([brandId])
  @@index([recordedAt])
  @@index([type])
  @@index([brandId, type, recordedAt])
}

// ========================================
// ADDITIONAL MODELS
// ========================================

model Asset {
  id        String   @id @default(cuid())
  designId  String
  url       String
  type      String // 'image', 'model', 'texture', 'video'
  format    String
  size      Int
  width     Int?
  height    Int?
  metadata  Json?
  createdAt DateTime @default(now())

  // Relations
  design Design @relation(fields: [designId], references: [id], onDelete: Cascade)

  @@index([designId])
  @@index([type])
}

model AuditLog {
  id           String   @id @default(cuid())
  eventType    String
  userId       String?
  brandId      String?
  resourceType String
  resourceId   String
  action       String
  success      Boolean  @default(true)
  metadata     Json?
  timestamp    DateTime @default(now())
  ipAddress    String?
  userAgent    String?

  // Relations
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)
  brand Brand? @relation(fields: [brandId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([brandId])
  @@index([eventType])
  @@index([resourceType])
  @@index([resourceId])
  @@index([timestamp])
  @@index([success])
  @@index([brandId, eventType, timestamp])
}

model UserConsent {
  id          String   @id @default(cuid())
  userId      String
  consentType String // 'privacy', 'marketing', 'analytics'
  granted     Boolean  @default(false)
  recordedAt  DateTime @default(now())
  ipAddress   String?
  userAgent   String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([consentType])
  @@index([recordedAt])
}

// ========================================
// DISCOUNT & PROMO CODES
// ========================================

enum DiscountType {
  PERCENTAGE
  FIXED
}

model Discount {
  id               String       @id @default(cuid())
  code             String       @unique
  type             DiscountType
  value            Int // Pourcentage (0-100) ou montant fixe en centimes
  minPurchaseCents Int?         @map("min_purchase_cents")
  maxDiscountCents Int?         @map("max_discount_cents")
  validFrom        DateTime     @map("valid_from")
  validUntil       DateTime     @map("valid_until")
  usageLimit       Int?         @map("usage_limit")
  usageCount       Int          @default(0) @map("usage_count")
  isActive         Boolean      @default(true) @map("is_active")
  brandId          String?
  brand            Brand?       @relation(fields: [brandId], references: [id], onDelete: SetNull)
  description      String?
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  discountUsages DiscountUsage[]
  orders         Order[]

  @@index([code])
  @@index([brandId])
  @@index([isActive])
  @@index([validFrom, validUntil])
  @@map("discounts")
}

model DiscountUsage {
  id         String   @id @default(cuid())
  discountId String   @map("discount_id")
  discount   Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  userId     String?  @map("user_id")
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  orderId    String?  @map("order_id")
  order      Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  usedAt     DateTime @default(now()) @map("used_at")

  @@index([discountId])
  @@index([userId])
  @@index([orderId])
  @@map("discount_usages")
}

// ========================================
// REFERRAL PROGRAM
// ========================================

enum ReferralStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model Referral {
  id             String         @id @default(cuid())
  referrerId     String         @map("referrer_id")
  referrer       User           @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referredUserId String?        @unique @map("referred_user_id")
  referredUser   User?          @relation("Referred", fields: [referredUserId], references: [id], onDelete: SetNull)
  referralCode   String         @map("referral_code")
  status         ReferralStatus @default(PENDING)
  createdAt      DateTime       @default(now()) @map("created_at")
  completedAt    DateTime?      @map("completed_at")

  commissions Commission[]

  @@index([referrerId])
  @@index([referredUserId])
  @@index([referralCode])
  @@index([status])
  @@map("referrals")
}

model Commission {
  id          String           @id @default(cuid())
  referralId  String           @map("referral_id")
  referral    Referral         @relation(fields: [referralId], references: [id], onDelete: Cascade)
  userId      String           @map("user_id")
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderId     String?          @map("order_id")
  order       Order?           @relation(fields: [orderId], references: [id], onDelete: SetNull)
  amountCents Int              @map("amount_cents")
  percentage  Float            @default(0.1) // 10% par défaut
  status      CommissionStatus @default(PENDING)
  approvedAt  DateTime?        @map("approved_at")
  paidAt      DateTime?        @map("paid_at")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  @@index([referralId])
  @@index([userId])
  @@index([orderId])
  @@index([status])
  @@map("commissions")
}

model Withdrawal {
  id            String           @id @default(cuid())
  userId        String           @map("user_id")
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  amountCents   Int              @map("amount_cents")
  iban          String
  status        WithdrawalStatus @default(PENDING)
  processedAt   DateTime?        @map("processed_at")
  failureReason String?          @map("failure_reason")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("withdrawals")
}

model ReferralApplication {
  id         String    @id @default(cuid())
  email      String    @unique
  status     String    @default("pending") // 'pending', 'approved', 'rejected'
  appliedAt  DateTime  @default(now()) @map("applied_at")
  reviewedAt DateTime? @map("reviewed_at")

  @@index([email])
  @@index([status])
  @@map("referral_applications")
}

// ========================================
// USER PROFILE (for IBAN and additional info)
// ========================================

model UserProfile {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  iban      String?
  bic       String?
  bankName  String?  @map("bank_name")
  address   Json? // Full address as JSON
  phone     String?
  website   String?
  timezone  String?  @default("Europe/Paris")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_profiles")
}

model UsageMetric {
  id        String   @id @default(cuid())
  brandId   String
  metric    String // 'designs_created', 'renders_2d', 'api_calls', etc.
  value     Int
  unit      String // 'count', 'bytes', 'seconds'
  timestamp DateTime @default(now())
  metadata  Json?

  // Relations
  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([metric])
  @@index([timestamp])
  @@index([brandId, metric, timestamp])
}

// ========================================
// WIDGET EDITOR MODELS (Zakeke-like)
// ========================================

model CustomizableArea {
  id          String  @id @default(cuid())
  productId   String
  name        String
  description String?

  // Position & Dimensions (in mm or pixels)
  x      Float @default(0)
  y      Float @default(0)
  width  Float
  height Float

  // Constraints
  minWidth    Float?
  maxWidth    Float?
  minHeight   Float?
  maxHeight   Float?
  aspectRatio Float? // Lock aspect ratio

  // Allowed layer types
  allowedLayerTypes String[] @default(["text", "image", "shape"]) // ["text", "image", "shape", "clipart"]

  // Text constraints (if text allowed)
  maxTextLength    Int?
  allowedFonts     String[]
  defaultFont      String?
  defaultFontSize  Int?
  allowedFontSizes Int[] // [12, 14, 16, 18, 24, 32, 48, 72]

  // Image constraints (if image allowed)
  maxImageSize   Int? // Max file size in bytes
  allowedFormats String[] @default(["png", "jpg", "jpeg", "svg", "webp"])
  minImageWidth  Int?
  minImageHeight Int?
  maxImageWidth  Int?
  maxImageHeight Int?

  // Shape constraints (if shape allowed)
  allowedShapes String[] @default(["rectangle", "circle", "triangle", "polygon", "star"])

  // Color constraints
  allowedColors String[] // Hex colors
  defaultColor  String?  @default("#000000")

  // Display settings
  isRequired   Boolean @default(false)
  isActive     Boolean @default(true)
  displayOrder Int     @default(0)

  // Metadata
  metadata Json? // Additional configuration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([isActive])
  @@index([displayOrder])
  @@index([productId, isActive])
}

model DesignLayer {
  id       String @id @default(cuid())
  designId String
  type     String // "text", "image", "shape", "clipart"

  // Position & Transform
  x        Float @default(0)
  y        Float @default(0)
  rotation Float @default(0) // degrees
  scaleX   Float @default(1)
  scaleY   Float @default(1)
  opacity  Float @default(1) // 0-1

  // Visibility & Lock
  visible Boolean @default(true)
  locked  Boolean @default(false)

  // Layer-specific data (JSON for flexibility)
  data Json // TextLayerData, ImageLayerData, ShapeLayerData, etc.

  // Z-index (order in layer stack)
  zIndex Int @default(0)

  // Metadata
  metadata Json? // Additional layer metadata

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  design Design @relation(fields: [designId], references: [id], onDelete: Cascade)

  @@index([designId])
  @@index([type])
  @@index([visible])
  @@index([zIndex])
  @@index([designId, zIndex])
}

// ========================================
// PRODUCT CUSTOMIZATION MODELS
// ========================================

model Zone {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        ZoneType @default(TEXT)

  // 3D Position & UV Mapping
  positionX Float
  positionY Float
  positionZ Float
  rotationX Float @default(0)
  rotationY Float @default(0)
  rotationZ Float @default(0)
  scaleX    Float @default(1)
  scaleY    Float @default(1)
  scaleZ    Float @default(1)

  // UV Mapping coordinates
  uvMinU Float // Minimum U coordinate (0-1)
  uvMaxU Float // Maximum U coordinate (0-1)
  uvMinV Float // Minimum V coordinate (0-1)
  uvMaxV Float // Maximum V coordinate (0-1)

  // Customization Options
  maxChars        Int? // Maximum characters for text zones
  allowedFonts    String[] // Allowed fonts for text zones
  defaultFont     String? // Default font
  defaultColor    String? // Default color (hex)
  defaultSize     Int? // Default text size
  allowedColors   String[] // Allowed colors
  allowedPatterns String[] // Allowed patterns

  // Constraints
  isRequired Boolean @default(false)
  isActive   Boolean @default(true)
  order      Int     @default(0) // Display order

  // Metadata
  metadata Json? // Additional configuration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  customizations Customization[]

  // DB-02: Contrainte unique pour éviter les zones avec le même nom sur un produit
  @@unique([productId, name])
  @@index([productId])
  @@index([type])
  @@index([isActive])
  @@index([order])
}

// ========================================
// NOTIFICATIONS
// ========================================

model Notification {
  id          String    @id @default(cuid())
  userId      String
  type        String // 'info', 'success', 'warning', 'error', 'order', 'customization', 'system'
  title       String
  message     String
  data        Json? // Additional data
  read        Boolean   @default(false)
  readAt      DateTime?
  actionUrl   String? // URL for action button
  actionLabel String? // Label for action button
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([type])
  @@index([createdAt])
  // DB-01: Composite index for user notification queries
  @@index([userId, read])
}

model Customization {
  id          String  @id @default(cuid())
  name        String?
  description String?

  // User Input
  prompt     String // User's text input
  promptHash String? // Hash for caching

  // Configuration
  zoneId String
  zone   Zone   @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Options used
  font        String?
  color       String?
  size        Int?
  effect      CustomizationEffect @default(ENGRAVED)
  orientation String? // horizontal, vertical, curved
  options     Json? // Additional options

  // Status & Generation
  status CustomizationStatus @default(PENDING)
  jobId  String? // AI engine job ID

  // Generated Assets
  textureUrl String? // Generated texture URL
  modelUrl   String? // Modified 3D model URL (.glb)
  previewUrl String? // Preview image URL
  highResUrl String? // High resolution render URL
  arModelUrl String? // AR-optimized model URL (.usdz)

  // Metadata
  metadata     Json? // Generation metadata (processing time, etc.)
  errorMessage String? // Error message if failed
  retryCount   Int     @default(0)

  // Cost tracking
  costCents        Int  @default(0)
  processingTimeMs Int? // Processing time in milliseconds

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: SetNull)

  designId String? // Link to Design if part of a design
  design   Design? @relation(fields: [designId], references: [id], onDelete: SetNull)

  orderId String? // Link to Order if purchased
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // NOUVEAU: Lien vers Snapshot
  snapshotId   String?
  snapshot     Snapshot?      @relation(fields: [snapshotId], references: [id], onDelete: SetNull)
  RenderResult RenderResult[]

  @@index([userId])
  @@index([productId])
  @@index([zoneId])
  @@index([brandId])
  @@index([status])
  @@index([promptHash])
  @@index([jobId])
  @@index([createdAt])
  @@index([designId])
  @@index([orderId])
  @@index([snapshotId]) // NOUVEAU
  // DB-01: Composite index for status-based queries with date sorting
  @@index([status, createdAt])
}

// ========================================
// OUTBOX PATTERN (Event Sourcing)
// ========================================

model OutboxEvent {
  id          String    @id @default(cuid())
  eventType   String // Event type (design.completed, order.paid, etc.)
  payload     Json // Event payload
  status      String    @default("pending") // pending, published, failed
  attempts    Int       @default(0)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status, createdAt])
  @@index([eventType])
}

// ========================================
// MARKETPLACE (Lot 4)
// ========================================

model Artisan {
  id           String  @id @default(cuid())
  userId       String  @unique
  businessName String
  legalName    String?
  taxId        String?
  address      Json?
  phone        String?
  email        String?
  website      String?

  // KYC/KYB - ENUM-01: Utilise enum au lieu de string
  kycStatus     KycStatus @default(PENDING)
  kycVerifiedAt DateTime?
  kycDocuments  Json?

  // Stripe Connect
  stripeAccountId     String?
  stripeAccountStatus String?
  onboardingCompleted Boolean @default(false)

  // Capacités
  maxVolume       Int @default(10)
  currentLoad     Int @default(0)
  averageLeadTime Int @default(7) // jours
  minOrderValue   Int @default(0) // cents

  // Matériaux supportés
  supportedMaterials  String[]
  supportedTechniques String[]
  supportedZones      String[]

  // Qualité & Performance
  qualityScore       Float @default(5.0)
  totalOrders        Int   @default(0)
  completedOrders    Int   @default(0)
  onTimeDeliveryRate Float @default(1.0)
  defectRate         Float @default(0.0)
  returnRate         Float @default(0.0)

  // SLA
  slaLevel     String @default("standard") // basic, standard, premium, enterprise
  slaPenalties Json   @default("{}")
  slaBonuses   Json   @default("{}")

  // Status
  status           String    @default("active") // active, inactive, suspended, quarantined
  quarantineReason String?
  quarantineUntil  DateTime?

  // Settings
  settings       Json   @default("{}")
  payoutSchedule String @default("weekly") // daily, weekly, biweekly, monthly

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  capabilities ArtisanCapability[]
  workOrders   WorkOrder[]
  quotes       Quote[]
  slaRecords   SLARecord[]
  payouts      Payout[]

  @@index([kycStatus])
  @@index([status])
  @@index([qualityScore])
  @@index([stripeAccountId])
}

model ArtisanCapability {
  id             String   @id @default(cuid())
  artisanId      String
  material       String
  technique      String
  maxSize        Float?
  minSize        Float?
  leadTime       Int? // jours
  costMultiplier Float    @default(1.0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  artisan Artisan @relation(fields: [artisanId], references: [id], onDelete: Cascade)

  @@index([artisanId])
  @@index([material])
  @@index([technique])
}

model WorkOrder {
  id        String  @id @default(cuid())
  orderId   String  @unique
  artisanId String
  quoteId   String? @unique

  // Routing
  routingScore  Float?
  routingReason String?
  selectedAt    DateTime?

  // Production - ENUM-01: Utilise enum au lieu de string
  status              WorkOrderStatus @default(ASSIGNED)
  acceptedAt          DateTime?
  startedAt           DateTime?
  estimatedCompletion DateTime?
  completedAt         DateTime?

  // SLA
  slaDeadline     DateTime?
  slaMet          Boolean?
  slaPenaltyCents Int       @default(0)
  slaBonusCents   Int       @default(0)

  // Financial
  payoutAmountCents Int?
  commissionCents   Int?
  payoutStatus      String  @default("pending") // pending, processing, paid, failed, cancelled
  payoutId          String?

  // QC
  qcScore    Float?
  qcPassed   Boolean?
  qcIssues   String[]
  qcReportId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order     Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  artisan   Artisan    @relation(fields: [artisanId], references: [id], onDelete: Restrict)
  quote     Quote?     @relation("WorkOrderQuote", fields: [quoteId], references: [id], onDelete: SetNull)
  slaRecord SLARecord?

  // NOUVEAU: Lien vers Snapshot (pour production bundle)
  snapshotId String?
  snapshot   Snapshot? @relation(fields: [snapshotId], references: [id], onDelete: SetNull)

  @@index([artisanId])
  @@index([status])
  @@index([slaDeadline])
  @@index([payoutStatus])
  @@index([snapshotId]) // NOUVEAU
  // DB-01: Index manquants sur champs date
  @@index([acceptedAt])
  @@index([completedAt])
  @@index([status, acceptedAt])
}

model Quote {
  id        String @id @default(cuid())
  orderId   String
  artisanId String

  // Pricing
  priceCents Int
  leadTime   Int // jours
  breakdown  Json

  // Scoring
  qualityScore  Float?
  costScore     Float?
  leadTimeScore Float?
  distanceScore Float?
  overallScore  Float?

  // Status
  status     String    @default("pending") // pending, selected, rejected, expired
  selectedAt DateTime?
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order     Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  artisan   Artisan    @relation(fields: [artisanId], references: [id], onDelete: Restrict)
  workOrder WorkOrder? @relation("WorkOrderQuote")

  @@index([orderId])
  @@index([artisanId])
  @@index([status])
  @@index([overallScore])
}

model SLARecord {
  id           String    @id @default(cuid())
  workOrderId  String    @unique
  artisanId    String
  deadline     DateTime
  completedAt  DateTime?
  onTime       Boolean?
  delayHours   Int?
  penaltyCents Int       @default(0)
  bonusCents   Int       @default(0)
  reason       String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  artisan   Artisan   @relation(fields: [artisanId], references: [id], onDelete: Restrict)

  @@index([artisanId])
  @@index([onTime])
}

model Payout {
  id               String  @id @default(cuid())
  artisanId        String
  stripeTransferId String?

  // Amount
  amountCents    Int
  currency       String @default("EUR")
  feesCents      Int    @default(0)
  netAmountCents Int

  // Period
  periodStart  DateTime
  periodEnd    DateTime
  workOrderIds String[]

  // Status - ENUM-01: Utilise enum au lieu de string
  status        PayoutStatus @default(PENDING)
  paidAt        DateTime?
  failureReason String?

  // Reserve (fraude/retours)
  reserveCents     Int       @default(0)
  reserveReleaseAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  artisan Artisan @relation(fields: [artisanId], references: [id], onDelete: Restrict)

  @@index([artisanId])
  @@index([status])
  @@index([periodStart])
  @@index([stripeTransferId])
}

// ========================================
// TRUST & SAFETY + ANALYTICS (Lot 6)
// ========================================

model ModerationRecord {
  id       String  @id @default(cuid())
  type     String // text, image, ai_generation
  content  String // Text or image URL
  userId   String?
  brandId  String?
  designId String?
  context  Json? // Additional context metadata

  // Result
  approved   Boolean
  confidence Float
  categories String[]
  reason     String?
  action     String // allow, review, block

  createdAt DateTime @default(now())

  // Relations
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  brand  Brand?  @relation(fields: [brandId], references: [id], onDelete: SetNull)
  design Design? @relation(fields: [designId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([approved])
  @@index([createdAt])
  @@index([userId])
  @@index([brandId])
  @@index([designId])
}

model IPClaim {
  id            String   @id @default(cuid())
  claimantName  String
  claimantEmail String
  claimantType  String // copyright, trademark, patent, other
  designId      String
  description   String
  evidence      String[] // URLs

  // Review
  status     String    @default("pending") // pending, under_review, approved, rejected, resolved
  reviewedBy String?
  reviewedAt DateTime?
  resolution String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  design         Design   @relation(fields: [designId], references: [id], onDelete: Cascade)
  blockedDesigns Design[] @relation("BlockedDesigns")

  @@index([designId])
  @@index([status])
  @@index([createdAt])
}

model Experiment {
  id             String    @id @default(cuid())
  name           String
  description    String
  type           String // pricing, copy, prompt, variants, layout
  variants       Json // Array of { id, name, config, weight }
  status         String    @default("draft") // draft, running, paused, completed
  startDate      DateTime?
  endDate        DateTime?
  targetAudience Json? // brands, countries, userRoles

  // P2-6: Multi-tenancy isolation
  brandId String?
  brand   Brand?  @relation("BrandExperiments", fields: [brandId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignments ExperimentAssignment[]
  conversions Conversion[]

  @@index([status])
  @@index([type])
  @@index([startDate])
  @@index([brandId])
}

model ExperimentAssignment {
  id           String   @id @default(cuid())
  userId       String
  experimentId String
  variantId    String
  assignedAt   DateTime @default(now())

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  experiment Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@unique([userId, experimentId])
  @@index([experimentId])
  @@index([variantId])
}

model Conversion {
  id           String   @id @default(cuid())
  userId       String?
  sessionId    String
  experimentId String?
  variantId    String?
  eventType    String // signup, design_created, order_created, purchase
  value        Int? // Revenue in cents
  attribution  Json // AttributionData
  timestamp    DateTime @default(now())

  // Relations
  experiment Experiment? @relation(fields: [experimentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([sessionId])
  @@index([experimentId])
  @@index([eventType])
  @@index([timestamp])
}

model Attribution {
  id          String   @id @default(cuid())
  userId      String?
  sessionId   String
  source      String // direct, organic, paid, referral, email, social
  medium      String?
  campaign    String?
  term        String?
  content     String?
  referrer    String?
  landingPage String
  device      Json
  location    Json?
  timestamp   DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([source])
  @@index([campaign])
  @@index([timestamp])
}

model FraudCheck {
  id                String  @id @default(cuid())
  userId            String?
  email             String?
  ipAddress         String?
  deviceFingerprint String?
  orderValue        Int?
  actionType        String // signup, login, order, payment

  // Result
  riskScore Int // 0-100
  riskLevel String // low, medium, high, critical
  reasons   String[]
  action    String // allow, review, block
  checks    Json // velocity, device, email, ip, value

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([email])
  @@index([ipAddress])
  @@index([riskLevel])
  @@index([createdAt])
}

// ========================================
// CREDITS SYSTEM
// ========================================

model CreditPack {
  id            String   @id @default(cuid())
  name          String
  credits       Int
  priceCents    Int      @map("price_cents")
  stripePriceId String?  @map("stripe_price_id")
  isActive      Boolean  @default(true) @map("is_active")
  isFeatured    Boolean  @default(false) @map("is_featured")
  savings       Int? // Percentage savings vs base pack
  badge         String? // "Best Value", "Most Popular", etc.
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  transactions CreditTransaction[]

  @@index([isActive])
  @@index([isFeatured])
  @@index([stripePriceId])
  @@map("CreditPack")
}

model CreditTransaction {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  packId          String?   @map("pack_id")
  amount          Int // Positive = purchase, Negative = usage
  balanceBefore   Int       @map("balance_before")
  balanceAfter    Int       @map("balance_after")
  type            String // 'purchase', 'usage', 'refund', 'bonus', 'expiration', 'monthly_refill'
  source          String? // '/api/ai/generate', 'admin', 'stripe_webhook'
  metadata        Json? // Additional data (endpoint, cost, model, duration, etc.)
  stripeSessionId String?   @map("stripe_session_id")
  stripePaymentId String?   @map("stripe_payment_id")
  expiresAt       DateTime? @map("expires_at") // Add-on credits expire after 12 months; plan refills have null
  expiredAt       DateTime? @map("expired_at") // When this transaction was marked expired (balance adjusted)
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  pack CreditPack? @relation(fields: [packId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([stripeSessionId])
  @@index([packId])
  @@index([expiresAt])
  @@index([expiredAt])
  // PRODUCTION: Composite for user credit history (sorted by date)
  @@index([userId, createdAt])
  @@map("CreditTransaction")
}

// ========================================
// MONITORING SYSTEM - Enterprise Grade
// ========================================

enum AlertSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  SUPPRESSED
}

enum ServiceHealthStatus {
  HEALTHY
  DEGRADED
  UNHEALTHY
  UNKNOWN
}

enum MetricType {
  COUNTER
  GAUGE
  HISTOGRAM
  SUMMARY
}

model MonitoringMetric {
  id        String   @id @default(cuid())
  service   String // database, cache, storage, email, payments, api
  metric    String // cpu_usage, memory_usage, request_count, error_rate
  value     Float
  unit      String? // ms, %, bytes, count
  labels    Json? // Additional metadata (endpoint, method, status, etc.)
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([service])
  @@index([metric])
  @@index([timestamp])
  @@index([service, metric, timestamp])
  @@map("MonitoringMetric")
}

model ServiceHealth {
  id           String              @id @default(cuid())
  service      String              @unique // database, cache, storage, email, payments
  status       ServiceHealthStatus @default(UNKNOWN)
  latency      Int? // milliseconds
  lastCheck    DateTime            @default(now())
  lastSuccess  DateTime?
  failureCount Int                 @default(0)
  message      String?
  metadata     Json? // Additional service info
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([service])
  @@index([status])
  @@index([lastCheck])
  @@map("ServiceHealth")
}

model Alert {
  id             String        @id @default(cuid())
  severity       AlertSeverity @default(WARNING)
  status         AlertStatus   @default(ACTIVE)
  title          String
  message        String
  service        String? // Which service triggered this
  metric         String? // Which metric triggered this
  threshold      Float? // Threshold that was exceeded
  currentValue   Float? // Current value when alert triggered
  acknowledgedBy String? // User ID who acknowledged
  acknowledgedAt DateTime?
  resolvedBy     String? // User ID who resolved
  resolvedAt     DateTime?
  resolvedReason String?
  metadata       Json? // Additional alert data
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([severity])
  @@index([status])
  @@index([service])
  @@index([createdAt])
  @@index([status, severity])
  @@map("Alert")
}

model AlertRule {
  id            String        @id @default(cuid())
  name          String
  description   String?
  service       String
  metric        String
  condition     String // gt, lt, eq, gte, lte
  threshold     Float
  severity      AlertSeverity @default(WARNING)
  enabled       Boolean       @default(true)
  cooldown      Int           @default(300) // seconds
  lastTriggered DateTime?
  triggerCount  Int           @default(0)
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([service, metric])
  @@index([enabled])
  @@map("AlertRule")
}

model WebVital {
  id         String   @id @default(cuid())
  userId     String?
  sessionId  String?
  page       String
  metric     String // LCP, FID, CLS, TTFB, FCP
  value      Float
  rating     String? // good, needs-improvement, poor
  device     Json? // Device info
  connection Json? // Connection info
  timestamp  DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([metric])
  @@index([timestamp])
  @@index([page, metric, timestamp])
  @@map("WebVital")
}

// ========================================
// SUPPORT SYSTEM - Enterprise Grade
// ========================================

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
  CANCELLED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  BILLING
  TECHNICAL
  ACCOUNT
  FEATURE_REQUEST
  BUG
  INTEGRATION
  OTHER
}

enum MessageType {
  USER
  AGENT
  SYSTEM
  INTERNAL
}

model Ticket {
  id           String         @id @default(cuid())
  ticketNumber String         @unique // TKT-XXXXX
  subject      String
  description  String
  status       TicketStatus   @default(OPEN)
  priority     TicketPriority @default(MEDIUM)
  category     TicketCategory @default(TECHNICAL)

  // Relations
  userId       String
  user         User      @relation("TicketUser", fields: [userId], references: [id], onDelete: Cascade)
  assignedTo   String? // User ID of assigned agent
  assignedUser User?     @relation("AssignedTickets", fields: [assignedTo], references: [id], onDelete: SetNull)
  assignedAt   DateTime?

  // Orion AI fields
  source          TicketSource     @default(PORTAL)
  sentiment       TicketSentiment?
  language        String           @default("fr")
  aiAnalysis      Json?
  confidenceScore Int?
  slaDeadline     DateTime?
  slaBreach       Boolean          @default(false)
  brandId         String?
  brand           Brand?           @relation("BrandTickets", fields: [brandId], references: [id], onDelete: SetNull)
  assignedAgent   String?

  // Metadata
  tags            String[]
  metadata        Json? // Additional ticket data
  firstResponseAt DateTime? // Time to first response
  resolvedAt      DateTime?
  closedAt        DateTime?

  // CSAT (Customer Satisfaction)
  csatRating      Int? // 1-5 rating
  csatComment     String? // Optional feedback comment
  csatSubmittedAt DateTime? // When CSAT was submitted

  // Relations
  messages           TicketMessage[]
  attachments        TicketAttachment[]
  activities         TicketActivity[]
  aiResponses        AITicketResponse[]
  escalationHistory  EscalationHistory[]
  satisfactionSurvey SatisfactionSurvey?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([assignedTo])
  @@index([ticketNumber])
  @@index([createdAt])
  @@index([status, priority])
  @@index([resolvedAt])
  @@index([closedAt])
  @@index([firstResponseAt])
  @@index([userId, status])
  @@index([brandId])
  @@index([slaDeadline])
  @@index([sentiment])
  @@map("Ticket")
}

model TicketMessage {
  id         String      @id @default(cuid())
  ticketId   String
  ticket     Ticket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  type       MessageType @default(USER)
  content    String
  userId     String? // User who sent the message
  user       User?       @relation("TicketMessages", fields: [userId], references: [id], onDelete: SetNull)
  isInternal Boolean     @default(false) // Internal note (not visible to user)
  isRead     Boolean     @default(false)
  readAt     DateTime?

  // Relations
  attachments TicketAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
  @@index([type])
  @@map("TicketMessage")
}

model TicketAttachment {
  id         String   @id @default(cuid())
  ticketId   String?
  messageId  String?
  fileName   String
  fileUrl    String
  fileSize   Int // bytes
  mimeType   String
  uploadedBy String // User ID
  createdAt  DateTime @default(now())

  ticket  Ticket?        @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  message TicketMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([messageId])
  @@index([uploadedBy])
  @@map("TicketAttachment")
}

model TicketActivity {
  id        String   @id @default(cuid())
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  action    String // created, status_changed, assigned, priority_changed, etc.
  userId    String? // User who performed the action
  user      User?    @relation("TicketActivities", fields: [userId], references: [id], onDelete: SetNull)
  oldValue  String?
  newValue  String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
  @@map("TicketActivity")
}

model KnowledgeBaseArticle {
  id            String    @id @default(cuid())
  title         String
  slug          String    @unique
  content       String // Markdown content
  excerpt       String?
  category      String
  tags          String[]
  isPublished   Boolean   @default(false)
  isFeatured    Boolean   @default(false)
  views         Int       @default(0)
  helpful       Int       @default(0)
  notHelpful    Int       @default(0)
  authorId      String
  author        User      @relation("KBAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  lastUpdatedBy String?
  publishedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([category])
  @@index([isPublished])
  @@index([isFeatured])
  @@index([slug])
  @@index([createdAt])
  @@index([authorId])
  @@map("KnowledgeBaseArticle")
}

// ========================================
// ANALYTICS AVANCÉES
// ========================================

model AnalyticsEvent {
  id         String   @id @default(cuid())
  eventType  String // 'page_view', 'conversion', 'funnel_step', 'user_action', etc.
  userId     String?
  sessionId  String?
  properties Json // Données événement (flexible pour différents types d'événements)
  timestamp  DateTime @default(now())

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([eventType, timestamp])
  @@index([userId, timestamp])
  @@index([brandId, timestamp])
  @@index([sessionId, timestamp])
  @@index([brandId, eventType, timestamp])
  @@index([timestamp])
  @@map("AnalyticsEvent")
}

model AnalyticsFunnel {
  id          String  @id @default(cuid())
  name        String
  description String?
  steps       Json // Configuration des étapes [{ name, eventType, order }]
  isActive    Boolean @default(true)

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([isActive])
  @@index([brandId, isActive])
  @@map("AnalyticsFunnel")
}

model AnalyticsCohort {
  id         String   @id @default(cuid())
  cohortDate DateTime // Date d'acquisition de la cohorte
  period     Int // Période de rétention (7, 30, 90, 180, 365 jours)
  retention  Float // Taux de rétention (0-100)
  revenue    Float // Revenus générés par la cohorte
  userCount  Int // Nombre d'utilisateurs dans la cohorte

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([brandId, cohortDate, period])
  @@index([brandId, cohortDate])
  @@index([brandId, period])
  @@index([cohortDate])
  @@index([period])
  @@map("AnalyticsCohort")
}

model AnalyticsSegment {
  id          String  @id @default(cuid())
  name        String
  description String?
  criteria    Json // Critères de segmentation (flexible)
  userCount   Int     @default(0)
  isActive    Boolean @default(true)

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([isActive])
  @@index([brandId, isActive])
  @@map("AnalyticsSegment")
}

model AnalyticsPrediction {
  id         String @id @default(cuid())
  type       String // 'revenue', 'conversion', 'churn', 'ltv', etc.
  value      Float // Valeur prédite
  confidence Float // Niveau de confiance (0-1)
  period     String // '7d', '30d', '90d', '1y'
  metadata   Json? // Métadonnées supplémentaires (facteurs, modèles ML, etc.)

  // Relations
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([brandId, type, createdAt])
  @@index([brandId, type])
  @@index([type, period])
  @@index([createdAt])
  @@map("AnalyticsPrediction")
}

// ========================================
// AI STUDIO - GÉNÉRATIONS
// ========================================

enum AIGenerationType {
  IMAGE_2D
  MODEL_3D
  ANIMATION
  TEMPLATE
}

enum AIGenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model AIGeneration {
  id             String             @id @default(cuid())
  type           AIGenerationType
  prompt         String
  negativePrompt String?
  model          String // 'stable-diffusion-xl', 'dall-e-3', 'midjourney-v6', etc.
  provider       String // 'openai', 'replicate', 'stability', 'custom'
  parameters     Json // Paramètres de génération (steps, guidance, seed, etc.)
  status         AIGenerationStatus @default(PENDING)
  resultUrl      String? // URL du résultat final
  thumbnailUrl   String? // URL de la miniature
  credits        Int                @default(0) // Crédits utilisés
  costCents      Int                @default(0) // Coût en centimes
  duration       Int? // Temps de génération en secondes
  quality        Float? // Score de qualité 0-100 (si disponible)
  error          String? // Message d'erreur si échec

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  // Versioning
  parentGenerationId String? // Pour les variantes
  parentGeneration   AIGeneration?  @relation("AIGenerationVersions", fields: [parentGenerationId], references: [id], onDelete: SetNull)
  versions           AIGeneration[] @relation("AIGenerationVersions")
  aiVersions         AIVersion[] // Versions détaillées

  // Collections
  collections AICollectionGeneration[]

  // Feedback
  feedback AIGenerationFeedback[]

  // Bulk job (optional)
  bulkJobGenerationId String?

  createdAt   DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete timestamp (user data cleanup)

  @@index([userId, createdAt])
  @@index([brandId, createdAt])
  @@index([brandId, type, status])
  @@index([type, status])
  @@index([status])
  @@index([model])
  @@index([parentGenerationId])
  @@index([userId, status])
  @@index([createdAt])
  @@index([deletedAt]) // Soft delete index for efficient queries on active generations
  @@map("AIGeneration")
}

model AIVersion {
  id           String       @id @default(cuid())
  generationId String
  generation   AIGeneration @relation(fields: [generationId], references: [id], onDelete: Cascade)
  version      Int // Numéro de version (1, 2, 3, etc.)
  prompt       String // Prompt utilisé pour cette version
  parameters   Json // Paramètres utilisés
  resultUrl    String // URL du résultat
  quality      Float? // Score de qualité
  credits      Int // Crédits utilisés
  createdAt    DateTime     @default(now())

  @@unique([generationId, version])
  @@index([generationId])
  @@map("AIVersion")
}

model AICollection {
  id          String  @id @default(cuid())
  name        String
  description String?
  isShared    Boolean @default(false)

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  generations AICollectionGeneration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([brandId])
  @@index([isShared])
  @@map("AICollection")
}

model AICollectionGeneration {
  id           String       @id @default(cuid())
  collectionId String
  collection   AICollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  generationId String
  generation   AIGeneration @relation(fields: [generationId], references: [id], onDelete: Cascade)
  addedAt      DateTime     @default(now())

  @@unique([collectionId, generationId])
  @@index([collectionId])
  @@index([generationId])
  @@map("AICollectionGeneration")
}

// ========================================
// COLLABORATION
// ========================================

enum ResourceType {
  ANALYTICS_REPORT
  AI_GENERATION
  DESIGN
  PRODUCT
  ORDER
  CUSTOMIZATION
}

model SharedResource {
  id           String       @id @default(cuid())
  resourceType ResourceType
  resourceId   String // ID de la ressource partagée
  sharedWith   String[] // IDs des utilisateurs avec qui c'est partagé
  permissions  Json // Permissions par utilisateur { userId: ['view', 'edit', 'delete'] }
  isPublic     Boolean      @default(false) // Partage public (lien)
  publicToken  String?      @unique // Token pour accès public

  // Relations
  createdBy     String
  createdByUser User   @relation("SharedResourcesCreated", fields: [createdBy], references: [id], onDelete: Cascade)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  comments Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceType, resourceId])
  @@index([createdBy])
  @@index([brandId])
  @@index([brandId, resourceType])
  @@index([isPublic, publicToken])
  @@index([publicToken])
  @@map("SharedResource")
}

model Comment {
  id           String       @id @default(cuid())
  resourceType ResourceType
  resourceId   String
  content      String
  parentId     String? // Pour les réponses aux commentaires
  parent       Comment?     @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies      Comment[]    @relation("CommentReplies")

  // Relations
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  sharedResourceId String?
  sharedResource   SharedResource? @relation(fields: [sharedResourceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceType, resourceId])
  @@index([authorId])
  @@index([parentId])
  @@index([sharedResourceId])
  @@index([resourceType, resourceId, createdAt])
  @@map("Comment")
}

// ========================================
// RELATIONS ADDITIONNELLES
// ========================================

// Add relations to User model
// Add to User model:
//   tickets            Ticket[]
//   ticketMessages     TicketMessage[]
//   assignedTickets     Ticket[] @relation("AssignedTickets")
//   aiGenerations      AIGeneration[]
//   aiCollections       AICollection[]
//   sharedResourcesCreated SharedResource[] @relation("SharedResourcesCreated")
//   comments           Comment[]

// ========================================
// COLLECTIONS & FAVORITES
// ========================================

model DesignCollection {
  id          String   @id @default(cuid())
  userId      String
  brandId     String
  name        String
  description String?
  isPublic    Boolean  @default(false)
  coverImage  String?
  itemCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand Brand                  @relation(fields: [brandId], references: [id], onDelete: Cascade)
  items DesignCollectionItem[]

  @@index([userId])
  @@index([brandId])
  @@index([isPublic])
  @@index([brandId, isPublic])
  @@index([brandId, createdAt])
  @@map("DesignCollection")
}

model DesignCollectionItem {
  id           String   @id @default(cuid())
  collectionId String
  designId     String
  notes        String?
  addedBy      String
  order        Int      @default(0)
  createdAt    DateTime @default(now())

  // Relations
  collection  DesignCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  design      Design           @relation(fields: [designId], references: [id], onDelete: Cascade)
  addedByUser User             @relation("CollectionItemsAdded", fields: [addedBy], references: [id], onDelete: Cascade)

  @@unique([collectionId, designId])
  @@index([collectionId])
  @@index([designId])
  @@map("DesignCollectionItem")
}

model LibraryFavorite {
  id           String   @id @default(cuid())
  userId       String
  resourceId   String
  resourceType String // 'template', 'clipart', 'design', etc.
  createdAt    DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceId, resourceType])
  @@index([userId])
  @@index([resourceType])
  @@map("LibraryFavorite")
}

model Clipart {
  id            String   @id @default(cuid())
  userId        String?
  brandId       String?
  name          String
  description   String?
  category      String
  tags          String[]
  url           String
  thumbnailUrl  String?
  width         Int?
  height        Int?
  fileSize      Int?
  isPublic      Boolean  @default(false)
  downloadCount Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)
  brand Brand? @relation(fields: [brandId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([brandId])
  @@index([category])
  @@index([isPublic])
  @@index([brandId, category])
  @@index([createdAt])
  @@map("Clipart")
}

// ========================================
// TEAM MANAGEMENT
// ========================================

model TeamMember {
  id             String    @id @default(cuid())
  organizationId String // Brand ID or User ID (for organization)
  userId         String? // User ID if user exists
  email          String
  role           String    @default("member") // 'admin', 'manager', 'designer', 'member', 'viewer'
  permissions    String[] // Array of permission strings
  status         String    @default("pending") // 'active', 'inactive', 'pending', 'invited'
  invitedBy      String?
  joinedAt       DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  user    User?  @relation(fields: [userId], references: [id], onDelete: SetNull)
  inviter User?  @relation("TeamInviter", fields: [invitedBy], references: [id], onDelete: SetNull)
  brand   Brand? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([organizationId, status])
  @@index([organizationId, role])
  @@map("TeamMember")
}

model TeamInvite {
  id             String    @id @default(cuid())
  organizationId String
  email          String
  role           String    @default("member")
  token          String    @unique
  invitedBy      String
  status         String    @default("pending") // 'pending', 'accepted', 'cancelled', 'expired'
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  inviter User   @relation("TeamInvitesSent", fields: [invitedBy], references: [id], onDelete: Cascade)
  brand   Brand? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email, status])
  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
  @@map("TeamInvite")
}

// Add relations to Brand model
// Add to Brand model:
//   analyticsEvents    AnalyticsEvent[]
//   analyticsFunnels   AnalyticsFunnel[]
//   analyticsCohorts   AnalyticsCohort[]
//   analyticsSegments  AnalyticsSegment[]
//   analyticsPredictions AnalyticsPrediction[]
//   aiGenerations      AIGeneration[]
//   aiCollections      AICollection[]
//   sharedResources    SharedResource[]

// ========================================
// AGENTS IA
// ========================================

enum AgentConversationStatus {
  ACTIVE
  ARCHIVED
  ESCALATED
  RESOLVED
}

enum AgentConversationChannel {
  WEB
  API
  WIDGET
  MOBILE
}

enum AgentMetricType {
  LATENCY
  TOKEN_COUNT
  COST
  ERROR_RATE
  SUCCESS_RATE
  SATISFACTION
  ESCALATION_RATE
  CACHE_HIT_RATE
  THROUGHPUT
}

enum AgentAlertType {
  BUDGET_EXCEEDED
  PROVIDER_DOWN
  HIGH_ERROR_RATE
  HIGH_LATENCY
  CIRCUIT_BREAKER_OPEN
  QUOTA_EXCEEDED
  SECURITY_THREAT
}

enum AgentAlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  SILENCED
}

model AgentConversation {
  id      String  @id @default(cuid())
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  agentType String // luna, aria, nova
  sessionId String?
  userId    String?
  title     String?

  status  AgentConversationStatus  @default(ACTIVE)
  channel AgentConversationChannel @default(WEB)

  // Contexte
  context  Json @default("{}")
  metadata Json @default("{}")

  // Compteurs
  totalTokens    Int @default(0)
  totalCostCents Int @default(0)
  messageCount   Int @default(0)

  // Messages
  messages AgentMessage[]
  events   ConversationEvent[]
  tags     ConversationTag[]

  // Relations agents
  novaTickets     NovaTicket[]
  lunaGenerations LunaGeneration[]
  ariaAnalyses    AriaAnalysis[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?

  @@index([brandId])
  @@index([agentType])
  @@index([sessionId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("AgentConversation")
}

model AgentMessage {
  id             String            @id @default(cuid())
  conversationId String
  conversation   AgentConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role    String // user, assistant, system, tool
  content String @db.Text

  // Metadata
  intent     String?
  actions    Json?
  metadata   Json    @default("{}")
  toolCalls  Json?
  toolResult Json?

  // Tracking
  tokenCount Int     @default(0)
  costCents  Int     @default(0)
  latencyMs  Int     @default(0)
  provider   String?
  model      String?

  // Feedback
  feedback MessageFeedback?

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([createdAt])
  @@index([role])
  @@map("AgentMessage")
}

model MessageFeedback {
  id        String       @id @default(cuid())
  messageId String       @unique
  message   AgentMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String?

  rating   Int // 1-5 or thumbs: 1 = down, 5 = up
  comment  String?
  category String? // helpful, accurate, fast, other

  createdAt DateTime @default(now())

  @@index([messageId])
  @@index([userId])
  @@map("MessageFeedback")
}

model ConversationEvent {
  id             String            @id @default(cuid())
  conversationId String
  conversation   AgentConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  type    String // status_change, escalation, tag_added, agent_switch, etc.
  data    Json    @default("{}")
  actorId String?

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([type])
  @@index([createdAt])
  @@map("ConversationEvent")
}

model ConversationTag {
  id             String            @id @default(cuid())
  conversationId String
  conversation   AgentConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  tag String

  createdAt DateTime @default(now())

  @@unique([conversationId, tag])
  @@index([tag])
  @@map("ConversationTag")
}

// ========================================
// AGENTS IA - RAG
// ========================================

model RAGDocument {
  id      String  @id @default(cuid())
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  title     String
  content   String  @db.Text
  source    String? // url, upload, api
  sourceUrl String?
  mimeType  String?

  // Chunking
  chunkIndex Int     @default(0)
  chunkTotal Int     @default(1)
  parentId   String? // ID du document parent si chunk

  // Embedding - stored as JSON array for compatibility; use pgvector raw SQL for similarity search
  embedding      Json?
  embeddingModel String @default("text-embedding-3-small")

  // Metadata
  metadata   Json    @default("{}")
  isActive   Boolean @default(true)
  tokenCount Int     @default(0)

  // Relations
  queries RAGQuery[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([isActive])
  @@index([source])
  @@index([parentId])
  @@map("RAGDocument")
}

model RAGQuery {
  id         String       @id @default(cuid())
  documentId String?
  document   RAGDocument? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  query          String  @db.Text
  agentType      String?
  userId         String?
  resultCount    Int     @default(0)
  relevanceScore Float?
  latencyMs      Int     @default(0)

  createdAt DateTime @default(now())

  @@index([agentType])
  @@index([userId])
  @@index([createdAt])
  @@map("RAGQuery")
}

// ========================================
// AGENTS IA - ARIA ANALYSIS
// ========================================

model AriaAnalysis {
  id             String             @id @default(cuid())
  conversationId String?
  conversation   AgentConversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  brandId        String?
  brand          Brand?             @relation(fields: [brandId], references: [id], onDelete: Cascade)
  userId         String?
  designId       String?

  // Scores (0-100)
  overallScore       Float @default(0)
  colorScore         Float @default(0)
  typographyScore    Float @default(0)
  layoutScore        Float @default(0)
  contrastScore      Float @default(0)
  accessibilityScore Float @default(0)
  consistencyScore   Float @default(0)

  // Feedback détaillé
  feedback    Json  @default("[]") // Array of { category, severity, message, suggestion }
  suggestions Json  @default("[]") // Array of { type, description, autoApplicable, impact }
  rawAnalysis Json?

  status String @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED

  // Améliorations appliquées
  improvements AriaAppliedImprovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId])
  @@index([brandId])
  @@index([userId])
  @@index([designId])
  @@index([status])
  @@map("AriaAnalysis")
}

model AriaAppliedImprovement {
  id         String       @id @default(cuid())
  analysisId String
  analysis   AriaAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  type        String // color, typography, layout, contrast, accessibility
  description String
  before      Json?
  after       Json?
  impact      Float  @default(0) // Score improvement

  appliedAt DateTime @default(now())

  @@index([analysisId])
  @@index([type])
  @@map("AriaAppliedImprovement")
}

// ========================================
// AGENTS IA - LUNA GENERATION
// ========================================

model LunaGeneration {
  id             String             @id @default(cuid())
  conversationId String?
  conversation   AgentConversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  brandId        String?
  brand          Brand?             @relation(fields: [brandId], references: [id], onDelete: Cascade)
  userId         String?

  type   String // design, palette, text, logo, banner, social_post
  prompt String @db.Text
  result Json? // Generation result (URLs, data, etc.)

  // Parameters
  parameters Json    @default("{}")
  style      String?
  dimensions Json? // { width, height }

  status String @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED

  // Costs
  tokenCount Int @default(0)
  costCents  Int @default(0)
  latencyMs  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId])
  @@index([brandId])
  @@index([userId])
  @@index([type])
  @@index([status])
  @@map("LunaGeneration")
}

// ========================================
// AGENTS IA - NOVA TICKETS
// ========================================

model NovaTicket {
  id             String             @id @default(cuid())
  conversationId String?
  conversation   AgentConversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  brandId        String?
  brand          Brand?             @relation(fields: [brandId], references: [id], onDelete: Cascade)
  userId         String?
  assignedTo     String?

  subject     String
  description String @db.Text
  status      String @default("OPEN") // OPEN, IN_PROGRESS, WAITING_CUSTOMER, ESCALATED, RESOLVED, CLOSED
  priority    String @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT, CRITICAL
  category    String @default("GENERAL") // GENERAL, BILLING, TECHNICAL, PRODUCT, SHIPPING, RETURNS, ACCOUNT

  // Metadata
  metadata Json     @default("{}")
  tags     String[] @default([])

  // Resolution
  resolution        String?   @db.Text
  satisfactionScore Int?
  resolvedAt        DateTime?
  firstResponseAt   DateTime?

  // Messages et activité
  messages   NovaTicketMessage[]
  activities NovaTicketActivity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId])
  @@index([brandId])
  @@index([userId])
  @@index([assignedTo])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([createdAt])
  @@map("NovaTicket")
}

model NovaTicketMessage {
  id       String     @id @default(cuid())
  ticketId String
  ticket   NovaTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  role        String // customer, agent, system, bot
  content     String @db.Text
  attachments Json?

  isInternal Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([createdAt])
  @@map("NovaTicketMessage")
}

model NovaTicketActivity {
  id       String     @id @default(cuid())
  ticketId String
  ticket   NovaTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  type    String // status_change, assignment, escalation, note, tag_change
  data    Json    @default("{}")
  actorId String?

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([type])
  @@index([createdAt])
  @@map("NovaTicketActivity")
}

// ========================================
// AGENTS IA - PROMPT TEMPLATES
// ========================================

model AgentPromptTemplate {
  id      String  @id @default(cuid())
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  name      String
  agentType String // luna, aria, nova, system
  type      String // system, user, few_shot, tool_instruction
  content   String @db.Text

  // Versioning
  version   Int     @default(1)
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  // Variables supportées
  variables Json @default("[]")

  // Performance tracking
  usageCount Int   @default(0)
  avgRating  Float @default(0)

  metadata Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([brandId, agentType, name, version])
  @@index([agentType])
  @@index([type])
  @@index([isActive])
  @@map("AgentPromptTemplate")
}

// ========================================
// AGENTS IA - METRICS & ALERTS
// ========================================

model AgentMetric {
  id      String  @id @default(cuid())
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  agentType  String?
  provider   String?
  model      String?
  metricType AgentMetricType

  value Float
  unit  String? // ms, tokens, usd, percent
  tags  Json    @default("{}")

  timestamp DateTime @default(now())

  @@index([brandId])
  @@index([agentType])
  @@index([provider])
  @@index([metricType])
  @@index([timestamp])
  @@map("AgentMetric")
}

model AgentAlert {
  id      String  @id @default(cuid())
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  type     AgentAlertType
  severity AlertSeverity
  status   AgentAlertStatus @default(ACTIVE)

  title   String
  message String @db.Text
  data    Json   @default("{}")

  // Resolution
  acknowledgedAt DateTime?
  acknowledgedBy String?
  resolvedAt     DateTime?
  resolvedBy     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
  @@map("AgentAlert")
}

// ========================================
// SUPER ADMIN DASHBOARD MODELS
// ========================================

// ========================================
// GESTION CLIENTS ÉTENDUE
// ========================================

model Customer {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Métriques
  totalRevenue    Float  @default(0)
  ltv             Float  @default(0)
  engagementScore Int    @default(100)
  churnRisk       String @default("low") // low, medium, high

  // Tracking
  firstSeenAt    DateTime @default(now())
  lastSeenAt     DateTime @default(now())
  totalSessions  Int      @default(0)
  totalTimeSpent Int      @default(0) // en secondes

  // Relations
  segments   CustomerSegment[]
  activities CustomerActivity[]
  emailsSent EmailLog[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  AutomationRun AutomationRun[]
  Event         Event[]

  @@index([userId])
  @@index([churnRisk])
  @@index([lastSeenAt])
  @@index([createdAt])
}

model CustomerActivity {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  type     String // login, action, page_view, etc.
  action   String
  metadata Json?

  createdAt DateTime @default(now())

  @@index([customerId, createdAt])
  @@index([type])
  @@index([createdAt])
}

model CustomerSegment {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Critères dynamiques
  criteria Json // { engagementScore: { gte: 80 }, plan: "pro" }

  // P2-6: Multi-tenancy isolation
  brandId String?
  brand   Brand?  @relation("BrandCustomerSegments", fields: [brandId], references: [id], onDelete: SetNull)

  // Relations
  customers Customer[]
  campaigns EmailCampaign[] @relation("CampaignSegment")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([brandId])
}

// ========================================
// EMAIL MARKETING
// ========================================

model EmailTemplate {
  id          String                @id @default(cuid())
  name        String
  slug        String                @unique
  subject     String
  htmlContent String                @db.Text
  textContent String?               @db.Text
  variables   String[] // ["firstName", "planName", etc.]
  category    EmailTemplateCategory @default(OTHER)

  // Relations
  campaigns       EmailCampaign[]
  automationSteps AutomationStep[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([category])
}

model EmailCampaign {
  id         String         @id @default(cuid())
  name       String
  subject    String
  templateId String?
  template   EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  status CampaignStatus @default(DRAFT) // ENUM-01: Utilise enum au lieu de string

  // P2-6: Multi-tenancy isolation
  brandId String?
  brand   Brand?  @relation("BrandEmailCampaigns", fields: [brandId], references: [id], onDelete: SetNull)

  // Ciblage
  segmentId String?
  segment   CustomerSegment? @relation("CampaignSegment", fields: [segmentId], references: [id], onDelete: SetNull)

  // Stats
  sentCount  Int @default(0)
  openCount  Int @default(0)
  clickCount Int @default(0)

  scheduledAt DateTime?
  sentAt      DateTime?

  // Relations
  logs EmailLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([scheduledAt])
  @@index([brandId])
}

model EmailAutomation {
  id            String  @id @default(cuid())
  name          String
  description   String?
  trigger       String // user.created, trial.started, etc.
  triggerConfig Json?

  status AutomationStatus @default(draft)

  // P2-6: Multi-tenancy isolation
  brandId String?
  brand   Brand?  @relation("BrandEmailAutomations", fields: [brandId], references: [id], onDelete: SetNull)

  // Relations
  steps AutomationStep[]
  runs  AutomationRun[]
  logs  EmailLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([trigger])
  @@index([status])
  @@index([brandId])
}

model AutomationStep {
  id           String          @id @default(cuid())
  automationId String
  automation   EmailAutomation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  order Int

  type String // email, wait, condition

  // Pour type "email"
  templateId String?
  template   EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  subject    String?

  // Pour type "wait"
  waitDuration Int? // en minutes

  // Pour type "condition"
  condition Json?

  createdAt DateTime @default(now())

  @@index([automationId, order])
}

model AutomationRun {
  id           String          @id @default(cuid())
  automationId String
  automation   EmailAutomation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  status      AutomationRunStatus @default(active)
  currentStep Int                 @default(0)

  startedAt   DateTime  @default(now())
  completedAt DateTime?
  nextStepAt  DateTime?

  @@index([automationId])
  @@index([customerId])
  @@index([status])
  @@index([nextStepAt])
}

model EmailLog {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  messageId String @unique // ID du provider (Resend, etc.)
  type      String // campaign, automation, transactional

  campaignId   String?
  campaign     EmailCampaign?   @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  automationId String?
  automation   EmailAutomation? @relation(fields: [automationId], references: [id], onDelete: SetNull)

  subject  String
  template String?

  status String @default("sent") // sent, delivered, opened, clicked, bounced

  openedAt  DateTime?
  clickedAt DateTime?
  bouncedAt DateTime?

  createdAt DateTime @default(now())

  @@index([customerId, createdAt])
  @@index([type])
  @@index([status])
  @@index([messageId])
  @@index([campaignId])
  @@index([automationId])
}

// ========================================
// INTÉGRATIONS ADS
// ========================================

model AdPlatformConnection {
  id          String  @id @default(cuid())
  platform    String // meta, google, tiktok
  accountId   String // ID du compte pub
  accountName String?

  accessToken  String    @db.Text
  refreshToken String?   @db.Text
  expiresAt    DateTime?

  status String @default("active") // active, expired, error

  lastSyncAt DateTime?
  metadata   Json? // Infos additionnelles du compte

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([platform, accountId])
  @@index([platform])
  @@index([status])
}

model AdCampaignSync {
  id         String @id @default(cuid())
  platform   String
  externalId String // ID de la campagne sur la plateforme
  name       String
  status     String

  // Métriques synchronisées
  spend       Float @default(0)
  impressions Int   @default(0)
  clicks      Int   @default(0)
  conversions Int   @default(0)
  revenue     Float @default(0)

  // Période des données
  dateFrom DateTime
  dateTo   DateTime

  syncedAt DateTime @default(now())

  @@unique([platform, externalId, dateFrom, dateTo])
  @@index([platform, dateFrom])
  @@index([dateFrom, dateTo])
}

// ========================================
// WEBHOOKS & EVENTS (Extension)
// ========================================

model Event {
  id         String    @id @default(cuid())
  type       String // user.created, subscription.cancelled, etc.
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  data Json // Payload de l'événement

  processed   Boolean   @default(false)
  processedAt DateTime?

  // Relations
  webhookLogs WebhookLog[] @relation

  createdAt DateTime @default(now())

  @@index([type, createdAt])
  @@index([customerId, createdAt])
  @@index([processed, createdAt])
}

// Note: Webhook et WebhookLog existent déjà dans le schema
// On ajoute juste la relation avec Event
// Il faut ajouter dans WebhookLog:
//   eventId String?
//   event   Event? @relation(fields: [eventId], references: [id])

// ========================================
// ANALYTICS & METRICS SNAPSHOTS
// ========================================

model DailyMetrics {
  id   String   @id @default(cuid())
  date DateTime @db.Date

  // Revenue
  mrr     Float @default(0)
  arr     Float @default(0)
  revenue Float @default(0)

  // Customers
  totalCustomers   Int @default(0)
  activeCustomers  Int @default(0)
  newCustomers     Int @default(0)
  churnedCustomers Int @default(0)

  // Trials
  activeTrials    Int @default(0)
  trialsStarted   Int @default(0)
  trialsConverted Int @default(0)

  // Churn
  churnRate Float @default(0)

  // Ads
  adSpend       Float @default(0)
  adConversions Int   @default(0)
  adRevenue     Float @default(0)

  createdAt DateTime @default(now())

  @@unique([date])
  @@index([date])
}

model MonthlyMetrics {
  id    String @id @default(cuid())
  year  Int
  month Int

  // Revenue
  mrr          Float @default(0)
  arr          Float @default(0)
  totalRevenue Float @default(0)

  // Growth
  mrrGrowth Float @default(0)

  // Customers
  startingCustomers Int @default(0)
  endingCustomers   Int @default(0)
  newCustomers      Int @default(0)
  churnedCustomers  Int @default(0)

  // Rates
  churnRate      Float @default(0)
  conversionRate Float @default(0)

  // LTV & CAC
  avgLtv      Float @default(0)
  avgCac      Float @default(0)
  ltvCacRatio Float @default(0)

  createdAt DateTime @default(now())

  @@unique([year, month])
  @@index([year, month])
}

model CohortData {
  id          String   @id @default(cuid())
  cohortMonth DateTime @db.Date // Mois de la cohorte (inscription)

  // Données par mois après inscription
  monthNumber    Int // 0 = mois d'inscription, 1 = mois suivant, etc.
  startingCount  Int // Nombre de clients au départ de la cohorte
  remainingCount Int // Nombre de clients restants ce mois
  retentionRate  Float // % de rétention
  revenue        Float @default(0)

  createdAt DateTime @default(now())

  @@unique([cohortMonth, monthNumber])
  @@index([cohortMonth])
}

// ========================================
// NOTIFICATIONS ADMIN
// ========================================

model AdminNotification {
  id      String @id @default(cuid())
  type    String // alert, info, success, warning
  title   String
  message String

  // Lien vers une action
  actionUrl   String?
  actionLabel String?

  read   Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([read, createdAt])
}

// ========================================
// AUDIT LOG (Actions Admin)
// ========================================

model AdminAuditLog {
  id         String  @id @default(cuid())
  adminId    String // ID de l'admin qui a fait l'action
  action     String // create, update, delete, export, etc.
  resource   String // customer, campaign, webhook, etc.
  resourceId String?

  changes Json? // Détail des changements (before/after)

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([adminId, createdAt])
  @@index([resource, resourceId])
}

// ========================================
// SSO CONFIGURATION (Enterprise SSO)
// ========================================

model SSOConfiguration {
  id       String  @id @default(cuid())
  brandId  String
  brand    Brand   @relation(fields: [brandId], references: [id], onDelete: Cascade)
  provider String // 'saml' | 'oidc'
  name     String
  enabled  Boolean @default(true)

  // SAML Configuration
  samlEntryPoint    String?
  samlIssuer        String?
  samlCert          String? // Base64 encoded certificate
  samlCallbackUrl   String?
  samlDecryptionPvk String? // Encrypted private key

  // OIDC Configuration
  oidcIssuer       String?
  oidcClientId     String?
  oidcClientSecret String? // Encrypted
  oidcCallbackUrl  String?
  oidcScope        String? @default("openid profile email")

  // Metadata
  metadataUrl String?
  metadataXml String? // SAML metadata XML

  // Settings
  autoProvisioning Boolean @default(true)
  defaultRole      String?
  attributeMapping Json? // { email: "email", firstName: "given_name", ... }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([brandId, provider])
  @@index([brandId])
  @@index([provider])
  @@index([enabled])
}

// ========================================
// MARKETPLACE & COMMUNITY (PHASE 7)
// ========================================

model MarketplaceTemplate {
  id          String   @id @default(cuid())
  creatorId   String
  name        String
  slug        String   @unique
  description String?
  category    String?
  tags        String[]

  // Template content
  promptTemplate String
  negativePrompt String?
  variables      Json?
  exampleOutputs String[]

  // AI settings
  aiProvider String @default("openai")
  model      String @default("dall-e-3")
  quality    String @default("standard")
  style      String @default("natural")

  // Pricing
  priceCents          Int     @default(0)
  isFree              Boolean @default(false)
  revenueSharePercent Int     @default(70)

  // Stats
  downloads         Int   @default(0)
  likes             Int   @default(0)
  reviews           Int   @default(0)
  averageRating     Float @default(0)
  totalRevenueCents Int   @default(0)

  // Status
  status      String    @default("draft")
  publishedAt DateTime?
  featured    Boolean   @default(false)

  // Metadata
  thumbnailUrl  String?
  previewImages String[]
  metadata      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId])
  @@index([status])
  @@index([category])
  @@index([featured])
  @@index([publishedAt])
}

model CreatorProfile {
  id          String  @id @default(cuid())
  userId      String  @unique
  username    String  @unique
  displayName String
  bio         String?
  avatar      String?
  coverImage  String?
  website     String?

  // Social links
  socialLinks Json?

  // Stats
  templatesCount     Int   @default(0)
  totalSales         Int   @default(0)
  totalEarningsCents Int   @default(0)
  followersCount     Int   @default(0)
  followingCount     Int   @default(0)
  averageRating      Float @default(0)

  // Stripe Connect
  stripeConnectId String?
  payoutEnabled   Boolean @default(false)

  // Verification
  verified   Boolean   @default(false)
  verifiedAt DateTime?

  // Status
  status String @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([username])
  @@index([verified])
  @@index([status])
}

model TemplatePurchase {
  id         String @id @default(cuid())
  templateId String
  buyerId    String
  creatorId  String

  // Pricing
  priceCents          Int
  platformFeeCents    Int
  creatorRevenueCents Int

  // Payment
  stripePaymentIntentId String?
  paymentStatus         String  @default("pending")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
  @@index([buyerId])
  @@index([creatorId])
  @@index([paymentStatus])
}

model CreatorPayout {
  id        String @id @default(cuid())
  creatorId String

  // Amounts
  totalRevenueCents Int
  platformFeeCents  Int
  netAmountCents    Int

  // Stripe
  stripeTransferId String?
  stripePayoutId   String?

  // Status
  status        String  @default("pending")
  failureReason String?

  // Period
  periodStart DateTime
  periodEnd   DateTime

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime?

  @@index([creatorId])
  @@index([status])
  @@index([periodStart])
  @@index([periodEnd])
}

model TemplateLike {
  id         String @id @default(cuid())
  templateId String
  userId     String

  createdAt DateTime @default(now())

  @@unique([templateId, userId])
  @@index([templateId])
  @@index([userId])
}

model CreatorFollow {
  id          String @id @default(cuid())
  followerId  String
  followingId String

  createdAt DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model TemplateReview {
  id         String  @id @default(cuid())
  templateId String
  userId     String
  purchaseId String?

  rating  Int
  comment String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, userId])
  @@index([templateId])
  @@index([userId])
  @@index([rating])
}

model TemplateFavorite {
  id         String @id @default(cuid())
  templateId String
  userId     String

  createdAt DateTime @default(now())

  @@unique([templateId, userId])
  @@index([templateId])
  @@index([userId])
}

model TemplateCollection {
  id           String  @id @default(cuid())
  creatorId    String
  name         String
  slug         String  @unique
  description  String?
  thumbnailUrl String?
  isPublic     Boolean @default(true)

  templatesCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId])
}

model TemplateCollectionItem {
  id           String @id @default(cuid())
  collectionId String
  templateId   String
  order        Int    @default(0)

  createdAt DateTime @default(now())

  @@unique([collectionId, templateId])
  @@index([collectionId])
  @@index([templateId])
}

// ========================================
// ENTERPRISE (PHASE 8)
// ========================================

model CustomTheme {
  id              String  @id @default(cuid())
  brandId         String
  name            String
  primaryColor    String
  secondaryColor  String
  accentColor     String
  backgroundColor String
  textColor       String
  fontFamily      String  @default("Inter")
  borderRadius    String  @default("8px")
  logoUrl         String?
  faviconUrl      String?
  customCss       String? @db.Text
  isActive        Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([isActive])
  @@index([brandId, isActive])
}

model CustomDomain {
  id             String    @id @default(cuid())
  brandId        String
  domain         String    @unique
  isActive       Boolean   @default(false)
  sslCertificate String?   @db.Text
  sslExpiresAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([isActive])
  @@index([brandId, isActive])
}

model SLATicket {
  id                    String    @id @default(cuid())
  ticketId              String
  brandId               String
  planId                String
  priority              String // 'low', 'medium', 'high', 'critical'
  createdAt             DateTime  @default(now())
  firstResponseAt       DateTime?
  resolvedAt            DateTime?
  slaResponseDeadline   DateTime
  slaResolutionDeadline DateTime
  slaStatus             String    @default("on_time") // 'on_time', 'at_risk', 'breached'
  escalationLevel       Int       @default(0)

  updatedAt DateTime @updatedAt

  @@unique([ticketId])
  @@index([brandId])
  @@index([planId])
  @@index([slaStatus])
  @@index([slaResponseDeadline])
  @@index([slaResolutionDeadline])
  @@index([brandId, slaStatus])
}

// ========================================
// AI MONITORING (Added for backend compatibility)
// ========================================

model AIQuota {
  id      String  @id @default(cuid())
  userId  String? @unique // Optional pour les quotas brand-level
  brandId String? @unique
  planId  String?

  // Limits
  dailyLimit      Int    @default(100)
  monthlyLimit    Int    @default(3000)
  tokenLimit      Int    @default(1000000)
  requestLimit    Int    @default(10000)
  totalLimit      Int    @default(100000)
  limitType       String @default("requests")
  limitValue      Int    @default(1000)
  monthlyTokens   Int    @default(1000000)
  monthlyRequests Int    @default(10000)

  // Usage
  dailyUsed    Int @default(0)
  monthlyUsed  Int @default(0)
  usedTokens   Int @default(0)
  usedRequests Int @default(0)
  totalUsed    Int @default(0)

  // Reset timestamps
  dailyResetAt   DateTime @default(now())
  monthlyResetAt DateTime @default(now())
  resetAt        DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([brandId])
  @@index([planId])
}

model AIUsageLog {
  id      String  @id @default(cuid())
  userId  String
  brandId String?
  agentId String?

  // Provider info
  provider  String?
  model     String
  operation String? // Type d'opération (chat, completion, embedding, etc.)

  // Request details - support both naming conventions
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  inputTokens      Int? // Alias pour promptTokens
  outputTokens     Int? // Alias pour completionTokens
  costCents        Int  @default(0)
  latencyMs        Int  @default(0)

  // Metadata
  requestType  String?
  success      Boolean @default(true)
  errorMessage String?
  metadata     Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([brandId])
  @@index([agentId])
  @@index([createdAt])
  @@index([model])
  @@index([provider])
  @@index([operation])
}

model AIAnalytics {
  id      String  @id @default(cuid())
  brandId String?
  agentId String?

  // Aggregated data
  date              DateTime @db.Date
  totalRequests     Int      @default(0)
  totalTokens       Int      @default(0)
  totalCostCents    Int      @default(0)
  averageLatencyMs  Int      @default(0)
  errorRate         Float    @default(0)
  conversationCount Int      @default(0)
  messageCount      Int      @default(0) // Nombre de messages

  // By model breakdown (JSON)
  modelBreakdown    Json?
  providerBreakdown Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([brandId, agentId, date])
  @@index([date])
  @@index([brandId])
  @@index([agentId])
}

model AIRateLimit {
  id      String  @id @default(cuid())
  userId  String?
  brandId String?

  // Rate limit data
  windowStart  DateTime
  requestCount Int      @default(0)
  tokenCount   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, windowStart])
  @@unique([brandId, userId, windowStart])
  @@index([userId])
  @@index([brandId])
  @@index([windowStart])
}

// ========================================
// AR INTEGRATIONS
// ========================================

model ARIntegration {
  id      String @id @default(cuid())
  brandId String

  // Platform config
  platform   String // 'web', 'ios', 'android'
  name       String
  apiKey     String?
  apiSecret  String?
  webhookUrl String?

  // Sync status
  lastSyncAt DateTime?
  syncStatus String    @default("idle")

  // Settings
  isActive Boolean @default(true)
  settings Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([platform])
  @@index([isActive])
  @@index([brandId, isActive])
}

model SyncHistory {
  id            String @id @default(cuid())
  integrationId String

  // Sync details
  entityType String?
  entityId   String?
  syncType   String?
  status     String  @default("pending")

  // Results
  itemsSynced      Int     @default(0)
  recordsProcessed Int     @default(0)
  errors           Json?
  errorMessage     String?
  metadata         Json?

  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  createdAt DateTime @default(now())

  @@index([integrationId])
  @@index([entityType])
  @@index([entityId])
  @@index([syncType])
  @@index([status])
  @@index([startedAt])
}

// ========================================
// WEBHOOK DELIVERY
// ========================================

model WebhookDelivery {
  id        String @id @default(cuid())
  webhookId String

  // Delivery details
  eventType String
  payload   Json

  // Response
  statusCode   Int?
  responseCode Int?
  responseBody String? @db.Text

  // Status
  status        String    @default("pending")
  attempts      Int       @default(0)
  lastAttemptAt DateTime?
  nextRetryAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([webhookId])
  @@index([status])
  @@index([eventType])
  @@index([createdAt])
}

// ========================================
// DISASTER RECOVERY
// ========================================

model BackupRecord {
  id String @id @default(cuid())

  // Backup details
  type   String // 'full', 'incremental', 'differential'
  status String @default("pending")

  // Storage
  storagePath String?
  location    String?
  sizeBytes   BigInt  @default(0)
  size        Int     @default(0)

  // Checksums
  checksum String?

  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime?

  // Metadata & Errors
  metadata     Json?
  errorMessage String?
  error        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model RestoreDrillRecord {
  id       String  @id @default(cuid())
  backupId String?

  // Drill details
  type   String // 'full', 'partial', 'verification'
  status String @default("pending")

  // Results
  tablesRestored  Int   @default(0)
  recordsVerified Int   @default(0)
  discrepancies   Json?
  duration        Int?

  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  // Metadata & Errors
  performedBy  String?
  notes        String? @db.Text
  errorMessage String?
  error        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([backupId])
  @@index([status])
  @@index([createdAt])
}

// ========================================
// ASSET HUB
// ========================================

model AssetFolder {
  id             String  @id @default(cuid())
  brandId        String
  organizationId String?
  parentId       String?

  name        String
  description String?
  path        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  parent   AssetFolder?  @relation("FolderTree", fields: [parentId], references: [id], onDelete: SetNull)
  children AssetFolder[] @relation("FolderTree")
  files    AssetFile[]

  @@index([brandId])
  @@index([organizationId])
  @@index([parentId])
}

model AssetFile {
  id             String  @id @default(cuid())
  brandId        String
  organizationId String?
  folderId       String?

  // File info
  name         String
  originalName String?
  mimeType     String
  size         Int
  sizeBytes    Int? // Alias for services using this field
  type         AssetFileType @default(OTHER)

  // Storage
  url          String
  cdnUrl       String?
  thumbnailUrl String?
  thumbnails   Json? // For multiple thumbnail sizes
  storageKey   String?
  publicId     String?

  // Metadata
  width    Int?
  height   Int?
  duration Int?
  metadata Json?
  tags     String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  folder AssetFolder? @relation(fields: [folderId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([folderId])
  @@index([type])
  @@index([brandId, type])
  @@index([brandId, folderId])
}

// ========================================
// PROJECTS & WORKSPACES
// ========================================

model Workspace {
  id      String @id @default(cuid())
  brandId String

  name        String
  slug        String
  description String?
  environment WorkspaceEnvironment @default(DEVELOPMENT)

  isDefault Boolean @default(false)
  settings  Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp (consistency with Project)

  // Relations
  brand           Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)
  projects        Project[]
  projectsManyRef Project[] @relation("ProjectWorkspaces")

  @@unique([brandId, slug])
  @@index([brandId])
  @@index([deletedAt]) // Soft delete index for efficient queries on active workspaces
}

model Project {
  id             String  @id @default(cuid())
  brandId        String
  organizationId String?
  workspaceId    String?

  name        String
  slug        String
  description String?
  type        ProjectType   @default(DESIGN)
  status      ProjectStatus @default(DRAFT)

  // Security
  apiKey String? @unique

  // Metadata
  thumbnail String?
  settings  Json?
  metadata  Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  brand                        Brand                         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  workspace                    Workspace?                    @relation(fields: [workspaceId], references: [id])
  configurator3DConfigurations Configurator3DConfiguration[]
  tryOnConfigurations          TryOnConfiguration[]
  visualCustomizers            VisualCustomizer[]
  workspaces                   Workspace[]                   @relation("ProjectWorkspaces")

  @@unique([brandId, slug])
  @@unique([organizationId, slug])
  @@index([brandId])
  @@index([organizationId])
  @@index([workspaceId])
  @@index([type])
  @@index([status])
  @@index([deletedAt])
  @@index([brandId, status])
  @@index([brandId, type])
}

// ========================================
// CONFIGURATOR 3D
// ========================================

model Configurator3DConfiguration {
  id          String  @id @default(cuid())
  brandId     String
  productId   String?
  projectId   String?
  createdById String?

  // Identification
  name        String
  description String?            @db.Text
  slug        String             @unique @default(cuid())
  type        ConfiguratorType   @default(CUSTOM)
  status      ConfiguratorStatus @default(DRAFT)

  // 3D Model
  modelUrl     String?
  modelFormat  String  @default("gltf")
  modelSize    Int?
  thumbnailUrl String?

  // Settings & Scene
  settings        Json?
  sceneConfig     Json?
  cameraSettings  Json?
  pricingSettings Json?
  uiConfig        Json?

  // Access & Security
  isActive            Boolean   @default(true)
  isPublic            Boolean   @default(false)
  isPasswordProtected Boolean   @default(false)
  password            String?
  allowedDomains      String[]
  expiresAt           DateTime?

  // Features
  enableAR          Boolean @default(true)
  enableScreenshots Boolean @default(true)
  enableSharing     Boolean @default(true)
  enablePricing     Boolean @default(true)
  enableComparison  Boolean @default(false)

  // Embed
  customCss String? @db.Text
  customJs  String? @db.Text

  // SEO
  metaTitle       String?
  metaDescription String? @db.Text
  ogImage         String?

  // Metadata
  tags     String[]
  metadata Json?

  // Versioning
  version          Int  @default(1)
  publishedVersion Int?

  // Counters
  viewCount       Int @default(0)
  sessionCount    Int @default(0)
  conversionCount Int @default(0)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
  archivedAt  DateTime?
  deletedAt   DateTime?

  // Relations
  brand           Brand                          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  project         Project?                       @relation(fields: [projectId], references: [id])
  options         Configurator3DOption[]
  sessions        Configurator3DSession[]
  components      Configurator3DComponent[]
  rules           Configurator3DRule[]
  savedDesigns    Configurator3DSavedDesign[]
  exports         Configurator3DExport[]
  auditLogs       Configurator3DAuditLog[]
  analytics       Configurator3DAnalytics[]
  componentGroups Configurator3DComponentGroup[]

  @@index([brandId])
  @@index([productId])
  @@index([projectId])
  @@index([isActive])
  @@index([brandId, isActive])
  @@index([brandId, status])
  @@index([status, isPublic])
  @@index([slug])
  @@index([createdAt])
}

model Configurator3DComponentGroup {
  id              String @id @default(cuid())
  configurationId String

  name          String
  description   String?
  sortOrder     Int     @default(0)
  isCollapsible Boolean @default(true)
  isCollapsed   Boolean @default(false)
  iconUrl       String?

  configuration Configurator3DConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  components    Configurator3DComponent[]

  @@index([configurationId, sortOrder])
  @@map("configurator_3d_component_groups")
}

model Configurator3DComponent {
  id              String @id @default(cuid())
  configurationId String

  // Identification
  name        String
  technicalId String?
  description String? @db.Text
  type        String
  meshName    String?

  // Selection
  selectionMode SelectionMode @default(SINGLE)
  isRequired    Boolean       @default(false)
  minSelections Int           @default(0)
  maxSelections Int           @default(1)

  // Display
  sortOrder       Int     @default(0)
  isVisible       Boolean @default(true)
  isOptional      Boolean @default(false)
  isEnabled       Boolean @default(true)
  iconUrl         String?
  previewImageUrl String?

  // 3D
  settings         Json?
  bounds           Json?
  cameraFocusPoint Json?
  highlightColor   String?

  // Dependencies
  dependencies   String[]
  dependencyMode DependencyMode @default(ALL)

  // Grouping
  groupId String?
  group   Configurator3DComponentGroup? @relation(fields: [groupId], references: [id])

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  configuration Configurator3DConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  options       Configurator3DOption[]

  @@unique([configurationId, technicalId])
  @@index([configurationId])
  @@index([configurationId, sortOrder])
  @@index([configurationId, type])
}

model Configurator3DOption {
  id              String  @id @default(cuid())
  configurationId String
  componentId     String?

  // Identification
  name        String
  label       String?
  sku         String?
  type        Configurator3DOptionType
  description String?                  @db.Text

  // Values
  value        String?
  values       Json?
  defaultValue String?

  // Display
  sortOrder       Int     @default(0)
  order           Int     @default(0)
  isDefault       Boolean @default(false)
  isRequired      Boolean @default(false)
  isEnabled       Boolean @default(true)
  isVisible       Boolean @default(true)
  previewImageUrl String?
  swatchImageUrl  String?

  // Constraints
  constraints Json?

  // Pricing
  priceDelta    Int         @default(0)
  pricingType   PricingType @default(FIXED)
  priceModifier Float       @default(0)
  priceFormula  String?
  currency      String      @default("EUR")

  // Stock
  inStock       Boolean @default(true)
  stockQuantity Int?
  leadTimeDays  Int?

  // 3D Assets
  textureUrls Json?
  modelUrl    String?

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  configuration Configurator3DConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  component     Configurator3DComponent?    @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@index([configurationId])
  @@index([componentId])
  @@index([componentId, sortOrder])
  @@index([componentId, isDefault])
  @@index([type])
  @@index([order])
  @@index([sku])
}

model Configurator3DRule {
  id              String @id @default(cuid())
  configurationId String

  name        String
  description String?  @db.Text
  type        RuleType

  // Conditions (AND logic)
  conditions Json

  // Actions
  actions Json

  // Execution
  priority       Int     @default(0)
  isEnabled      Boolean @default(true)
  stopProcessing Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  configuration Configurator3DConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)

  @@index([configurationId, priority])
  @@index([configurationId, isEnabled])
  @@map("configurator_3d_rules")
}

model Configurator3DSession {
  id              String  @id @default(cuid())
  sessionId       String? @unique
  configurationId String
  userId          String?
  visitorId       String?
  anonymousId     String?

  status Configurator3DSessionStatus @default(ACTIVE)

  // Session data
  selectedOptions Json?
  selections      Json?
  previewUrl      String?
  previewImageUrl String?
  state           Json?

  // Pricing
  calculatedPrice Float?
  priceBreakdown  Json?
  currency        String @default("EUR")

  // Tracking
  source    String?
  referrer  String?
  utmParams Json?

  // Metadata
  deviceInfo String?
  ipAddress  String?

  // Geo
  country String?
  region  String?
  city    String?

  // Timestamps
  startedAt      DateTime  @default(now())
  lastActivityAt DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  savedAt        DateTime?
  completedAt    DateTime?
  expiresAt      DateTime?

  // Conversion
  convertedAt     DateTime?
  conversionType  ConversionType?
  conversionValue Float?
  orderId         String?

  // Relations
  configuration Configurator3DConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  interactions  Configurator3DInteraction[]
  exports       Configurator3DExport[]
  savedDesign   Configurator3DSavedDesign?

  @@index([configurationId])
  @@index([configurationId, status])
  @@index([configurationId, startedAt])
  @@index([userId])
  @@index([status])
  @@index([sessionId])
  @@index([visitorId])
  @@index([anonymousId])
  @@index([status, lastActivityAt])
}

model Configurator3DInteraction {
  id        String @id @default(cuid())
  sessionId String

  type InteractionType

  // Interaction data
  componentId      String?
  optionId         String?
  previousOptionId String?

  // Camera
  cameraPosition Json?
  cameraTarget   Json?

  // Timing
  timestamp  DateTime @default(now())
  durationMs Int?

  // Metadata
  metadata Json?

  session Configurator3DSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
  @@index([sessionId, type])
  @@index([componentId])
  @@map("configurator_3d_interactions")
}

model Configurator3DSavedDesign {
  id              String  @id @default(cuid())
  configurationId String
  sessionId       String? @unique
  userId          String?

  // Design
  name        String
  description String? @db.Text
  selections  Json

  // Pricing
  savedPrice Float?
  currency   String @default("EUR")

  // Images
  thumbnailUrl  String?
  previewImages String[]

  // Sharing
  shareToken String  @unique @default(cuid())
  isPublic   Boolean @default(false)
  shareUrl   String?
  viewCount  Int     @default(0)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime?

  configuration Configurator3DConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  session       Configurator3DSession?      @relation(fields: [sessionId], references: [id])

  @@index([configurationId, userId])
  @@index([shareToken])
  @@index([userId, createdAt])
  @@map("configurator_3d_saved_designs")
}

model Configurator3DExport {
  id              String  @id @default(cuid())
  configurationId String
  sessionId       String?
  userId          String

  type   ExportType
  format String
  status ExportStatus @default(PENDING)

  // File
  fileUrl  String?
  fileName String?
  fileSize Int?

  // Options
  options Json?

  // Progress
  progress Int @default(0)

  // Error
  errorMessage String? @db.Text

  // Timestamps
  createdAt   DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime?

  configuration Configurator3DConfiguration @relation(fields: [configurationId], references: [id])
  session       Configurator3DSession?      @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
  @@index([userId, createdAt])
  @@index([status])
  @@map("configurator_3d_exports")
}

model Configurator3DAuditLog {
  id              String @id @default(cuid())
  configurationId String
  userId          String

  action     String
  entityType String
  entityId   String?

  // Changes
  previousValue Json?
  newValue      Json?

  // Context
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  configuration Configurator3DConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)

  @@index([configurationId, createdAt])
  @@index([userId, createdAt])
  @@index([action])
  @@map("configurator_3d_audit_logs")
}

model Configurator3DAnalytics {
  id              String   @id @default(cuid())
  configurationId String
  date            DateTime @db.Date

  // Metrics
  views              Int @default(0)
  uniqueViews        Int @default(0)
  sessions           Int @default(0)
  completedSessions  Int @default(0)
  avgSessionDuration Int @default(0)

  // Interactions
  totalInteractions Int @default(0)
  optionChanges     Int @default(0)
  screenshots       Int @default(0)
  arLaunches        Int @default(0)

  // Conversions
  addToCarts    Int @default(0)
  purchases     Int @default(0)
  quoteRequests Int @default(0)
  savedDesigns  Int @default(0)
  shares        Int @default(0)

  // Revenue
  revenue       Float @default(0)
  avgOrderValue Float @default(0)

  // Performance
  avgLoadTime Int?
  errorCount  Int  @default(0)

  // Breakdown
  deviceBreakdown   Json?
  platformBreakdown Json?

  configuration Configurator3DConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)

  @@unique([configurationId, date])
  @@index([configurationId, date])
  @@map("configurator_3d_analytics")
}

model Configurator3DOptionAnalytics {
  id              String   @id @default(cuid())
  configurationId String
  componentId     String
  optionId        String
  date            DateTime @db.Date

  // Selections
  selections       Int @default(0)
  uniqueSelections Int @default(0)

  // Conversions
  addToCarts Int @default(0)
  purchases  Int @default(0)

  // Revenue
  revenue Float @default(0)

  @@unique([optionId, date])
  @@index([configurationId, date])
  @@index([componentId, date])
  @@map("configurator_3d_option_analytics")
}

// ========================================
// IDEMPOTENCY & WEBHOOK TRACKING
// ========================================

model IdempotencyKey {
  id        String   @id @default(cuid())
  key       String   @unique
  result    String?  @db.Text
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([expiresAt])
}

// Renamed from WebhookEvent to avoid conflict with WebhookEvent enum
model ProcessedWebhookEvent {
  id        String  @id @default(cuid())
  eventId   String  @unique // Stripe event ID
  eventType String
  processed Boolean @default(false)
  result    Json?
  error     String? @db.Text
  attempts  Int     @default(0)

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([eventType])
  @@index([processed])
  @@index([createdAt])
  @@map("webhook_events") // Keep original table name for compatibility
}

// ========================================
// TRY-ON MODULE (Virtual Try-On)
// ========================================

enum TryOnProductType {
  GLASSES
  JEWELRY
  WATCH
  HAT
  MAKEUP
  CLOTHING
  ACCESSORY
}

enum TryOnSessionStatus {
  ACTIVE
  COMPLETED
  EXPIRED
}

model TryOnConfiguration {
  id          String           @id @default(cuid())
  projectId   String
  name        String
  productType TryOnProductType
  settings    Json             @default("{}")
  uiConfig    Json?
  isActive    Boolean          @default(true)

  // 3D rendering configuration
  targetZone       String? // WRIST, FINGER, EAR, FACE, NOSE
  renderSettings   Json? // 3D render params: quality, shadows, reflections, lighting
  calibrationRules Json? // Per-device calibration rules

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project  Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sessions TryOnSession[]
  mappings TryOnProductMapping[]

  @@index([projectId])
  @@index([productType])
  @@index([isActive])
}

model TryOnProductMapping {
  id              String  @id @default(cuid())
  configurationId String
  productId       String
  modelId         String? // 3D model reference

  // 3D model assets
  model3dUrl   String? // glTF/GLB URL dedicated for try-on
  modelUSDZUrl String? // USDZ URL for iOS AR Quick Look
  thumbnailUrl String? // Model thumbnail preview

  // 3D positioning data
  anchorPoints    Json?
  scaleFactor     Float @default(1.0)
  adjustments     Json? // Position/rotation adjustments
  defaultPosition Json? // Default 3D position {x, y, z}
  defaultRotation Json? // Default 3D rotation {x, y, z}
  lodLevels       Json? // Level of detail URLs {high, medium, low}

  // Rendering options
  enableOcclusion Boolean @default(true)
  enableShadows   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  configuration TryOnConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  product       Product            @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([configurationId, productId])
  @@index([configurationId])
  @@index([productId])
}

model TryOnSession {
  id              String             @id @default(cuid())
  sessionId       String?            @unique // External session ID
  configurationId String
  userId          String?
  visitorId       String? // Anonymous visitor tracking
  status          TryOnSessionStatus @default(ACTIVE)

  // Session data
  deviceInfo String?
  ipAddress  String?
  userAgent  String?

  // Analytics
  productsViewed   Json?
  productsTried    String[] @default([])
  interactionData  Json?
  screenshotsTaken Int      @default(0)
  shared           Boolean  @default(false)
  converted        Boolean  @default(false)

  // 3D / Performance data
  calibrationData    Json? // Device calibration: pixelToRealRatio, distance, accuracy
  performanceMetrics Json? // Session perf: avgFps, avgDetectionLatency, avgRenderLatency
  conversionAction   ConversionAction? // Specific action: ADD_TO_CART, SHARE, PURCHASE, WISHLIST, CLICK_THROUGH
  renderQuality      String? // Quality used: high, medium, low, 2d_fallback

  // Timestamps
  startedAt DateTime  @default(now())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  endedAt   DateTime?
  expiresAt DateTime?

  // Relations
  configuration      TryOnConfiguration       @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  screenshots        TryOnScreenshot[]
  performanceSamples TryOnPerformanceMetric[]
  conversions        TryOnConversion[]
  shares             TryOnShare[]

  @@index([configurationId])
  @@index([userId])
  @@index([status])
  @@index([sessionId])
  @@index([startedAt])
  @@index([visitorId])
  @@index([status, updatedAt])
  @@index([expiresAt])
}

model TryOnScreenshot {
  id        String @id @default(cuid())
  sessionId String
  productId String

  // Image data
  imageUrl     String
  thumbnailUrl String?
  sharedUrl    String? // Public share URL

  // Metadata
  metadata Json?
  isShared Boolean @default(false)

  createdAt DateTime @default(now())

  // Relations
  session TryOnSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  product Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  shares  TryOnShare[]

  @@index([sessionId])
  @@index([productId])
}

model TryOnPerformanceMetric {
  id        String @id @default(cuid())
  sessionId String

  // Performance data
  fps                Int // Average FPS during sample window
  detectionLatencyMs Int // ML detection latency in ms
  renderLatencyMs    Int // 3D render latency in ms
  gpuInfo            String? // GPU renderer string
  deviceType         String // mobile, desktop, tablet
  browserInfo        String? // Browser name + version

  createdAt DateTime @default(now())

  // Relations
  session TryOnSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([deviceType])
  @@index([createdAt])
}

// ========================================
// TRY-ON CONVERSION & COMMISSION TRACKING
// ========================================

enum ConversionAction {
  ADD_TO_CART
  PURCHASE
  WISHLIST
  SHARE
  CLICK_THROUGH
}

model TryOnConversion {
  id               String           @id @default(cuid())
  sessionId        String
  productId        String
  brandId          String
  action           ConversionAction
  source           String // widget, dashboard, embed, pixel
  revenue          Float? // sale amount (if PURCHASE)
  currency         String? // ISO currency code
  commissionRate   Float? // commission rate applied (e.g. 0.10 for 10%)
  commissionAmount Float? // calculated commission for Luneo
  externalOrderId  String? // external order ID (Shopify, WooCommerce, etc.)
  attributionData  Json? // UTM params, referrer, landing page, etc.
  createdAt        DateTime         @default(now())

  // Relations
  session TryOnSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  product Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  brand   Brand        @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([productId])
  @@index([brandId])
  @@index([action])
  @@index([createdAt])
  @@index([brandId, action, createdAt])
}

// ========================================
// TRY-ON WIDGET CONFIGURATION (WHITE-LABEL)
// ========================================

model TryOnWidgetConfig {
  id                  String   @id @default(cuid())
  brandId             String   @unique
  theme               Json     @default("{\"primaryColor\":\"#8B5CF6\",\"secondaryColor\":\"#1F2937\",\"fontFamily\":\"Inter, sans-serif\",\"borderRadius\":\"12px\"}")
  logo                String? // Brand logo URL for widget header
  ctaText             String   @default("Ajouter au panier")
  ctaAction           String   @default("postMessage") // postMessage, redirect, callback
  ctaUrl              String? // Redirect URL (if ctaAction = redirect)
  showPoweredBy       Boolean  @default(true) // false for premium plans
  customCss           String? // Custom CSS override (premium)
  allowedDomains      String[] @default([]) // Authorized domains for iframe embedding
  locale              String   @default("fr")
  translations        Json? // Custom translations override
  analyticsEnabled    Boolean  @default(true)
  showRecommendations Boolean  @default(true)
  showSocialShare     Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)
}

// ========================================
// TRY-ON SOCIAL SHARING
// ========================================

model TryOnShare {
  id           String   @id @default(cuid())
  sessionId    String
  screenshotId String?
  productId    String?
  brandId      String
  platform     String // instagram, tiktok, whatsapp, twitter, facebook, link
  shareToken   String   @unique
  shareUrl     String // Full public share URL
  ogImageUrl   String? // Optimized OG image URL
  viewCount    Int      @default(0)
  clickCount   Int      @default(0) // clicks to product page
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  // Relations
  session    TryOnSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  screenshot TryOnScreenshot? @relation(fields: [screenshotId], references: [id], onDelete: SetNull)
  product    Product?         @relation(fields: [productId], references: [id], onDelete: SetNull)
  brand      Brand            @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([shareToken])
  @@index([sessionId])
  @@index([brandId])
  @@index([createdAt])
  @@index([expiresAt])
}

// ========================================
// VISUAL CUSTOMIZER MODULE (V2)
// ========================================

// -- Enums --

enum VisualCustomizerLayerType {
  IMAGE
  TEXT
  SHAPE
  PATTERN
  CLIPART
  DRAWING
  QR_CODE
  GROUP
}

enum CustomizerType {
  PRODUCT
  APPAREL
  STATIONERY
  PACKAGING
  SIGNAGE
  JEWELRY
  ACCESSORIES
  GIFT
  CUSTOM
}

enum CustomizerStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CanvasUnit {
  PIXEL
  MM
  CM
  INCH
}

enum ZoneType2D {
  EDITABLE
  READONLY
  MASK
  BLEED
  SAFE
}

enum ZoneShape {
  RECTANGLE
  CIRCLE
  ELLIPSE
  POLYGON
  FREEFORM
}

enum BlendMode {
  NORMAL
  MULTIPLY
  SCREEN
  OVERLAY
  DARKEN
  LIGHTEN
  COLOR_DODGE
  COLOR_BURN
  HARD_LIGHT
  SOFT_LIGHT
  DIFFERENCE
  EXCLUSION
}

enum CustomizerSessionStatus {
  ACTIVE
  COMPLETED
  ABANDONED
  CONVERTED
  EXPIRED
}

enum CustomizerConversionType {
  ADD_TO_CART
  PURCHASE
  QUOTE_REQUEST
  SAVE_DESIGN
  SHARE
  EXPORT
}

enum CustomizerInteractionType {
  SESSION_START
  SESSION_END
  TOOL_SELECT
  LAYER_CREATE
  LAYER_UPDATE
  LAYER_DELETE
  LAYER_SELECT
  LAYER_MOVE
  LAYER_RESIZE
  LAYER_ROTATE
  TEXT_EDIT
  IMAGE_UPLOAD
  IMAGE_FILTER
  CLIPART_ADD
  SHAPE_ADD
  DRAWING_START
  DRAWING_END
  COLOR_CHANGE
  FONT_CHANGE
  PRESET_APPLY
  UNDO
  REDO
  ZOOM
  PAN
  VIEW_CHANGE
  SCREENSHOT
  EXPORT_ACTION
  SAVE_DESIGN
  SHARE_ACTION
  ADD_TO_CART
  ERROR
}

enum CustomizerExportType {
  IMAGE
  PDF
  PRINT
  SVG
  THUMBNAIL
}

enum CustomizerExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}

enum CustomizerAssetType {
  IMAGE
  CLIPART
  FONT
  TEMPLATE
  BACKGROUND
  MASK
}

enum CustomizerAssetVisibility {
  PRIVATE
  BRAND
  PUBLIC
}

enum CustomizerModerationStatus {
  PENDING
  APPROVED
  REJECTED
  ESCALATED
}

// -- Main Model --

model VisualCustomizer {
  id        String  @id @default(cuid())
  projectId String?

  // Brand scoping (primary)
  brandId String
  brand   Brand  @relation("BrandVisualCustomizers", fields: [brandId], references: [id], onDelete: Cascade)

  // Product link
  productId String?
  product   Product? @relation("ProductVisualCustomizers", fields: [productId], references: [id], onDelete: SetNull)

  // Created by
  createdById String?
  createdBy   User?   @relation("UserCreatedCustomizers", fields: [createdById], references: [id], onDelete: SetNull)

  // Basic info
  name        String
  description String? @db.Text
  slug        String  @unique

  type   CustomizerType   @default(PRODUCT)
  status CustomizerStatus @default(DRAFT)

  // Product images
  productImageUrl String?
  productMaskUrl  String?
  thumbnailUrl    String?

  // Canvas settings
  canvasConfig       Json
  canvasWidth        Int        @default(800)
  canvasHeight       Int        @default(800)
  canvasUnit         CanvasUnit @default(PIXEL)
  canvasDPI          Int        @default(72)
  backgroundColor    String?
  backgroundImageUrl String?

  // Grid & guides
  showGrid       Boolean @default(false)
  gridSize       Int     @default(20)
  snapToGrid     Boolean @default(true)
  showRulers     Boolean @default(true)
  showSafeZone   Boolean @default(true)
  safeZoneMargin Int     @default(10)
  showBleedArea  Boolean @default(false)
  bleedSize      Float   @default(3)

  // Tool settings (JSON)
  toolSettings  Json?
  textSettings  Json?
  imageSettings Json?

  // UI configuration
  uiConfig Json?

  // Pricing
  pricingEnabled Boolean @default(false)
  basePrice      Float   @default(0)
  currency       String  @default("EUR")
  pricePerText   Float   @default(0)
  pricePerImage  Float   @default(0)
  pricePerColor  Float   @default(0)

  // Moderation settings
  moderationEnabled  Boolean  @default(true)
  nsfwDetection      Boolean  @default(true)
  profanityFilter    Boolean  @default(true)
  trademarkDetection Boolean  @default(false)
  autoRejectFlagged  Boolean  @default(false)
  quarantineFlagged  Boolean  @default(true)
  blockedWords       String[] @default([])

  // Multi-view
  enableMultiView Boolean @default(false)

  // Access
  isActive            Boolean   @default(true)
  isPublic            Boolean   @default(false)
  isPasswordProtected Boolean   @default(false)
  password            String?
  allowedDomains      String[]  @default([])
  expiresAt           DateTime?

  // SEO
  metaTitle       String?
  metaDescription String? @db.Text
  ogImage         String?

  // Stats (denormalized counters)
  viewCount    Int @default(0)
  sessionCount Int @default(0)
  designsSaved Int @default(0)
  conversions  Int @default(0)

  // Metadata
  tags     String[] @default([])
  metadata Json?
  version  Int      @default(1)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
  archivedAt  DateTime?
  deletedAt   DateTime?

  // Relations
  project      Project?                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  views        CustomizerView[]
  zones        CustomizerZone[]
  layers       VisualCustomizerLayer[]
  presets      VisualCustomizerPreset[]
  sessions     CustomizerSession[]
  assets       CustomizerAsset[]
  analytics    CustomizerAnalytics[]
  auditLogs    CustomizerAuditLog[]
  savedDesigns CustomizerSavedDesign[]

  @@unique([brandId, slug])
  @@index([projectId])
  @@index([brandId, status])
  @@index([status, isPublic])
  @@index([slug])
  @@index([isActive])
  @@index([deletedAt])
  @@index([brandId, productId])
  @@map("visual_customizers")
}

// -- Multi-View --

model CustomizerView {
  id           String           @id @default(cuid())
  customizerId String
  customizer   VisualCustomizer @relation(fields: [customizerId], references: [id], onDelete: Cascade)

  name         String
  imageUrl     String
  maskUrl      String?
  thumbnailUrl String?

  isDefault Boolean @default(false)
  sortOrder Int     @default(0)

  canvasWidth  Int?
  canvasHeight Int?

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  zones CustomizerZone[]

  @@index([customizerId, sortOrder])
  @@map("customizer_views")
}

// -- Zones (Editable Areas) --

model CustomizerZone {
  id           String           @id @default(cuid())
  customizerId String
  customizer   VisualCustomizer @relation(fields: [customizerId], references: [id], onDelete: Cascade)

  viewId String?
  view   CustomizerView? @relation(fields: [viewId], references: [id], onDelete: Cascade)

  name        String
  description String? @db.Text

  type  ZoneType2D
  shape ZoneShape

  // Bounds
  x        Float
  y        Float
  width    Float
  height   Float
  rotation Float @default(0)

  // For polygon shapes
  polygonPoints Json?

  // Styling
  borderRadius    Float   @default(0)
  backgroundColor String?
  borderColor     String?
  borderWidth     Float   @default(0)
  opacity         Float   @default(1)

  // Constraints
  allowText       Boolean @default(true)
  allowImages     Boolean @default(true)
  allowShapes     Boolean @default(true)
  allowClipart    Boolean @default(true)
  allowDrawing    Boolean @default(false)
  maxElements     Int     @default(10)
  lockAspectRatio Boolean @default(false)
  minScale        Float   @default(0.1)
  maxScale        Float   @default(5)
  allowRotation   Boolean @default(true)
  snapToBounds    Boolean @default(false)
  clipContent     Boolean @default(true)

  // Display
  sortOrder Int     @default(0)
  isVisible Boolean @default(true)
  isLocked  Boolean @default(false)

  // Pricing
  priceModifier Float @default(0)

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  layers CustomizerLayer[]

  @@index([customizerId, sortOrder])
  @@index([viewId])
  @@map("customizer_zones")
}

// -- Layers (Design Elements in Zones) --

model CustomizerLayer {
  id     String         @id @default(cuid())
  zoneId String
  zone   CustomizerZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  // Session association (for user-created layers)
  sessionId String?
  session   CustomizerSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  name String
  type VisualCustomizerLayerType

  // Transform
  x        Float
  y        Float
  width    Float?
  height   Float?
  scaleX   Float   @default(1)
  scaleY   Float   @default(1)
  rotation Float   @default(0)
  skewX    Float   @default(0)
  skewY    Float   @default(0)
  flipX    Boolean @default(false)
  flipY    Boolean @default(false)

  // Content (type-specific, stored as JSON)
  content Json

  // Styling
  opacity   Float     @default(1)
  blendMode BlendMode @default(NORMAL)

  // Shadow
  shadowEnabled Boolean @default(false)
  shadowColor   String?
  shadowOffsetX Float   @default(0)
  shadowOffsetY Float   @default(0)
  shadowBlur    Float   @default(0)

  // State
  sortOrder    Int     @default(0)
  isVisible    Boolean @default(true)
  isLocked     Boolean @default(false)
  isSelectable Boolean @default(true)

  // Hierarchy
  parentLayerId String?
  parentLayer   CustomizerLayer?  @relation("LayerHierarchy", fields: [parentLayerId], references: [id])
  childLayers   CustomizerLayer[] @relation("LayerHierarchy")

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([zoneId, sortOrder])
  @@index([sessionId])
  @@map("customizer_layers")
}

// -- Legacy Layer model (kept for backward compatibility) --

model VisualCustomizerLayer {
  id           String                    @id @default(cuid())
  customizerId String
  name         String
  type         VisualCustomizerLayerType
  order        Int                       @default(0)

  properties  Json  @default("{}")
  config      Json?
  constraints Json?

  isLocked  Boolean @default(false)
  isVisible Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customizer VisualCustomizer @relation(fields: [customizerId], references: [id], onDelete: Cascade)

  @@index([customizerId])
  @@index([type])
  @@index([order])
}

// -- Presets / Templates --

model VisualCustomizerPreset {
  id           String           @id @default(cuid())
  customizerId String
  customizer   VisualCustomizer @relation(fields: [customizerId], references: [id], onDelete: Cascade)

  createdById String?
  createdBy   User?   @relation("UserCreatedPresets", fields: [createdById], references: [id])

  name            String
  description     String? @db.Text
  thumbnailUrl    String?
  previewImageUrl String?

  // Canvas data (Konva JSON)
  layerConfig Json
  canvasData  Json?

  // Category
  category String?
  tags     String[] @default([])

  // Visibility
  isPublic   Boolean @default(false)
  isDefault  Boolean @default(false)
  isFeatured Boolean @default(false)

  // Stats
  usageCount Int @default(0)

  sortOrder Int @default(0)

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customizerId, isPublic])
  @@index([customizerId, category])
  @@map("customizer_presets")
}

// -- Assets (Images, Fonts, Clipart) --

model CustomizerAsset {
  id      String @id @default(cuid())
  brandId String
  brand   Brand  @relation("BrandCustomizerAssets", fields: [brandId], references: [id], onDelete: Cascade)

  uploadedById String?
  uploadedBy   User?   @relation("UserUploadedAssets", fields: [uploadedById], references: [id])

  customizerId String?
  customizer   VisualCustomizer? @relation(fields: [customizerId], references: [id], onDelete: SetNull)

  name        String
  description String? @db.Text

  type       CustomizerAssetType
  visibility CustomizerAssetVisibility @default(PRIVATE)

  // File info
  fileUrl          String
  thumbnailUrl     String?
  originalFileName String
  mimeType         String
  fileSize         Int

  // Image-specific
  width    Int?
  height   Int?
  format   String?
  hasAlpha Boolean @default(false)

  // Font-specific
  fontFamily  String?
  fontVariant String?
  fontFormat  String?

  // Categorization
  category String?
  tags     String[] @default([])

  // Moderation
  moderationStatus CustomizerModerationStatus @default(PENDING)
  moderationNotes  String?
  moderatedAt      DateTime?
  moderatedById    String?

  // Stats
  usageCount Int @default(0)

  metadata Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([brandId, type])
  @@index([brandId, visibility])
  @@index([category])
  @@map("customizer_assets")
}

// -- Clipart Categories --

model ClipartCategory {
  id      String  @id @default(cuid())
  brandId String?
  brand   Brand?  @relation("BrandClipartCategories", fields: [brandId], references: [id], onDelete: Cascade)

  name         String
  slug         String
  description  String?
  thumbnailUrl String?

  parentId String?
  parent   ClipartCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ClipartCategory[] @relation("CategoryHierarchy")

  sortOrder    Int     @default(0)
  isActive     Boolean @default(true)
  clipartCount Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([brandId, slug])
  @@index([brandId, isActive])
  @@map("clipart_categories")
}

// -- Sessions --

model CustomizerSession {
  id           String           @id @default(cuid())
  customizerId String
  customizer   VisualCustomizer @relation(fields: [customizerId], references: [id], onDelete: Cascade)

  // User (optional for anonymous)
  userId      String?
  user        User?   @relation("UserCustomizerSessions", fields: [userId], references: [id])
  anonymousId String?

  status CustomizerSessionStatus @default(ACTIVE)

  // Current canvas state
  canvasData Json?

  // Selected view (for multi-view)
  activeViewId String?

  // Calculated pricing
  calculatedPrice Float?
  priceBreakdown  Json?
  currency        String @default("EUR")

  // Tracking
  source    String?
  referrer  String?
  utmParams Json?

  // Device
  ipAddress  String?
  userAgent  String?
  deviceInfo Json?

  // Geo
  country String?
  region  String?
  city    String?

  // Timing
  startedAt      DateTime  @default(now())
  lastActivityAt DateTime  @default(now())
  completedAt    DateTime?

  // Conversion
  convertedAt     DateTime?
  conversionType  CustomizerConversionType?
  conversionValue Float?
  orderId         String?
  cartItemId      String?

  // Relations
  layers       CustomizerLayer[]
  interactions CustomizerInteraction[]
  savedDesign  CustomizerSavedDesign?
  exports      CustomizerExport[]

  @@index([customizerId, status])
  @@index([userId])
  @@index([anonymousId])
  @@index([status, lastActivityAt])
  @@map("customizer_sessions")
}

// -- Interactions (Analytics) --

model CustomizerInteraction {
  id        String            @id @default(cuid())
  sessionId String
  session   CustomizerSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  type CustomizerInteractionType

  // Context
  zoneId   String?
  layerId  String?
  toolUsed String?

  data Json?

  timestamp  DateTime @default(now())
  durationMs Int?

  @@index([sessionId, timestamp])
  @@index([type])
  @@map("customizer_interactions")
}

// -- Saved Designs --

model CustomizerSavedDesign {
  id           String           @id @default(cuid())
  customizerId String
  customizer   VisualCustomizer @relation(fields: [customizerId], references: [id])

  sessionId String?            @unique
  session   CustomizerSession? @relation(fields: [sessionId], references: [id])

  userId String?
  user   User?   @relation("UserSavedDesigns", fields: [userId], references: [id])

  name        String
  description String? @db.Text

  canvasData Json

  // Generated images
  thumbnailUrl String?
  previewUrls  String[] @default([])

  // Pricing snapshot
  savedPrice Float?
  currency   String @default("EUR")

  // Sharing
  shareToken String  @unique @default(cuid())
  isPublic   Boolean @default(false)
  allowRemix Boolean @default(false)
  shareUrl   String?

  // Stats
  viewCount  Int @default(0)
  remixCount Int @default(0)

  // Moderation
  moderationStatus  CustomizerModerationStatus @default(APPROVED)
  moderationReasons String[]                   @default([])
  moderationNotes   String?

  // Remix
  remixedFromId String?
  remixedFrom   CustomizerSavedDesign?  @relation("DesignRemix", fields: [remixedFromId], references: [id])
  remixes       CustomizerSavedDesign[] @relation("DesignRemix")

  expiresAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([customizerId, userId])
  @@index([shareToken])
  @@index([userId, createdAt])
  @@index([isPublic, moderationStatus])
  @@map("customizer_saved_designs")
}

// -- Exports --

model CustomizerExport {
  id        String            @id @default(cuid())
  sessionId String
  session   CustomizerSession @relation(fields: [sessionId], references: [id])

  userId String?
  user   User?   @relation("UserCustomizerExports", fields: [userId], references: [id])

  type   CustomizerExportType
  format String
  status CustomizerExportStatus @default(PENDING)

  options Json?

  width   Int?
  height  Int?
  dpi     Int?
  quality Int?

  fileUrl  String?
  fileName String?
  fileSize Int?

  progress Int @default(0)

  errorMessage String? @db.Text

  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  expiresAt   DateTime?

  @@index([sessionId])
  @@index([userId, createdAt])
  @@index([status])
  @@map("customizer_exports")
}

// -- Moderation Records --

model CustomizerModerationRecord {
  id      String @id @default(cuid())
  brandId String
  brand   Brand  @relation("BrandCustomizerModerations", fields: [brandId], references: [id])

  designId String?
  assetId  String?

  contentType       String
  contentPreviewUrl String?
  flaggedContent    Json?

  detectionMethod String
  reasons         String[] @default([])
  confidence      Float?

  detectedContent Json?

  status CustomizerModerationStatus @default(PENDING)

  reviewedById String?
  reviewedBy   User?     @relation("UserModerationReviews", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  reviewNotes  String?   @db.Text

  actionTaken  String?
  userNotified Boolean @default(false)

  contentUserId    String?
  contentUserEmail String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId, status])
  @@index([status, createdAt])
  @@index([designId])
  @@index([assetId])
  @@map("customizer_moderation_records")
}

// -- Analytics (Daily Aggregates) --

model CustomizerAnalytics {
  id           String           @id @default(cuid())
  customizerId String
  customizer   VisualCustomizer @relation(fields: [customizerId], references: [id], onDelete: Cascade)

  date DateTime @db.Date

  // Sessions
  sessions           Int @default(0)
  uniqueUsers        Int @default(0)
  avgSessionDuration Int @default(0)

  // Engagement
  totalInteractions Int @default(0)
  textEdits         Int @default(0)
  imageUploads      Int @default(0)
  clipartAdded      Int @default(0)
  shapesAdded       Int @default(0)
  presetsApplied    Int @default(0)

  // Conversions
  designsSaved   Int @default(0)
  exportsCreated Int @default(0)
  addToCarts     Int @default(0)
  purchases      Int @default(0)
  shares         Int @default(0)

  // Revenue
  revenue       Float @default(0)
  avgOrderValue Float @default(0)

  // Performance
  avgLoadTime Int? // ms
  errorCount  Int  @default(0)

  // Breakdowns (JSON)
  deviceBreakdown   Json?
  platformBreakdown Json?

  @@unique([customizerId, date])
  @@index([customizerId, date])
  @@map("customizer_analytics")
}

model CustomizerToolAnalytics {
  id           String   @id @default(cuid())
  customizerId String
  date         DateTime @db.Date

  toolName     String
  usageCount   Int    @default(0)
  uniqueUsers  Int    @default(0)
  avgTimeSpent Int    @default(0)

  @@unique([customizerId, date, toolName])
  @@index([customizerId, date])
  @@map("customizer_tool_analytics")
}

// -- Audit Logs --

model CustomizerAuditLog {
  id           String           @id @default(cuid())
  customizerId String
  customizer   VisualCustomizer @relation(fields: [customizerId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("UserCustomizerAuditLogs", fields: [userId], references: [id])

  action     String
  entityType String
  entityId   String?

  previousValue Json?
  newValue      Json?

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([customizerId, createdAt])
  @@index([userId, createdAt])
  @@map("customizer_audit_logs")
}

// ========================================
// OBSERVABILITY - Distributed Tracing
// ========================================

model Trace {
  id            String  @id @default(cuid())
  traceId       String  @unique
  spanId        String
  parentSpanId  String?
  operationName String
  serviceName   String
  duration      Int // milliseconds
  status        String  @default("ok") // ok, error, timeout
  metadata      Json?
  brandId       String?
  userId        String?

  createdAt DateTime @default(now())

  // Relations
  brand Brand? @relation("BrandTraces", fields: [brandId], references: [id], onDelete: SetNull)
  user  User?  @relation("UserTraces", fields: [userId], references: [id], onDelete: SetNull)

  @@index([traceId])
  @@index([serviceName])
  @@index([operationName])
  @@index([status])
  @@index([createdAt])
  @@index([brandId])
  @@index([userId])
  @@index([serviceName, createdAt])
}

// ========================================
// FEATURE FLAGS
// ========================================

model FeatureFlag {
  id          String  @id @default(cuid())
  key         String  @unique
  description String?
  isEnabled   Boolean @default(false)
  brandId     String? // null = global flag, set = brand-specific
  brand       Brand?  @relation("BrandFeatureFlags", fields: [brandId], references: [id], onDelete: SetNull)
  percentage  Int? // Gradual rollout percentage (0-100)
  conditions  Json? // Advanced targeting conditions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([brandId])
  @@index([isEnabled])
  @@index([brandId, isEnabled])
}

// ============================================================================
// ORION - Super Admin AI Command Center
// ============================================================================

// ========================================
// ORION ENUMS
// ========================================

enum OrionAgentType {
  ACQUISITION
  ONBOARDING
  COMMUNICATION
  RETENTION
  REVENUE
  ANALYTICS
  GENERAL
}

enum OrionAgentStatus {
  ACTIVE
  PAUSED
  MAINTENANCE
}

enum ChurnRisk {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum GrowthPotential {
  LOW
  MEDIUM
  HIGH
}

enum AutomationStatus {
  draft
  active
  paused
}

enum AutomationRunStatus {
  active
  completed
  cancelled
}

enum EmailTemplateCategory {
  ONBOARDING
  RETENTION
  ENGAGEMENT
  TRANSACTIONAL
  UPSELL
  WIN_BACK
  OTHER
}

model OrionAgent {
  id           String           @id @default(uuid())
  name         String           @unique // APOLLO, ATHENA, HERMES, ARTEMIS, HADES, ZEUS
  displayName  String
  type         OrionAgentType   @default(GENERAL)
  description  String?
  status       OrionAgentStatus @default(PAUSED)
  config       Json             @default("{}")
  lastRunAt    DateTime?
  tasksLast24h Int              @default(0)
  successRate  Float            @default(0)
  errorCount   Int              @default(0)
  avgExecTime  Float            @default(0) // ms
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@map("orion_agents")
}

model CustomerHealthScore {
  id                String          @id @default(uuid())
  userId            String          @unique
  healthScore       Int             @default(50) // 0-100
  churnRisk         ChurnRisk       @default(LOW)
  churnRiskScore    Float           @default(0)
  activationScore   Int             @default(0)
  engagementScore   Int             @default(0)
  satisfactionScore Int             @default(0)
  financialScore    Int             @default(0)
  supportScore      Int             @default(0)
  adoptionScore     Int             @default(0)
  growthPotential   GrowthPotential @default(MEDIUM)
  trend             String          @default("stable")
  lastActivityAt    DateTime?
  signals           Json            @default("[]")
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("customer_health_scores")
}

// ========================================
// MARKETING SPEND (CAC Tracking)
// ========================================

model MarketingSpend {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  channel   String // organic, google_ads, facebook, linkedin, referral, etc.
  amount    Int // Amount in cents
  currency  String   @default("eur")
  notes     String?
  createdBy String? // Admin user ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([channel])
  @@map("marketing_spends")
}

// ========================================
// NPS (Net Promoter Score)
// ========================================

model NPSResponse {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserNPSResponses", fields: [userId], references: [id], onDelete: Cascade)
  score     Int // 0-10
  comment   String?
  source    String   @default("in_app") // in_app, email, manual
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("nps_responses")
}

// ========================================
// CART (Shopping Cart)
// ========================================

model Cart {
  id        String     @id @default(cuid())
  sessionId String?    @unique // For anonymous users
  userId    String?
  user      User?      @relation("UserCart", fields: [userId], references: [id], onDelete: Cascade)
  brandId   String
  items     CartItem[]
  metadata  Json?
  expiresAt DateTime? // Auto-expire abandoned carts
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([userId, brandId])
  @@index([sessionId])
  @@index([brandId])
  @@index([expiresAt])
}

model CartItem {
  id              String   @id @default(cuid())
  cartId          String
  cart            Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId       String
  designId        String?
  customizationId String?
  quantity        Int      @default(1)
  priceCents      Int // snapshot price at time of add
  metadata        Json? // custom options, preview URL, etc.
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([cartId, productId, designId, customizationId])
  @@index([cartId])
  @@index([productId])
}

// ========================================
// AI DESIGN STUDIO - ENTERPRISE MODELS
// ========================================

model AIProviderPricing {
  id            String   @id @default(cuid())
  provider      String // "openai", "stability", "replicate", "meshy", "runway"
  model         String // "dall-e-3", "sdxl-1.0", "gen3a_turbo"
  operation     String // "generate", "upscale", "animate", "remove-bg", "3d"
  costPerUnit   Float // Cost in EUR per unit
  unit          String // "image", "second", "token", "model"
  currency      String   @default("EUR")
  isActive      Boolean  @default(true)
  effectiveDate DateTime @default(now())
  notes         String?

  @@unique([provider, model, operation, effectiveDate])
  @@index([provider, isActive])
  @@index([operation])
  @@map("ai_provider_pricing")
}

model AIBudgetAlert {
  id                String    @id @default(cuid())
  userId            String
  brandId           String?
  threshold         Float // Threshold percentage (50, 80, 100)
  thresholdType     String    @default("percentage") // "percentage" or "absolute"
  currentSpend      Float     @default(0)
  budgetLimit       Float // Total budget limit in cents
  period            String // "daily", "weekly", "monthly"
  alertSent         Boolean   @default(false)
  alertSentAt       DateTime?
  notificationEmail String?
  webhookUrl        String?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId, period, isActive])
  @@index([brandId, period])
  @@map("ai_budget_alerts")
}

model AICostOptimization {
  id                 String    @id @default(cuid())
  generationId       String?
  userId             String
  originalProvider   String
  originalModel      String
  suggestedProvider  String
  suggestedModel     String
  originalCostCents  Int
  suggestedCostCents Int
  estimatedSavings   Float // Percentage saved
  qualityScore       Float // Expected quality 0-1
  reason             String
  acceptedByUser     Boolean?
  appliedAt          DateTime?
  createdAt          DateTime  @default(now())

  @@index([userId, createdAt])
  @@index([originalProvider])
  @@map("ai_cost_optimizations")
}

model AICachedGeneration {
  id               String   @id @default(cuid())
  promptHash       String   @unique // SHA-256 of normalized prompt
  prompt           String   @db.Text
  normalizedPrompt String   @db.Text
  provider         String
  model            String
  parameters       Json // Generation parameters (steps, cfg_scale, seed, etc.)
  resultUrl        String
  thumbnailUrl     String?
  width            Int?
  height           Int?
  quality          Float? // Quality score 0-100
  generatedAt      DateTime @default(now())
  accessCount      Int      @default(0)
  lastAccessedAt   DateTime @default(now())
  expiresAt        DateTime // Auto-expire after 30 days by default
  sizeBytes        Int?

  @@index([promptHash])
  @@index([provider, model])
  @@index([expiresAt])
  @@index([lastAccessedAt])
  @@map("ai_cached_generations")
}

model AIBulkJob {
  id                String        @id @default(cuid())
  userId            String
  brandId           String
  name              String
  description       String?
  template          String        @db.Text // Prompt template with {{variables}}
  variables         Json // Array of variable sets
  variablesCount    Int
  completedCount    Int           @default(0)
  failedCount       Int           @default(0)
  status            BulkJobStatus @default(PENDING)
  estimatedCost     Float // Estimated total cost in cents
  actualCost        Float         @default(0)
  estimatedCredits  Int
  actualCredits     Int           @default(0)
  estimatedDuration Int // Estimated duration in seconds
  provider          String?
  model             String?
  parameters        Json? // Base generation parameters
  batchSize         Int           @default(10)
  startedAt         DateTime?
  completedAt       DateTime?
  errorMessage      String?       @db.Text
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  generations AIBulkJobGeneration[]

  @@index([userId, status])
  @@index([brandId, status])
  @@index([status, createdAt])
  @@map("ai_bulk_jobs")
}

model AIBulkJobGeneration {
  id           String    @id @default(cuid())
  bulkJobId    String
  bulkJob      AIBulkJob @relation(fields: [bulkJobId], references: [id], onDelete: Cascade)
  generationId String?
  variableSet  Json // The specific variables used for this generation
  index        Int // Position in the bulk job
  status       String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  error        String?
  resultUrl    String?
  costCents    Int       @default(0)
  createdAt    DateTime  @default(now())

  @@index([bulkJobId, status])
  @@index([generationId])
  @@map("ai_bulk_job_generations")
}

enum BulkJobStatus {
  PENDING
  PROCESSING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

model AIFineTunedModel {
  id                String         @id @default(cuid())
  organizationId    String
  brandId           String
  name              String
  displayName       String?
  description       String?        @db.Text
  baseModel         String // "sdxl-1.0", "sd-1.5", "flux-1"
  technique         String         @default("lora") // "lora", "dreambooth", "textual_inversion"
  trainingImages    Int            @default(0)
  trainingSteps     Int            @default(0)
  learningRate      Float?
  status            TrainingStatus @default(PENDING)
  progress          Float          @default(0) // 0-100
  endpoint          String? // Replicate model endpoint URL
  replicateModelId  String?
  costCents         Int            @default(0) // Training cost
  costPerGeneration Float          @default(0) // Cost per generation in cents
  triggerWord       String? // e.g., "ROLEX_STYLE" for DreamBooth
  sampleImages      String[] // Generated sample images after training
  metadata          Json?
  errorMessage      String?        @db.Text
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@unique([organizationId, name])
  @@index([brandId, status])
  @@index([status])
  @@map("ai_fine_tuned_models")
}

enum TrainingStatus {
  PENDING
  PREPARING_DATASET
  VALIDATING
  TRAINING
  DEPLOYING
  READY
  FAILED
  ARCHIVED
}

model BrandGuidelines {
  id               String   @id @default(cuid())
  brandId          String   @unique
  organizationId   String?
  colorPalette     Json // Array of hex colors: ["#D4AF37", "#000000", "#FFFFFF"]
  primaryColor     String? // Primary brand color hex
  secondaryColor   String? // Secondary brand color hex
  fontFamily       String?
  styleKeywords    String[] // ["minimalist", "luxury", "elegant"]
  negativeKeywords String[] // ["cheap", "plastic", "colorful"]
  referenceImages  String[] // URLs of reference images
  consistencySeed  Int? // Fixed seed for visual consistency
  logoUrl          String?
  brandVoice       String?  @db.Text // Description of brand tone
  industry         String? // "jewelry", "fashion", "automotive"
  targetAudience   String? // "luxury", "mass-market", "youth"
  promptPrefix     String?  @db.Text // Auto-prepended to every prompt
  promptSuffix     String?  @db.Text // Auto-appended to every prompt
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([brandId])
  @@index([organizationId])
  @@map("brand_guidelines")
}

model AIVideoGeneration {
  id             String      @id @default(cuid())
  userId         String
  brandId        String
  sourceImages   String[] // 1+ source images
  prompt         String?     @db.Text
  motion         String // "360-rotation", "zoom-in", "parallax", "turntable", "custom"
  duration       Int // Duration in seconds
  fps            Int         @default(30)
  resolution     String      @default("1080p") // "720p", "1080p", "4k"
  resultUrl      String?
  thumbnailUrl   String?
  status         VideoStatus @default(PENDING)
  provider       String // "runway", "pika-labs"
  providerTaskId String?
  model          String? // "gen3a_turbo", "pika-1.0"
  costCents      Int         @default(0)
  credits        Int         @default(0)
  metadata       Json?
  errorMessage   String?
  createdAt      DateTime    @default(now())
  completedAt    DateTime?
  updatedAt      DateTime    @updatedAt

  @@index([userId, status])
  @@index([brandId, status])
  @@index([status, createdAt])
  @@map("ai_video_generations")
}

enum VideoStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model AIGenerationFeedback {
  id             String       @id @default(cuid())
  generationId   String
  generation     AIGeneration @relation(fields: [generationId], references: [id], onDelete: Cascade)
  userId         String
  rating         Int // 1-5 stars
  feedback       String?      @db.Text
  issues         String[] // ["low_quality", "wrong_style", "artifacts", "nsfw", "watermark"]
  wasRegenerated Boolean      @default(false)
  isUseful       Boolean? // Was the generation useful for the user
  createdAt      DateTime     @default(now())

  @@unique([generationId, userId])
  @@index([generationId])
  @@index([userId])
  @@index([rating])
  @@map("ai_generation_feedback")
}

model AIPromptExperiment {
  id          String           @id @default(cuid())
  name        String
  description String?
  brandId     String?
  userId      String
  basePrompt  String           @db.Text
  variantA    String           @db.Text
  variantB    String           @db.Text
  provider    String           @default("stability")
  model       String           @default("sdxl-1.0")
  parameters  Json? // Shared generation parameters
  metricsA    Json? // { qualityScore, userPreference, generationTime, cost }
  metricsB    Json?
  samplesA    String[] // Generated sample image URLs for variant A
  samplesB    String[]
  sampleCount Int              @default(5) // Number of samples per variant
  winner      String? // "A", "B", or null
  winReason   String?
  status      ExperimentStatus @default(RUNNING)
  createdAt   DateTime         @default(now())
  completedAt DateTime?
  updatedAt   DateTime         @updatedAt

  @@index([userId, status])
  @@index([brandId])
  @@index([status])
  @@map("ai_prompt_experiments")
}

enum ExperimentStatus {
  DRAFT
  RUNNING
  ANALYZING
  COMPLETED
  CANCELLED
}

model AIMarketplaceTemplate {
  id            String   @id @default(cuid())
  creatorId     String
  name          String
  description   String   @db.Text
  prompt        String   @db.Text // Optimized prompt
  category      String // "jewelry", "watches", "fashion", "cosmetics"
  industry      String? // "luxury", "mass-market"
  subcategory   String?
  previewImages String[]
  price         Float    @default(0) // 0 = free
  currency      String   @default("EUR")
  purchases     Int      @default(0)
  rating        Float?
  reviewsCount  Int      @default(0)
  tags          String[]
  isPublished   Boolean  @default(false)
  isFeatured    Boolean  @default(false)
  version       Int      @default(1)
  metadata      Json? // Additional metadata (style, quality settings)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([category, rating])
  @@index([industry, isPublished])
  @@index([creatorId])
  @@index([isPublished, isFeatured])
  @@map("ai_marketplace_templates")
}

model AICollaborationWorkspace {
  id              String   @id @default(cuid())
  name            String
  ownerId         String
  brandId         String
  collaboratorIds String[] // User IDs of collaborators
  generationIds   String[] // AI Generation IDs shared in workspace
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([ownerId, isActive])
  @@index([brandId])
  @@map("ai_collaboration_workspaces")
}

// ========================================
// PRODUCTION & COMMERCE ENGINE (PCE)
// ========================================

enum PipelineStatus {
  CREATED
  IN_PROGRESS
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

enum FulfillmentStatus {
  PENDING
  PICKING
  PACKING
  READY_TO_SHIP
  SHIPPED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  RETURNED
  CANCELLED
  FAILED
}

model Pipeline {
  id                  String         @id @default(cuid())
  orderId             String         @unique
  order               Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  brandId             String
  brand               Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  stages              Json
  currentStage        String
  progress            Int            @default(0)
  status              PipelineStatus @default(CREATED)
  metadata            Json?
  startedAt           DateTime?
  completedAt         DateTime?
  failedAt            DateTime?
  cancelledAt         DateTime?
  estimatedCompletion DateTime?
  version             Int            @default(0) // Optimistic locking
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  transitions PipelineTransition[]
  errors      PipelineError[]
  fulfillment Fulfillment?

  @@index([brandId])
  @@index([status])
  @@index([currentStage])
  @@index([brandId, status])
  @@index([brandId, currentStage])
  @@index([createdAt])
  @@map("pce_pipelines")
}

model PipelineTransition {
  id          String   @id @default(cuid())
  pipelineId  String
  pipeline    Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  fromStage   String
  toStage     String
  duration    Int      @default(0) // milliseconds spent in fromStage
  triggeredBy String? // 'system', 'manual', 'webhook'
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([pipelineId])
  @@index([pipelineId, createdAt])
  @@map("pce_pipeline_transitions")
}

model PipelineError {
  id         String    @id @default(cuid())
  pipelineId String
  pipeline   Pipeline  @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  stage      String
  error      String    @db.Text
  details    Json?
  retryable  Boolean   @default(true)
  retryCount Int       @default(0)
  resolvedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([pipelineId])
  @@index([pipelineId, stage])
  @@index([resolvedAt])
  @@map("pce_pipeline_errors")
}

model Fulfillment {
  id                String            @id @default(cuid())
  pipelineId        String            @unique
  pipeline          Pipeline          @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  orderId           String
  brandId           String
  status            FulfillmentStatus @default(PENDING)
  carrier           String?
  trackingNumber    String?
  trackingUrl       String?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  estimatedDelivery DateTime?
  weight            Float?
  packages          Json?
  metadata          Json?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([orderId])
  @@index([brandId])
  @@index([status])
  @@index([brandId, status])
  @@map("pce_fulfillments")
}

// ---------------------------------------------------------------------------
// PCE - Render Jobs
// ---------------------------------------------------------------------------

enum RenderJobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum RenderSourceType {
  DESIGN
  CUSTOMIZATION
  TEMPLATE
  MOCKUP
}

model RenderJob {
  id          String           @id @default(cuid())
  brandId     String
  brand       Brand            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  orderId     String?
  orderItemId String?
  batchId     String?
  batch       RenderBatch?     @relation(fields: [batchId], references: [id], onDelete: SetNull)
  sourceType  RenderSourceType
  sourceId    String
  outputs     Json
  status      RenderJobStatus  @default(QUEUED)
  progress    Int              @default(0)
  results     Json?
  error       String?          @db.Text
  priority    Int              @default(5)
  startedAt   DateTime?
  completedAt DateTime?
  durationMs  Int?
  metadata    Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([brandId])
  @@index([orderId])
  @@index([batchId])
  @@index([status])
  @@index([brandId, status])
  @@index([createdAt])
  @@map("pce_render_jobs")
}

enum BatchStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  PARTIALLY_COMPLETED
  FAILED
  CANCELLED
}

model RenderBatch {
  id            String      @id @default(cuid())
  brandId       String
  brand         Brand       @relation(fields: [brandId], references: [id], onDelete: Cascade)
  name          String?
  totalJobs     Int         @default(0)
  completedJobs Int         @default(0)
  failedJobs    Int         @default(0)
  status        BatchStatus @default(PENDING)
  metadata      Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  jobs RenderJob[]

  @@index([brandId])
  @@index([status])
  @@map("pce_render_batches")
}

model RenderUsage {
  id              String   @id @default(cuid())
  brandId         String
  brand           Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  period          String
  renderCount     Int      @default(0)
  totalDurationMs BigInt   @default(0)
  quotaLimit      Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([brandId, period])
  @@index([brandId])
  @@map("pce_render_usage")
}

// ---------------------------------------------------------------------------
// PCE - Production Orders (POD)
// ---------------------------------------------------------------------------

enum ProductionOrderStatus {
  DRAFT
  SUBMITTED
  ACCEPTED
  IN_PRODUCTION
  QUALITY_CHECK
  READY_TO_SHIP
  SHIPPED
  DELIVERED
  CANCELLED
  FAILED
}

enum ProviderStatus {
  ACTIVE
  INACTIVE
  TESTING
  SUSPENDED
}

model ProductionOrder {
  id              String                @id @default(cuid())
  brandId         String
  brand           Brand                 @relation(fields: [brandId], references: [id], onDelete: Cascade)
  orderId         String
  order           Order                 @relation(fields: [orderId], references: [id], onDelete: Cascade)
  providerId      String?
  provider        PODProvider?          @relation(fields: [providerId], references: [id], onDelete: SetNull)
  externalOrderId String?
  status          ProductionOrderStatus @default(DRAFT)
  items           Json
  shippingAddress Json?
  costs           Json?
  trackingNumber  String?
  trackingUrl     String?
  statusHistory   Json?
  error           String?               @db.Text
  submittedAt     DateTime?
  completedAt     DateTime?
  metadata        Json?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([brandId])
  @@index([orderId])
  @@index([providerId])
  @@index([status])
  @@index([brandId, status])
  @@index([externalOrderId])
  @@map("pce_production_orders")
}

model PODProvider {
  id           String         @id @default(cuid())
  brandId      String
  brand        Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  name         String
  slug         String
  providerType String
  credentials  Json
  settings     Json?
  status       ProviderStatus @default(INACTIVE)
  priority     Int            @default(0)
  capabilities Json?
  metadata     Json?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  productionOrders ProductionOrder[]

  @@unique([brandId, slug])
  @@index([brandId])
  @@index([status])
  @@map("pce_pod_providers")
}

// ---------------------------------------------------------------------------
// PCE - Returns & Shipping
// ---------------------------------------------------------------------------

enum ReturnStatus {
  REQUESTED
  APPROVED
  REJECTED
  LABEL_CREATED
  IN_TRANSIT
  RECEIVED
  INSPECTED
  REFUND_PENDING
  REFUNDED
  CLOSED
  CANCELLED
}

enum RefundStatus {
  PENDING
  PARTIAL
  FULL
  REJECTED
}

model Return {
  id                String        @id @default(cuid())
  brandId           String
  brand             Brand         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  orderId           String
  fulfillmentId     String?
  status            ReturnStatus  @default(REQUESTED)
  reason            String
  reasonDetails     String?       @db.Text
  items             Json
  returnLabel       Json?
  trackingNumber    String?
  trackingUrl       String?
  refundStatus      RefundStatus?
  refundAmountCents Int?
  refundedAt        DateTime?
  receivedAt        DateTime?
  inspectedAt       DateTime?
  notes             String?       @db.Text
  metadata          Json?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([brandId])
  @@index([orderId])
  @@index([fulfillmentId])
  @@index([status])
  @@index([brandId, status])
  @@map("pce_returns")
}

model ShippingRate {
  id                   String   @id @default(cuid())
  brandId              String
  brand                Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  name                 String
  carrier              String
  serviceLevel         String?
  originCountry        String?
  destinationCountries Json?
  minWeightKg          Float?
  maxWeightKg          Float?
  basePriceCents       Int      @default(0)
  perKgCents           Int      @default(0)
  estimatedDaysMin     Int?
  estimatedDaysMax     Int?
  isActive             Boolean  @default(true)
  metadata             Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([brandId])
  @@index([carrier])
  @@index([brandId, isActive])
  @@map("pce_shipping_rates")
}

// ========================================
// ORION MODULE 24 - SUPER ADMIN AI SYSTEM
// ========================================

enum AIResponseStatus {
  PENDING
  APPROVED
  REJECTED
  SENT
  EXPIRED
}

enum TicketSentiment {
  VERY_NEGATIVE
  NEGATIVE
  NEUTRAL
  POSITIVE
  VERY_POSITIVE
}

enum TicketSource {
  PORTAL
  EMAIL
  API
  CHAT
  PHONE
}

enum EscalationLevel {
  L1_AI
  L2_SUPPORT
  L3_TECH_LEAD
  L4_ENGINEERING
}

model AITicketResponse {
  id                String           @id @default(cuid())
  ticketId          String
  ticket            Ticket           @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  agentId           String?
  modelUsed         String
  generatedContent  String           @db.Text
  confidenceScore   Int              @default(0)
  confidenceFactors Json?
  status            AIResponseStatus @default(PENDING)
  reviewedById      String?
  reviewedBy        User?            @relation("AIResponseReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewedAt        DateTime?
  reviewNotes       String?
  sentAt            DateTime?
  feedbackRating    Int?
  feedbackComment   String?
  tokensUsed        Int              @default(0)
  latencyMs         Int              @default(0)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([ticketId])
  @@index([status])
  @@index([reviewedById])
  @@index([createdAt])
  @@index([status, createdAt])
  @@map("orion_ai_ticket_responses")
}

model KnowledgeBaseCategory {
  id          String                  @id @default(cuid())
  name        String
  slug        String                  @unique
  description String?
  parentId    String?
  parent      KnowledgeBaseCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    KnowledgeBaseCategory[] @relation("CategoryHierarchy")
  sortOrder   Int                     @default(0)
  isActive    Boolean                 @default(true)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  @@index([parentId])
  @@index([slug])
  @@map("orion_kb_categories")
}

model SecurityThreat {
  id          String    @id @default(cuid())
  brandId     String?
  brand       Brand?    @relation(fields: [brandId], references: [id], onDelete: SetNull)
  type        String
  severity    String
  source      String
  description String    @db.Text
  ipAddress   String?
  userId      String?
  metadata    Json?
  status      String    @default("active")
  resolvedAt  DateTime?
  resolvedBy  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([brandId])
  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([ipAddress])
  @@index([createdAt])
  @@map("orion_security_threats")
}

model BlockedIP {
  id        String    @id @default(cuid())
  brandId   String?
  brand     Brand?    @relation(fields: [brandId], references: [id], onDelete: SetNull)
  ipAddress String
  reason    String
  blockedBy String
  expiresAt DateTime?
  isActive  Boolean   @default(true)
  metadata  Json?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([brandId, ipAddress])
  @@index([ipAddress])
  @@index([isActive])
  @@index([expiresAt])
  @@map("orion_blocked_ips")
}

model SupportSLAPolicy {
  id                String   @id @default(cuid())
  brandId           String?
  brand             Brand?   @relation(fields: [brandId], references: [id], onDelete: SetNull)
  plan              String
  priority          String
  firstResponseMin  Int
  resolutionMin     Int
  businessHoursOnly Boolean  @default(true)
  timezone          String   @default("Europe/Zurich")
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([brandId, plan, priority])
  @@index([plan])
  @@index([isActive])
  @@map("orion_sla_policies")
}

model EscalationRule {
  id         String          @id @default(cuid())
  brandId    String?
  brand      Brand?          @relation(fields: [brandId], references: [id], onDelete: SetNull)
  name       String
  fromLevel  EscalationLevel
  toLevel    EscalationLevel
  conditions Json
  timeoutMin Int             @default(60)
  isActive   Boolean         @default(true)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  @@index([brandId])
  @@index([fromLevel])
  @@index([isActive])
  @@map("orion_escalation_rules")
}

model EscalationHistory {
  id            String          @id @default(cuid())
  ticketId      String
  ticket        Ticket          @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  fromLevel     EscalationLevel
  toLevel       EscalationLevel
  reason        String
  escalatedById String?
  escalatedBy   User?           @relation("EscalationUser", fields: [escalatedById], references: [id], onDelete: SetNull)
  metadata      Json?
  createdAt     DateTime        @default(now())

  @@index([ticketId])
  @@index([createdAt])
  @@map("orion_escalation_history")
}

model AITrainingExample {
  id             String   @id @default(cuid())
  ticketId       String?
  input          String   @db.Text
  expectedOutput String   @db.Text
  actualOutput   String?  @db.Text
  rating         Int?
  category       String?
  tags           String[]
  isApproved     Boolean  @default(false)
  createdById    String?
  createdBy      User?    @relation("AITrainingCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([category])
  @@index([isApproved])
  @@index([createdAt])
  @@map("orion_ai_training_examples")
}

model SupportMacro {
  id          String   @id @default(cuid())
  brandId     String?
  brand       Brand?   @relation(fields: [brandId], references: [id], onDelete: SetNull)
  title       String
  content     String   @db.Text
  category    String?
  variables   Json?
  usageCount  Int      @default(0)
  successRate Float    @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([brandId])
  @@index([category])
  @@index([isActive])
  @@map("orion_support_macros")
}

model OrionAgentAction {
  id          String    @id @default(cuid())
  agentType   String
  actionType  String
  title       String
  description String?   @db.Text
  priority    String    @default("medium")
  status      String    @default("pending")
  data        Json?
  result      Json?
  executedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([agentType])
  @@index([actionType])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("orion_agent_actions")
}

model OrionInsight {
  id          String    @id @default(cuid())
  agentType   String
  type        String
  title       String
  description String    @db.Text
  severity    String    @default("info")
  data        Json?
  isRead      Boolean   @default(false)
  isArchived  Boolean   @default(false)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([agentType])
  @@index([type])
  @@index([severity])
  @@index([isRead])
  @@index([createdAt])
  @@map("orion_insights")
}

model OrionAutomationV2 {
  id          String    @id @default(cuid())
  brandId     String?
  brand       Brand?    @relation(fields: [brandId], references: [id], onDelete: SetNull)
  name        String
  description String?
  trigger     Json
  conditions  Json?
  actions     Json
  isActive    Boolean   @default(false)
  version     Int       @default(1)
  lastRunAt   DateTime?
  runCount    Int       @default(0)
  errorCount  Int       @default(0)
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  runs OrionAutomationRunV2[]

  @@index([brandId])
  @@index([isActive])
  @@index([lastRunAt])
  @@map("orion_automations_v2")
}

model OrionAutomationRunV2 {
  id           String            @id @default(cuid())
  automationId String
  automation   OrionAutomationV2 @relation(fields: [automationId], references: [id], onDelete: Cascade)
  status       String            @default("running")
  triggerData  Json?
  result       Json?
  error        String?
  startedAt    DateTime          @default(now())
  completedAt  DateTime?

  @@index([automationId])
  @@index([status])
  @@index([startedAt])
  @@map("orion_automation_runs_v2")
}

model SatisfactionSurvey {
  id          String   @id @default(cuid())
  ticketId    String   @unique
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  npsScore    Int?
  csatScore   Int?
  cesScore    Int?
  comment     String?
  categories  String[]
  submittedAt DateTime @default(now())

  @@index([npsScore])
  @@index([submittedAt])
  @@map("orion_satisfaction_surveys")
}
