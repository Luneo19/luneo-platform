// ═══════════════════════════════════════════════════════════════════
// LUNEO V2 — PRISMA SCHEMA PRODUCTION READY
// Agent IA Platform — Multi-tenant — Scale to 1B valuation
// ═══════════════════════════════════════════════════════════════════

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "fullTextSearch", "metrics"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  // directUrl  = env("DATABASE_DIRECT_URL") // Uncomment for read replicas in production
  extensions = [pg_trgm, btree_gin]
  // pgvector extension requires: CREATE EXTENSION vector; (run manually or use Neon/Supabase)
  // Re-add when pgvector is installed: pgvector(map: "vector", schema: "public")
}

// ═══════════════════════════════════════════════════════════════════
// CORE — USERS & AUTHENTICATION
// ═══════════════════════════════════════════════════════════════════

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  passwordHash     String?

  firstName        String?
  lastName         String?
  avatar           String?
  phone            String?
  locale           String    @default("fr")
  timezone         String    @default("Europe/Paris")

  emailVerified    Boolean   @default(false)
  emailVerifiedAt  DateTime?
  twoFactorEnabled Boolean   @default(false)
  twoFactorSecret  String?

  role             PlatformRole @default(USER)
  metadata         Json?

  lastLoginAt      DateTime?
  lastLoginIp      String?
  loginCount       Int       @default(0)

  deletedAt        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  memberships      OrganizationMember[]
  sessions         Session[]
  oauthAccounts    OAuthAccount[]
  sentInvitations  Invitation[]      @relation("InvitedBy")
  auditLogs        AuditLog[]
  createdTickets   Ticket[]          @relation("TicketCreator")
  assignedTickets  Ticket[]          @relation("TicketAssignee")

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("users")
}

model OAuthAccount {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider         String
  providerId       String
  providerEmail    String?

  accessToken      String?  @db.Text
  refreshToken     String?  @db.Text
  tokenExpiresAt   DateTime?
  scope            String?
  metadata         Json?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([provider, providerId])
  @@index([userId])
  @@index([provider])
  @@map("oauth_accounts")
}

model Session {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  token            String   @unique

  userAgent        String?  @db.Text
  ipAddress        String?
  country          String?
  city             String?
  device           String?
  browser          String?
  os               String?

  isActive         Boolean  @default(true)
  lastActivityAt   DateTime @default(now())

  expiresAt        DateTime
  createdAt        DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@index([isActive])
  @@map("sessions")
}

model RefreshToken {
  id               String   @id @default(cuid())
  token            String   @unique
  userId           String

  deviceId         String?
  deviceName       String?

  isRevoked        Boolean  @default(false)
  revokedAt        DateTime?

  expiresAt        DateTime
  createdAt        DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@index([isRevoked])
  @@map("refresh_tokens")
}

// ═══════════════════════════════════════════════════════════════════
// CORE — ORGANIZATIONS (Multi-tenant)
// ═══════════════════════════════════════════════════════════════════

model Organization {
  id               String   @id @default(cuid())

  name             String
  slug             String   @unique
  logo             String?
  website          String?

  industry         Industry?
  size             CompanySize?
  country          String?
  timezone         String   @default("Europe/Paris")

  supportEmail     String?
  phone            String?
  address          Json?

  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?
  plan                 Plan     @default(FREE)
  planPeriodStart      DateTime?
  planPeriodEnd        DateTime?
  billingEmail         String?
  taxId                String?

  conversationsUsed    Int      @default(0)
  conversationsLimit   Int      @default(50)
  agentsUsed           Int      @default(0)
  agentsLimit          Int      @default(1)
  knowledgeSourcesUsed Int      @default(0)
  knowledgeSourcesLimit Int     @default(1)
  teamMembersUsed      Int      @default(1)
  teamMembersLimit     Int      @default(1)

  currentMonthSpend    Float    @default(0)
  monthlyBudgetLimit   Float?

  defaultLanguage      String   @default("fr")
  defaultTone          AgentTone @default(PROFESSIONAL)
  allowedDomains       String[]
  features             Json?

  onboardingCompleted  Boolean  @default(false)
  onboardingStep       Int      @default(0)
  onboardingData       Json?

  status               OrgStatus @default(ACTIVE)
  suspendedAt          DateTime?
  suspendedReason      String?

  deletedAt            DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  members              OrganizationMember[]
  invitations          Invitation[]
  agents               Agent[]
  knowledgeBases       KnowledgeBase[]
  conversations        Conversation[]
  integrations         Integration[]
  apiKeys              ApiKey[]
  webhooks             Webhook[]
  invoices             Invoice[]
  auditLogs            AuditLog[]
  usageRecords         UsageRecord[]
  tickets              Ticket[]

  @@index([slug])
  @@index([plan])
  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([stripeCustomerId])
  @@map("organizations")
}

model OrganizationMember {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId           String
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  role             OrgRole      @default(MEMBER)
  customPermissions Json?
  isActive         Boolean      @default(true)

  joinedAt         DateTime     @default(now())
  lastActiveAt     DateTime?

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@index([role])
  @@map("organization_members")
}

model Invitation {
  id               String       @id @default(cuid())
  email            String
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  invitedById      String
  invitedBy        User         @relation("InvitedBy", fields: [invitedById], references: [id])

  role             OrgRole      @default(MEMBER)
  token            String       @unique
  status           InvitationStatus @default(PENDING)

  message          String?      @db.Text
  metadata         Json?

  expiresAt        DateTime
  acceptedAt       DateTime?
  createdAt        DateTime     @default(now())

  @@unique([email, organizationId])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
  @@map("invitations")
}

// ═══════════════════════════════════════════════════════════════════
// AGENT TEMPLATES
// ═══════════════════════════════════════════════════════════════════

model AgentTemplate {
  id               String   @id @default(cuid())

  name             String
  slug             String   @unique
  description      String   @db.Text
  longDescription  String?  @db.Text

  category         AgentCategory
  icon             String
  color            String   @default("#6366F1")
  coverImage       String?
  demoUrl          String?
  videoUrl         String?

  defaultModules   Json
  capabilities     String[]
  tools            String[]
  requiredSources  String[]
  suggestedQuestions String[]

  systemPrompt     String   @db.Text
  exampleConversations Json?

  defaultModel     String   @default("gpt-4o-mini")
  defaultTemperature Float  @default(0.3)
  maxTokensPerReply Int     @default(1000)

  targetIndustries Industry[]
  targetCompanySizes CompanySize[]
  targetUseCases   String[]

  isPublic         Boolean  @default(true)
  requiredPlan     Plan     @default(FREE)
  isFeatured       Boolean  @default(false)
  sortOrder        Int      @default(0)

  setupSteps       Json
  estimatedSetupTime Int?

  usageCount       Int      @default(0)
  avgRating        Float?
  ratingsCount     Int      @default(0)

  metaTitle        String?
  metaDescription  String?  @db.Text

  version          String   @default("1.0.0")
  changelog        Json?
  isActive         Boolean  @default(true)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  agents           Agent[]

  @@index([slug])
  @@index([category])
  @@index([isPublic, isFeatured])
  @@index([isActive])
  @@index([sortOrder])
  @@map("agent_templates")
}

// ═══════════════════════════════════════════════════════════════════
// AGENTS
// ═══════════════════════════════════════════════════════════════════

model Agent {
  id               String       @id @default(cuid())

  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  templateId       String?
  template         AgentTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  name             String
  description      String?      @db.Text
  avatar           String?

  status           AgentStatus  @default(DRAFT)
  publishedAt      DateTime?

  modules          Json

  systemPrompt     String?      @db.Text
  customInstructions String?    @db.Text
  contextWindow    Int          @default(10)

  tone             AgentTone    @default(PROFESSIONAL)
  languages        String[]     @default(["fr"])
  responseStyle    String?

  model            String       @default("gpt-4o-mini")
  temperature      Float        @default(0.3)
  topP             Float        @default(1.0)
  frequencyPenalty Float        @default(0.0)
  presencePenalty  Float        @default(0.0)
  maxTokensPerReply Int         @default(1000)

  monthlyBudgetUsd Float?
  currentMonthSpend Float       @default(0)
  maxConversationLength Int     @default(50)
  maxConcurrentConversations Int?

  autoEscalate     Boolean      @default(true)
  confidenceThreshold Float     @default(0.7)
  escalationEmail  String?
  escalationSlackWebhook String?
  escalationMessage String?     @db.Text
  escalationConditions Json?

  greeting         String?      @db.Text
  fallbackMessage  String?      @db.Text
  closingMessage   String?      @db.Text
  offlineMessage   String?      @db.Text

  businessHours    Json?
  businessTimezone String?

  enableMemory     Boolean      @default(true)
  enableSentiment  Boolean      @default(true)
  enableTopicDetection Boolean  @default(true)
  enableAutoSummary Boolean     @default(true)

  totalConversations Int        @default(0)
  totalMessages    Int          @default(0)
  avgSatisfaction  Float?
  resolutionRate   Float?
  avgResponseTime  Int?

  metadata         Json?
  tags             String[]

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  lastActiveAt     DateTime?
  deletedAt        DateTime?

  channels         Channel[]
  agentKnowledgeBases AgentKnowledgeBase[]
  conversations    Conversation[]
  analytics        AgentDailyAnalytics[]

  @@index([organizationId])
  @@index([status])
  @@index([templateId])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("agents")
}

// ═══════════════════════════════════════════════════════════════════
// CHANNELS
// ═══════════════════════════════════════════════════════════════════

model Channel {
  id               String   @id @default(cuid())
  agentId          String
  agent            Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  type             ChannelType
  status           ChannelStatus @default(ACTIVE)

  widgetId         String?  @unique @default(cuid())
  widgetColor      String?  @default("#6366F1")
  widgetSecondaryColor String? @default("#4F46E5")
  widgetPosition   WidgetPosition @default(BOTTOM_RIGHT)
  widgetSize       WidgetSize @default(MEDIUM)
  widgetWelcomeMessage String? @default("Bonjour ! Comment puis-je vous aider ?")
  widgetPlaceholder String? @default("Ecrivez votre message...")
  widgetShowOnMobile Boolean @default(true)
  widgetShowOnDesktop Boolean @default(true)
  widgetAvatar     String?
  widgetBrandName  String?
  widgetTheme      String?  @default("light")
  widgetLanguage   String?  @default("fr")
  widgetCustomCSS  String?  @db.Text
  widgetAllowedOrigins String[]

  emailForwardAddress String?
  emailFromName    String?
  emailFromAddress String?
  emailSignature   String?  @db.Text
  emailReplyTo     String?
  emailAutoReply   Boolean  @default(true)

  slackWorkspaceId String?
  slackChannelId   String?
  slackBotToken    String?
  slackSigningSecret String?
  slackNotifyOnEscalation Boolean @default(true)

  whatsappPhoneNumber String?
  whatsappAccountId String?
  whatsappAccessToken String?
  whatsappWebhookSecret String?

  apiWebhookUrl    String?
  apiSecret        String?
  apiAuthType      String?
  apiHeaders       Json?

  rateLimitPerMinute Int?
  rateLimitPerHour Int?

  totalConversations Int   @default(0)
  totalMessages    Int     @default(0)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  deletedAt        DateTime?

  conversations    Conversation[]

  @@unique([agentId, type])
  @@index([widgetId])
  @@index([agentId])
  @@index([type])
  @@index([status])
  @@map("channels")
}

// ═══════════════════════════════════════════════════════════════════
// KNOWLEDGE BASES
// ═══════════════════════════════════════════════════════════════════

model KnowledgeBase {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name             String
  description      String?      @db.Text
  icon             String?
  color            String?      @default("#6366F1")

  language         String?      @default("fr")
  chunkingStrategy String       @default("semantic")
  chunkSize        Int          @default(512)
  chunkOverlap     Int          @default(50)
  embeddingModel   String       @default("text-embedding-3-small")

  sourcesCount     Int          @default(0)
  documentsCount   Int          @default(0)
  chunksCount      Int          @default(0)
  totalTokens      Int          @default(0)
  totalSize        BigInt       @default(0)

  status           KBStatus     @default(READY)
  lastSyncAt       DateTime?
  nextSyncAt       DateTime?
  indexingProgress Float?
  indexingStatus   String?
  indexingError    String?      @db.Text

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  deletedAt        DateTime?

  sources          KnowledgeSource[]
  agents           AgentKnowledgeBase[]

  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
  @@map("knowledge_bases")
}

model KnowledgeSource {
  id               String        @id @default(cuid())
  knowledgeBaseId  String
  knowledgeBase    KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)

  name             String
  type             KBSourceType

  fileUrl          String?
  fileName         String?
  fileSize         Int?
  mimeType         String?
  fileHash         String?

  websiteUrl       String?
  crawlDepth       Int?         @default(1)
  crawlLimit       Int?         @default(100)
  crawlIncludePatterns String[]
  crawlExcludePatterns String[]

  textContent      String?      @db.Text

  apiType          String?
  apiConfig        Json?
  apiCredentials   String?

  status           KBSourceStatus @default(PENDING)
  processingProgress Float?
  errorMessage     String?      @db.Text
  errorCount       Int          @default(0)
  lastErrorAt      DateTime?

  lastSyncAt       DateTime?
  nextSyncAt       DateTime?
  syncFrequency    SyncFrequency? @default(MANUAL)
  autoSync         Boolean      @default(false)

  documentsCount   Int          @default(0)
  chunksCount      Int          @default(0)
  tokensCount      Int          @default(0)

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  deletedAt        DateTime?

  documents        KnowledgeDocument[]

  @@index([knowledgeBaseId])
  @@index([status])
  @@index([type])
  @@index([fileHash])
  @@map("knowledge_sources")
}

model KnowledgeDocument {
  id               String            @id @default(cuid())
  sourceId         String
  source           KnowledgeSource   @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  externalId       String?
  title            String
  content          String?           @db.Text
  url              String?

  metadata         Json?
  author           String?
  publishedAt      DateTime?
  language         String?
  contentHash      String?

  status           DocProcessingStatus @default(PENDING)
  processedAt      DateTime?
  processingTime   Int?
  errorMessage     String?           @db.Text

  chunksCount      Int               @default(0)
  tokensCount      Int               @default(0)

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?

  chunks           KnowledgeChunk[]

  @@unique([sourceId, externalId])
  @@index([sourceId])
  @@index([status])
  @@index([contentHash])
  @@map("knowledge_documents")
}

model KnowledgeChunk {
  id               String            @id @default(cuid())
  documentId       String
  document         KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  content          String            @db.Text
  // embedding     Unsupported("vector(1536)")? // Requires pgvector extension
  embeddingJson    Json?  // Fallback: store as JSON array until pgvector is installed

  position         Int
  tokenCount       Int
  metadata         Json?

  pineconeId       String?           @unique
  pineconeNamespace String?

  createdAt        DateTime          @default(now())

  @@index([documentId])
  @@index([pineconeId])
  @@map("knowledge_chunks")
}

model AgentKnowledgeBase {
  agentId          String
  agent            Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  knowledgeBaseId  String
  knowledgeBase    KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)

  priority         Int           @default(0)
  maxChunks        Int?
  confidenceThreshold Float?

  createdAt        DateTime      @default(now())

  @@id([agentId, knowledgeBaseId])
  @@index([agentId])
  @@index([knowledgeBaseId])
  @@map("agent_knowledge_bases")
}

// ═══════════════════════════════════════════════════════════════════
// CONVERSATIONS
// ═══════════════════════════════════════════════════════════════════

model Conversation {
  id               String       @id @default(cuid())

  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  agentId          String
  agent            Agent        @relation(fields: [agentId], references: [id])

  channelId        String?
  channel          Channel?     @relation(fields: [channelId], references: [id], onDelete: SetNull)

  channelType      ChannelType
  externalId       String?

  visitorId        String?
  visitorEmail     String?
  visitorName      String?
  visitorPhone     String?
  visitorCompany   String?
  visitorMetadata  Json?
  visitorIp        String?
  visitorUserAgent String?      @db.Text
  visitorCountry   String?
  visitorCity      String?
  visitorLanguage  String?
  visitorTimezone  String?
  visitorDevice    String?
  visitorBrowser   String?
  visitorOs        String?
  visitorReferrer  String?      @db.Text

  utmSource        String?
  utmMedium        String?
  utmCampaign      String?
  utmTerm          String?
  utmContent       String?

  status           ConversationStatus @default(ACTIVE)
  resolvedBy       ResolvedBy?
  resolvedAt       DateTime?
  assignedToId     String?
  assignedAt       DateTime?

  messageCount     Int          @default(0)
  userMessageCount Int          @default(0)
  agentMessageCount Int         @default(0)

  totalTokensIn    Int          @default(0)
  totalTokensOut   Int          @default(0)
  totalCostUsd     Float        @default(0)

  avgResponseMs    Int?
  firstResponseMs  Int?
  totalDuration    Int?

  satisfactionRating Int?
  satisfactionComment String?   @db.Text
  satisfactionAskedAt DateTime?
  satisfactionRatedAt DateTime?

  escalatedAt      DateTime?
  escalatedTo      String?
  escalationReason String?      @db.Text
  escalationPriority String?

  summary          String?      @db.Text
  topics           String[]
  sentiment        String?
  language         String?
  intent           String?

  tags             String[]
  notes            String?      @db.Text

  priority         Int          @default(0)
  isUrgent         Boolean      @default(false)
  isStarred        Boolean      @default(false)
  isSpam           Boolean      @default(false)
  spamScore        Float?

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  deletedAt        DateTime?

  messages         Message[]

  @@index([organizationId])
  @@index([agentId])
  @@index([status])
  @@index([channelType])
  @@index([createdAt])
  @@index([visitorId])
  @@index([visitorEmail])
  @@index([resolvedAt])
  @@index([escalatedAt])
  @@index([assignedToId])
  @@index([isUrgent])
  @@index([isSpam])
  @@map("conversations")
}

model Message {
  id               String       @id @default(cuid())
  conversationId   String
  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role             MessageRole
  content          String       @db.Text
  contentType      String       @default("text")
  attachments      Json?

  model            String?
  tokensIn         Int?
  tokensOut        Int?
  costUsd          Float?
  latencyMs        Int?
  confidence       Float?

  sourcesUsed      Json?
  chunksUsed       String[]
  retrievalScore   Float?

  toolCalls        Json?
  toolResults      Json?

  flagged          Boolean      @default(false)
  flagReason       String?
  moderationScore  Float?
  moderationCategories Json?

  isEdited         Boolean      @default(false)
  editedAt         DateTime?
  originalContent  String?      @db.Text

  deliveryStatus   String?
  deliveryError    String?
  deliveredAt      DateTime?
  readAt           DateTime?

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  deletedAt        DateTime?

  @@index([conversationId])
  @@index([role])
  @@index([createdAt])
  @@index([flagged])
  @@map("messages")
}

// ═══════════════════════════════════════════════════════════════════
// ANALYTICS
// ═══════════════════════════════════════════════════════════════════

model AgentDailyAnalytics {
  id                   String   @id @default(cuid())
  agentId              String
  agent                Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  date                 DateTime @db.Date

  conversations        Int      @default(0)
  messages             Int      @default(0)
  uniqueVisitors       Int      @default(0)

  autoResolved         Int      @default(0)
  humanResolved        Int      @default(0)
  escalated            Int      @default(0)
  abandoned            Int      @default(0)
  spam                 Int      @default(0)

  avgResponseMs        Int?
  avgFirstResponseMs   Int?
  avgConversationLength Int?
  avgTokensPerMessage  Int?

  ratingsCount         Int      @default(0)
  ratingsSum           Int      @default(0)
  avgSatisfaction      Float?
  rating1Count         Int      @default(0)
  rating2Count         Int      @default(0)
  rating3Count         Int      @default(0)
  rating4Count         Int      @default(0)
  rating5Count         Int      @default(0)
  npsScore             Int?

  totalTokensIn        Int      @default(0)
  totalTokensOut       Int      @default(0)
  totalCostUsd         Float    @default(0)
  avgCostPerConversation Float?

  modelsUsage          Json?

  widgetConversations  Int      @default(0)
  emailConversations   Int      @default(0)
  slackConversations   Int      @default(0)
  apiConversations     Int      @default(0)

  estimatedHoursSaved  Float?
  estimatedCostSaved   Float?

  topTopics            Json?

  positiveSentiment    Int      @default(0)
  neutralSentiment     Int      @default(0)
  negativeSentiment    Int      @default(0)

  languageBreakdown    Json?

  createdAt            DateTime @default(now())

  @@unique([agentId, date])
  @@index([agentId])
  @@index([date])
  @@map("agent_daily_analytics")
}

// ═══════════════════════════════════════════════════════════════════
// PLATFORM ANALYTICS & WEB VITALS
// ═══════════════════════════════════════════════════════════════════

model AnalyticsEvent {
  id          String   @id @default(cuid())
  eventType   String
  userId      String?
  sessionId   String?
  properties  Json?
  brandId     String?
  page        String?
  referrer    String?
  userAgent   String?  @db.Text
  ipAddress   String?
  country     String?
  device      String?

  createdAt   DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("analytics_events")
}

model WebVital {
  id          String   @id @default(cuid())
  name        String
  value       Float
  rating      String?
  delta       Float?
  page        String?
  userAgent   String?  @db.Text
  sessionId   String?
  connection  String?

  createdAt   DateTime @default(now())

  @@index([name])
  @@index([createdAt])
  @@map("web_vitals")
}

// ═══════════════════════════════════════════════════════════════════
// INTEGRATIONS
// ═══════════════════════════════════════════════════════════════════

model Integration {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  type             IntegrationType
  status           IntegrationStatus @default(CONNECTED)

  accessToken      String?      @db.Text
  refreshToken     String?      @db.Text
  tokenExpiresAt   DateTime?
  scope            String?

  shopDomain       String?
  shopId           String?
  shopName         String?
  hubspotPortalId  String?
  slackTeamId      String?
  slackTeamName    String?

  config           Json?

  lastSyncAt       DateTime?
  lastSyncSuccess  Boolean?
  lastSyncError    String?      @db.Text
  syncEnabled      Boolean      @default(true)
  autoSync         Boolean      @default(false)
  syncFrequency    String?

  webhookSecret    String?
  webhooksEnabled  Boolean      @default(false)

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  deletedAt        DateTime?

  @@unique([organizationId, type])
  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@map("integrations")
}

// ═══════════════════════════════════════════════════════════════════
// BILLING
// ═══════════════════════════════════════════════════════════════════

model UsageRecord {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  type             UsageType
  quantity         Int
  agentId          String?
  conversationId   String?
  metadata         Json?

  periodStart      DateTime
  periodEnd        DateTime

  createdAt        DateTime     @default(now())

  @@index([organizationId])
  @@index([type])
  @@index([periodStart, periodEnd])
  @@index([agentId])
  @@map("usage_records")
}

model Invoice {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  stripeInvoiceId  String       @unique
  stripePaymentIntent String?

  subtotal         Float
  tax              Float        @default(0)
  discount         Float        @default(0)
  total            Float
  currency         String       @default("usd")

  status           InvoiceStatus
  paidAt           DateTime?

  periodStart      DateTime
  periodEnd        DateTime
  items            Json
  pdfUrl           String?
  hostedUrl        String?
  paymentMethod    String?
  lastPaymentError String?      @db.Text

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([stripeInvoiceId])
  @@map("invoices")
}

// ═══════════════════════════════════════════════════════════════════
// API & WEBHOOKS
// ═══════════════════════════════════════════════════════════════════

model ApiKey {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name             String
  keyHash          String       @unique
  keyPrefix        String
  permissions      String[]
  scopes           String[]

  rateLimit        Int          @default(1000)
  allowedIps       String[]

  lastUsedAt       DateTime?
  lastUsedIp       String?
  usageCount       Int          @default(0)
  expiresAt        DateTime?
  isActive         Boolean      @default(true)

  createdAt        DateTime     @default(now())
  revokedAt        DateTime?

  @@index([keyHash])
  @@index([organizationId])
  @@index([isActive])
  @@map("api_keys")
}

model Webhook {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  url              String
  events           String[]
  secret           String
  customHeaders    Json?

  maxRetries       Int          @default(3)
  retryBackoff     String       @default("exponential")
  status           WebhookStatus @default(ACTIVE)

  lastCalledAt     DateTime?
  lastStatusCode   Int?
  lastError        String?      @db.Text
  consecutiveFailures Int       @default(0)
  totalCalls       Int          @default(0)
  successfulCalls  Int          @default(0)

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  logs             WebhookLog[]

  @@index([organizationId])
  @@index([status])
  @@map("webhooks")
}

model WebhookLog {
  id               String   @id @default(cuid())
  webhookId        String
  webhook          Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  event            String
  payload          Json
  statusCode       Int?
  response         String?  @db.Text
  latencyMs        Int?
  success          Boolean
  error            String?  @db.Text
  retryCount       Int      @default(0)

  createdAt        DateTime @default(now())

  @@index([webhookId])
  @@index([createdAt])
  @@index([success])
  @@map("webhook_logs")
}

// ═══════════════════════════════════════════════════════════════════
// AUDIT & SUPPORT
// ═══════════════════════════════════════════════════════════════════

model AuditLog {
  id               String       @id @default(cuid())
  organizationId   String?
  organization     Organization? @relation(fields: [organizationId], references: [id])
  userId           String?
  user             User?        @relation(fields: [userId], references: [id])

  action           String
  resource         String
  resourceId       String?
  changes          Json?
  metadata         Json?
  ipAddress        String?
  userAgent        String?      @db.Text
  country          String?

  success          Boolean      @default(true)
  error            String?      @db.Text

  createdAt        DateTime     @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

model Ticket {
  id               String   @id @default(cuid())
  organizationId   String?
  organization     Organization? @relation(fields: [organizationId], references: [id])

  createdById      String?
  createdBy        User?    @relation("TicketCreator", fields: [createdById], references: [id])
  assignedToId     String?
  assignedTo       User?    @relation("TicketAssignee", fields: [assignedToId], references: [id])

  subject          String
  description      String   @db.Text
  category         String?
  priority         TicketPriority @default(MEDIUM)
  status           TicketStatus @default(OPEN)

  dueAt            DateTime?
  firstResponseAt  DateTime?
  resolvedAt       DateTime?
  closedAt         DateTime?

  tags             String[]
  customFields     Json?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  messages         TicketMessage[]

  @@index([status])
  @@index([priority])
  @@index([assignedToId])
  @@index([createdAt])
  @@map("tickets")
}

model TicketMessage {
  id               String  @id @default(cuid())
  ticketId         String
  ticket           Ticket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  content          String  @db.Text
  contentType      String  @default("text")
  isStaff          Boolean @default(false)
  authorId         String?
  authorName       String?
  authorEmail      String?
  attachments      Json?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([ticketId])
  @@map("ticket_messages")
}

model FeatureFlag {
  id               String  @id @default(cuid())
  key              String  @unique
  name             String
  description      String? @db.Text

  enabled          Boolean @default(false)
  rules            Json?
  rolloutPercentage Int   @default(0)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([key])
  @@index([enabled])
  @@map("feature_flags")
}

// ═══════════════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════════════

enum PlatformRole {
  USER
  ADMIN
  @@map("platform_role")
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
  @@map("org_role")
}

enum OrgStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  CANCELED
  @@map("org_status")
}

enum Plan {
  FREE
  STARTER
  PRO
  BUSINESS
  ENTERPRISE
  @@map("plan")
}

enum Industry {
  ECOMMERCE
  SAAS
  FINTECH
  HEALTHCARE
  REAL_ESTATE
  INSURANCE
  EDUCATION
  AGENCY
  CONSULTING
  RETAIL
  HOSPITALITY
  AUTOMOTIVE
  TRAVEL
  MEDIA
  NONPROFIT
  GOVERNMENT
  OTHER
  @@map("industry")
}

enum CompanySize {
  SOLO
  SMALL
  MEDIUM
  LARGE
  ENTERPRISE
  @@map("company_size")
}

enum AgentCategory {
  SUPPORT
  SALES
  ONBOARDING
  REVIEWS
  CONTENT
  ANALYTICS
  EMAIL
  CUSTOM
  @@map("agent_category")
}

enum AgentStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
  @@map("agent_status")
}

enum AgentTone {
  PROFESSIONAL
  FRIENDLY
  FORMAL
  CASUAL
  EMPATHETIC
  ENTHUSIASTIC
  CUSTOM
  @@map("agent_tone")
}

enum ChannelType {
  WIDGET
  EMAIL
  SLACK
  TEAMS
  WHATSAPP
  INSTAGRAM
  FACEBOOK
  TELEGRAM
  API
  @@map("channel_type")
}

enum ChannelStatus {
  ACTIVE
  PAUSED
  ERROR
  @@map("channel_status")
}

enum WidgetPosition {
  BOTTOM_RIGHT
  BOTTOM_LEFT
  TOP_RIGHT
  TOP_LEFT
  @@map("widget_position")
}

enum WidgetSize {
  SMALL
  MEDIUM
  LARGE
  @@map("widget_size")
}

enum KBStatus {
  READY
  INDEXING
  ERROR
  SYNCING
  @@map("kb_status")
}

enum KBSourceType {
  FILE
  WEBSITE
  TEXT
  API_SHOPIFY
  API_WOOCOMMERCE
  API_PRESTASHOP
  API_HUBSPOT
  API_SALESFORCE
  API_NOTION
  API_CONFLUENCE
  API_GOOGLE_DRIVE
  API_SHAREPOINT
  API_ZENDESK
  API_INTERCOM
  API_CUSTOM
  @@map("kb_source_type")
}

enum KBSourceStatus {
  PENDING
  PROCESSING
  READY
  ERROR
  SYNCING
  PAUSED
  @@map("kb_source_status")
}

enum SyncFrequency {
  MANUAL
  REALTIME
  EVERY_15_MIN
  HOURLY
  EVERY_6_HOURS
  DAILY
  WEEKLY
  MONTHLY
  @@map("sync_frequency")
}

enum DocProcessingStatus {
  PENDING
  PROCESSING
  INDEXED
  ERROR
  SKIPPED
  @@map("doc_processing_status")
}

enum ConversationStatus {
  ACTIVE
  RESOLVED
  ESCALATED
  CLOSED
  SPAM
  ARCHIVED
  @@map("conversation_status")
}

enum ResolvedBy {
  AGENT
  HUMAN
  VISITOR
  TIMEOUT
  SYSTEM
  @@map("resolved_by")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
  INTERNAL_NOTE
  @@map("message_role")
}

enum IntegrationType {
  SHOPIFY
  WOOCOMMERCE
  PRESTASHOP
  MAGENTO
  BIGCOMMERCE
  HUBSPOT
  SALESFORCE
  PIPEDRIVE
  ZOHO_CRM
  SLACK
  TEAMS
  DISCORD
  TELEGRAM
  GMAIL
  OUTLOOK
  SENDGRID
  MAILCHIMP
  ZENDESK
  INTERCOM
  FRESHDESK
  HELPSCOUT
  NOTION
  CONFLUENCE
  GOOGLE_DRIVE
  SHAREPOINT
  DROPBOX
  ZAPIER
  MAKE
  N8N
  CALENDLY
  GOOGLE_CALENDAR
  OUTLOOK_CALENDAR
  STRIPE
  PAYPAL
  @@map("integration_type")
}

enum IntegrationStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  EXPIRED
  PENDING
  @@map("integration_status")
}

enum UsageType {
  CONVERSATION
  MESSAGE
  KNOWLEDGE_INDEX
  API_CALL
  LLM_TOKENS
  STORAGE
  @@map("usage_type")
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
  @@map("invoice_status")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
  @@map("invitation_status")
}

enum WebhookStatus {
  ACTIVE
  PAUSED
  FAILED
  @@map("webhook_status")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING
  RESOLVED
  CLOSED
  @@map("ticket_status")
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
  @@map("ticket_priority")
}
