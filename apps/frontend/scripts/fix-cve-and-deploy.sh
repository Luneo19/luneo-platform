#!/bin/bash

# ==============================================
# FIX CVE VULNÉRABILITÉS ET DÉPLOIEMENT PRODUCTION
# LUNEO - SaaS de niveau mondial #1
# ==============================================

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}╔════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  🔒 FIX CVE VULNÉRABILITÉS ET DÉPLOIEMENT PRODUCTION               ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════════════════════════════════╝${NC}"
echo ""

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRONTEND_DIR="$(dirname "$SCRIPT_DIR")"
ROOT_DIR="$(dirname "$(dirname "$FRONTEND_DIR")")"

cd "$FRONTEND_DIR"

# ==============================================
# ÉTAPE 1: MISE À JOUR DES PACKAGES
# ==============================================
echo -e "${YELLOW}📦 Étape 1/4: Mise à jour des packages pour corriger les CVE...${NC}"

# Mettre à jour React et Next.js vers les versions patchées
echo "Mise à jour React vers 18.3.1..."
pnpm add react@^18.3.1 react-dom@^18.3.1 --save

echo "Mise à jour Next.js vers 15.5.6..."
pnpm add next@^15.5.6 --save

echo "Mise à jour @types/react..."
pnpm add -D @types/react@^18.3.0 @types/react-dom@^18.3.0

echo -e "${GREEN}✅ Packages mis à jour${NC}"
echo ""

# ==============================================
# ÉTAPE 2: INSTALLATION DES DÉPENDANCES
# ==============================================
echo -e "${YELLOW}📥 Étape 2/4: Installation des dépendances...${NC}"

cd "$ROOT_DIR"
pnpm install

echo -e "${GREEN}✅ Dépendances installées${NC}"
echo ""

# ==============================================
# ÉTAPE 3: BUILD ET VÉRIFICATION
# ==============================================
echo -e "${YELLOW}🔨 Étape 3/4: Build et vérification...${NC}"

cd "$FRONTEND_DIR"

if pnpm run build > /tmp/build.log 2>&1; then
    echo -e "${GREEN}✅ Build réussi${NC}"
else
    echo -e "${RED}❌ Erreur lors du build${NC}"
    cat /tmp/build.log | tail -50
    exit 1
fi

echo ""

# ==============================================
# ÉTAPE 4: DÉPLOIEMENT VERCEL
# ==============================================
echo -e "${YELLOW}🚀 Étape 4/4: Déploiement en production...${NC}"

# Vérifier Vercel CLI
if ! command -v vercel &> /dev/null; then
    echo -e "${RED}❌ Vercel CLI non installé${NC}"
    exit 1
fi

# Vérifier connexion
if ! vercel whoami > /dev/null 2>&1; then
    echo -e "${RED}❌ Vercel CLI non connecté${NC}"
    echo "Exécutez: vercel login"
    exit 1
fi

echo "Déploiement en production..."
if vercel --prod --yes > /tmp/vercel-deploy.log 2>&1; then
    echo -e "${GREEN}✅ Déploiement réussi!${NC}"
    DEPLOYMENT_URL=$(grep -o 'https://[^ ]*\.vercel\.app' /tmp/vercel-deploy.log | head -1)
    echo -e "${GREEN}🌐 URL: $DEPLOYMENT_URL${NC}"
else
    echo -e "${RED}❌ Erreur lors du déploiement${NC}"
    cat /tmp/vercel-deploy.log | tail -50
    exit 1
fi

echo ""
echo -e "${GREEN}╔════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║  ✅ CVE CORRIGÉES ET DÉPLOIEMENT TERMINÉ                          ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════════════╝${NC}"
echo ""




















