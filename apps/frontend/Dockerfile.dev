# Using node:22-bullseye (Debian) for dev: native modules (e.g. sharp, canvas) build reliably.
# Alpine could reduce image size but may require extra build deps for native modules.
FROM node:22-bullseye

RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /workspace

# Create non-root user for security (run app as app, not root)
RUN addgroup --system --gid 1001 app && \
    adduser --system --uid 1001 --ingroup app app

COPY --chown=app:app package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json ./
COPY --chown=app:app apps/frontend/package.json apps/frontend/

RUN pnpm install --frozen-lockfile

COPY --chown=app:app . .

# Ensure app user owns everything (e.g. node_modules created by install)
RUN chown -R app:app /workspace

WORKDIR /workspace/apps/frontend

ENV NODE_ENV=development
ENV PORT=3000

EXPOSE 3000

USER app

CMD ["pnpm", "run", "dev"]
