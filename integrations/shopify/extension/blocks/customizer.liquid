{% comment %}
  Luneo Product Customizer Block
  Add this block to product pages
{% endcomment %}

<div id="luneo-customizer-{{ block.id }}" class="luneo-customizer-container">
  <button
    type="button"
    class="luneo-customize-button"
    data-product-id="{{ product.id }}"
    data-variant-id="{{ product.selected_or_first_available_variant.id }}"
    style="
      background-color: {{ block.settings.button_background }};
      color: {{ block.settings.button_text_color }};
      padding: {{ block.settings.button_padding }}px;
      border-radius: {{ block.settings.button_border_radius }}px;
      font-size: {{ block.settings.button_font_size }}px;
      width: 100%;
      border: none;
      cursor: pointer;
      margin-bottom: 10px;
      font-weight: 500;
      transition: all 0.2s;
    "
    onmouseover="this.style.opacity='0.9'"
    onmouseout="this.style.opacity='1'"
  >
    {{ block.settings.button_text }}
  </button>
  
  <div id="luneo-modal-{{ block.id }}" class="luneo-modal" style="display: none;">
    <div class="luneo-modal-content">
      <button class="luneo-modal-close" aria-label="Fermer">&times;</button>
      <div id="luneo-widget-{{ block.id }}" class="luneo-widget-container"></div>
    </div>
  </div>
</div>

<style>
  .luneo-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-in;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .luneo-modal-content {
    background: white;
    width: 90%;
    max-width: 1200px;
    height: 90%;
    border-radius: 8px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease-out;
  }
  
  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  .luneo-modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    font-size: 28px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  
  .luneo-modal-close:hover {
    background: rgba(0, 0, 0, 0.7);
    transform: scale(1.1);
  }
  
  .luneo-widget-container {
    width: 100%;
    height: 100%;
    overflow: hidden;
  }
  
  .luneo-customize-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
</style>

<script>
  (function() {
    const blockId = '{{ block.id }}';
    const productId = '{{ product.id }}';
    const variantId = '{{ product.selected_or_first_available_variant.id }}';
    const apiKey = '{{ shop.metafields.luneo.api_key }}' || '{{ block.settings.api_key }}';
    const widgetUrl = '{{ block.settings.widget_url | default: "https://cdn.luneo.app/widget/v1/luneo-widget.iife.js" }}';
    
    let widgetInitialized = false;
    
    // Load Luneo Widget script
    function loadWidgetScript() {
      return new Promise((resolve, reject) => {
        if (window.LuneoWidget) {
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = widgetUrl;
        script.async = true;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error('Failed to load Luneo Widget'));
        document.head.appendChild(script);
      });
    }
    
    function initWidget() {
      const button = document.querySelector(`#luneo-customizer-${blockId} .luneo-customize-button`);
      const modal = document.querySelector(`#luneo-modal-${blockId}`);
      const closeBtn = modal.querySelector('.luneo-modal-close');
      const widgetContainer = document.querySelector(`#luneo-widget-${blockId}`);
      
      if (!button || !modal || !widgetContainer) {
        console.error('Luneo: Required elements not found');
        return;
      }
      
      button.addEventListener('click', async () => {
        modal.style.display = 'flex';
        
        if (!widgetInitialized) {
          try {
            await loadWidgetScript();
            
            if (!window.LuneoWidget) {
              throw new Error('LuneoWidget not available after script load');
            }
            
            window.LuneoWidget.init({
              container: `#luneo-widget-${blockId}`,
              apiKey: apiKey,
              productId: productId,
              locale: '{{ request.locale.iso_code }}',
              theme: 'light',
              onSave: (designData) => {
                // Add to cart with customization data
                addToCartWithDesign(designData);
                modal.style.display = 'none';
              },
              onError: (error) => {
                console.error('Luneo Widget Error:', error);
                alert('Une erreur est survenue lors de la personnalisation. Veuillez réessayer.');
              },
              onReady: () => {
                console.log('Luneo Widget ready');
              }
            });
            
            widgetInitialized = true;
          } catch (error) {
            console.error('Luneo: Failed to initialize widget:', error);
            alert('Impossible de charger l\'éditeur de personnalisation. Veuillez réessayer.');
            modal.style.display = 'none';
          }
        }
      });
      
      closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
    }
    
    function addToCartWithDesign(designData) {
      const formData = {
        items: [{
          id: variantId,
          quantity: 1,
          properties: {
            '_luneo_design_id': designData.id || 'temp-' + Date.now(),
            '_luneo_preview': designData.previewUrl || '',
            'Personnalisation': 'Design personnalisé',
            '_luneo_design_data': JSON.stringify(designData)
          },
        }],
      };
      
      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      })
      .then(response => response.json())
      .then(data => {
        // Dispatch cart update event
        document.dispatchEvent(new CustomEvent('cart:updated'));
        
        // Show success message
        if (typeof window.showNotification === 'function') {
          window.showNotification('Produit ajouté au panier avec personnalisation!');
        } else {
          alert('Produit ajouté au panier!');
        }
        
        // Optionally redirect to cart
        // window.location.href = '/cart';
      })
      .catch(error => {
        console.error('Error adding to cart:', error);
        alert('Erreur lors de l\'ajout au panier. Veuillez réessayer.');
      });
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initWidget);
    } else {
      initWidget();
    }
  })();
</script>

{% schema %}
{
  "name": "Luneo Customizer",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Personnaliser ce produit"
    },
    {
      "type": "color",
      "id": "button_background",
      "label": "Button Background",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "button_padding",
      "label": "Button Padding",
      "min": 8,
      "max": 24,
      "default": 16,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "label": "Button Border Radius",
      "min": 0,
      "max": 24,
      "default": 4,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "button_font_size",
      "label": "Button Font Size",
      "min": 12,
      "max": 24,
      "default": 16,
      "unit": "px"
    },
    {
      "type": "text",
      "id": "api_key",
      "label": "API Key",
      "info": "Votre clé API Luneo (optionnel si configuré dans les metafields)"
    },
    {
      "type": "url",
      "id": "widget_url",
      "label": "Widget URL (optional)",
      "info": "URL du widget Luneo (par défaut: CDN)"
    }
  ]
}
{% endschema %}


