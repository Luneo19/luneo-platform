# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë  üê≥ DOCKER COMPOSE DEV - LUNEO ENTERPRISE                        ‚ïë
# ‚ïë     Environnement de d√©veloppement complet                       ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

version: '3.8'

services:
  # ========================================
  # DATABASE SERVICES
  # ========================================
  
  postgres:
    image: postgres:15-alpine
    container_name: luneo-postgres-dev
    environment:
      POSTGRES_DB: luneo_dev
      POSTGRES_USER: luneo_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-luneo_dev_password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/prisma/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U luneo_user -d luneo_dev"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - luneo-dev

  redis:
    image: redis:7-alpine
    container_name: luneo-redis-dev
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-luneo_dev_password}
    command: redis-server --requirepass ${REDIS_PASSWORD:-luneo_dev_password}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - luneo-dev

  # ========================================
  # API SERVICES
  # ========================================

  api:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: luneo-api-dev
    environment:
      # Database
      DATABASE_URL: "postgresql://luneo_user:${POSTGRES_PASSWORD:-luneo_dev_password}@postgres:5432/luneo_dev"
      
      # Redis
      REDIS_URL: "redis://:${REDIS_PASSWORD:-luneo_dev_password}@redis:6379"
      
      # JWT
      JWT_SECRET: "dev-jwt-secret-change-in-production"
      JWT_EXPIRES_IN: "15m"
      JWT_REFRESH_SECRET: "dev-jwt-refresh-secret-change-in-production"
      JWT_REFRESH_EXPIRES_IN: "7d"
      
      # App
      NODE_ENV: "development"
      PORT: "3001"
      API_URL: "http://localhost:3001"
      FRONTEND_URL: "http://localhost:3000"
      CORS_ORIGIN: "http://localhost:3000"
      
      # OAuth (dev credentials - change in production)
      GOOGLE_CLIENT_ID: "your-google-client-id"
      GOOGLE_CLIENT_SECRET: "your-google-client-secret"
      GOOGLE_CALLBACK_URL: "http://localhost:3001/auth/google/callback"
      
      GITHUB_CLIENT_ID: "your-github-client-id"
      GITHUB_CLIENT_SECRET: "your-github-client-secret"
      GITHUB_CALLBACK_URL: "http://localhost:3001/auth/github/callback"
      
      # External Services (dev - change in production)
      STRIPE_SECRET_KEY: "sk_test_..."
      STRIPE_WEBHOOK_SECRET: "whsec_..."
      OPENAI_API_KEY: "sk-..."
      SENDGRID_API_KEY: "SG..."
      SENDGRID_FROM_EMAIL: "dev@luneo.app"
      SENTRY_DSN: "https://..."
      CLOUDINARY_CLOUD_NAME: "dev-cloud"
      CLOUDINARY_API_KEY: "..."
      CLOUDINARY_API_SECRET: "..."
      
      # Rate Limiting
      RATE_LIMIT_TTL: "60"
      RATE_LIMIT_MAX: "1000" # Plus permissif en dev
      
      # Development
      DEBUG: "true"
      LOG_LEVEL: "debug"
    ports:
      - "3001:3001"
    volumes:
      - ./backend:/app
      - /app/node_modules
      - ./backend/.env:/app/.env:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - luneo-dev
    command: pnpm run start:dev

  # ========================================
  # WORKER SERVICES
  # ========================================

  ai-worker:
    build:
      context: ./workers
      dockerfile: ai-worker/Dockerfile.dev
    container_name: luneo-ai-worker-dev
    environment:
      # Database
      DATABASE_URL: "postgresql://luneo_user:${POSTGRES_PASSWORD:-luneo_dev_password}@postgres:5432/luneo_dev"
      
      # Redis
      REDIS_URL: "redis://:${REDIS_PASSWORD:-luneo_dev_password}@redis:6379"
      
      # AI Services
      OPENAI_API_KEY: "sk-..."
      
      # Storage
      CLOUDINARY_CLOUD_NAME: "dev-cloud"
      CLOUDINARY_API_KEY: "..."
      CLOUDINARY_API_SECRET: "..."
      
      # Development
      NODE_ENV: "development"
      LOG_LEVEL: "debug"
    volumes:
      - ./workers:/app
      - /app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - luneo-dev
    command: pnpm run start:dev

  render-worker:
    build:
      context: ./workers
      dockerfile: render-worker/Dockerfile.dev
    container_name: luneo-render-worker-dev
    environment:
      # Database
      DATABASE_URL: "postgresql://luneo_user:${POSTGRES_PASSWORD:-luneo_dev_password}@postgres:5432/luneo_dev"
      
      # Redis
      REDIS_URL: "redis://:${REDIS_PASSWORD:-luneo_dev_password}@redis:6379"
      
      # Storage
      CLOUDINARY_CLOUD_NAME: "dev-cloud"
      CLOUDINARY_API_KEY: "..."
      CLOUDINARY_API_SECRET: "..."
      
      # 3D Rendering
      BLENDER_PATH: "/usr/bin/blender"
      OUTPUT_FORMAT: "gltf"
      
      # Development
      NODE_ENV: "development"
      LOG_LEVEL: "debug"
    volumes:
      - ./workers:/app
      - /app/node_modules
      - /tmp:/tmp # Pour les fichiers temporaires de rendu
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - luneo-dev
    command: pnpm run start:dev

  # ========================================
  # DEVELOPMENT TOOLS
  # ========================================

  # Redis Commander (interface web pour Redis)
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: luneo-redis-commander-dev
    environment:
      REDIS_HOSTS: "local:redis:6379:0:${REDIS_PASSWORD:-luneo_dev_password}"
    ports:
      - "8081:8081"
    depends_on:
      - redis
    networks:
      - luneo-dev

  # pgAdmin (interface web pour PostgreSQL)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: luneo-pgadmin-dev
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@luneo.dev
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "8080:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - luneo-dev

  # ========================================
  # MONITORING & LOGGING
  # ========================================

  # Prometheus pour les m√©triques
  prometheus:
    image: prom/prometheus:latest
    container_name: luneo-prometheus-dev
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - luneo-dev

  # Grafana pour les dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: luneo-grafana-dev
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: false
    ports:
      - "3002:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      - prometheus
    networks:
      - luneo-dev

  # ========================================
  # EXTERNAL SERVICES MOCK
  # ========================================

  # LocalStack pour simuler AWS services
  localstack:
    image: localstack/localstack:latest
    container_name: luneo-localstack-dev
    environment:
      SERVICES: s3,lambda,apigateway
      DEBUG: 1
      DATA_DIR: /tmp/localstack/data
      DOCKER_HOST: unix:///var/run/docker.sock
    ports:
      - "4566:4566"
    volumes:
      - localstack_data:/tmp/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - luneo-dev

  # MailHog pour capturer les emails en dev
  mailhog:
    image: mailhog/mailhog:latest
    container_name: luneo-mailhog-dev
    ports:
      - "1025:1025" # SMTP
      - "8025:8025" # Web UI
    networks:
      - luneo-dev

  # ========================================
  # FRONTEND (OPTIONNEL EN DEV)
  # ========================================

  # Frontend Next.js (optionnel, peut √™tre lanc√© s√©par√©ment)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: luneo-frontend-dev
    environment:
      NODE_ENV: "development"
      NEXT_PUBLIC_API_URL: "http://localhost:3001"
      NEXT_PUBLIC_APP_URL: "http://localhost:3000"
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    networks:
      - luneo-dev
    command: pnpm run dev
    profiles:
      - frontend # Utiliser --profile frontend pour l'inclure

# ========================================
# VOLUMES
# ========================================

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  pgadmin_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  localstack_data:
    driver: local

# ========================================
# NETWORKS
# ========================================

networks:
  luneo-dev:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ========================================
# COMMANDES UTILES
# ========================================

# D√©marrer tous les services :
# docker-compose -f docker-compose.dev.yml up -d

# D√©marrer avec le frontend :
# docker-compose -f docker-compose.dev.yml --profile frontend up -d

# Voir les logs :
# docker-compose -f docker-compose.dev.yml logs -f api

# Arr√™ter tous les services :
# docker-compose -f docker-compose.dev.yml down

# Nettoyer les volumes :
# docker-compose -f docker-compose.dev.yml down -v

# Rebuild une image :
# docker-compose -f docker-compose.dev.yml build api

# Acc√©der aux interfaces :
# - API : http://localhost:3001
# - Frontend : http://localhost:3000
# - pgAdmin : http://localhost:8080 (admin@luneo.dev / admin)
# - Redis Commander : http://localhost:8081
# - Prometheus : http://localhost:9090
# - Grafana : http://localhost:3002 (admin / admin)
# - MailHog : http://localhost:8025

