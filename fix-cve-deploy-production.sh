#!/bin/bash

# ==============================================
# FIX CVE ET DÃ‰PLOIEMENT PRODUCTION COMPLET
# LUNEO - SaaS de niveau mondial #1
# ==============================================

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘  ğŸ”’ FIX CVE ET DÃ‰PLOIEMENT PRODUCTION                                â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRONTEND_DIR="$ROOT_DIR/apps/frontend"

cd "$ROOT_DIR"

# ==============================================
# Ã‰TAPE 1: MISE Ã€ JOUR DES PACKAGES CVE
# ==============================================
echo -e "${YELLOW}ğŸ“¦ Ã‰tape 1/5: Correction des vulnÃ©rabilitÃ©s CVE...${NC}"

cd "$FRONTEND_DIR"

# Mettre Ã  jour vers les versions patchÃ©es
echo "Mise Ã  jour React 18.3.1..."
pnpm add react@^18.3.1 react-dom@^18.3.1 --save

echo "Mise Ã  jour Next.js 15.5.6..."
pnpm add next@^15.5.6 --save

echo "Mise Ã  jour @types/react..."
pnpm add -D @types/react@^18.3.0 @types/react-dom@^18.3.0

echo -e "${GREEN}âœ… CVE corrigÃ©es${NC}"
echo ""

# ==============================================
# Ã‰TAPE 2: INSTALLATION
# ==============================================
echo -e "${YELLOW}ğŸ“¥ Ã‰tape 2/5: Installation des dÃ©pendances...${NC}"

cd "$ROOT_DIR"
pnpm install

echo -e "${GREEN}âœ… DÃ©pendances installÃ©es${NC}"
echo ""

# ==============================================
# Ã‰TAPE 3: BUILD
# ==============================================
echo -e "${YELLOW}ğŸ”¨ Ã‰tape 3/5: Build de l'application...${NC}"

cd "$FRONTEND_DIR"

if pnpm run build > /tmp/build.log 2>&1; then
    echo -e "${GREEN}âœ… Build rÃ©ussi${NC}"
else
    echo -e "${RED}âŒ Erreur lors du build${NC}"
    cat /tmp/build.log | tail -50
    exit 1
fi

echo ""

# ==============================================
# Ã‰TAPE 4: CONFIGURATION VERCEL
# ==============================================
echo -e "${YELLOW}âš™ï¸  Ã‰tape 4/5: Configuration Vercel...${NC}"

cd "$ROOT_DIR"

# CrÃ©er vercel.json Ã  la racine
cat > vercel.json << 'EOF'
{
  "buildCommand": "pnpm --filter luneo-frontend run build",
  "outputDirectory": "apps/frontend/.next",
  "installCommand": "pnpm install --no-frozen-lockfile",
  "framework": "nextjs"
}
EOF

# Lier le projet
if [ ! -d ".vercel" ]; then
    vercel link --yes --project=luneo-frontend --scope=luneos-projects
fi

echo -e "${GREEN}âœ… Configuration Vercel OK${NC}"
echo ""

# ==============================================
# Ã‰TAPE 5: DÃ‰PLOIEMENT
# ==============================================
echo -e "${YELLOW}ğŸš€ Ã‰tape 5/5: DÃ©ploiement en production...${NC}"

if vercel --prod --yes > /tmp/vercel-deploy.log 2>&1; then
    echo -e "${GREEN}âœ… DÃ©ploiement rÃ©ussi!${NC}"
    DEPLOYMENT_URL=$(grep -o 'https://[^ ]*\.vercel\.app' /tmp/vercel-deploy.log | head -1)
    echo -e "${GREEN}ğŸŒ URL Production: $DEPLOYMENT_URL${NC}"
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘  âœ… CVE CORRIGÃ‰ES ET DÃ‰PLOIEMENT TERMINÃ‰                          â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
else
    echo -e "${RED}âŒ Erreur lors du dÃ©ploiement${NC}"
    cat /tmp/vercel-deploy.log | tail -50
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Solution alternative:${NC}"
    echo "   1. Aller sur: https://vercel.com/luneos-projects/luneo-frontend/settings"
    echo "   2. Configurer:"
    echo "      - Root Directory: apps/frontend"
    echo "      - Build Command: pnpm run build"
    echo "      - Output Directory: .next"
    echo "   3. DÃ©ployer depuis le dashboard Vercel"
    exit 1
fi

echo ""




















